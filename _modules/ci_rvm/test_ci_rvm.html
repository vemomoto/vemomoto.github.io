
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ci_rvm.test_ci_rvm &#8212; Vector Movement Modelling Tools</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">VeMoMoTo</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ci_rvm.test_ci_rvm</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Created on 18.09.2019</span>

<span class="sd">@author: Samuel</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">starmap</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span> <span class="k">as</span> <span class="n">op</span><span class="p">,</span> <span class="n">integrate</span><span class="p">,</span> <span class="n">sparse</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">numdifftools</span> <span class="kn">import</span> <span class="n">Gradient</span><span class="p">,</span> <span class="n">Hessian</span>
    <span class="c1">#from autograd import grad as AgGradient, hessian as AgHessian</span>
    <span class="kn">import</span> <span class="nn">autograd.numpy</span> <span class="k">as</span> <span class="nn">ag</span>
<span class="k">except</span> <span class="n">ModuleNotFoundError</span><span class="p">:</span>
    <span class="k">raise</span> <span class="n">ModuleNotFoundError</span><span class="p">(</span><span class="s2">&quot;This module requires numdifftools and autograd &quot;</span>
                              <span class="s2">&quot;for numerical and automatic differenciation. &quot;</span>
                              <span class="s2">&quot;The packages are available on the Python package&quot;</span>
                              <span class="s2">&quot;index.&quot;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.ci_rvm</span> <span class="kn">import</span> <span class="n">find_profile_CI_bound</span><span class="p">,</span> <span class="n">CounterFun</span>
    <span class="kn">from</span> <span class="nn">.ci_rvm_mpinv</span> <span class="kn">import</span> <span class="n">find_profile_CI_bound</span> <span class="k">as</span> <span class="n">find_profile_CI_bound_mpinv</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ci_rvm.ci_rvm</span> <span class="kn">import</span> <span class="n">find_profile_CI_bound</span><span class="p">,</span> <span class="n">CounterFun</span>
        <span class="kn">from</span> <span class="nn">ci_rvm.ci_rvm_mpinv</span> <span class="kn">import</span> <span class="n">find_profile_CI_bound</span> <span class="k">as</span> <span class="n">find_profile_CI_bound_mpinv</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">ci_rvm</span> <span class="kn">import</span> <span class="n">find_profile_CI_bound</span><span class="p">,</span> <span class="n">CounterFun</span>
        <span class="kn">from</span> <span class="nn">ci_rvm_mpinv</span> <span class="kn">import</span> <span class="n">find_profile_CI_bound</span> <span class="k">as</span> <span class="n">find_profile_CI_bound_mpinv</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># if vemomoto_core_tools is installed, you can call the module with an </span>
    <span class="c1"># argument specifying a log file to which the output is written in addition</span>
    <span class="c1"># to the console.</span>
    <span class="kn">from</span> <span class="nn">vemomoto_core.tools.tee</span> <span class="kn">import</span> <span class="n">Tee</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">teeObject</span> <span class="o">=</span> <span class="n">Tee</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="k">except</span> <span class="n">ModuleNotFoundError</span><span class="p">:</span>
    <span class="k">pass</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>

<span class="n">CONVERT</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">ALPHA</span> <span class="o">=</span> <span class="mf">0.95</span>
<div class="viewcode-block" id="convertPos"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.convertPos">[docs]</a><span class="k">def</span> <span class="nf">convertPos</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="n">CONVERT</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">convert</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">cons</span> <span class="o">=</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="mi">50</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cons</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">res</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">res2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">res2</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">res2</span>
    <span class="n">x</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
    <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="convertPos_"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.convertPos_">[docs]</a><span class="k">def</span> <span class="nf">convertPos_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="n">CONVERT</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">convert</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="convertPosInv"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.convertPosInv">[docs]</a><span class="k">def</span> <span class="nf">convertPosInv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="n">CONVERT</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">convert</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">cons</span> <span class="o">=</span> <span class="n">res</span> <span class="o">&gt;</span> <span class="mi">50</span>
    <span class="n">res2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">res</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">cons</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">res2</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="p">[</span><span class="n">cons</span><span class="p">]</span>
    <span class="n">res2</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">res2</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000</span>
    <span class="n">x</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span> <span class="o">=</span> <span class="n">res2</span>
    <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="convertPosInv_"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.convertPosInv_">[docs]</a><span class="k">def</span> <span class="nf">convertPosInv_</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">convert</span><span class="o">=</span><span class="n">CONVERT</span><span class="p">):</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">convert</span> <span class="ow">or</span> <span class="n">x</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">x</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">res</span><span class="p">):</span>
        <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10000</span>
    <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="TrackFun"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.TrackFun">[docs]</a><span class="k">class</span> <span class="nc">TrackFun</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="venzon_moolgavkar"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.venzon_moolgavkar">[docs]</a><span class="k">def</span> <span class="nf">venzon_moolgavkar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> 
                      <span class="n">fun0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hess0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">track_x</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="k">if</span> <span class="n">fun0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">target</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">diff</span>
    
    <span class="n">step_scale</span> <span class="o">=</span> <span class="n">direction</span>
    
    <span class="n">x_track</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># TODO: handle singular matrices (check determinant, return NaN), extend algorithm to be more robust</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>    
        <span class="c1"># preparation</span>
        
        <span class="k">if</span> <span class="n">fun0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">target_diff</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">target</span>
        <span class="k">if</span> <span class="n">hess0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dl2_dx2_0</span> <span class="o">=</span> <span class="n">hess</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dl2_dx2_0</span> <span class="o">=</span> <span class="n">hess0</span>
        
        <span class="n">considered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">considered</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">hessConsidered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">considered</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>
        
        <span class="c1"># test</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> 
                           <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">])))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="p">))</span>
                           
        <span class="c1"># x is the parameter vector</span>
        <span class="c1"># w is the vector of nuisance parameters (x without row &quot;index&quot;)</span>
        <span class="c1"># b is the parameter of interest, which is x[index]</span>
        <span class="c1"># l is fun</span>
        <span class="c1"># dl_d* is the derivative of l w.r.t. *</span>
        <span class="c1"># dl2_d*2 is the second derivative of l w.r.t. *</span>
        
        <span class="c1"># choosing the first step x1</span>
        
        <span class="n">dl2_dw2</span> <span class="o">=</span> <span class="n">dl2_dx2_0</span><span class="p">[</span><span class="n">hessConsidered</span><span class="p">]</span>
        
        <span class="n">dl2_dbdw</span> <span class="o">=</span> <span class="n">dl2_dx2_0</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">considered</span><span class="p">]</span>
        <span class="n">dl2_dw2_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">dl2_dw2</span><span class="p">)</span>
        <span class="n">dw_db</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dl2_dw2_inv</span><span class="p">,</span> <span class="n">dl2_dbdw</span><span class="p">)</span>
        
        <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">target_diff</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">dl2_dx2_0</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dl2_dbdw</span><span class="p">,</span> <span class="n">dl2_dw2_inv</span><span class="p">),</span> <span class="n">dl2_dbdw</span><span class="p">))))</span>
                                               <span class="o">*</span> <span class="n">step_scale</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">factor</span><span class="p">):</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="c1">#raise np.linalg.LinAlgError()</span>
        
        <span class="n">init_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">init_direction</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span> <span class="o">=</span> <span class="n">dw_db</span>
        <span class="n">init_direction</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">factor</span><span class="o">*</span><span class="n">init_direction</span>
        
        
        <span class="c1"># iteration</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmax</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">track_x</span><span class="p">:</span>
                <span class="n">x_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">dl_dx_</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">violation</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dl_dx_</span><span class="p">[</span><span class="n">considered</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">target</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
                <span class="c1">#print(x)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iteration </span><span class="si">{}</span><span class="s2">: fun_diff=</span><span class="si">{}</span><span class="s2">; jac_violation=</span><span class="si">{}</span><span class="s2">; direction=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="o">-</span><span class="n">target</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dl_dx_</span><span class="p">[</span><span class="n">considered</span><span class="p">])),</span> <span class="n">step_scale</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">violation</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">violation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">()</span>
            
            <span class="n">D</span> <span class="o">=</span> <span class="n">dl2_dx2</span> <span class="o">=</span> <span class="n">hess</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">dl2_dx2_</span> <span class="o">=</span> <span class="n">dl2_dx2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">dl2_dx2_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">dl_dx_</span>
            <span class="n">dl_dx_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">-</span><span class="n">target</span> 
            
            <span class="n">dl2_dx2__inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">dl2_dx2_</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">dl2_dx2__inv</span><span class="p">[:,</span><span class="n">index</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dl2_dx2__inv</span><span class="p">,</span> <span class="n">dl_dx_</span><span class="p">)</span>
            
            <span class="n">Dg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="n">vDg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Dg</span><span class="p">)</span>
            <span class="n">gDg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">Dg</span><span class="p">)</span>
            <span class="n">vDv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">D</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
            
            <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">vDg</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">gDg</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">vDv</span> <span class="o">/</span> <span class="n">gDg</span>
            
            <span class="n">_s</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="mi">4</span> <span class="o">-</span> <span class="n">q</span>
            
            <span class="k">if</span> <span class="n">_s</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_s</span><span class="p">)</span>
                <span class="n">s_</span> <span class="o">=</span> <span class="o">-</span> <span class="n">p</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">s_1</span> <span class="o">=</span> <span class="n">s_</span> <span class="o">+</span> <span class="n">_s</span>
                <span class="n">s_2</span> <span class="o">=</span> <span class="n">s_</span> <span class="o">-</span> <span class="n">_s</span>
                
                <span class="n">v_sg_1</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">s_1</span><span class="o">*</span><span class="n">g</span>
                <span class="n">v_sg_2</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">s_2</span><span class="o">*</span><span class="n">g</span>
                <span class="n">measure1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v_sg_1</span><span class="p">,</span> <span class="n">dl2_dx2_0</span><span class="p">),</span> <span class="n">v_sg_1</span><span class="p">))</span>
                <span class="n">measure2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v_sg_2</span><span class="p">,</span> <span class="n">dl2_dx2_0</span><span class="p">),</span> <span class="n">v_sg_2</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="n">measure1</span> <span class="o">&lt;</span> <span class="n">measure2</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">-=</span> <span class="n">v_sg_1</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">x</span> <span class="o">-=</span> <span class="n">v_sg_2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: do line search here! </span>
                <span class="n">x</span> <span class="o">-=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">dl_dx_</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">violation</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dl_dx_</span><span class="p">[</span><span class="n">considered</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">target</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> 
                                     <span class="n">fun</span><span class="o">=</span><span class="n">l</span><span class="p">,</span>
                                     <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">,</span>
                                     <span class="n">violation</span><span class="o">=</span><span class="n">violation</span><span class="p">,</span>
                                     <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">nfev</span><span class="o">=</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span> 
                                     <span class="n">nit</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span>
                                     <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_track</span><span class="p">),</span>
                                     <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Iteration limit exceeded&quot;</span>
                                     <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> 
                                 <span class="n">fun</span><span class="o">=</span><span class="n">l</span><span class="p">,</span>
                                 <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                 <span class="n">violation</span><span class="o">=</span><span class="n">violation</span><span class="p">,</span>
                                 <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">nfev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> 
                                 <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                 <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_track</span><span class="p">),</span>
                                 <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Success&quot;</span>
                                 <span class="p">)</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
                                 <span class="n">fun</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                 <span class="n">jac</span><span class="o">=</span><span class="n">x0</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                 <span class="n">violation</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                 <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="n">nfev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> 
                                 <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                 <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_track</span><span class="p">),</span>
                                 <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Ill-conditioned matrix&quot;</span>
                                 <span class="p">)</span></div>

<div class="viewcode-block" id="wald"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.wald">[docs]</a><span class="k">def</span> <span class="nf">wald</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">[</span><span class="kc">None</span><span class="p">]:</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">hinv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">hess</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;H is singular&quot;</span>
            <span class="k">break</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">hinv</span><span class="p">)</span> <span class="o">*</span> <span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;H is not negative definite&quot;</span>
            <span class="k">break</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
        
    <span class="n">success</span> <span class="o">=</span> <span class="n">message</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">direction</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">-</span><span class="n">diff</span><span class="p">,</span> <span class="n">x</span><span class="o">+</span><span class="n">diff</span>
    <span class="k">elif</span> <span class="n">direction</span><span class="o">==</span><span class="mi">1</span><span class="p">:</span> 
        <span class="n">res</span> <span class="o">=</span> <span class="n">x</span><span class="o">+</span><span class="n">diff</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">res</span> <span class="o">=</span> <span class="n">x</span><span class="o">-</span><span class="n">diff</span>
    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">res</span><span class="p">,</span> 
                             <span class="n">fun</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> 
                             <span class="n">nfev</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">x_track</span><span class="o">=</span><span class="p">[],</span>
                             <span class="n">f_track</span><span class="o">=</span><span class="p">[],</span>
                             <span class="n">message</span><span class="o">=</span><span class="n">message</span>
                             <span class="p">)</span></div>


<div class="viewcode-block" id="root"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.root">[docs]</a><span class="k">def</span> <span class="nf">root</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;df-sane&quot;</span><span class="p">):</span> <span class="c1">#method=&#39;df-sane&#39;):</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">def</span> <span class="nf">PL</span><span class="p">(</span><span class="n">xi</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x2</span>
        <span class="n">fun_nuiscance</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">xx</span><span class="p">:</span> <span class="o">-</span><span class="n">fun</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">fun_nuiscance</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">x</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">xi</span><span class="p">,</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span><span class="o">-</span><span class="n">target</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span><span class="o">-</span><span class="n">target</span>
    <span class="n">fullres</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">root</span><span class="p">(</span><span class="n">PL</span><span class="p">,</span> <span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">method</span><span class="o">=</span><span class="n">method</span><span class="p">)</span>
    <span class="n">fullres</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">fullres</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span></div>

<div class="viewcode-block" id="binsearch"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.binsearch">[docs]</a><span class="k">def</span> <span class="nf">binsearch</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">initstep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
              <span class="n">resulttol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">infstep</span><span class="o">=</span><span class="mf">1e10</span><span class="p">,</span> <span class="n">stepn</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">checkNo</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>
        <span class="n">jac_nuiscance</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">jac</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="p">)),</span> <span class="n">index</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">jac_nuiscance</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="n">xi</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">direction</span><span class="o">*</span><span class="n">initstep</span>
    <span class="n">xi0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">fun_nuiscance</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">fun</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
    <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">xi_above</span> <span class="o">=</span> <span class="n">xi0</span>
    <span class="n">xi_below</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span>
    <span class="n">f_trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">fun0</span><span class="p">]</span>
    <span class="n">x_trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">]</span>
    <span class="n">checkit</span> <span class="o">=</span> <span class="n">checkNo</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stepn</span><span class="p">):</span>
        <span class="n">opres</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">fun_nuiscance</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">jac_nuiscance</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="n">opres</span><span class="o">.</span><span class="n">fun</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: x_</span><span class="si">{}</span><span class="s2">_d=</span><span class="si">{:6.3f}</span><span class="s2">, f_d=</span><span class="si">{:6.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="o">-</span><span class="n">xi0</span><span class="p">,</span> <span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="n">f_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">x_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">opres</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">checkit</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">checkit</span> <span class="o">=</span> <span class="n">checkNo</span>
            <span class="n">xi_below</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">xi_below</span> <span class="o">=</span> <span class="n">xi</span>
            <span class="n">checkit</span> <span class="o">=</span> <span class="n">checkNo</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xi_above</span> <span class="o">=</span> <span class="n">xi</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">opres</span><span class="o">.</span><span class="n">x</span>
            <span class="n">checkit</span> <span class="o">-=</span> <span class="mi">1</span>
            
        <span class="k">if</span> <span class="n">xi_below</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">xi_above</span><span class="p">,</span> <span class="n">xi_below</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">resulttol</span><span class="p">):</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="k">if</span> <span class="n">checkit</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="n">xi_below</span>
                <span class="n">checkit</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi_above</span><span class="o">+</span><span class="n">xi_below</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">xi0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">infstep</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;unbounded&quot;</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
            <span class="n">initstep</span> <span class="o">*=</span> <span class="mi">10</span>
            <span class="n">xi</span> <span class="o">+=</span> <span class="n">direction</span><span class="o">*</span><span class="n">initstep</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;iteration limit exceeded&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="p">),</span> 
                             <span class="n">fun</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                             <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> 
                             <span class="n">nfev</span><span class="o">=</span><span class="n">fun</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> 
                             <span class="n">njev</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jac</span><span class="o">.</span><span class="n">evals</span><span class="p">),</span> 
                             <span class="n">nhev</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                             <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_trace</span><span class="p">),</span>
                             <span class="n">f_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_trace</span><span class="p">),</span>
                             <span class="n">message</span><span class="o">=</span><span class="n">message</span>
                             <span class="p">)</span>
    <span class="c1">#print(result)</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="gridsearch"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.gridsearch">[docs]</a><span class="k">def</span> <span class="nf">gridsearch</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span>
               <span class="n">resulttol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">stepn</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">infstep</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    
    <span class="n">f</span> <span class="o">=</span> <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    
    <span class="n">fun</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">xi0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    
    <span class="n">dim</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">size</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">dok_matrix</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
    <span class="n">A</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">target_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">fun</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">target_fun</span><span class="p">(</span><span class="n">p</span><span class="p">):</span> 
        <span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">fun</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="c1">#print(res+target, p[index]-xi) #, np.round(p,2)</span>
        <span class="k">return</span> <span class="n">res</span>
    <span class="n">target_jac</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">jac</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="n">target_hess</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">hess</span><span class="p">(</span><span class="n">p</span><span class="p">))</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">bound0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="n">bound1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stepn</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="n">stepn</span><span class="p">:</span>
            <span class="n">x_prev</span> <span class="o">=</span> <span class="n">x</span>
            <span class="n">f_prev</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">xi</span> <span class="o">+=</span> <span class="n">direction</span><span class="o">*</span><span class="n">infstep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">xi</span> <span class="o">+=</span> <span class="n">direction</span><span class="o">*</span><span class="n">step</span>
        <span class="c1">#bounds = (-np.inf, xi) if direction &lt; 0 else (xi, np.inf)</span>
        <span class="n">bound0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">bound1</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">xi</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">bound0</span><span class="p">,</span> <span class="n">bound1</span><span class="p">)</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">LinearConstraint</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="o">*</span><span class="n">bounds</span><span class="p">)</span> 
        <span class="n">res</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">target_fun</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">target_jac</span><span class="p">,</span> <span class="n">hess</span><span class="o">=</span><span class="n">target_hess</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                             <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">500</span><span class="p">),</span> <span class="n">tol</span><span class="o">=</span><span class="n">resulttol</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;trust-constr&quot;</span><span class="p">)</span> <span class="c1">#, gtol=resulttol</span>
        <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">fun</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: x_</span><span class="si">{}</span><span class="s2">_d=</span><span class="si">{:6.3f}</span><span class="s2">, f_d=</span><span class="si">{:6.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="o">-</span><span class="n">xi0</span><span class="p">,</span> <span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;=</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">&gt;</span> <span class="n">resulttol</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">-=</span> <span class="n">direction</span><span class="o">*</span><span class="n">step</span>
                <span class="n">step</span> <span class="o">/=</span> <span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Success&quot;</span>
                <span class="c1">#xi -= direction*step/2</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;iteration limit exceeded&quot;</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_prev</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f_prev</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Result is unbounded&quot;</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> 
                             <span class="n">fun</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                             <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> 
                             <span class="n">nfev</span><span class="o">=</span><span class="n">fun</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> 
                             <span class="n">njev</span><span class="o">=</span><span class="n">target_jac</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> 
                             <span class="n">nhev</span><span class="o">=</span><span class="n">target_hess</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span>
                             <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                             <span class="n">message</span><span class="o">=</span><span class="n">message</span>
                             <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>
    

<div class="viewcode-block" id="bisection"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.bisection">[docs]</a><span class="k">def</span> <span class="nf">bisection</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun_</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">initstep</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
              <span class="n">resulttol</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">constrainedMin</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">infstep</span><span class="o">=</span><span class="mf">1e10</span><span class="p">,</span> <span class="n">stepn</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">fun_</span><span class="p">)</span>
    <span class="n">xi</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="n">direction</span><span class="o">*</span><span class="n">initstep</span>
    <span class="n">xi0</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    
    <span class="n">jac_nuiscance</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">constrainedMin</span><span class="p">:</span>
        <span class="n">fun_nuiscance</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>
            <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            <span class="c1">#def jac_nuiscance(x):</span>
            <span class="c1">#    print(x)</span>
            <span class="c1">#    jj = -jac(x)</span>
            <span class="c1">#    return jj</span>
            <span class="c1">#jac_nuiscance = CounterFun(jac_nuiscance)</span>
            <span class="n">jac_nuiscance</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-</span><span class="n">xi</span><span class="p">,</span> 
                           <span class="n">jac</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">unit</span><span class="p">)</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">size</span>
        <span class="n">A</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">dok_matrix</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="n">dim</span><span class="p">))</span>
        <span class="n">A</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">fun_nuiscance</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">fun</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jac</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>
            <span class="n">jac_nuiscance</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">jac</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="p">)),</span> <span class="n">index</span><span class="p">)</span>
    
    <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">f_above</span> <span class="o">=</span> <span class="n">fun0</span>
    <span class="n">xi_above</span> <span class="o">=</span> <span class="n">xi0</span>
    <span class="n">f_below</span> <span class="o">=</span> <span class="kc">None</span> 
    <span class="n">xi_below</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">f_trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">fun0</span><span class="p">]</span>
    <span class="n">xi_trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">xi0</span><span class="p">]</span>
    <span class="n">x_trace_full</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">constrainedMin</span><span class="p">:</span>
        <span class="n">x_trace</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">index</span><span class="p">)]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x_trace</span> <span class="o">=</span> <span class="n">x_trace_full</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">stepn</span><span class="p">):</span>
        <span class="c1">#if constrainedMin:</span>
        <span class="c1">#    bounds = (-np.inf, xi) if direction &lt; 0 else (xi, np.inf)</span>
        <span class="c1">#    constraints = op.LinearConstraint(A, *bounds) </span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x_trace</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xi_trace</span><span class="p">)))]</span>
        <span class="n">x</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span> <span class="o">=</span> <span class="n">x_trace</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">x</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">20</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">opres</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">fun_nuiscance</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">jac_nuiscance</span><span class="p">,</span> 
                                    <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">opres</span><span class="o">.</span><span class="n">fun</span><span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span> <span class="o">+</span> <span class="n">xi_above</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Error in function or jacobian&quot;</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">break</span>
            
        <span class="n">x_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">opres</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">constrainedMin</span><span class="p">:</span>
            <span class="n">x_trace_full</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">opres</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="o">-</span><span class="n">opres</span><span class="o">.</span><span class="n">fun</span>
        <span class="n">f_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">xi_trace</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xi</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{}</span><span class="s2">: x_</span><span class="si">{}</span><span class="s2">_d=</span><span class="si">{:6.3f}</span><span class="s2">, f_d=</span><span class="si">{:6.3f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">xi</span><span class="o">-</span><span class="n">xi0</span><span class="p">,</span> <span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Nan&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">xi_below</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">resulttol</span><span class="p">)</span> <span class="ow">or</span>
            <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">xi_above</span><span class="p">,</span> <span class="n">xi_below</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">resulttol</span><span class="p">))):</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
        <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">xi0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">infstep</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
            <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;unbounded&quot;</span>
            <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">break</span>
        <span class="n">two_point</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_trace</span><span class="p">)</span><span class="o">&gt;</span><span class="n">target</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">f_below</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">f_below</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f_below</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">f_below</span><span class="p">:</span>
                    <span class="n">f_above</span> <span class="o">=</span> <span class="n">f_below</span>
                    <span class="n">xi_above</span> <span class="o">=</span> <span class="n">xi_below</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">two_point</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">f_below</span> <span class="o">=</span> <span class="n">f</span>
                <span class="n">xi_below</span> <span class="o">=</span> <span class="n">xi</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">f_above</span> <span class="o">=</span> <span class="n">f</span>
                <span class="n">xi_above</span> <span class="o">=</span> <span class="n">xi</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f_below</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">f_below</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                <span class="n">f_above</span> <span class="o">=</span> <span class="n">f_below</span>
                <span class="n">xi_above</span> <span class="o">=</span> <span class="n">xi_below</span>
            <span class="n">f_below</span> <span class="o">=</span> <span class="n">f</span>
            <span class="n">xi_below</span> <span class="o">=</span> <span class="n">xi</span>
            
        <span class="k">if</span> <span class="n">two_point</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">fun0</span><span class="o">-</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">xi0</span><span class="o">-</span><span class="n">xi</span><span class="o">-</span><span class="mf">0.5</span><span class="o">/</span><span class="n">xi0</span><span class="o">*</span><span class="p">(</span><span class="n">xi0</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="n">xi</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">p</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">xi0</span><span class="p">)</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="n">xi0</span><span class="p">)</span><span class="o">-</span><span class="n">a</span><span class="o">*</span><span class="n">xi0</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">xi0</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">xi0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                          <span class="p">[</span><span class="n">xi_above</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">xi_above</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                          <span class="p">[</span><span class="n">xi_below</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">xi_below</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">m</span><span class="p">),</span> <span class="p">[</span><span class="n">fun0</span><span class="p">,</span> <span class="n">f_above</span><span class="p">,</span> <span class="n">f_below</span><span class="p">])</span>
        
            
        <span class="n">root</span> <span class="o">=</span> <span class="n">p</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">q</span><span class="o">-</span><span class="n">target</span><span class="p">)</span><span class="o">/</span><span class="n">a</span>
        <span class="k">if</span> <span class="n">root</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">initstep</span> <span class="o">*=</span> <span class="mi">10</span>
            <span class="n">xi</span> <span class="o">+=</span> <span class="n">direction</span><span class="o">*</span><span class="n">initstep</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dirFact</span> <span class="o">=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">a</span><span class="o">&lt;</span><span class="mi">0</span> <span class="k">else</span> <span class="o">-</span><span class="mi">1</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="o">-</span><span class="n">p</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">dirFact</span> <span class="o">*</span> <span class="n">direction</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">root</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">xi0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">infstep</span><span class="p">:</span>
                <span class="n">xi</span> <span class="o">=</span> <span class="n">direction</span><span class="o">*</span><span class="n">infstep</span><span class="o">*</span><span class="mf">1.1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;iteration limit exceeded&quot;</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x_trace_full</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                             <span class="n">fun</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                             <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> 
                             <span class="n">nfev</span><span class="o">=</span><span class="n">fun</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> 
                             <span class="n">njev</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">jac</span><span class="o">.</span><span class="n">evals</span><span class="p">),</span> 
                             <span class="n">nhev</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                             <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_trace_full</span><span class="p">),</span>
                             <span class="n">f_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_trace</span><span class="p">),</span>
                             <span class="n">message</span><span class="o">=</span><span class="n">message</span>
                             <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="constrained_max"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.constrained_max">[docs]</a><span class="k">def</span> <span class="nf">constrained_max</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">nit</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
    <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
    
    <span class="n">target</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">preconditioning</span> <span class="o">=</span> <span class="mf">0.001</span>
    <span class="n">target_fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">direction</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">unit</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">*</span><span class="n">direction</span>
    <span class="n">target_jac</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">unit</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">type</span><span class="o">=</span><span class="s2">&quot;eq&quot;</span><span class="p">,</span> <span class="n">fun</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">target</span><span class="p">)</span><span class="o">*</span><span class="n">preconditioning</span><span class="p">,</span> 
                       <span class="n">jac</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="n">preconditioning</span><span class="p">)</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">target_fun</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">target_jac</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">,</span>
                             <span class="n">options</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">maxiter</span><span class="o">=</span><span class="mi">500</span><span class="p">))</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">fun</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                 <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span>
                                 <span class="n">nit</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>
    
    
<div class="viewcode-block" id="mixed_min"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.mixed_min">[docs]</a><span class="k">def</span> <span class="nf">mixed_min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">):</span>
    
    <span class="n">preconditioning</span> <span class="o">=</span> <span class="mf">0.01</span>
    <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">-</span> <span class="n">direction</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">])</span><span class="o">*</span><span class="n">preconditioning</span>
    
    
    <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">unit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">j</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">-</span> <span class="n">direction</span><span class="o">*</span><span class="n">unit</span><span class="p">)</span><span class="o">*</span><span class="n">preconditioning</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">j</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="c1">#j = Gradient(f, step=1e-7)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">j</span><span class="p">)</span> <span class="c1">#, method=&#39;trust-exact&#39;)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;index </span><span class="si">{:2d}</span><span class="s2">: f_diff=</span><span class="si">{:7.3f}</span><span class="s2"> (direction </span><span class="si">{}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">fun</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">target</span><span class="p">,</span> <span class="n">direction</span><span class="p">))</span>
    <span class="n">result</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="c1">#print(result)</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="fixedFun"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.fixedFun">[docs]</a><span class="k">def</span> <span class="nf">fixedFun</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">origArg</span><span class="p">,</span> <span class="n">flex</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">fun</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">xx</span> <span class="o">=</span> <span class="n">origArg</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">xx</span><span class="p">[</span><span class="n">flex</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
        
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">CounterFun</span><span class="p">):</span>
        <span class="n">fun</span><span class="o">.</span><span class="n">evals</span> <span class="o">=</span> <span class="k">lambda</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">evals</span>
    <span class="k">return</span> <span class="n">fun</span></div>

<div class="viewcode-block" id="BaseTester"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.BaseTester">[docs]</a><span class="k">class</span> <span class="nc">BaseTester</span><span class="p">():</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ML</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MLE</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataN</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convertIndices</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">test_prediction</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">MLE</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MLE</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_MLE</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">)</span>
        
    <span class="nd">@MLE</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">MLE</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_MLE</span> <span class="o">=</span> <span class="n">val</span>
        
<div class="viewcode-block" id="BaseTester.convertPos"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.BaseTester.convertPos">[docs]</a>    <span class="k">def</span> <span class="nf">convertPos</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">convertPos</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertIndices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">)</span> </div>
<div class="viewcode-block" id="BaseTester.convertPosInv"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.BaseTester.convertPosInv">[docs]</a>    <span class="k">def</span> <span class="nf">convertPosInv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">convertPosInv</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertIndices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert</span><span class="p">)</span> </div>
    
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">funs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_funs</span><span class="p">()</span>
        
<div class="viewcode-block" id="BaseTester.get_funs"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.BaseTester.get_funs">[docs]</a>    <span class="k">def</span> <span class="nf">get_funs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;get_funs has not been implemented yet&quot;</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="DynamicalSystemTester"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.DynamicalSystemTester">[docs]</a><span class="k">class</span> <span class="nc">DynamicalSystemTester</span><span class="p">(</span><span class="n">BaseTester</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">sim_args</span><span class="p">,</span> <span class="o">**</span><span class="n">sim_kwargs</span><span class="p">):</span>
        
        <span class="n">BaseTester</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">convert</span> <span class="o">=</span> <span class="n">CONVERT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">8</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="o">*</span><span class="n">sim_args</span><span class="p">,</span> <span class="o">**</span><span class="n">sim_kwargs</span><span class="p">)</span>
    
<div class="viewcode-block" id="DynamicalSystemTester.rss_dyn"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.DynamicalSystemTester.rss_dyn">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">rss_dyn</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dim</span><span class="p">):</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">ff</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">dim</span><span class="p">:])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span>
                    <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">),</span> <span class="n">p</span><span class="p">[:</span><span class="n">dim</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">1000000</span>
            <span class="c1">#print(res)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">ff</span></div>
    
<div class="viewcode-block" id="DynamicalSystemTester.f_constr"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.DynamicalSystemTester.f_constr">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">f_constr</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">fact</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">tol</span><span class="p">):</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">ff</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">f</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">[</span><span class="n">dim</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sol</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">),</span> <span class="n">p</span><span class="p">[:</span><span class="n">dim</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">fact</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">tt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">tol</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">target</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">res</span> <span class="o">=</span> <span class="mi">1000000</span>
            <span class="c1">#print(res)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">ff</span></div>
    
<div class="viewcode-block" id="DynamicalSystemTester.f_prime"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.DynamicalSystemTester.f_prime">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">f_prime</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">r</span><span class="p">,</span> <span class="n">K</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">conversion</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">h</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">r</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="o">/</span><span class="n">K</span><span class="p">)</span> <span class="o">-</span> <span class="n">conversion</span><span class="p">,</span> 
                         <span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">conversion</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">d</span><span class="p">)))</span></div>
    
<div class="viewcode-block" id="DynamicalSystemTester.get_rss"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.DynamicalSystemTester.get_rss">[docs]</a>    <span class="k">def</span> <span class="nf">get_rss</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rss_</span> <span class="o">=</span> <span class="n">DynamicalSystemTester</span><span class="o">.</span><span class="n">rss_dyn</span><span class="p">(</span><span class="n">DynamicalSystemTester</span><span class="o">.</span><span class="n">f_prime</span><span class="p">,</span> <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">rss_</span><span class="p">(</span><span class="n">convertPos</span><span class="p">(</span><span class="n">p</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="DynamicalSystemTester.get_funs"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.DynamicalSystemTester.get_funs">[docs]</a>    <span class="k">def</span> <span class="nf">get_funs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rss</span><span class="p">()</span>  
        <span class="n">fact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fact</span>
        <span class="n">f_</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fact</span><span class="o">*</span><span class="n">rss</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">MLE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MLE</span>
            <span class="n">flex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">MLE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">flex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">f_</span> <span class="o">=</span> <span class="n">fixedFun</span><span class="p">(</span><span class="n">f_</span><span class="p">,</span> <span class="n">MLE</span><span class="p">,</span> <span class="n">flex</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">f_</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Gradient</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">Hessian</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span></div>
    
<div class="viewcode-block" id="DynamicalSystemTester.get_funs_constr"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.DynamicalSystemTester.get_funs_constr">[docs]</a>    <span class="k">def</span> <span class="nf">get_funs_constr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">varMLE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ML</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataN</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">fact</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">/</span><span class="n">varMLE</span>
        <span class="n">dim</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">DynamicalSystemTester</span><span class="o">.</span><span class="n">f_constr</span><span class="p">(</span><span class="n">DynamicalSystemTester</span><span class="o">.</span><span class="n">f_prime</span><span class="p">,</span> 
                                           <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">dim</span><span class="p">,</span> <span class="n">fact</span><span class="p">,</span> 
                                           <span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="o">.</span><span class="mi">95</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mf">1e-3</span><span class="p">)</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Gradient</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">Hessian</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1e-8</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">tmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">MLE</span>
        <span class="n">sol</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="n">DynamicalSystemTester</span><span class="o">.</span><span class="n">f_prime</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">),</span> <span class="n">p</span><span class="p">[:</span><span class="n">dim</span><span class="p">],</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-9</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="mf">1e-11</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tmax</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cMLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">MLE</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sol</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">tt</span><span class="p">)[</span><span class="mi">0</span><span class="p">]))</span>
        
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span></div>
        
        
<div class="viewcode-block" id="DynamicalSystemTester.simulate"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.DynamicalSystemTester.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataN</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">tEnd</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">std</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">plot</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
            
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;simulating data&quot;</span><span class="p">)</span>
        
        <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tEnd</span><span class="p">,</span> <span class="n">dataN</span><span class="p">)</span>
        <span class="n">paramsFull</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">x0</span><span class="p">,</span> <span class="n">params</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_prime</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">),</span> 
                                  <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tEnd</span><span class="p">),</span> <span class="n">x0</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                  <span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span><span class="o">*</span><span class="n">std</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="n">x</span><span class="p">]</span>
        <span class="c1">#print(x[:,-1])</span>
        <span class="n">rss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_rss</span><span class="p">()</span>   
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;creating likelihood function&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">rsss</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="c1">#print(convertPos(p))</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">rss</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">convertPosInv</span><span class="p">(</span><span class="n">paramsFull</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="n">rss</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">))</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">Gradient</span><span class="p">(</span><span class="n">rss</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">)</span> <span class="c1">#Gradient(rss, 1e-6, num_steps=4)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">Hessian</span><span class="p">(</span><span class="n">rss</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">rsss</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">g</span><span class="p">,</span> <span class="n">hess</span><span class="o">=</span><span class="n">h</span><span class="p">)</span> <span class="c1">#, options=dict(maxiter=1))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
        <span class="n">xMLE</span><span class="p">,</span> <span class="n">paramsMLE</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="mi">2</span><span class="p">],</span> <span class="n">fit</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">:]</span>
        
        <span class="n">varMLE</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">fun</span> <span class="o">/</span> <span class="n">dataN</span><span class="o">**</span><span class="mi">2</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fact</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">/</span><span class="n">varMLE</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ML</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">fun</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MLE</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">paramsFull</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dataN</span> <span class="o">=</span> <span class="n">dataN</span>
        <span class="k">if</span> <span class="n">plot</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;plotting&quot;</span><span class="p">)</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tEnd</span><span class="p">,</span> <span class="n">tEnd</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">resHat</span> <span class="o">=</span> <span class="n">integrate</span><span class="o">.</span><span class="n">solve_ivp</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">f_prime</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="n">convertPos</span><span class="p">(</span><span class="n">paramsMLE</span><span class="p">)),</span> 
                                         <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">tEnd</span><span class="p">),</span> <span class="n">convertPos</span><span class="p">(</span><span class="n">xMLE</span><span class="p">),</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                         <span class="n">vectorized</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">tt</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">resHat</span><span class="o">.</span><span class="n">sol</span><span class="p">(</span><span class="n">tt</span><span class="p">):</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tt</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div></div>
        
        
<div class="viewcode-block" id="LogRegressTester"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.LogRegressTester">[docs]</a><span class="k">class</span> <span class="nc">LogRegressTester</span><span class="p">(</span><span class="n">BaseTester</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">sim_args</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">sim_kwargs</span><span class="p">):</span>
        <span class="n">BaseTester</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">simulate</span><span class="p">(</span><span class="o">*</span><span class="n">sim_args</span><span class="p">,</span> <span class="o">**</span><span class="n">sim_kwargs</span><span class="p">)</span>
    
<div class="viewcode-block" id="LogRegressTester.get_funs"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.LogRegressTester.get_funs">[docs]</a>    <span class="k">def</span> <span class="nf">get_funs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">covariates</span><span class="p">,</span> <span class="n">switch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">powers</span><span class="p">:</span>
            <span class="n">covariateN</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">covariateN</span>
            <span class="c1">#f = lambda p: (-ag.sum(ag.log(1+ag.exp(-ag.sum(p[:covariateN]*covariates[switch:]**p[covariateN:-1], 1)-p[-1])))</span>
            <span class="c1">#               -ag.sum(ag.log(1+ag.exp(ag.sum(p[:covariateN]*covariates[:switch]**p[covariateN:-1], 1)+p[-1]))))</span>
            <span class="n">f_</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ag</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="n">ag</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">covariates</span><span class="p">[</span><span class="n">switch</span><span class="p">:],</span><span class="n">p</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
                           <span class="o">-</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ag</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="n">ag</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">covariates</span><span class="p">[:</span><span class="n">switch</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))))</span>
            <span class="k">def</span> <span class="nf">f_</span><span class="p">(</span><span class="n">p</span><span class="p">):</span> 
                <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ag</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="n">ag</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">covariates</span><span class="p">[</span><span class="n">switch</span><span class="p">:],</span><span class="n">p</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
                        <span class="o">-</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ag</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="n">ag</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">covariates</span><span class="p">[:</span><span class="n">switch</span><span class="p">],</span><span class="n">p</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f_</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ag</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">covariates</span><span class="p">[</span><span class="n">switch</span><span class="p">:]</span><span class="o">*</span><span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
                           <span class="o">-</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ag</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">covariates</span><span class="p">[:</span><span class="n">switch</span><span class="p">]</span><span class="o">*</span><span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">+</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))))</span>
        
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_prediction</span><span class="p">:</span>
            <span class="n">testData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">testData</span>
            <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.001</span>
            <span class="n">target</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">f_</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> 
               <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                   <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="n">testData</span><span class="o">**</span><span class="n">p</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                   <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">tol</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">target</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">p</span><span class="p">):</span> 
                <span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span>
                   <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="n">testData</span><span class="o">**</span><span class="n">p</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span>
                   <span class="o">-</span><span class="n">p</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]))))</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">f_</span><span class="p">(</span><span class="n">p</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">diff</span><span class="o">/</span><span class="n">tol</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">target</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
                    <span class="c1">#print(diff)</span>
                    <span class="k">pass</span>
                <span class="k">return</span> <span class="n">res</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">f_</span>
            
        <span class="n">f</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">MLE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MLE</span>
            <span class="n">flex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">MLE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">flex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fixedFun</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">MLE</span><span class="p">,</span> <span class="n">flex</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Gradient</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">Hessian</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1">#g = AgGradient(f)</span>
            <span class="c1">#h = AgHessian(f)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">Gradient</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="n">Hessian</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;complex&#39;</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="mf">1e-7</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span></div>
    
<div class="viewcode-block" id="LogRegressTester.simulate"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.LogRegressTester.simulate">[docs]</a>    <span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataN</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">testDataN</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">powers</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;3&quot;</span><span class="p">):</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;simulating data&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;3&quot;</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;11&quot;</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">elif</span> <span class="n">mode</span><span class="o">==</span><span class="s2">&quot;11cx&quot;</span><span class="p">:</span>
                <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.6</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>
                <span class="n">powers</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">powers</span><span class="p">:</span>
            <span class="n">covariateN</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">covariateN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dataN</span> <span class="o">=</span> <span class="n">dataN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">powers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convert</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">convertIndices</span> <span class="o">=</span> <span class="nb">slice</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">dim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">allDataN</span> <span class="o">=</span> <span class="n">testDataN</span> <span class="o">+</span> <span class="n">dataN</span>
        
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">allDataN</span><span class="p">,</span> <span class="n">covariateN</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">p</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">p2</span> <span class="o">=</span> <span class="mf">0.2</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">covariateN</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">covariates</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">negative_binomial</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">allDataN</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">covariates</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="n">covariates</span><span class="p">[:,</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">p2</span><span class="p">,</span> <span class="n">allDataN</span><span class="p">)</span> <span class="c1">#+ np.random.poisson(0.5, allDataN)</span>
        
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span><span class="o">+</span><span class="mf">1e-16</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">testData</span> <span class="o">=</span> <span class="n">covariates</span><span class="p">[</span><span class="n">dataN</span><span class="p">:]</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span><span class="p">[:</span><span class="n">dataN</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">powers</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="n">covariates</span><span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">covariates</span><span class="o">*</span><span class="n">params</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">powers</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="n">covariates</span><span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="n">covariates</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])),</span><span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">covariateN</span> <span class="o">=</span> <span class="n">covariateN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">powers</span> <span class="o">=</span> <span class="n">powers</span>
        
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        
        <span class="n">switch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">covariates</span><span class="p">,</span> <span class="n">switch</span><span class="p">]</span>
        
        <span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">funs</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">convertPosInv</span><span class="p">(</span><span class="n">params</span><span class="p">)))</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">f</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">jj</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">j</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">hh</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">h</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">convertPosInv</span><span class="p">(</span><span class="n">params</span><span class="p">),</span> <span class="n">jac</span><span class="o">=</span><span class="n">jj</span><span class="p">)</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">fit</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">jj</span><span class="p">,</span> <span class="n">hess</span><span class="o">=</span><span class="n">hh</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trust-exact&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">j</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">test_prediction</span> <span class="o">=</span> <span class="n">testDataN</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">test_prediction</span><span class="p">:</span>
            <span class="n">testP</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">testData</span><span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">testPMLE</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">x</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">testData</span><span class="o">**</span><span class="n">fit</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">fit</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">testP</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MLE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fit</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">testPMLE</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">params</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">MLE</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ML</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit</span><span class="o">.</span><span class="n">fun</span></div>
    
    
<div class="viewcode-block" id="LogRegressTester.simulate_"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.LogRegressTester.simulate_">[docs]</a>    <span class="k">def</span> <span class="nf">simulate_</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">dataN</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">powers</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">params</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">params</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">powers</span><span class="p">:</span>
            <span class="n">covariateN</span> <span class="o">=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">covariateN</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">powers</span><span class="p">:</span>
            <span class="n">params</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">covariateN</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;simulating data&quot;</span><span class="p">)</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">covariateN</span><span class="p">,</span> <span class="n">covariateN</span><span class="p">)</span><span class="o">+</span><span class="mi">10</span>
        <span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">cov</span><span class="p">,</span> <span class="n">cov</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
        
        
        <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">covariateN</span><span class="p">)</span>
        
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">dataN</span><span class="p">)</span><span class="o">/</span><span class="mi">50</span>
        <span class="c1">#covariates[:,1] = covariates[:,0] + np.random.rand(dataN)*0.01</span>
        
        <span class="k">if</span> <span class="n">powers</span><span class="p">:</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="mf">0.01</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">covariates</span><span class="p">)</span>
            <span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">shift</span>
            <span class="n">covariates</span> <span class="o">+=</span> <span class="n">shift</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">params</span><span class="p">[:</span><span class="n">covariateN</span><span class="p">]</span><span class="o">*</span><span class="n">covariates</span><span class="o">**</span><span class="n">params</span><span class="p">[</span><span class="n">covariateN</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">covariates</span><span class="o">*</span><span class="n">params</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">covariateN</span> <span class="o">=</span> <span class="n">covariateN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">powers</span> <span class="o">=</span> <span class="n">powers</span>
        
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">covariates</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        
        <span class="n">switch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">covariates</span><span class="p">,</span> <span class="n">switch</span><span class="p">]</span>
        
        <span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">funs</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="n">f</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">f</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">params</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">j</span><span class="p">(</span><span class="n">params</span><span class="p">))</span>
        <span class="n">fit</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">hess</span><span class="o">=</span><span class="n">h</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;trust-exact&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">fit</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">ML</span> <span class="o">=</span> <span class="o">-</span><span class="n">fit</span><span class="o">.</span><span class="n">fun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">MLE</span> <span class="o">=</span> <span class="n">fit</span><span class="o">.</span><span class="n">x</span></div></div>

<div class="viewcode-block" id="H14Tester"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.H14Tester">[docs]</a><span class="k">class</span> <span class="nc">H14Tester</span><span class="p">(</span><span class="n">BaseTester</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fixed</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vals</span><span class="o">=</span><span class="p">[</span><span class="mi">25</span><span class="p">]):</span>
        <span class="n">BaseTester</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert</span> <span class="o">=</span> <span class="n">CONVERT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dim</span> <span class="o">=</span> <span class="mi">7</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">fixed</span><span class="p">)</span>
        
        <span class="kn">from</span> <span class="nn">rpy2</span> <span class="kn">import</span> <span class="n">robjects</span>
        <span class="n">r_source</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Executing R script&quot;</span><span class="p">)</span>
        <span class="c1">#robjects.r(&#39;setwd(&quot;test_CI/Histone_H1&quot;)&#39;)</span>
        <span class="n">r_source</span><span class="p">(</span><span class="s2">&quot;get_f.R&quot;</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.090083433</span><span class="p">,</span> <span class="mf">0.015029212</span><span class="p">,</span> <span class="mf">0.001207238</span><span class="p">,</span> <span class="mf">0.002303329</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">fixed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x0</span><span class="p">[</span><span class="n">fixed</span><span class="p">]</span> <span class="o">=</span> <span class="n">vals</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">convertPosInv</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span>
        <span class="n">vals</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">fixed</span><span class="p">]</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">fixed</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fixed</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ff</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">convertPos</span><span class="p">(</span><span class="n">x</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1">#rinterface.RRuntimeError:</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="n">fun2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">opres</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">fun2</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;dataN&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">var</span> <span class="o">=</span> <span class="n">opres</span><span class="o">.</span><span class="n">fun</span> <span class="o">/</span> <span class="n">n</span>
        <span class="n">fact</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">/</span><span class="n">var</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constVals</span> <span class="o">=</span> <span class="p">(</span><span class="n">fixed</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">MLE</span> <span class="o">=</span> <span class="n">opres</span><span class="o">.</span><span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ML</span> <span class="o">=</span> <span class="o">-</span><span class="n">fact</span> <span class="o">*</span> <span class="n">opres</span><span class="o">.</span><span class="n">fun</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">fact</span> <span class="o">=</span> <span class="n">fact</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">convertPos</span><span class="p">(</span><span class="n">opres</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">)</span>
        
<div class="viewcode-block" id="H14Tester.get_funs"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.H14Tester.get_funs">[docs]</a>    <span class="k">def</span> <span class="nf">get_funs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        
        <span class="n">fixed</span><span class="p">,</span> <span class="n">vals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constVals</span>
        <span class="kn">from</span> <span class="nn">rpy2</span> <span class="kn">import</span> <span class="n">robjects</span>
        <span class="n">r_source</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;source&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Executing R script&quot;</span><span class="p">)</span>
        <span class="c1">#robjects.r(&#39;setwd(&quot;test_CI/Histone_H1&quot;)&#39;)</span>
        <span class="n">r_source</span><span class="p">(</span><span class="s2">&quot;get_f.R&quot;</span><span class="p">)</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">robjects</span><span class="o">.</span><span class="n">r</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span>
        
        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">fixed</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fixed</span><span class="p">,</span> <span class="n">vals</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">ff</span><span class="p">(</span><span class="n">robjects</span><span class="o">.</span><span class="n">FloatVector</span><span class="p">(</span><span class="n">convertPos</span><span class="p">(</span><span class="n">x</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span> <span class="c1">#rinterface.RRuntimeError:</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        
        <span class="n">fact</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fact</span>
        
        <span class="n">fun</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fact</span><span class="o">*</span><span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">MLE</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_MLE</span>
            <span class="n">flex2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">MLE</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="n">flex2</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">fixed</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">fun</span> <span class="o">=</span> <span class="n">fixedFun</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="n">MLE</span><span class="p">,</span> <span class="n">flex2</span><span class="p">)</span>
        
        <span class="n">j</span> <span class="o">=</span> <span class="n">Gradient</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">Hessian</span><span class="p">(</span><span class="n">fun</span><span class="p">,</span> <span class="mf">1e-5</span><span class="p">,</span> <span class="n">num_steps</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">fun</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span>        </div></div>
        
<div class="viewcode-block" id="find_CI"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.find_CI">[docs]</a><span class="k">def</span> <span class="nf">find_CI</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;RVM&quot;</span><span class="p">,</span> <span class="n">f_track</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Wald&quot;</span><span class="p">:</span>
        <span class="n">tmpPos</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span>
        <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">f_</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">funs</span>
    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Wald&quot;</span><span class="p">:</span>
        <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span> <span class="o">=</span> <span class="n">tmpPos</span> 
    
    <span class="k">if</span> <span class="n">f_track</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">TrackFun</span><span class="p">(</span><span class="n">f_</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="n">f_</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RVM&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">find_profile_CI_bound</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">,</span>
                                         <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">apprxtol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                         <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;RVM_psI&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">find_profile_CI_bound_mpinv</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">,</span>
                                         <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">apprxtol</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                                         <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;VM&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">venzon_moolgavkar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">,</span>
                                         <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
                                         <span class="n">alpha</span><span class="o">=</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;bisection&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">bisection</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;binsearch&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">binsearch</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;gridsearch&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">gridsearch</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;Wald&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">wald</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">,</span> <span class="n">h</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">)),</span> <span class="n">direction</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="mi">0</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;mixed_min&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">mixed_min</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">&quot;constrained_max&quot;</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">constrained_max</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Method </span><span class="si">{}</span><span class="s2"> unknown.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">f_track</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">track</span>
        <span class="k">return</span> <span class="n">res</span><span class="p">,</span> <span class="n">f_</span><span class="o">.</span><span class="n">evals</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
                             <span class="n">fun</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                             <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                             <span class="n">nfev</span><span class="o">=</span><span class="n">f_</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> 
                             <span class="n">njev</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                             <span class="n">nhev</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">nit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                             <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">MLE</span><span class="p">),</span>
                             <span class="n">f_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">ML</span><span class="p">),</span>
                             <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Error when computing the CI.&quot;</span>
                             <span class="p">),</span> <span class="n">f_</span><span class="o">.</span><span class="n">evals</span></div>

<div class="viewcode-block" id="find_CIs"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.find_CIs">[docs]</a><span class="k">def</span> <span class="nf">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;RVM&quot;</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">printCI</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
             <span class="n">multiprocessing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using method&quot;</span><span class="p">,</span> <span class="n">method</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">dim</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
    
    <span class="c1">#results = list(starmap(find_CI, zip(repeat(tester), list(range(4, dim))*2, [1]*dim + [-1]*dim, repeat(method))))</span>
    <span class="n">args</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">tester</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">n</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
    <span class="c1">#args = zip([tester], [10], [1], repeat(method))</span>
    
    
    <span class="k">if</span> <span class="n">multiprocessing</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">find_CI</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">starmap</span><span class="p">(</span><span class="n">find_CI</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
    
    
    <span class="n">results</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
    
    <span class="n">results2</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="n">target</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">ML</span><span class="o">-</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-3</span>
    <span class="k">if</span> <span class="n">printCI</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;============== </span><span class="si">{:&lt;15}</span><span class="s2">================&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">method</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="n">result1</span><span class="p">,</span> <span class="n">feval1</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">result2</span><span class="p">,</span> <span class="n">feval2</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">n</span><span class="p">]</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">result1</span><span class="o">.</span><span class="n">x</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">result2</span><span class="o">.</span><span class="n">x</span><span class="p">)[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">leftOriginal</span> <span class="o">=</span> <span class="n">result1</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="n">rightOriginal</span> <span class="o">=</span> <span class="n">result2</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">printCI</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{:12.3f}{}</span><span class="s2">, </span><span class="si">{:7.3f}</span><span class="s2">, </span><span class="si">{:12.3f}{}</span><span class="s2">], (</span><span class="si">{:4d}</span><span class="s2">, </span><span class="si">{:4d}</span><span class="s2">), (</span><span class="si">{:6d}</span><span class="s2">, </span><span class="si">{:6d}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">left</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">result1</span><span class="o">.</span><span class="n">success</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span><span class="p">,</span>
                <span class="n">tester</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">right</span><span class="p">,</span> 
                <span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">result2</span><span class="o">.</span><span class="n">success</span> <span class="k">else</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">result1</span><span class="o">.</span><span class="n">nit</span><span class="p">,</span> <span class="n">result2</span><span class="o">.</span><span class="n">nit</span><span class="p">,</span>
                <span class="n">feval1</span><span class="p">,</span> <span class="n">feval2</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;RVM&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">result1</span><span class="o">.</span><span class="n">fun</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">-</span><span class="n">tol</span> <span class="ow">or</span> <span class="n">result2</span><span class="o">.</span><span class="n">fun</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">-</span><span class="n">tol</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">result1</span><span class="o">.</span><span class="n">fun</span> <span class="o">-</span><span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="n">tol</span><span class="p">),</span> <span class="n">result2</span><span class="o">.</span><span class="n">fun</span> <span class="o">-</span> <span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="n">tol</span><span class="p">))</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@&quot;</span><span class="p">)</span>
            
        <span class="n">results2</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">leftOriginal</span><span class="p">,</span> <span class="n">rightOriginal</span><span class="p">,</span> <span class="n">result1</span><span class="o">.</span><span class="n">fun</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="o">-</span><span class="n">tol</span><span class="p">,</span> 
                         <span class="n">result2</span><span class="o">.</span><span class="n">fun</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="o">-</span><span class="n">tol</span><span class="p">,</span> <span class="n">result1</span><span class="o">.</span><span class="n">success</span><span class="p">,</span> 
                         <span class="n">result2</span><span class="o">.</span><span class="n">success</span><span class="p">,</span> <span class="n">feval1</span><span class="p">,</span> <span class="n">feval2</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">printCI</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==============================================&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">()</span>
            
    <span class="k">return</span> <span class="n">results2</span></div>

<div class="viewcode-block" id="test_dynamical_system"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.test_dynamical_system">[docs]</a><span class="k">def</span> <span class="nf">test_dynamical_system</span><span class="p">():</span>
    <span class="c1">#                      r, K,   a,    h,     c,  d</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">tester</span> <span class="o">=</span> <span class="n">DynamicalSystemTester</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span> <span class="c1">#p, std=3)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;mixed_min&quot;</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;RVM&quot;</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;constrained_max&quot;</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;Wald&quot;</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;binsearch&quot;</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;bisection&quot;</span><span class="p">)</span>
    <span class="k">return</span></div>

<div class="viewcode-block" id="test_LogRegress"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.test_LogRegress">[docs]</a><span class="k">def</span> <span class="nf">test_LogRegress</span><span class="p">(</span><span class="n">methods</span><span class="p">):</span>
    <span class="n">tester</span> <span class="o">=</span> <span class="n">LogRegressTester</span><span class="p">(</span><span class="n">dataN</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
    <span class="c1">#find_CI(tester, 3, 1, &quot;constrained_max&quot;)</span>
    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
        <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">m</span><span class="p">)</span></div>

<div class="viewcode-block" id="test_LogRegress_pred"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.test_LogRegress_pred">[docs]</a><span class="k">def</span> <span class="nf">test_LogRegress_pred</span><span class="p">():</span>
    <span class="n">tester</span> <span class="o">=</span> <span class="n">LogRegressTester</span><span class="p">(</span><span class="n">testDataN</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">tester</span><span class="o">.</span><span class="n">dim</span><span class="p">]</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;constrained_max&quot;</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;mixed_min&quot;</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;Wald&quot;</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;RVM&quot;</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;binsearch&quot;</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;bisection&quot;</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>
    <span class="k">return</span></div>

<div class="viewcode-block" id="test_H14"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.test_H14">[docs]</a><span class="k">def</span> <span class="nf">test_H14</span><span class="p">():</span>
    <span class="n">tester</span> <span class="o">=</span> <span class="n">H14Tester</span><span class="p">()</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;constrained_max&quot;</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;mixed_min&quot;</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;RVM&quot;</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;binsearch&quot;</span><span class="p">)</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;bisection&quot;</span><span class="p">)</span>
    <span class="k">return</span>
    <span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="s2">&quot;Wald&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_plot"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.create_plot">[docs]</a><span class="k">def</span> <span class="nf">create_plot</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">additional</span><span class="o">=</span><span class="p">[],</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;RVM&quot;</span><span class="p">],</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Creating figure for&quot;</span><span class="p">,</span> <span class="n">tester</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">additional</span><span class="p">)</span>
    
    <span class="n">fixed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">dim</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">considered</span><span class="p">:</span>
        <span class="n">fixed</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">additional</span><span class="p">:</span>
        <span class="n">fixed</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">methods</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;RVM&quot;</span><span class="p">]:</span>
        <span class="n">rvmplot</span> <span class="o">=</span> <span class="kc">True</span>
    
    <span class="n">consIndices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">considered</span><span class="p">,</span> <span class="n">additional</span><span class="p">)))</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">consIndices</span><span class="p">,</span> <span class="n">considered</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">ind2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">consIndices</span><span class="p">,</span> <span class="n">considered</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plotinds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">index</span><span class="p">,</span> <span class="n">ind2</span><span class="p">])</span>
    <span class="n">flex</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">additional</span><span class="p">:</span>
        <span class="n">flex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">consIndices</span><span class="p">,</span> <span class="n">i</span><span class="p">))</span>
    <span class="n">flex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flex</span><span class="p">)</span>
    
    <span class="n">tester</span><span class="o">.</span><span class="n">fixed</span> <span class="o">=</span> <span class="n">fixed</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">funs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">xmax</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">x2</span><span class="p">,</span> <span class="n">y2</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="n">strings</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
        <span class="n">r1</span><span class="p">,</span> <span class="n">track1</span> <span class="o">=</span> <span class="n">find_CI</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">f_track</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">r2</span><span class="p">,</span> <span class="n">track2</span> <span class="o">=</span> <span class="n">find_CI</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">f_track</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xmax</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">ymax</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">r2</span><span class="o">.</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>
        <span class="n">strings</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">method</span> <span class="o">+</span> <span class="s2">&quot;: [</span><span class="si">{:6.3f}</span><span class="s2">, </span><span class="si">{:6.3f}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">considered</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">r2</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">considered</span><span class="p">[</span><span class="mi">0</span><span class="p">]]))</span>
        <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">track1</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">track2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="n">considered</span><span class="p">]</span>
        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">rvmplot</span><span class="p">:</span>
            <span class="n">xx2</span><span class="p">,</span> <span class="n">yy2</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">r1</span><span class="o">.</span><span class="n">x_track</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">r2</span><span class="o">.</span><span class="n">x_track</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="p">)[</span><span class="n">considered</span><span class="p">]</span>
            <span class="n">x2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xx2</span><span class="p">)</span>
            <span class="n">y2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">yy2</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">strings</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">rvmplot</span><span class="p">:</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">99</span><span class="p">)</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">99</span><span class="p">)</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        
        <span class="n">xOrder</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">xmax</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
        <span class="n">yOrder</span> <span class="o">=</span> <span class="mi">10</span><span class="o">**</span><span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ymax</span><span class="p">))</span>
        <span class="n">xmax</span> <span class="o">=</span> <span class="p">(</span><span class="n">xmax</span> <span class="o">//</span> <span class="n">xOrder</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span><span class="n">xOrder</span>
        <span class="n">xmin</span> <span class="o">=</span> <span class="nb">max</span><span class="p">((</span><span class="n">xmin</span> <span class="o">//</span> <span class="n">xOrder</span><span class="p">)</span> <span class="o">*</span> <span class="n">xOrder</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymax</span> <span class="o">//</span> <span class="n">yOrder</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span><span class="n">yOrder</span>
        <span class="n">ymin</span> <span class="o">=</span> <span class="p">(</span><span class="n">ymin</span> <span class="o">//</span> <span class="n">yOrder</span><span class="p">)</span> <span class="o">*</span> <span class="n">yOrder</span>
        
        <span class="k">if</span> <span class="n">tester</span><span class="o">.</span><span class="n">dataN</span> <span class="o">&gt;=</span> <span class="mi">10000</span><span class="p">:</span>
            <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">11</span>
        
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xdiff</span> <span class="o">=</span> <span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span>
        <span class="n">ydiff</span> <span class="o">=</span> <span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span>
        
        <span class="n">xmax</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">xdiff</span>
        <span class="n">xmin</span> <span class="o">-=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">xdiff</span>
        <span class="n">ymax</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">ydiff</span>
        <span class="n">ymin</span> <span class="o">-=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">ydiff</span>
    <span class="c1">#print(np.arctan(r1.x[index])/np.pi+0.5, np.arctan(r2.x[index])/np.pi+0.5)</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="n">r2</span><span class="o">.</span><span class="n">success</span><span class="p">):</span>
        <span class="c1">#raise Exception(&quot;no success&quot;)</span>
        <span class="k">pass</span>
    
    <span class="c1">#x, y = tester.convertPos(np.concatenate((r1.x_track[::-1], r2.x_track))).T[considered]</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    xmax = np.max(x[0])</span>
<span class="sd">    xmin = np.min(x[0])</span>
<span class="sd">    ymax = np.max(y[0])</span>
<span class="sd">    ymin = np.min(y[0])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1">#xmin, xmax = -100, 2</span>
    <span class="c1">#ymin, ymax = -2, 2</span>
    <span class="c1">#ymax = np.mean(y)</span>
    <span class="c1">#xmax = np.mean(x)</span>
    
    
    <span class="c1">#xmin = max(0, xmin)</span>
    <span class="c1">#ymin = max(0, ymin)</span>
    <span class="n">plotn</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">XX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">plotn</span><span class="p">)</span>
    <span class="n">YY</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">plotn</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">XX</span><span class="p">,</span> <span class="n">YY</span><span class="p">)</span>
    
    <span class="n">Z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    
    <span class="n">x0</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">MLE</span>
    <span class="n">target</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">ML</span><span class="o">-</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">ALPHA</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">ML</span><span class="p">)</span>
    <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
    <span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.78</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rvmplot</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xx2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">XX</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">yy2</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">YY</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tester</span><span class="o">.</span><span class="n">convert</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xx2</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">yy2</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">):</span>
                    <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span> 
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">additional</span><span class="p">:</span>
                        <span class="n">x02</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">x02</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">x02</span><span class="p">)</span>
                        <span class="n">x02</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">xx2</span>
                        <span class="n">x02</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span> <span class="o">=</span> <span class="n">yy2</span>
                        <span class="n">x02</span> <span class="o">=</span> <span class="n">tester</span><span class="o">.</span><span class="n">convertPosInv</span><span class="p">(</span><span class="n">x02</span><span class="p">)</span>
                        <span class="c1">#x02[flex] = -x02[ind2]</span>
                        <span class="n">ff</span> <span class="o">=</span> <span class="n">fixedFun</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x02</span><span class="p">,</span> <span class="n">flex</span><span class="p">)</span>
                        <span class="c1">#x03 = op.basinhopping(ff, x02[flex], 10).x</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">additional</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">op</span><span class="o">.</span><span class="n">minimize_scalar</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">300</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;bounded&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fun</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">x02</span><span class="p">)</span><span class="o">.</span><span class="n">fun</span>
                        <span class="c1">#Z[j, i] = -op.minimize(ff, x02[flex]).fun</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">Z</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">convertPosInv</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">xx2</span><span class="p">,</span> <span class="n">yy2</span><span class="p">])))</span>
        <span class="n">Z</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">Z</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">tester</span><span class="o">.</span><span class="n">ML</span><span class="o">-</span><span class="mi">50</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;gouraud&#39;</span><span class="p">)</span> <span class="c1">#cmap=cmap) #, </span>
    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="c1">#plt.plot(xx, yy, marker = &#39;x&#39;, color=&#39;C5&#39;)</span>
    <span class="c1">#plt.plot(x, y, marker = &#39;o&#39;, color=&#39;C1&#39;)</span>
    <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;h&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">]</span>
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="s2">&quot;C4&quot;</span><span class="p">,</span> <span class="s2">&quot;C5&quot;</span><span class="p">]</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">])</span> <span class="c1">#cmap=cmap) #, </span>
    <span class="k">if</span> <span class="n">rvmplot</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">methods</span><span class="p">):</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
        
        
    <span class="k">for</span> <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">marker</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">method</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">methods</span><span class="p">):</span>
        <span class="n">opacity</span> <span class="o">=</span> <span class="mi">1</span> 
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rvmplot</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s2">&quot;RVM&quot;</span><span class="p">:</span> 
                <span class="n">color</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">opacity</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="n">markersize</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">markersize</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="n">marker</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">opacity</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> 
                 <span class="n">label</span><span class="o">=</span><span class="n">method</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="n">markersize</span><span class="p">)</span>
            
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="o">*</span><span class="n">tester</span><span class="o">.</span><span class="n">convertPos</span><span class="p">(</span><span class="n">x0</span><span class="p">)[</span><span class="n">plotinds</span><span class="p">],</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C3&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;MLE&quot;</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">rvmplot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\beta_1$&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$\alpha_1$&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nticks</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$x_</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">considered</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;$x_</span><span class="si">{}</span><span class="s2">$&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">considered</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="c1">#print(xx)</span>
    <span class="c1">#print(yy)</span>
    
    <span class="c1">#ax.plot_surface(X, Y, Z, rstride=1, cstride=1,</span>
    <span class="c1">#                   linewidth=0, antialiased=True)</span>
    <span class="k">if</span> <span class="n">rvmplot</span><span class="p">:</span>
        <span class="n">fileName</span> <span class="o">=</span> <span class="s2">&quot;rvm&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">tester</span><span class="o">.</span><span class="n">dataN</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">fileName</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span><span class="o">+</span><span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span><span class="o">+</span><span class="s2">&quot;.pdf&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fileName</span> <span class="ow">or</span> <span class="n">rvmplot</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>

<div class="viewcode-block" id="benchmark_"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.benchmark_">[docs]</a><span class="k">def</span> <span class="nf">benchmark_</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="n">simkwargs</span><span class="p">):</span>
    <span class="n">tester</span> <span class="o">=</span> <span class="n">LogRegressTester</span><span class="p">(</span><span class="o">**</span><span class="n">simkwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">find_CIs</span><span class="p">(</span><span class="n">tester</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">printCI</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">multiprocessing</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">]</span></div>

<div class="viewcode-block" id="benchmark"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.test_ci_rvm.html#ci_rvm.test_ci_rvm.benchmark">[docs]</a><span class="k">def</span> <span class="nf">benchmark</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="n">nsim</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="o">**</span><span class="n">simkwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Benchmarking </span><span class="si">{}</span><span class="s2"> realizations.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nsim</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;simargs:&quot;</span><span class="p">,</span> <span class="n">simkwargs</span><span class="p">)</span>
    
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;right&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;leftOriginal&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> 
             <span class="p">(</span><span class="s2">&quot;rightOriginal&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;leftAdmissible&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> 
             <span class="p">(</span><span class="s2">&quot;rightAdmissible&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;leftSuccess&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> 
             <span class="p">(</span><span class="s2">&quot;rightSuccess&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;leftEvals&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;rightEvals&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)]</span>
    
    <span class="n">stats</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="p">[],</span> <span class="n">error</span><span class="o">=</span><span class="p">[],</span> <span class="n">evals</span><span class="o">=</span><span class="p">[],</span> 
                                     <span class="n">errorTot</span><span class="o">=</span><span class="p">[],</span> <span class="n">evalsTot</span><span class="o">=</span><span class="p">[],</span>
                                     <span class="n">errorReduced</span><span class="o">=</span><span class="p">[],</span> <span class="n">largeErrors</span><span class="o">=</span><span class="p">[],</span>
                                     <span class="n">largeErrorsTot</span><span class="o">=</span><span class="p">[]))</span>
    
    <span class="n">bound</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">tol</span> <span class="o">=</span> <span class="mf">1e-3</span>
    <span class="n">rtol</span> <span class="o">=</span> <span class="mf">0.05</span>
    <span class="k">with</span> <span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">results_</span> <span class="ow">in</span> <span class="n">pool</span><span class="o">.</span><span class="n">starmap</span><span class="p">(</span><span class="n">benchmark_</span><span class="p">,</span> <span class="nb">zip</span><span class="p">(</span><span class="n">repeat</span><span class="p">(</span><span class="n">methods</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">simkwargs</span><span class="p">,</span> <span class="n">nsim</span><span class="p">)),</span>
                                     <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">records</span><span class="o">.</span><span class="n">fromarrays</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results_</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            
            <span class="n">lefts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=~</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;leftAdmissible&quot;</span><span class="p">])</span>
            <span class="n">rights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">],</span> <span class="n">mask</span><span class="o">=~</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;rightAdmissible&quot;</span><span class="p">])</span>
            
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">],</span> <span class="o">-</span><span class="n">bound</span><span class="p">)</span>
            <span class="n">results</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">],</span> <span class="n">bound</span><span class="p">)</span>
            
            
            <span class="n">trueLeft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">lefts</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">trueLeft</span><span class="p">[</span><span class="n">trueLeft</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">trueLeft</span> <span class="o">=</span> <span class="n">trueLeft</span><span class="o">.</span><span class="n">data</span>
            <span class="n">trueRight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">rights</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">trueRight</span><span class="p">[</span><span class="n">trueRight</span><span class="o">.</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">trueRight</span> <span class="o">=</span> <span class="n">trueRight</span><span class="o">.</span><span class="n">data</span>
            
            <span class="k">for</span> <span class="n">method</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="n">results</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
                <span class="n">methodStats</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;leftSuccess&quot;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">],</span> <span class="n">trueLeft</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tol</span><span class="p">))</span>
                     <span class="o">|</span> <span class="p">((</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;leftOriginal&quot;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;leftAdmissible&quot;</span><span class="p">]))</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rightSuccess&quot;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">],</span> <span class="n">trueRight</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">rtol</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tol</span><span class="p">))</span>
                     <span class="o">|</span> <span class="p">((</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rightOriginal&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;rightAdmissible&quot;</span><span class="p">]))</span>
                <span class="n">leftError</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">trueLeft</span><span class="p">)</span>
                <span class="n">rightError</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span><span class="o">-</span><span class="n">trueRight</span><span class="p">))</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">leftError</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;leftSuccess&quot;</span><span class="p">]])</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rightError</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rightSuccess&quot;</span><span class="p">]])</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;errorTot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">leftError</span><span class="p">[</span><span class="n">trueLeft</span> <span class="o">&gt;</span> <span class="o">-</span><span class="n">bound</span><span class="p">])</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;errorTot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rightError</span><span class="p">[</span><span class="n">trueRight</span> <span class="o">&lt;</span> <span class="n">bound</span><span class="p">])</span>
                <span class="n">largeLeftError</span> <span class="o">=</span> <span class="p">((</span><span class="n">leftError</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;leftSuccess&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="p">((</span><span class="n">trueLeft</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="o">-</span><span class="n">bound</span><span class="p">))</span>
                <span class="n">largeRightError</span> <span class="o">=</span> <span class="p">((</span><span class="n">rightError</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;rightSuccess&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="p">((</span><span class="n">trueRight</span> <span class="o">&gt;=</span> <span class="n">bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">bound</span><span class="o">-</span><span class="mi">10</span><span class="p">))</span>
                <span class="n">largeLeftErrorTot</span> <span class="o">=</span> <span class="p">(</span><span class="n">leftError</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">trueLeft</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="n">bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;left&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="o">-</span><span class="n">bound</span><span class="p">))</span>
                <span class="n">largeRightErrorTot</span> <span class="o">=</span> <span class="p">(</span><span class="n">rightError</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">trueRight</span> <span class="o">&gt;=</span> <span class="n">bound</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;right&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bound</span><span class="o">-</span><span class="mi">10</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">method</span><span class="o">==</span><span class="s1">&#39;RVM&#39;</span> <span class="ow">and</span> <span class="p">(</span><span class="n">largeLeftError</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">largeRightError</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################################&quot;</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;####################################&quot;</span><span class="p">)</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;errorReduced&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">leftError</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;leftSuccess&quot;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">largeLeftError</span><span class="p">)])</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;errorReduced&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">rightError</span><span class="p">[</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rightSuccess&quot;</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">~</span><span class="n">largeRightError</span><span class="p">)])</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;largeErrors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">largeLeftError</span><span class="p">)</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;largeErrors&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">largeRightError</span><span class="p">)</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;largeErrorsTot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">largeLeftErrorTot</span><span class="p">)</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;largeErrorsTot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">largeRightErrorTot</span><span class="p">)</span>
                
                <span class="c1">#methodStats[&quot;errorTot&quot;].extend(np.abs(result[&quot;left&quot;]-trueLeft)[result[&quot;leftOriginal&quot;] &gt; -bound])</span>
                <span class="c1">#methodStats[&quot;errorTot&quot;].extend(np.abs(result[&quot;right&quot;]-trueRight)[result[&quot;rightOriginal&quot;] &lt; bound])</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;evals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;leftEvals&quot;</span><span class="p">][</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;leftSuccess&quot;</span><span class="p">]])</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;evals&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rightEvals&quot;</span><span class="p">][</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rightSuccess&quot;</span><span class="p">]])</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;evalsTot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;leftEvals&quot;</span><span class="p">])</span>
                <span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;evalsTot&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">result</span><span class="p">[</span><span class="s2">&quot;rightEvals&quot;</span><span class="p">])</span>
        
    <span class="k">for</span> <span class="n">method</span> <span class="ow">in</span> <span class="n">methods</span><span class="p">:</span>
        <span class="n">methodStats</span> <span class="o">=</span> <span class="n">stats</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;15}</span><span class="s2">: success=</span><span class="si">{:7.5f}</span><span class="s2">, error=</span><span class="si">{:8.4f}</span><span class="s2">, errorReduced=</span><span class="si">{:8.4f}</span><span class="s2">, errorTot=</span><span class="si">{:8.4f}</span><span class="s2">, largeErrors=</span><span class="si">{:7.5f}</span><span class="s2">, largeErrorsTot=</span><span class="si">{:7.5f}</span><span class="s2">, evals=</span><span class="si">{:8.1f}</span><span class="s2">, evalsTot=</span><span class="si">{:8.1f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">method</span><span class="p">,</span> 
            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;success&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;errorReduced&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;errorTot&quot;</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;largeErrors&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;largeErrorsTot&quot;</span><span class="p">]),</span>
            <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;evals&quot;</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">methodStats</span><span class="p">[</span><span class="s2">&quot;evalsTot&quot;</span><span class="p">])))</span></div>
        
    

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">methods</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Wald&quot;</span><span class="p">,</span> <span class="s2">&quot;RVM&quot;</span><span class="p">,</span> <span class="s2">&quot;RVM_psI&quot;</span><span class="p">,</span> <span class="s2">&quot;bisection&quot;</span><span class="p">,</span> <span class="s2">&quot;mixed_min&quot;</span><span class="p">,</span> <span class="s2">&quot;constrained_max&quot;</span><span class="p">,</span> <span class="s2">&quot;binsearch&quot;</span><span class="p">,</span> <span class="s2">&quot;VM&quot;</span><span class="p">,</span>  <span class="s2">&quot;gridsearch&quot;</span><span class="p">]</span>
    <span class="n">benchmark</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">dataN</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;11cx&quot;</span><span class="p">)</span> 
    <span class="n">benchmark</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">dataN</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;11&quot;</span><span class="p">)</span> 
    <span class="n">benchmark</span><span class="p">(</span><span class="n">methods</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">dataN</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;3&quot;</span><span class="p">)</span> 
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Packages</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../hybrid_vector_model.html">hybrid_vector_model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ci_rvm.html">ci_rvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lopaths.html">lopaths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vemomoto_core.html">vemomoto_core</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">VeMoMoTo</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Samuel M. Fischer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.0.
    </div>
  </body>
</html>