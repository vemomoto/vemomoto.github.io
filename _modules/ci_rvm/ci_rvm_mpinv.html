
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>ci_rvm.ci_rvm_mpinv &#8212; Vector Movement Modelling Tools</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">VeMoMoTo</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ci_rvm.ci_rvm_mpinv</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Created on 16.01.2018</span>

<span class="sd">@author: Samuel</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">linalg</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>


<span class="kn">from</span> <span class="nn">numdifftools</span> <span class="kn">import</span> <span class="n">nd_algopy</span>
<span class="kn">import</span> <span class="nn">algopy</span>
<span class="kn">from</span> <span class="nn">scipy.optimize._trustregion_exact</span> <span class="kn">import</span> <span class="n">IterativeSubproblem</span>



<div class="viewcode-block" id="round_str"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.round_str">[docs]</a><span class="k">def</span> <span class="nf">round_str</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">digipre</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">after</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">full</span><span class="o">-</span><span class="n">digipre</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">after</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;{:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">after</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;f}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span></div>

<div class="viewcode-block" id="is_negative_definite"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.is_negative_definite">[docs]</a><span class="k">def</span> <span class="nf">is_negative_definite</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tol</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>
<div class="viewcode-block" id="is_negative_semidefinite"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.is_negative_semidefinite">[docs]</a><span class="k">def</span> <span class="nf">is_negative_semidefinite</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">return_singular</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> <span class="c1">#</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_singular</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">M</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">tol</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">return_singular</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="FlexibleSubproblem"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.FlexibleSubproblem">[docs]</a><span class="k">class</span> <span class="nc">FlexibleSubproblem</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing constained quadratic subproblems</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">hessp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">k_easy</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">k_hard</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ``k_easy`` and ``k_hard`` are parameters used</span>
<span class="sd">        to determine the stop criteria to the iterative</span>
<span class="sd">        subproblem solver. Take a look at the IterativeSubproblem class</span>
<span class="sd">        for more info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jac</span> <span class="o">=</span> <span class="n">jac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hess</span> <span class="o">=</span> <span class="n">hess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hessp</span> <span class="o">=</span> <span class="n">hessp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_easy</span> <span class="o">=</span> <span class="n">k_easy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_hard</span> <span class="o">=</span> <span class="n">k_hard</span>
        
<div class="viewcode-block" id="FlexibleSubproblem.solve"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.FlexibleSubproblem.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">positiveDefinite</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">jac0tol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">radius</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)),</span> <span class="kc">True</span>
        
        <span class="n">subproblem</span> <span class="o">=</span> <span class="n">IterativeSubproblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jac</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hess</span><span class="p">,</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">hessp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_easy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_hard</span><span class="p">)</span>
        
        <span class="c1"># IterativeSubproblem runs into issues, if jac is too small</span>
        <span class="k">if</span> <span class="n">subproblem</span><span class="o">.</span><span class="n">jac_mag</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">subproblem</span><span class="o">.</span><span class="n">CLOSE_TO_ZERO</span><span class="p">,</span> <span class="n">jac0tol</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">positiveDefinite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">positiveDefinite</span> <span class="o">=</span> <span class="n">is_negative_definite</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">positiveDefinite</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vals</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">vals</span><span class="p">))]</span>
                <span class="n">x</span> <span class="o">*=</span> <span class="n">radius</span>
            <span class="n">jNorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">jNorm</span><span class="p">:</span>
                <span class="n">x_alt</span> <span class="o">=</span> <span class="n">j</span> <span class="o">/</span> <span class="n">jNorm</span> <span class="o">*</span> <span class="n">radius</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> 
                    <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">((</span><span class="n">x_alt</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x_alt</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">x_alt</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="n">x_alt</span><span class="p">,</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">subproblem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="Flipper"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.Flipper">[docs]</a><span class="k">class</span> <span class="nc">Flipper</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">index</span><span class="p">:</span> <span class="s2">&quot;index in which the result should be flipped&quot;</span><span class="p">,</span>
            <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="CounterFun"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.CounterFun">[docs]</a><span class="k">class</span> <span class="nc">CounterFun</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts how often a function has been called</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evals</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evals</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="create_profile_plots"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.create_profile_plots">[docs]</a><span class="k">def</span> <span class="nf">create_profile_plots</span><span class="p">(</span><span class="n">profile_result</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                         <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="n">considered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">profile_result</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">considered</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="n">parms_t</span> <span class="o">=</span> <span class="n">profile_result</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>
    <span class="n">interestParm</span> <span class="o">=</span> <span class="n">parms_t</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">relativeChange</span> <span class="o">=</span> <span class="n">parms_t</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
    
    <span class="n">relativeChange</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">relativeChange</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span> 
                                 <span class="mf">1e-20</span><span class="p">)[:,</span><span class="kc">None</span><span class="p">]</span> <span class="c1">#relativeChange[:,len(interestParm)//2][:,None]</span>
    <span class="c1">#relativeChange -= 1</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">xLabel</span> <span class="o">=</span> <span class="s2">&quot;Parameter &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">xLabel</span> <span class="o">=</span> <span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    
    <span class="n">labels</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">labels</span><span class="p">)</span>
    <span class="k">del</span> <span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interestParm</span><span class="p">,</span> <span class="n">profile_result</span><span class="p">[</span><span class="s2">&quot;logL&quot;</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xLabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Log-Likelihood&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_name</span> <span class="o">+=</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">xLabel</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_logL.pdf&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_logL.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    
    <span class="k">for</span> <span class="n">relChange</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">relativeChange</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">interestParm</span><span class="p">,</span> <span class="n">relChange</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xLabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Relative parameter change&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_params.pdf&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_params.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xLabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Log-Likelihood&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">profile_result</span><span class="p">[</span><span class="s2">&quot;x_track&quot;</span><span class="p">]),</span> 
             <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">profile_result</span><span class="p">[</span><span class="s2">&quot;f_track&quot;</span><span class="p">]))</span>
    
    <span class="k">if</span> <span class="n">file_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_search.pdf&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_name</span> <span class="o">+</span> <span class="s2">&quot;_search.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="find_profile_CI_bound"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.find_profile_CI_bound">[docs]</a><span class="k">def</span> <span class="nf">find_profile_CI_bound</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> 
                          <span class="n">fun0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">vm</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    
    <span class="k">if</span> <span class="n">fun0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    
    <span class="n">target</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">diff</span>
    
    <span class="k">if</span> <span class="n">vm</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">venzon_moolgavkar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> 
                                 <span class="n">direction</span><span class="p">,</span> <span class="n">fun0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">find_CI_bound</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">direction</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> 
                             <span class="n">fun0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">track_x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">track_f</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="find_profile_CI_bound_steps"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.find_profile_CI_bound_steps">[docs]</a><span class="k">def</span> <span class="nf">find_profile_CI_bound_steps</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> 
                          <span class="n">stepn</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">fun0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hess0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> 
                          <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-4</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vm</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    
    <span class="k">if</span> <span class="n">fun0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    
    <span class="n">steps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">fun0</span><span class="p">,</span> <span class="n">fun0</span><span class="o">-</span><span class="n">diff</span><span class="p">,</span> <span class="n">stepn</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;diff&quot;</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;steps&quot;</span><span class="p">,</span> <span class="n">steps</span><span class="p">)</span> 
    
    <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;params&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;double&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s1">&#39;logL&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
             <span class="p">(</span><span class="s2">&quot;x_track&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
             <span class="p">(</span><span class="s2">&quot;f_track&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
             <span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stepn</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
    
    <span class="n">result</span><span class="p">[</span><span class="s1">&#39;logL&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">steps</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;x_track&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x0</span><span class="p">]</span>
    <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f_track&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fun0</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">steps</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">if</span> <span class="n">vm</span><span class="p">:</span>
            <span class="n">op_result</span> <span class="o">=</span> <span class="n">venzon_moolgavkar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> 
                                          <span class="n">direction</span><span class="p">,</span> <span class="n">fun0</span><span class="p">,</span> <span class="n">hess0</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> 
                                          <span class="n">epsilon</span><span class="p">,</span> <span class="n">disp</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">op_result</span> <span class="o">=</span> <span class="n">find_CI_bound</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">direction</span><span class="o">==</span><span class="mi">1</span><span class="p">,</span> 
                                      <span class="n">fun0</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">hess0</span><span class="p">,</span> <span class="n">nmax</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="n">disp</span><span class="p">,</span> 
                                      <span class="n">track_x</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">track_f</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">op_result</span><span class="o">.</span><span class="n">x</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">op_result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op_result</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Iteration limit exceeded for variable &quot;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; and logL=&quot;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; in direction &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
            <span class="k">elif</span> <span class="n">op_result</span><span class="o">.</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Optimization failed for variable &quot;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; and logL=&quot;</span>
                              <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; in direction &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">direction</span><span class="p">))</span>
                <span class="c1">#if not np.isnan(x0).any():</span>
                <span class="c1">#    x0 = op_result.x</span>
                <span class="n">op_result</span><span class="o">.</span><span class="n">x</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">op_result</span><span class="o">.</span><span class="n">fun</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;x_track&quot;</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">op_result</span><span class="o">.</span><span class="n">x_track</span><span class="p">[::</span><span class="n">direction</span><span class="p">])</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;f_track&quot;</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_result</span><span class="o">.</span><span class="n">f_track</span><span class="p">[::</span><span class="n">direction</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;logL&quot;</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_result</span><span class="o">.</span><span class="n">fun</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;params&quot;</span><span class="p">][</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">op_result</span><span class="o">.</span><span class="n">x</span>
        <span class="n">fun0</span> <span class="o">=</span> <span class="n">op_result</span><span class="o">.</span><span class="n">fun</span>
        <span class="n">hess0</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** logL=</span><span class="si">{}</span><span class="s2">; index=</span><span class="si">{}</span><span class="s2">, direction=</span><span class="si">{}</span><span class="s2">, fdiff=</span><span class="si">{}</span><span class="s2">; jdiff=</span><span class="si">{}</span><span class="s2">, nit=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">fun0</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">op_result</span><span class="o">.</span><span class="n">fun</span><span class="o">-</span><span class="n">target</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">op_result</span><span class="o">.</span><span class="n">jac</span><span class="p">)),</span> <span class="n">op_result</span><span class="o">.</span><span class="n">nit</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;*** finished, but can&#39;t print due to exception.&quot;</span><span class="p">,</span> <span class="n">op_result</span><span class="o">.</span><span class="n">jac</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">direction</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            
    <span class="k">return</span> <span class="n">result</span></div>
    


<div class="viewcode-block" id="venzon_moolgavkar"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.venzon_moolgavkar">[docs]</a><span class="k">def</span> <span class="nf">venzon_moolgavkar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">step_scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> 
                      <span class="n">fun0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hess0</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">track_x</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="n">x_track</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="c1"># TODO: handle singular matrices (check determinant, return NaN), extend algorithm to be more robust</span>
    <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">try</span><span class="p">:</span>    
        <span class="c1"># preparation</span>
        
        <span class="k">if</span> <span class="n">fun0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">target_diff</span> <span class="o">=</span> <span class="n">fun0</span><span class="o">-</span><span class="n">target</span>
        <span class="k">if</span> <span class="n">hess0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">dl2_dx2_0</span> <span class="o">=</span> <span class="n">hess</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">dl2_dx2_0</span> <span class="o">=</span> <span class="n">hess0</span>
        
        <span class="n">considered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">considered</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">hessConsidered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">considered</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>
        
        <span class="c1"># test</span>
        <span class="k">if</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> 
                           <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">])))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="p">))</span>
                           
        <span class="c1"># x is the parameter vector</span>
        <span class="c1"># w is the vector of nuisance parameters (x without row &quot;index&quot;)</span>
        <span class="c1"># b is the parameter of interest, which is x[index]</span>
        <span class="c1"># l is fun</span>
        <span class="c1"># dl_d* is the derivative of l w.r.t. *</span>
        <span class="c1"># dl2_d*2 is the second derivative of l w.r.t. *</span>
        
        <span class="c1"># choosing the first step x1</span>
        
        <span class="n">dl2_dw2</span> <span class="o">=</span> <span class="n">dl2_dx2_0</span><span class="p">[</span><span class="n">hessConsidered</span><span class="p">]</span>
        
        <span class="n">dl2_dbdw</span> <span class="o">=</span> <span class="n">dl2_dx2_0</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">considered</span><span class="p">]</span>
        <span class="n">dl2_dw2_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">dl2_dw2</span><span class="p">)</span>
        <span class="n">dw_db</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dl2_dw2_inv</span><span class="p">,</span> <span class="n">dl2_dbdw</span><span class="p">)</span>
        
        <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">target_diff</span> <span class="o">/</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">dl2_dx2_0</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>
                            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dl2_dbdw</span><span class="p">,</span> <span class="n">dl2_dw2_inv</span><span class="p">),</span> <span class="n">dl2_dbdw</span><span class="p">))))</span>
                                               <span class="o">*</span> <span class="n">step_scale</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">factor</span><span class="p">):</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mf">0.5</span>
            <span class="c1">#raise np.linalg.LinAlgError()</span>
        
        <span class="n">init_direction</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="n">init_direction</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span> <span class="o">=</span> <span class="n">dw_db</span>
        <span class="n">init_direction</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">factor</span><span class="o">*</span><span class="n">init_direction</span>
        
        
        <span class="c1"># iteration</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nmax</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">track_x</span><span class="p">:</span>
                <span class="n">x_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">dl_dx_</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">violation</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dl_dx_</span><span class="p">[</span><span class="n">considered</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">target</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
                <span class="c1">#print(x)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iteration </span><span class="si">{}</span><span class="s2">: fun_diff=</span><span class="si">{}</span><span class="s2">; jac_violation=</span><span class="si">{}</span><span class="s2">; direction=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">i</span><span class="p">,</span> <span class="n">l</span><span class="o">-</span><span class="n">target</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dl_dx_</span><span class="p">[</span><span class="n">considered</span><span class="p">])),</span> <span class="n">step_scale</span><span class="p">))</span>
            
            <span class="k">if</span> <span class="n">violation</span> <span class="o">&lt;</span> <span class="n">epsilon</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">violation</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">()</span>
            
            <span class="n">D</span> <span class="o">=</span> <span class="n">dl2_dx2</span> <span class="o">=</span> <span class="n">hess</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">dl2_dx2_</span> <span class="o">=</span> <span class="n">dl2_dx2</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">dl2_dx2_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">dl_dx_</span>
            <span class="n">dl_dx_</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="o">-</span><span class="n">target</span> 
            
            <span class="n">dl2_dx2__inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">dl2_dx2_</span><span class="p">)</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">dl2_dx2__inv</span><span class="p">[:,</span><span class="n">index</span><span class="p">]</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">dl2_dx2__inv</span><span class="p">,</span> <span class="n">dl_dx_</span><span class="p">)</span>
            
            <span class="n">Dg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">g</span><span class="p">)</span>
            <span class="n">vDg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Dg</span><span class="p">)</span>
            <span class="n">gDg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">Dg</span><span class="p">)</span>
            <span class="n">vDv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">D</span><span class="p">),</span> <span class="n">v</span><span class="p">)</span>
            
            <span class="n">p</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">vDg</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">gDg</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">vDv</span> <span class="o">/</span> <span class="n">gDg</span>
            
            <span class="n">_s</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="n">p</span><span class="o">/</span><span class="mi">4</span> <span class="o">-</span> <span class="n">q</span>
            
            <span class="k">if</span> <span class="n">_s</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">_s</span><span class="p">)</span>
                <span class="n">s_</span> <span class="o">=</span> <span class="o">-</span> <span class="n">p</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">s_1</span> <span class="o">=</span> <span class="n">s_</span> <span class="o">+</span> <span class="n">_s</span>
                <span class="n">s_2</span> <span class="o">=</span> <span class="n">s_</span> <span class="o">-</span> <span class="n">_s</span>
                
                <span class="n">v_sg_1</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">s_1</span><span class="o">*</span><span class="n">g</span>
                <span class="n">v_sg_2</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">s_2</span><span class="o">*</span><span class="n">g</span>
                <span class="n">measure1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v_sg_1</span><span class="p">,</span> <span class="n">dl2_dx2_0</span><span class="p">),</span> <span class="n">v_sg_1</span><span class="p">))</span>
                <span class="n">measure2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">v_sg_2</span><span class="p">,</span> <span class="n">dl2_dx2_0</span><span class="p">),</span> <span class="n">v_sg_2</span><span class="p">))</span>
                
                <span class="k">if</span> <span class="n">measure1</span> <span class="o">&lt;</span> <span class="n">measure2</span><span class="p">:</span>
                    <span class="n">x</span> <span class="o">-=</span> <span class="n">v_sg_1</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">x</span> <span class="o">-=</span> <span class="n">v_sg_2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># TODO: do line search here! </span>
                <span class="n">x</span> <span class="o">-=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">v</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">dl_dx_</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">violation</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dl_dx_</span><span class="p">[</span><span class="n">considered</span><span class="p">])),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">l</span><span class="o">-</span><span class="n">target</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> 
                                     <span class="n">fun</span><span class="o">=</span><span class="n">l</span><span class="p">,</span>
                                     <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">,</span>
                                     <span class="n">violation</span><span class="o">=</span><span class="n">violation</span><span class="p">,</span>
                                     <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">nfev</span><span class="o">=</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span> 
                                     <span class="n">nit</span><span class="o">=</span><span class="n">nmax</span><span class="p">,</span>
                                     <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_track</span><span class="p">),</span>
                                     <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Iteration limit exceeded&quot;</span>
                                     <span class="p">)</span>
        
        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> 
                                 <span class="n">fun</span><span class="o">=</span><span class="n">l</span><span class="p">,</span>
                                 <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                                 <span class="n">violation</span><span class="o">=</span><span class="n">violation</span><span class="p">,</span>
                                 <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                 <span class="n">nfev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> 
                                 <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                 <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_track</span><span class="p">),</span>
                                 <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Success&quot;</span>
                                 <span class="p">)</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> 
                                 <span class="n">fun</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                 <span class="n">jac</span><span class="o">=</span><span class="n">x0</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                 <span class="n">violation</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
                                 <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                 <span class="n">nfev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="n">i</span><span class="p">,</span> 
                                 <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                                 <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_track</span><span class="p">),</span>
                                 <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Ill-conditioned matrix&quot;</span>
                                 <span class="p">)</span></div>

<span class="n">STATUS_MESSAGES</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s2">&quot;Success&quot;</span><span class="p">,</span>
                   <span class="mi">1</span><span class="p">:</span><span class="s2">&quot;Result on discontinuity&quot;</span><span class="p">,</span>
                   <span class="mi">2</span><span class="p">:</span><span class="s2">&quot;Result is unbounded&quot;</span><span class="p">,</span>
                   <span class="mi">3</span><span class="p">:</span><span class="s2">&quot;Iteration limit exceeded&quot;</span><span class="p">,</span>
                   <span class="mi">4</span><span class="p">:</span><span class="s2">&quot;Ill-conditioned matrix&quot;</span><span class="p">,</span>
                   <span class="mi">5</span><span class="p">:</span><span class="s2">&quot;Unspecified error&quot;</span>
                   <span class="p">}</span>

<div class="viewcode-block" id="find_CI_bound"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.find_CI_bound">[docs]</a><span class="k">def</span> <span class="nf">find_CI_bound</span><span class="p">(</span>
        <span class="n">index</span><span class="p">:</span> <span class="s2">&quot;index of the parameter to consider&quot;</span><span class="p">,</span> 
        <span class="n">target</span><span class="p">:</span> <span class="s2">&quot;target log-likelihood l*&quot;</span><span class="p">,</span> 
        <span class="n">x0</span><span class="p">:</span> <span class="s2">&quot;maximum likelihood estimator (MLE)&quot;</span><span class="p">,</span> 
        <span class="n">fun</span><span class="p">:</span> <span class="s2">&quot;log-likelihood function&quot;</span><span class="p">,</span> 
        <span class="n">jac</span><span class="p">:</span> <span class="s2">&quot;gradient of fun&quot;</span><span class="p">,</span> 
        <span class="n">hess</span><span class="p">:</span> <span class="s2">&quot;hessian of fun&quot;</span><span class="p">,</span> 
        <span class="n">forward</span><span class="p">:</span> <span class="s2">&quot;True, if right end point of CI is sought, else False&quot;</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
        <span class="n">fun0</span><span class="p">:</span> <span class="s2">&quot;log-likelihood at MLE&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">jac0</span><span class="p">:</span> <span class="s2">&quot;gradient of log-liekelihood at MLE&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">hess0</span><span class="p">:</span> <span class="s2">&quot;Hessian of log-likelihood at MLE&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">nmax</span><span class="p">:</span> <span class="s2">&quot;maximal number of iterations&quot;</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> 
        <span class="n">nchecks</span><span class="p">:</span> <span class="s2">&quot;maximal number of trust-region changes per iteration&quot;</span> <span class="o">=</span> <span class="mi">65</span><span class="p">,</span>
        <span class="n">apprxtol</span><span class="p">:</span> <span class="s2">&quot;relative tolerance between f and its approximation&quot;</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="c1">#0.2 a 0.8 b</span>
        <span class="n">resulttol</span><span class="p">:</span> <span class="s2">&quot;tolerance of the result (f and norm(jac))&quot;</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span> <span class="c1">#g</span>
        <span class="n">singtol</span><span class="p">:</span> <span class="s2">&quot;tolerance for singularity checks&quot;</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span> <span class="c1">#1e-5, i</span>
        <span class="n">minstep</span><span class="p">:</span> <span class="s2">&quot;controls the minimal radius of the trust region&quot;</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span> 
        <span class="n">radiusFactor</span><span class="p">:</span> <span class="s2">&quot;In [1, 2]. Controls how quickly the trust region decreases&quot;</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">infstep</span><span class="p">:</span> <span class="s2">&quot;Stepsize after which a parameter is deemed unestimbale&quot;</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">,</span> 
        <span class="n">maxRadius</span><span class="p">:</span> <span class="s2">&quot;radius of the trust region in the last iteration&quot;</span> <span class="o">=</span> <span class="mf">1e4</span><span class="p">,</span>
        <span class="n">disp</span><span class="p">:</span> <span class="s2">&quot;whether to print a status message in each iteration&quot;</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
        <span class="n">track_x</span><span class="p">:</span> <span class="s2">&quot;whether to return the parameter trace&quot;</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
        <span class="n">track_f</span><span class="p">:</span> <span class="s2">&quot;whether to return the log-likelihood trace&quot;</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
    
    <span class="n">nuisance_minstep</span> <span class="o">=</span> <span class="mf">1e-3</span>
    
    <span class="c1"># ----- PREPARATION --------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">fun0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jac0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jac0</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hess0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hess0</span> <span class="o">=</span> <span class="n">hess</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        
    <span class="c1"># wrap the functions so that the correct end point is found</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">forward</span><span class="p">:</span>
        <span class="n">fun2</span> <span class="o">=</span> <span class="n">fun</span>
        <span class="n">jac2</span> <span class="o">=</span> <span class="n">jac</span>
        <span class="n">hess2</span> <span class="o">=</span> <span class="n">hess</span>
        <span class="n">flip</span> <span class="o">=</span> <span class="n">Flipper</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fun2</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> 
        <span class="n">jac</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">flip</span><span class="p">(</span><span class="n">jac2</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">flip</span><span class="p">(</span><span class="n">hess2</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">jac0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">hess0</span> <span class="o">=</span> <span class="n">flip</span><span class="p">(</span><span class="n">hess0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="c1"># this is just to ensure the results are traced and returned correctly</span>
        <span class="n">flip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
    
    <span class="n">i</span><span class="p">:</span> <span class="s2">&quot;current iteration&quot;</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x_track</span><span class="p">:</span> <span class="s2">&quot;trace of parameter values&quot;</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">f_track</span><span class="p">:</span> <span class="s2">&quot;trace of log-likelihood values&quot;</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maximizing</span><span class="p">:</span> <span class="s2">&quot;flag controlling whether we are maximizing f w.r.t. x[index]&quot;</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nuisanceRadius</span><span class="p">:</span> <span class="s2">&quot;search radius for unconstrained subproblems&quot;</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="c1"># counters to keep track how often functions have been called</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="n">jac</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>
    <span class="n">hess</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">hess</span><span class="p">)</span>
    
    <span class="n">multi_dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span>
    
    <span class="n">is_negative_semidefinite_</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">is_negative_semidefinite</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">fPredicted_fun</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Taylor approximation of f</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">xTmp</span><span class="o">-</span><span class="n">x</span>
        <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">dx</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    
    <span class="k">def</span> <span class="nf">JPredicted_fun</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Taylor approximation of jac</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">J</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">xTmp</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
    
    <span class="n">norm</span><span class="p">:</span> <span class="s2">&quot;applied norm&quot;</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr</span><span class="o">*</span><span class="n">arr</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">jac_approx_precise</span><span class="p">(</span><span class="n">JPredicted_</span><span class="p">,</span> <span class="n">JActual_</span><span class="p">,</span> <span class="n">J_</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">apprxtol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True, iff the predicted gradient is close to the</span>
<span class="sd">        actual one or, even better, closer to the target than predicted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># note how far we are from the target likelihood</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;normal&quot;</span> <span class="ow">or</span> <span class="n">maximizing</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">closeToDisc</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">return</span> <span class="n">norm</span><span class="p">(</span><span class="n">JActual_</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">J_</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">bound</span> <span class="ow">or</span> <span class="n">norm</span><span class="p">(</span><span class="n">JPredicted_</span><span class="o">-</span><span class="n">JActual_</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">J_</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">bound</span>
    
    <span class="c1"># TODO Accept improvements only then always, if they are better by a certain constant (compare values - line search)</span>
    <span class="k">def</span> <span class="nf">f_approx_precise</span><span class="p">(</span><span class="n">fPredicted</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">apprxtol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True, iff the predicted log-likelihood value is close to the</span>
<span class="sd">        actual one or, even better, closer to the target than predicted</span>
<span class="sd">        &quot;&quot;&quot;</span>
            
        <span class="c1"># steps to negative predicted values cannot occur in theory and are </span>
        <span class="c1"># either due to numerical issues or because we tried a very long step. </span>
        <span class="c1"># Therefore, we reject these steps right away, if fActual is below the </span>
        <span class="c1"># target.</span>
        <span class="k">if</span> <span class="n">fPredicted</span> <span class="o">&lt;</span> <span class="n">target</span> <span class="o">-</span> <span class="n">resulttol</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="c1"># return True if result is better than expected</span>
        <span class="k">if</span> <span class="n">fActual</span> <span class="o">&gt;</span> <span class="n">fPredicted</span> <span class="ow">and</span> <span class="n">xiTmp</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="c1"># if we are maximizing w.r.t. the nuisance parameters, </span>
        <span class="k">if</span> <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;max_nuisance&quot;</span> <span class="ow">or</span> <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;max_nuisance_const&quot;</span> <span class="ow">or</span> <span class="n">maximizing</span><span class="p">:</span>
            <span class="c1"># we do not accept steps that are worse than the current stage</span>
            <span class="c1"># (we guarantee elsewhere that it IS possible to increase f)</span>
            <span class="k">if</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">:</span> 
                <span class="k">if</span> <span class="ow">not</span> <span class="n">relax_maximum_constraint</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fPredicted</span><span class="o">-</span><span class="n">fActual</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">resulttol</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="n">bound</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">relax_maximum_constraint</span><span class="p">:</span>
                <span class="n">bound</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="c1"># if we are outside the admissible region, we enforce that</span>
            <span class="c1"># we get closer to it again</span>
            <span class="k">if</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">-</span><span class="n">resulttol</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fActual</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="n">f</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fActual</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">resulttol</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fPredicted</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">resulttol</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            
            <span class="k">elif</span> <span class="n">fActual</span> <span class="o">&gt;</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                <span class="c1"># we relax the precision requirement, if the step is not of</span>
                <span class="c1"># disadvantage and brings us forward (we value progression in </span>
                <span class="c1"># the paramater of interest higher than a maximal likelihood)</span>
                <span class="n">bound</span> <span class="o">*=</span> <span class="mi">2</span>
                
        
        <span class="c1"># we require that the error relative to the distance from the target</span>
        <span class="c1"># is not larger than the given bound.</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fPredicted</span><span class="o">-</span><span class="n">fActual</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="n">f</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">bound</span>
    
    <span class="k">def</span> <span class="nf">test_precision</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;True, if appxomiations are sufficiently precise&quot;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests the precision of the Taylor approximation at the suggested </span>
<span class="sd">        parameter vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
        <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f_approx_precise</span><span class="p">(</span><span class="n">fPredicted</span><span class="p">,</span> <span class="n">fActual</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">resulttol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">closeToDisc</span><span class="p">:</span> 
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
        <span class="n">JPredicted</span> <span class="o">=</span> <span class="n">JPredicted_fun</span><span class="p">()</span> 
        
        <span class="n">JActual_</span> <span class="o">=</span> <span class="n">JActual</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
        <span class="n">JPredicted_</span> <span class="o">=</span> <span class="n">JPredicted</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
        <span class="n">jac_precise</span> <span class="o">=</span> <span class="n">jac_approx_precise</span><span class="p">(</span><span class="n">JPredicted_</span><span class="p">,</span> <span class="n">JActual_</span><span class="p">,</span> <span class="n">J_</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">jac_precise</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="n">JActual</span>
        
        
    
    <span class="k">def</span> <span class="nf">is_concave_down</span><span class="p">():</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether the profile likelihood function is concave down.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span>
    
    <span class="c1"># variable definitions -------------------------------------------------</span>
    <span class="n">x</span><span class="p">:</span>      <span class="s2">&quot;parameter vector at current iteration&quot;</span>      <span class="o">=</span> <span class="n">x0</span>
    <span class="n">xTmp</span><span class="p">:</span>   <span class="s2">&quot;potential new parameter vector&quot;</span>
    <span class="n">xi</span><span class="p">:</span>     <span class="s2">&quot;parameter of interest at current iteration&quot;</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">f</span><span class="p">:</span>      <span class="s2">&quot;log-likelihood at current iteration&quot;</span>        <span class="o">=</span> <span class="n">fun0</span>
    <span class="n">J</span><span class="p">:</span>      <span class="s2">&quot;gradient at current iteration&quot;</span>              <span class="o">=</span> <span class="n">jac0</span>
    <span class="n">H</span><span class="p">:</span>      <span class="s2">&quot;Hessian at current iteration&quot;</span>               <span class="o">=</span> <span class="n">hess0</span>
    <span class="n">maxFun</span><span class="p">:</span> <span class="s2">&quot;maximal log-likelihood&quot;</span>                     <span class="o">=</span> <span class="n">fun0</span>
    <span class="n">xi_max</span><span class="p">:</span> <span class="s2">&quot;maximal value for the parameter of interest with f(xi, x_) &gt;= f*&quot;</span>    <span class="o">=</span> <span class="n">xi</span>
    <span class="n">x_max</span><span class="p">:</span>  <span class="s2">&quot;parameter vector where xi_max leads to a log-likelihood value &gt;= f*&quot;</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">considered</span><span class="p">:</span>     <span class="s2">&quot;Array indexing nuisance parameters&quot;</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">considered</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="o">=</span> <span class="kc">False</span>
    <span class="n">consideredOriginal</span> <span class="o">=</span> <span class="n">considered</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">hessConsidered</span><span class="p">:</span> <span class="s2">&quot;Array indexing nuisance Hessian&quot;</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">considered</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>
    <span class="n">H_</span><span class="p">:</span>     <span class="s2">&quot;nuisance Hessian&quot;</span>                           <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">hessConsidered</span><span class="p">]</span>
    <span class="n">H0_</span><span class="p">:</span>    <span class="s2">&quot;nuisance entries of Hessian row corresponding to the parameter of interest&quot;</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">considered</span><span class="p">]</span>
    <span class="n">discontinuity_counter</span><span class="p">:</span> <span class="s2">&quot;steps until discontinuous parameters are released&quot;</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maximizing</span><span class="p">:</span> <span class="s2">&quot;flag to memorize whether the target has been changed temporarily&quot;</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">resultmode</span><span class="p">:</span> <span class="s2">&quot;denotes whether or what kind of result has been found&quot;</span> <span class="o">=</span> <span class="s2">&quot;searching&quot;</span>
    <span class="n">radius</span><span class="p">:</span> <span class="s2">&quot;radius of the trust region in the last iteration&quot;</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">closeToDisc</span><span class="p">:</span> <span class="s2">&quot;True if we ar close to a discontinuity&quot;</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">free_params_exist</span><span class="p">:</span> <span class="s2">&quot;True if the nuisance Hessian does not have full rank&quot;</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nuisance_dim</span><span class="p">:</span> <span class="s2">&quot;dimension of the nuisance vector&quot;</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span>
    <span class="n">xi_hist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">f_hist</span> <span class="o">=</span> <span class="p">[]</span>
    
    
    <span class="n">subproblem</span> <span class="o">=</span> <span class="n">FlexibleSubproblem</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> 
             <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">f</span><span class="p">,</span> 
             <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">J_</span> <span class="o">-</span> <span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">)</span><span class="o">*</span><span class="n">H0_</span><span class="p">,</span>
             <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">H_</span>
             <span class="p">)</span>
    
    
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>                        <span class="c1"># just to prevent a possible name error...</span>
    <span class="n">xiRadius</span> <span class="o">=</span> <span class="n">nuisanceRadius</span>
        
    <span class="c1"># Wrapper to catch potential errors without braking down completely</span>
    <span class="k">try</span><span class="p">:</span>    
        <span class="c1"># ----- ITERATIONS -----------------------------------------------------</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            
            <span class="n">redoIteration</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ballsearch</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">jacDiscont</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">infstepTmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">infstep</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
            <span class="c1">#closeToDisc = False</span>
            
            <span class="k">if</span> <span class="n">track_x</span><span class="p">:</span>
                <span class="n">x_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">track_f</span><span class="p">:</span>
                <span class="n">f_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
            <span class="c1"># if discontinuities are found, some parameters are held constant</span>
            <span class="c1"># for a while. The discontinuity_counter keeps track of the time</span>
            <span class="k">if</span> <span class="n">discontinuity_counter</span><span class="p">:</span>
                <span class="n">discontinuity_counter</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">considered</span> <span class="o">=</span> <span class="n">consideredOriginal</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">hessConsidered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">considered</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>
                <span class="n">relax_maximum_constraint</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            
            <span class="c1"># determine approximation</span>
            <span class="n">J_</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">H0</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">H0_</span> <span class="o">=</span> <span class="n">H0</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
            <span class="n">H00</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">H_</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">hessConsidered</span><span class="p">]</span>
            
            <span class="c1"># Determine search mode:</span>
            <span class="c1"># max_nuisance:  set xi to specific value, maximize other parameters</span>
            <span class="c1"># max_nuisance_const:  hold xi constant, maximize other parameters</span>
            <span class="c1"># normal:        search x with f(x) = f*, J(x) = 0</span>
            <span class="c1"># binary search: get back to the adissible region with a binary </span>
            <span class="c1">#                search</span>
            <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance&quot;</span>
            <span class="n">negDefinite</span><span class="p">,</span> <span class="n">singular</span> <span class="o">=</span> <span class="n">is_negative_semidefinite_</span><span class="p">(</span><span class="n">H_</span><span class="p">,</span> <span class="n">return_singular</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">negDefinite</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">singular</span><span class="p">:</span>
                    <span class="n">H_inv</span><span class="p">,</span> <span class="n">rank</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">pinvh</span><span class="p">(</span><span class="n">H_</span><span class="p">,</span> <span class="n">singtol</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">return_rank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    
                    <span class="c1"># This should be true in genera; however, we use a different</span>
                    <span class="c1"># method to check for singularity here. Hence, we rather </span>
                    <span class="c1"># double check that...</span>
                    <span class="n">free_params_exist</span> <span class="o">=</span> <span class="n">rank</span> <span class="o">==</span> <span class="n">nuisance_dim</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rank</span> <span class="o">=</span> <span class="n">nuisance_dim</span>
                    <span class="n">free_params_exist</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">H_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">H_</span><span class="p">)</span>
                    
                <span class="c1"># in theory, the inverse of a negative definite matrix is also</span>
                <span class="c1"># negative definite. However, due to numerical issues this</span>
                <span class="c1"># may not hold here, if the matrix has unfavourable properties.</span>
                <span class="c1"># Therefore, we rather double check that...</span>
                <span class="k">if</span> <span class="n">is_negative_semidefinite_</span><span class="p">(</span><span class="n">H_inv</span><span class="p">):</span>
                    <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span>
                
            <span class="c1"># ----- NORMAL SEARCH ----------------------------------------------   </span>
            <span class="k">while</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
                
                <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">H00</span> <span class="o">-</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">H0_</span><span class="p">,</span> <span class="n">H_inv</span><span class="p">,</span> <span class="n">H0_</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">H0_</span><span class="p">,</span> <span class="n">H_inv</span><span class="p">,</span> <span class="n">J_</span><span class="p">))</span>
                <span class="n">fPL0</span><span class="p">:</span> <span class="s2">&quot;current value on profile log-likelihood&quot;</span> 
                <span class="n">fPL0</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">J_</span><span class="p">,</span> <span class="n">H_inv</span><span class="p">,</span> <span class="n">J_</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
                
                <span class="k">if</span> <span class="n">maximizing</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">is_concave_down</span><span class="p">()</span> 
                            <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span> <span class="ow">and</span> 
                                     <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(((</span><span class="n">fPL0</span><span class="o">-</span><span class="n">target</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> 
                                                 <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">))</span>
                            <span class="p">)</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
                        <span class="n">maximizing</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">targetTmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fPL0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">maxFun</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">maximizing</span><span class="p">:</span>
                    <span class="n">targetTmp</span> <span class="o">=</span> <span class="n">target</span>
                    
                <span class="n">q</span> <span class="o">=</span> <span class="n">fPL0</span> <span class="o">-</span> <span class="n">targetTmp</span>
                
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sqroot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sqroot</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">q</span><span class="o">/</span><span class="n">a</span> 
                
                
                <span class="c1"># if desired point is not on approximation</span>
                <span class="k">if</span> <span class="n">sqroot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span> 
                            <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">singtol</span><span class="p">)</span> <span class="o">==</span> <span class="n">rank</span><span class="p">):</span> 
                            <span class="c1">#                                )[index]):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">maximizing</span> <span class="ow">and</span> <span class="n">a</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">targetTmp</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The current function value is not on the approximation. &quot;</span>
                                          <span class="o">+</span> <span class="s2">&quot;This may be due to a too large singtol. &quot;</span>
                                          <span class="o">+</span> <span class="s2">&quot;The algorithm may not converge. Index=&quot;</span> 
                                          <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;; forward=&quot;</span> 
                                          <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">forward</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;; a=&quot;</span> 
                                          <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;; f=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                                          <span class="o">+</span> <span class="s2">&quot;; root=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sqroot</span><span class="p">))</span>
                        
                        <span class="k">assert</span> <span class="ow">not</span> <span class="n">maximizing</span>
                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_concave_down</span><span class="p">()</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                            <span class="c1"># if beyond or very close to a local min</span>
                            <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="o">-</span><span class="n">p</span><span class="o">/</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">singtol</span><span class="p">:</span>
                                <span class="n">maximizing</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># jump over minimum by factor 2</span>
                                <span class="n">p</span> <span class="o">*=</span> <span class="mi">2</span>
                            
                        <span class="n">sqroot</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># if f is approximately constant, we do not trust the </span>
                    <span class="c1"># quadratic approximation too much and jsut try a very long</span>
                    <span class="c1"># step, even if it goes beyond the predicted admissible </span>
                    <span class="c1"># region</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">sqroot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">sqroot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sqroot</span><span class="p">)</span>
                
                <span class="c1"># if Hessian is singular in the considered component</span>
                <span class="c1"># this control is important to prevent numerical errors if</span>
                <span class="c1"># |a| &lt;&lt; 1 and the summands of the root are equal order of </span>
                <span class="c1"># magnitude</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span> <span class="ow">and</span> 
                        <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">((</span><span class="n">q</span><span class="o">/</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">maximizing</span> <span class="ow">and</span> <span class="n">q</span><span class="o">*</span><span class="n">p</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">maximizing</span> <span class="ow">and</span> 
                                                    <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">q</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">maximizing</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">maximizing</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">-</span> <span class="n">q</span><span class="o">/</span><span class="n">p</span>
                <span class="c1"># control for NaN case</span>
                <span class="k">elif</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xi1</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="o">/</span><span class="n">a</span> <span class="o">+</span> <span class="n">sqroot</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">xi2</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="o">/</span><span class="n">a</span> <span class="o">-</span> <span class="n">sqroot</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    
                    <span class="c1"># check which root is closer to current value</span>
                    <span class="k">if</span> <span class="n">is_concave_down</span><span class="p">():</span> <span class="c1">#not maximizing</span>
                        <span class="k">assert</span> <span class="ow">not</span> <span class="n">maximizing</span>
                        <span class="n">xiTmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">p</span><span class="o">*</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">maximizing</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                        <span class="n">maximizing</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">maximizing</span> <span class="ow">and</span> <span class="n">p</span><span class="o">/</span><span class="n">a</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">singtol</span><span class="p">:</span>
                        <span class="n">maximizing</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">maximizing</span><span class="p">:</span>
                        <span class="n">xiTmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">xi1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">xi2</span><span class="p">):</span> 
                            <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi2</span>
                <span class="k">if</span> <span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">f</span><span class="o">&gt;</span><span class="n">target</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;asdasdasdasd&quot;</span><span class="p">)</span>
                
                <span class="c1"># if likelihood is independent of parameter</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">infstep</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">singtol</span><span class="p">):</span>
                    
                    
                    <span class="c1"># try a very large xi value</span>
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">infstepTmp</span>
                    <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">xiTmp</span>
                    <span class="n">xTmp</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H_inv</span><span class="p">,</span> <span class="n">H0_</span><span class="o">*</span><span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">)</span><span class="o">+</span><span class="n">J_</span><span class="p">)</span>
                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                    
                    <span class="c1"># if still larger than target</span>
                    <span class="k">if</span> <span class="n">fActual</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                        <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                        <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;unbounded&quot;</span>
                        <span class="k">break</span> 
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">J_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">singtol</span><span class="p">:</span>
                            <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance&quot;</span>
                            <span class="k">break</span> 
                        
                        <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;binary_search&quot;</span>
                        <span class="k">break</span> 
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xiTmp</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">xi</span><span class="o">/</span><span class="mi">4</span>
                
                <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">xiTmp</span>
                <span class="n">xTmp</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H_inv</span><span class="p">,</span> <span class="n">H0_</span><span class="o">*</span><span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">)</span><span class="o">+</span><span class="n">J_</span><span class="p">)</span>
                
                <span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
                <span class="n">upperRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">xTmp</span><span class="p">[</span><span class="n">considered</span><span class="p">])</span>
                
                <span class="c1"># Test precision</span>
                <span class="n">stop</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="n">JActual</span> <span class="o">=</span> <span class="n">test_precision</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
                    <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">upperRadius</span><span class="p">)</span>
                    <span class="k">break</span>
                
                <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;=</span> <span class="n">upperRadius</span><span class="p">:</span>
                    <span class="n">lowerRadius</span> <span class="o">=</span> <span class="n">upperRadius</span><span class="o">/</span><span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lowerRadius</span> <span class="o">=</span> <span class="n">radius</span>
                
                <span class="k">if</span> <span class="n">upperRadius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">radius</span> <span class="o">=</span> <span class="n">upperRadius</span>
                
                <span class="n">tmpRadius</span> <span class="o">=</span> <span class="n">lowerRadius</span>
                <span class="n">xiStep</span> <span class="o">=</span> <span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span>
                
                <span class="k">if</span> <span class="n">tmpRadius</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">xiStep</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">infstep</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">xiStep</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">tmpRadius</span><span class="o">/</span><span class="n">radius</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radiusFactor</span><span class="p">))</span>
                
                <span class="n">ballsearch</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
                    
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resultmode</span><span class="o">==</span><span class="s2">&quot;searching&quot;</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xTmp</span>
                <span class="n">J</span> <span class="o">=</span> <span class="n">JActual</span>
                <span class="n">JActual_</span> <span class="o">=</span> <span class="n">JActual</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">fActual</span>
                <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span> <span class="ow">and</span> <span class="n">free_params_exist</span><span class="p">:</span>
                <span class="n">J_new</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">JPredicted_fun</span><span class="p">()[</span><span class="n">considered</span><span class="p">])</span>
                <span class="n">J_current</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">])</span>
                
                <span class="c1"># if ignoring the free parameters hinders us from making an </span>
                <span class="c1"># improvement w.r.t. the gradient</span>
                <span class="n">abstol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">)</span>
                             <span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">maxFun</span><span class="o">-</span><span class="n">target</span><span class="p">),</span> <span class="n">resulttol</span><span class="p">)</span>
                <span class="c1">#if (J_new &gt; abstol and J_new/J_current &gt; apprxtol):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">J_new</span> <span class="o">&gt;</span> <span class="n">abstol</span> <span class="ow">and</span> <span class="n">J_new</span><span class="o">/</span><span class="n">J_current</span> <span class="o">&gt;</span> <span class="n">apprxtol</span><span class="p">):</span>
                    <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance&quot;</span>            
            
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">repeat</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="n">repeat</span><span class="p">:</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Infinite loop&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>
                
                <span class="c1"># ----- CONSTRAINED MAXIMIZATION -----------------------------------</span>
                <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span> <span class="ow">or</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span><span class="p">:</span>
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span>
                    <span class="n">tmpRadius</span> <span class="o">=</span> <span class="n">nuisanceRadius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">J_</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">ballsearch</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                            <span class="n">xiTmp</span> <span class="o">+=</span> <span class="n">xiRadius</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance_const&quot;</span>
                    
                <span class="c1"># ----- BALL SEARCH ------------------------------------------------   </span>
                <span class="k">if</span> <span class="n">ballsearch</span><span class="p">:</span>
                    <span class="n">increaseTrustRegion</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">xiPrev</span> <span class="o">=</span> <span class="n">xi</span>
                    <span class="n">nAdjustement</span> <span class="o">=</span> <span class="mi">5</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchecks</span><span class="p">):</span>
                        
                        <span class="c1"># it can happen that the radius is so conservative that</span>
                        <span class="c1"># the nuisance parameters cannot be maximized </span>
                        <span class="c1"># sufficiently far to keep f in the admissible region</span>
                        <span class="n">nRatioAdjustement</span> <span class="o">=</span> <span class="mi">10</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nRatioAdjustement</span><span class="p">):</span>
                            <span class="c1">#print(&quot;tmpRadius&quot;, tmpRadius)</span>
                            <span class="n">xTmp_diff</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">subproblem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">tmpRadius</span><span class="p">,</span> 
                                                            <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                                                            <span class="n">jac0tol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">xi</span> <span class="o">&gt;</span> <span class="n">xiTmp</span> <span class="ow">and</span> <span class="n">f</span><span class="o">&gt;</span><span class="n">target</span><span class="p">:</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a, p&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;q, fPL0&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">fPL0</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;targetTmp&quot;</span><span class="p">,</span> <span class="n">targetTmp</span><span class="p">)</span>
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xiTmp, xi&quot;</span><span class="p">,</span> <span class="n">xiTmp</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
                            <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">xiTmp</span>
                            <span class="n">xTmp</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span> <span class="o">+=</span> <span class="n">xTmp_diff</span>
                            <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
                            
                            <span class="c1"># if we maximize w.r.t. the nuisance parameters,</span>
                            <span class="c1"># we want to assure that f gets increased to get</span>
                            <span class="c1"># back to the likelihood ridge</span>
                            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span> <span class="ow">and</span> 
                                    <span class="ow">not</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span><span class="p">):</span>
                                <span class="k">break</span>
                            <span class="n">precise</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="n">JActual</span> <span class="o">=</span> <span class="n">test_precision</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">fPredicted</span> <span class="o">&gt;=</span> <span class="n">f</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="c1"># if the step is super close and f still does not </span>
                            <span class="c1"># increase, there must be a numerical issue. We</span>
                            <span class="c1"># leave the treatment of this issue to the procedures</span>
                            <span class="c1"># below.</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">xiTmp</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">minstep</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tmpRadius</span><span class="o">&lt;</span><span class="n">minstep</span><span class="o">/</span><span class="mi">100</span><span class="p">):</span>
                                <span class="k">break</span>
                            
                            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">nRatioAdjustement</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                                <span class="n">xiPrev</span> <span class="o">=</span> <span class="n">xiTmp</span>
                                <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># we either increase the search radius for the</span>
                                <span class="c1"># nuisance parameters or decrease the search</span>
                                <span class="c1"># radius for the parameter of interest dependent</span>
                                <span class="c1"># on whether the approximation is precise and</span>
                                <span class="c1"># we can increase the trust region or not</span>
                                <span class="k">if</span> <span class="n">increaseTrustRegion</span> <span class="ow">and</span> <span class="n">precise</span> <span class="ow">and</span> <span class="n">tmpRadius</span> <span class="o">&lt;</span> <span class="n">maxRadius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xTmp_diff</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                                    <span class="n">tmpRadius</span> <span class="o">*=</span> <span class="mi">2</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># if the error occurs even though xi is </span>
                                    <span class="c1"># constant, there must be an error in the </span>
                                    <span class="c1"># approximate solution and we decrease the</span>
                                    <span class="c1"># search radius</span>
                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">xiTmp</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">minstep</span><span class="o">/</span><span class="mi">100</span><span class="p">):</span>
                                        <span class="n">tmpRadius</span> <span class="o">/=</span> <span class="mi">5</span>
                                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="o">+</span><span class="n">xiTmp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                                    
                        <span class="c1"># if maximizing w.r.t. the nuisance parameters,</span>
                        <span class="c1"># adjust the trust region</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span> <span class="ow">or</span> 
                                <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">precise</span><span class="p">:</span>
                                <span class="c1"># update trust region</span>
                                <span class="n">nuisanceRadius</span> <span class="o">=</span> <span class="n">tmpRadius</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">J_</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                                <span class="c1"># update xiRadius only if we have changed xi</span>
                                <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">xi</span> <span class="o">!=</span> <span class="n">xiTmp</span><span class="p">:</span>
                                        <span class="n">xiRadius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">,</span> <span class="n">minstep</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># if we had to set xiRadius to 0, we set </span>
                                        <span class="c1"># it to the last non-zero value</span>
                                        <span class="n">xiRadius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xiPrev</span><span class="o">-</span><span class="n">xi</span><span class="p">,</span> <span class="n">minstep</span><span class="p">)</span>
                                    <span class="c1"># since the xiRadius cannot recover on its</span>
                                    <span class="c1"># own, we always gradually increase it</span>
                                    <span class="k">if</span> <span class="mi">2</span><span class="o">*</span><span class="n">xiRadius</span> <span class="o">&lt;</span> <span class="n">nuisanceRadius</span><span class="p">:</span>
                                        <span class="n">xiRadius</span> <span class="o">*=</span> <span class="mi">2</span>
                                
                                <span class="c1"># if we have not decreased the trust region </span>
                                <span class="c1"># before, try to increase it</span>
                                <span class="k">if</span> <span class="n">increaseTrustRegion</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nAdjustement</span><span class="p">:</span>
                                    <span class="n">xTmp2</span> <span class="o">=</span> <span class="n">xTmp</span>
                                    <span class="n">fActual2</span> <span class="o">=</span> <span class="n">fActual</span>
                                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">xiRadius</span>
                                    <span class="n">tmpRadius</span> <span class="o">*=</span> <span class="mi">2</span>
                                    <span class="n">tmpRadius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxRadius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xTmp_diff</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
                                                    <span class="n">tmpRadius</span><span class="p">)</span>
                                    <span class="k">continue</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">increaseTrustRegion</span><span class="p">:</span> 
                                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
                                        <span class="c1"># if in the first iteration, note that </span>
                                        <span class="c1"># we are decreasing the trust region</span>
                                        <span class="n">increaseTrustRegion</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># set xTmp to the last precise value</span>
                                        <span class="n">fActual</span> <span class="o">=</span> <span class="n">fActual2</span>
                                        <span class="n">xTmp</span> <span class="o">=</span> <span class="n">xTmp2</span>
                                        <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                        <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>    
                            <span class="n">stop</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="n">JActual</span> <span class="o">=</span> <span class="n">test_precision</span><span class="p">()</span>
                        
                        <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
                            
                            <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
                                <span class="c1"># if the approximation is precise, we may increase</span>
                                <span class="c1"># the radius, but save the largest current result</span>
                                <span class="c1"># to fall back to</span>
                                <span class="n">xTmp2</span> <span class="o">=</span> <span class="n">xTmp</span>
                                <span class="n">fActual2</span> <span class="o">=</span> <span class="n">fActual</span>
                                <span class="n">lowerRadius</span> <span class="o">=</span> <span class="n">tmpRadius</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">upperRadius</span> <span class="o">=</span> <span class="n">tmpRadius</span>
                                
                            <span class="c1"># if we have to decrease the trust region</span>
                            <span class="k">if</span> <span class="n">upperRadius</span> <span class="o">&lt;=</span> <span class="n">lowerRadius</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">:</span>
                                <span class="c1"># continue with the continuity checks and</span>
                                <span class="c1"># cut the trust trust region by half</span>
                                <span class="k">pass</span>
                            <span class="c1"># if precision of geometric binary search is as </span>
                            <span class="c1"># desired (first equality necessary to prevent NaNs)</span>
                            <span class="k">elif</span> <span class="n">upperRadius</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">upperRadius</span><span class="o">/</span><span class="n">lowerRadius</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="c1"># stop iteration and set xTmp to the optimal </span>
                                <span class="c1"># value</span>
                                <span class="k">if</span> <span class="n">lowerRadius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">radius</span> <span class="o">=</span> <span class="n">lowerRadius</span>
                                <span class="n">fActual</span> <span class="o">=</span> <span class="n">fActual2</span>
                                <span class="n">xTmp</span> <span class="o">=</span> <span class="n">xTmp2</span>
                                <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># update xiTmp and radius</span>
                                <span class="n">tmpRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lowerRadius</span><span class="o">*</span><span class="n">upperRadius</span><span class="p">)</span>
                                <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">xiStep</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">tmpRadius</span><span class="o">/</span><span class="n">radius</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radiusFactor</span><span class="p">))</span>
                                <span class="k">continue</span>
                        <span class="k">elif</span> <span class="n">stop</span><span class="p">:</span>
                            <span class="k">break</span>
                        
                        <span class="n">minstepTmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">minstep</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">J_</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1e-12</span><span class="p">)</span>
                        <span class="c1">#if (not searchmode==&quot;normal&quot; or maximizing) and not closeToDisc:</span>
                        <span class="c1">#    minstepTmp *= 1000</span>
                        
                        <span class="c1"># if the step is too small</span>
                        <span class="n">diffs</span> <span class="o">=</span> <span class="n">xTmp</span> <span class="o">-</span> <span class="n">x</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">stop</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">xTmp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">minstepTmp</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">):</span>
                            
                            <span class="c1"># if we are not really on a discontinuity but only </span>
                            <span class="c1"># on a local maximum with a non-negative definite</span>
                            <span class="c1"># Hessian, we may just release the constraint</span>
                            <span class="c1"># that we need to get to a larger function value</span>
                            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;normal&quot;</span> <span class="ow">or</span> <span class="n">maximizing</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">closeToDisc</span><span class="p">:</span> 
                                <span class="n">relax_maximum_constraint</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">discontinuity_counter</span> <span class="o">=</span> <span class="mi">20</span>
                                <span class="k">if</span> <span class="n">test_precision</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="k">break</span>
                                
                            <span class="c1"># check parameter of interest first</span>
                            <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diffs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            
                            <span class="c1"># if small change in parameter of interest makes </span>
                            <span class="c1"># approximation imprecise</span>
                            <span class="k">if</span> <span class="n">diffs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">test_precision</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                                
                                <span class="c1"># make sure discontinuity happens on </span>
                                <span class="c1"># profile function</span>
                                <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">resulttol</span><span class="p">:</span>
                                    <span class="n">relax_maximum_constraint</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance_const&quot;</span>
                                    <span class="n">closeToDisc</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">xiDisc</span> <span class="o">=</span> <span class="n">xi</span>
                                    <span class="n">repeat</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">radius</span> <span class="o">=</span> <span class="n">tmpRadius</span>
                                    <span class="k">break</span>
                                
                                <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                                <span class="n">fCloseTarget</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> 
                                                            <span class="n">atol</span><span class="o">=</span><span class="n">resulttol</span><span class="p">)</span> <span class="ow">and</span>
                                                <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> 
                                                                <span class="n">atol</span><span class="o">=</span><span class="n">resulttol</span><span class="p">))</span>
                                
                                <span class="c1"># if step is favourable or benign, we accept </span>
                                <span class="c1"># depending on the distance measure this case</span>
                                <span class="c1"># will never occur, as favourable steps may </span>
                                <span class="c1"># always be classified as precise</span>
                                <span class="k">if</span> <span class="n">fActual</span> <span class="o">&gt;=</span> <span class="n">target</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">fActual</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="c1"># if the target is on the jump</span>
                                <span class="k">elif</span> <span class="p">((</span><span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span> <span class="ow">or</span> <span class="n">fCloseTarget</span><span class="p">)</span>
                                      <span class="ow">and</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">):</span>
                                    <span class="c1"># stop here</span>
                                    <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
                                    <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;discontinuous&quot;</span>
                                    <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span>
                                    <span class="n">JActual</span> <span class="o">=</span> <span class="n">J</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># get back to the feasible region by </span>
                                    <span class="c1"># conducting a binary search</span>
                                    <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;binary_search&quot;</span>
                                    
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iter </span><span class="si">{:3d}{}</span><span class="s2">: ***discontinuity of </span><span class="si">{}</span><span class="s2"> in x_</span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2">***&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-</span><span class="n">fActual</span><span class="p">,</span> 
                                            <span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                                <span class="k">break</span>
                            
                            <span class="c1"># check for discontinuities in nuisance parameters</span>
                            <span class="n">discontinuities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">considered</span><span class="p">)</span>
                            <span class="n">discontinuities_rejected</span> <span class="o">=</span> <span class="n">discontinuities</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">f_approx_precise</span><span class="p">(</span><span class="n">fPredicted</span><span class="p">,</span> <span class="n">fActual</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">diffs</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                                    <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
                                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fActual</span> <span class="o">=</span> <span class="n">f</span>
                                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">considered</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="n">xTmp</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diffs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                                    <span class="n">fActual_previous</span> <span class="o">=</span> <span class="n">fActual</span>
                                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                                    <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f_approx_precise</span><span class="p">(</span><span class="n">fPredicted</span><span class="p">,</span> <span class="n">fActual</span><span class="p">):</span>
                                        <span class="n">discontinuities</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">if</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">fActual_previous</span><span class="p">:</span>
                                            <span class="n">discontinuities_rejected</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="n">xTmp</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                                            <span class="n">fActual</span> <span class="o">=</span> <span class="n">fActual_previous</span>
                                <span class="n">jacDiscont</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="c1"># if the gradient is responsible for the rejection</span>
                            <span class="c1"># we require a smaller steap</span>
                            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">resulttol</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">xTmp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">minstepTmp</span><span class="o">/</span><span class="mi">10</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">considered</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="n">xTmp</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diffs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                                    <span class="n">JActual_previous</span> <span class="o">=</span> <span class="n">JActual</span>
                                    <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span> 
                                    <span class="n">JPredicted</span> <span class="o">=</span> <span class="n">JPredicted_fun</span><span class="p">()</span>
                                    <span class="n">jac_precise</span> <span class="o">=</span> <span class="n">jac_approx_precise</span><span class="p">(</span><span class="n">JPredicted</span><span class="p">[</span><span class="n">considered</span><span class="p">],</span> <span class="n">JActual</span><span class="p">[</span><span class="n">considered</span><span class="p">],</span> <span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">])</span> 
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">jac_precise</span><span class="p">:</span>
                                        <span class="n">discontinuities</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">JActual_previous</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">J</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> 
                                                <span class="ow">or</span> <span class="n">diffs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">J</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
                                            <span class="n">discontinuities_rejected</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="n">xTmp</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                                            <span class="n">JActual</span> <span class="o">=</span> <span class="n">JActual_previous</span>
                                <span class="n">jacDiscont</span> <span class="o">=</span> <span class="kc">True</span>
                            

                            <span class="k">if</span> <span class="n">discontinuities</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                
                                <span class="n">varStr</span> <span class="o">=</span> <span class="s2">&quot;variables&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">jacDiscont</span> <span class="k">else</span> <span class="s2">&quot;gradient entries&quot;</span>
                                    
                                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iter </span><span class="si">{:3d}{}</span><span class="s2">: ***index=</span><span class="si">{}</span><span class="s2">: discontinuities in </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2">***&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">varStr</span><span class="p">,</span>
                                            <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">discontinuities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">))</span>
                                
                                <span class="n">redoIteration</span> <span class="o">=</span> <span class="n">discontinuities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="n">discontinuities_rejected</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                                
                                <span class="k">if</span> <span class="n">discontinuities_rejected</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                    <span class="n">discontinuity_counter</span> <span class="o">=</span> <span class="mi">25</span>
                                    <span class="n">considered</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">discontinuities_rejected</span>
                                    <span class="n">hessConsidered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">considered</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>
                                    <span class="n">relax_maximum_constraint</span> <span class="o">=</span> <span class="kc">False</span>
                                
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">tmpRadius</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">radiusFactor</span><span class="o">**</span><span class="n">nchecks</span><span class="o">-</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">minstep</span><span class="p">:</span>
                            <span class="n">tmpRadius</span> <span class="o">/=</span> <span class="mi">5</span>
                            <span class="n">xiTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="o">+</span><span class="n">xiTmp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tmpRadius</span> <span class="o">/=</span> <span class="n">radiusFactor</span>
                            <span class="n">xiTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="o">+</span><span class="n">xiTmp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                        
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span>
                        <span class="n">JActual</span> <span class="o">=</span> <span class="n">J</span>
                        <span class="n">fActual</span> <span class="o">=</span> <span class="n">f</span>
            
            <span class="k">if</span> <span class="n">redoIteration</span><span class="p">:</span>
                <span class="k">continue</span>
                    
            <span class="c1"># ----- BINARY SEARCH ----------------------------------------------</span>
            <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;binary_search&quot;</span><span class="p">:</span>
                <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.01</span>
                <span class="n">bin_min</span> <span class="o">=</span> <span class="n">x</span>
                <span class="n">bin_max</span> <span class="o">=</span> <span class="n">x_max</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchecks</span><span class="p">):</span>
                    <span class="n">xTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_max</span><span class="o">+</span><span class="n">bin_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">fActual</span> <span class="o">-</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="k">break</span>
                    
                    <span class="k">if</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
                        <span class="n">bin_min</span> <span class="o">=</span> <span class="n">xTmp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bin_max</span> <span class="o">=</span> <span class="n">xTmp</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">xTmp</span> <span class="o">=</span> <span class="n">bin_max</span>
                <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                        
                        
            <span class="c1"># ----- UPDATES &amp; CEHCKS -------------------------------------------</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">xTmp</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">jacDiscont</span> <span class="ow">and</span> <span class="n">resultmode</span><span class="o">==</span><span class="s2">&quot;searching&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iter </span><span class="si">{:3d}{}</span><span class="s2">: ***no improvement when optimizing x_</span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2">***&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;discontinuous&quot;</span>
            
            
            
            <span class="n">xiChange</span> <span class="o">=</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">xi</span>
            <span class="n">xChange</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xTmp</span><span class="p">)</span>
            
            <span class="c1"># when we are maximizing the nuisance parameters, we may step </span>
            <span class="c1"># farther than the allowedbound</span>
            <span class="k">if</span> <span class="n">xiChange</span> <span class="o">&gt;=</span> <span class="n">infstep</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;unbounded&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span> <span class="ow">or</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span>
                  <span class="ow">or</span> <span class="n">maximizing</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xiChange</span> <span class="o">&lt;</span> <span class="n">nuisance_minstep</span> 
                                      <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="o">+</span><span class="n">resulttol</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xi_hist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xi_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nuisance_minstep</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span> <span class="o">-</span> <span class="n">f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nuisance_minstep</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
                    
                    <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nuisance_minstep</span>
                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">fActual_previous</span> <span class="o">=</span> <span class="n">fActual</span>
                    <span class="n">xTmp_previous</span> <span class="o">=</span> <span class="n">xTmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">while</span> <span class="n">fActual</span> <span class="o">&gt;</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                        <span class="n">fActual_previous</span> <span class="o">=</span> <span class="n">fActual</span>
                        <span class="n">xTmp_previous</span> <span class="o">=</span> <span class="n">xTmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nuisance_minstep</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">m</span>
                        <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                        <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="n">xTmp</span> <span class="o">=</span> <span class="n">xTmp_previous</span>
                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fActual_previous</span>
                    
                    <span class="n">m</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">while</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">-</span><span class="mi">50</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">:</span>
                        <span class="n">fActual_previous</span> <span class="o">=</span> <span class="n">fActual</span>
                        <span class="n">xTmp_previous</span> <span class="o">=</span> <span class="n">xTmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nuisance_minstep</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">m</span>
                        <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                        <span class="n">m</span> <span class="o">-=</span> <span class="mi">1</span>
                    
                    
                    <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                    
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;iter </span><span class="si">{:3d}{}</span><span class="s2">: ***taking additional step in x_</span><span class="si">{}</span><span class="s2"> to avoid convergence issues. f=</span><span class="si">{:6.3}</span><span class="s2">***&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">fActual</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">xi_hist</span><span class="p">[</span><span class="o">-</span><span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-</span><span class="n">xi</span>
                <span class="n">xi_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                <span class="n">f_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fActual</span><span class="p">)</span>
            
            <span class="n">x</span> <span class="o">=</span> <span class="n">xTmp</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">JActual</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
            <span class="n">JImprovement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">])</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">JActual</span><span class="p">[</span><span class="n">considered</span><span class="p">]))</span>
            <span class="n">fImprovement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">fActual</span><span class="o">-</span><span class="n">target</span><span class="p">)))</span>
            
            <span class="n">J</span> <span class="o">=</span> <span class="n">JActual</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fActual</span>
            <span class="n">JActual_</span> <span class="o">=</span> <span class="n">JActual</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
            
            <span class="c1"># reset maximal value</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">xi</span> <span class="o">&gt;</span> <span class="n">xi_max</span><span class="p">:</span>
                <span class="n">xi_max</span> <span class="o">=</span> <span class="n">xi</span>
                <span class="n">x_max</span> <span class="o">=</span> <span class="n">x</span>
            
            <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
                <span class="n">radius_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">maximizing</span><span class="p">:</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;maximizing&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;searching&quot;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span> 
                      <span class="ow">or</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span><span class="p">):</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;maximizing nuisance parameters&quot;</span>
                    <span class="n">radius_str</span> <span class="o">=</span> <span class="s2">&quot;; step=</span><span class="si">{}</span><span class="s2">; radius=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">round_str</span><span class="p">(</span><span class="n">xiRadius</span><span class="p">),</span> <span class="n">round_str</span><span class="p">(</span><span class="n">nuisanceRadius</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;binary_search&quot;</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;binary search&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span>
                
                <span class="n">ndiscont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">considered</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">ndiscont</span><span class="p">:</span>
                    <span class="n">discontStr</span> <span class="o">=</span> <span class="s2">&quot;; ndisct=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndiscont</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">discontStr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    
                <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;iter </span><span class="si">{:3d}{}</span><span class="s2">: x_</span><span class="si">{}</span><span class="s2">_d=</span><span class="si">{}</span><span class="s2">; f_d=</span><span class="si">{}</span><span class="s2">; jac_d=</span><span class="si">{}</span><span class="s2">; &quot;</span> <span class="o">+</span> 
                       <span class="s2">&quot;nsteps=</span><span class="si">{:2d}</span><span class="s2">; x_d=</span><span class="si">{}</span><span class="s2">; f_impr=</span><span class="si">{}</span><span class="s2">; jac_impr=</span><span class="si">{}</span><span class="s2">; &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;f_e=</span><span class="si">{}{}{}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> 
                                                 <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> 
                                                 <span class="n">round_str</span><span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> 
                                                 <span class="n">round_str</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">),</span> 
                                                 <span class="n">round_str</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">JActual_</span><span class="p">)),</span> <span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> 
                                                 <span class="n">round_str</span><span class="p">(</span><span class="n">xChange</span><span class="p">),</span> 
                                                 <span class="n">round_str</span><span class="p">(</span><span class="n">fImprovement</span><span class="p">),</span> 
                                                 <span class="n">round_str</span><span class="p">(</span><span class="n">JImprovement</span><span class="p">),</span> 
                                                 <span class="n">round_str</span><span class="p">(</span><span class="n">fActual</span><span class="o">-</span><span class="n">fPredicted</span><span class="p">),</span> 
                                                 <span class="n">discontStr</span><span class="p">,</span> <span class="n">radius_str</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
            
            
            <span class="k">if</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;searching&quot;</span><span class="p">:</span>
                <span class="n">resViol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">JActual_</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">resViol</span> <span class="o">&lt;=</span> <span class="n">resulttol</span><span class="p">:</span>
                    <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">maxFun</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&gt; iter </span><span class="si">{:3d}{}</span><span class="s2">: !!!found NEW MAXIMUM for x_</span><span class="si">{}</span><span class="s2"> of </span><span class="si">{:6.3f}</span><span class="s2"> (+</span><span class="si">{:6.3f}</span><span class="s2">) at </span><span class="si">{}</span><span class="s2">!!!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">-</span><span class="n">fun0</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="n">maxFun</span> <span class="o">=</span> <span class="n">f</span>
            
            <span class="k">if</span> <span class="n">closeToDisc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">xiDisc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">minstep</span><span class="p">:</span>
                    <span class="n">closeToDisc</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="n">H</span> <span class="o">=</span> <span class="n">hess</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;exceeded&quot;</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;linalg_error&quot;</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">,</span>
                                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">,</span>
                                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

    
    <span class="k">if</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;discontinuous&quot;</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;unbounded&quot;</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;exceeded&quot;</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span> <span class="ow">or</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;linalg_error&quot;</span><span class="p">:</span>
        <span class="c1">#x = x0+np.nan</span>
        <span class="c1">#f = np.nan</span>
        <span class="c1">#JActual_ = x0[considered] + np.nan</span>
        <span class="k">try</span><span class="p">:</span>        
            <span class="n">JActual_</span> <span class="o">=</span> <span class="n">J_</span>
        <span class="k">except</span> <span class="ne">UnboundLocalError</span><span class="p">:</span>
            <span class="n">JActual_</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">]</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">4</span>
    
    <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                             <span class="n">fun</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                             <span class="n">jac</span><span class="o">=</span><span class="n">JActual_</span><span class="p">,</span>
                             <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                             <span class="n">nfev</span><span class="o">=</span><span class="n">fun</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="n">jac</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="n">hess</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> 
                             <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                             <span class="n">message</span><span class="o">=</span><span class="n">STATUS_MESSAGES</span><span class="p">[</span><span class="n">status</span><span class="p">]</span>
                             <span class="p">))</span>
    
    <span class="k">if</span> <span class="n">track_f</span><span class="p">:</span>
        <span class="n">f_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">track_x</span><span class="p">:</span>
        <span class="n">x_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                             <span class="n">fun</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                             <span class="n">jac</span><span class="o">=</span><span class="n">JActual_</span><span class="p">,</span>
                             <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                             <span class="n">nfev</span><span class="o">=</span><span class="n">fun</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="n">jac</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="n">hess</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> 
                             <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                             <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_track</span><span class="p">),</span>
                             <span class="n">f_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_track</span><span class="p">),</span>
                             <span class="n">message</span><span class="o">=</span><span class="n">STATUS_MESSAGES</span><span class="p">[</span><span class="n">status</span><span class="p">]</span>
                             <span class="p">)</span></div>
    
<div class="viewcode-block" id="test2"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.test2">[docs]</a><span class="k">def</span> <span class="nf">test2</span><span class="p">():</span>
    <span class="n">H</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">2.23327686e+03</span><span class="p">,</span><span class="mf">3.99193784e+02</span><span class="p">,</span><span class="mf">4.74986638e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">8.55852404e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">7.08365052e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">3.87178313e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">4.71627573e+00</span><span class="p">,</span><span class="mf">5.01847818e+02</span><span class="p">,</span><span class="mf">1.44515881e-01</span><span class="p">,</span><span class="mf">2.09204344e+02</span><span class="p">,</span><span class="o">-</span><span class="mf">2.02882521e+03</span><span class="p">,</span><span class="mf">6.66055028e+03</span><span class="p">],</span>
<span class="p">[</span><span class="mf">3.99193784e+02</span><span class="p">,</span><span class="o">-</span><span class="mf">2.86681223e+02</span><span class="p">,</span><span class="o">-</span><span class="mf">8.65003524e-02</span><span class="p">,</span><span class="mf">1.57660291e+01</span><span class="p">,</span><span class="mf">1.37304541e+01</span><span class="p">,</span><span class="mf">6.87668109e+00</span><span class="p">,</span><span class="mf">7.85222384e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">8.58418932e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">2.47201778e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">3.48771207e+01</span><span class="p">,</span><span class="mf">3.70636919e+02</span><span class="p">,</span><span class="o">-</span><span class="mf">1.19345238e+03</span><span class="p">],</span>
<span class="p">[</span><span class="mf">4.74986638e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">8.65003524e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">1.64835411e-04</span><span class="p">,</span><span class="mf">1.92763890e-02</span><span class="p">,</span><span class="mf">1.72011648e-02</span><span class="p">,</span><span class="mf">6.75886299e-03</span><span class="p">,</span><span class="mf">8.91626484e-04</span><span class="p">,</span><span class="o">-</span><span class="mf">9.91940354e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">2.85644463e-05</span><span class="p">,</span><span class="o">-</span><span class="mf">4.52167010e-02</span><span class="p">,</span><span class="mf">4.33103480e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">1.41922723e+00</span><span class="p">],</span>
<span class="p">[</span><span class="o">-</span><span class="mf">8.55852404e+01</span><span class="p">,</span><span class="mf">1.57660291e+01</span><span class="p">,</span><span class="mf">1.92763890e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">7.94912934e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">2.12003533e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">8.30980052e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">6.01223691e-02</span><span class="p">,</span><span class="mf">8.52047771e+00</span><span class="p">,</span><span class="mf">2.45365018e-03</span><span class="p">,</span><span class="mf">8.47158090e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">7.95298372e+01</span><span class="p">,</span><span class="mf">2.50601940e+02</span><span class="p">],</span>
<span class="p">[</span><span class="o">-</span><span class="mf">7.08365052e+01</span><span class="p">,</span><span class="mf">1.37304541e+01</span><span class="p">,</span><span class="mf">1.72011648e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">2.12003533e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">7.23593328e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">7.92316206e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">5.74494253e-02</span><span class="p">,</span><span class="mf">8.56654775e+00</span><span class="p">,</span><span class="mf">2.46704626e-03</span><span class="p">,</span><span class="mf">6.51037754e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">6.54960801e+01</span><span class="p">,</span><span class="mf">2.13904934e+02</span><span class="p">],</span>
<span class="p">[</span><span class="o">-</span><span class="mf">3.87178313e+01</span><span class="p">,</span><span class="mf">6.87668109e+00</span><span class="p">,</span><span class="mf">6.75886299e-03</span><span class="p">,</span><span class="o">-</span><span class="mf">8.30980052e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">7.92316206e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">1.29001560e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">5.33347490e-02</span><span class="p">,</span><span class="mf">7.97675579e+00</span><span class="p">,</span><span class="mf">2.29710812e-03</span><span class="p">,</span><span class="mf">3.50273390e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">3.55470579e+01</span><span class="p">,</span><span class="mf">1.19683855e+02</span><span class="p">],</span>
<span class="p">[</span><span class="o">-</span><span class="mf">4.71627573e+00</span><span class="p">,</span><span class="mf">7.85222384e-01</span><span class="p">,</span><span class="mf">8.91626484e-04</span><span class="p">,</span><span class="o">-</span><span class="mf">6.01223691e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">5.74494253e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">5.33347490e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">2.51590522e-02</span><span class="p">,</span><span class="mf">2.16451499e+00</span><span class="p">,</span><span class="mf">6.23292769e-04</span><span class="p">,</span><span class="mf">4.30597816e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">4.06813815e+00</span><span class="p">,</span><span class="mf">1.36888080e+01</span><span class="p">],</span>
<span class="p">[</span><span class="mf">5.01847818e+02</span><span class="p">,</span><span class="o">-</span><span class="mf">8.58418932e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">9.91940354e-02</span><span class="p">,</span><span class="mf">8.52047771e+00</span><span class="p">,</span><span class="mf">8.56654775e+00</span><span class="p">,</span><span class="mf">7.97675579e+00</span><span class="p">,</span><span class="mf">2.16451499e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">4.04649962e+02</span><span class="p">,</span><span class="o">-</span><span class="mf">1.16533068e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">4.51388591e+01</span><span class="p">,</span><span class="mf">4.46790932e+02</span><span class="p">,</span><span class="o">-</span><span class="mf">1.47552673e+03</span><span class="p">],</span>
<span class="p">[</span><span class="mf">1.44515881e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">2.47201778e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">2.85644463e-05</span><span class="p">,</span><span class="mf">2.45365018e-03</span><span class="p">,</span><span class="mf">2.46704626e-03</span><span class="p">,</span><span class="mf">2.29710812e-03</span><span class="p">,</span><span class="mf">6.23292769e-04</span><span class="p">,</span><span class="o">-</span><span class="mf">1.16533068e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">3.37252324e-05</span><span class="p">,</span><span class="o">-</span><span class="mf">1.29984733e-02</span><span class="p">,</span><span class="mf">1.28662083e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">4.24906261e-01</span><span class="p">],</span>
<span class="p">[</span><span class="mf">2.09204344e+02</span><span class="p">,</span><span class="o">-</span><span class="mf">3.48771207e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">4.52167010e-02</span><span class="p">,</span><span class="mf">8.47158090e+00</span><span class="p">,</span><span class="mf">6.51037754e+00</span><span class="p">,</span><span class="mf">3.50273390e+00</span><span class="p">,</span><span class="mf">4.30597816e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">4.51388591e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">1.29984733e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">3.17095991e+01</span><span class="p">,</span><span class="mf">1.88854937e+02</span><span class="p">,</span><span class="o">-</span><span class="mf">6.14833131e+02</span><span class="p">],</span>
<span class="p">[</span><span class="o">-</span><span class="mf">2.02882521e+03</span><span class="p">,</span><span class="mf">3.70636919e+02</span><span class="p">,</span><span class="mf">4.33103480e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">7.95298372e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">6.54960801e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">3.55470579e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">4.06813815e+00</span><span class="p">,</span><span class="mf">4.46790932e+02</span><span class="p">,</span><span class="mf">1.28662083e-01</span><span class="p">,</span><span class="mf">1.88854937e+02</span><span class="p">,</span><span class="o">-</span><span class="mf">2.02882525e+03</span><span class="p">,</span><span class="mf">6.00165782e+03</span><span class="p">],</span>
<span class="p">[</span><span class="mf">6.66055028e+03</span><span class="p">,</span><span class="o">-</span><span class="mf">1.19345238e+03</span><span class="p">,</span><span class="o">-</span><span class="mf">1.41922723e+00</span><span class="p">,</span><span class="mf">2.50601940e+02</span><span class="p">,</span><span class="mf">2.13904934e+02</span><span class="p">,</span><span class="mf">1.19683855e+02</span><span class="p">,</span><span class="mf">1.36888080e+01</span><span class="p">,</span><span class="o">-</span><span class="mf">1.47552673e+03</span><span class="p">,</span><span class="o">-</span><span class="mf">4.24906261e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">6.14833131e+02</span><span class="p">,</span><span class="mf">6.00165782e+03</span><span class="p">,</span><span class="o">-</span><span class="mf">2.02998942e+04</span><span class="p">]]</span>
    <span class="n">J</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">2.39836336e+00</span><span class="p">,</span><span class="mf">4.09572931e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">5.69090295e-04</span><span class="p">,</span><span class="o">-</span><span class="mf">4.22659930e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">4.20388261e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">4.28440455e-02</span><span class="p">,</span><span class="o">-</span><span class="mf">3.82639520e-02</span><span class="p">,</span><span class="mf">1.97355806e+00</span><span class="p">,</span><span class="mf">5.71485452e-04</span><span class="p">,</span><span class="mf">2.16780197e-01</span><span class="p">,</span><span class="o">-</span><span class="mf">2.13385259e+00</span><span class="p">,</span><span class="mf">7.04714512e+00</span><span class="p">]</span>

    <span class="n">H</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="n">J</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">J</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">((</span><span class="n">x</span><span class="p">,</span><span class="n">H</span><span class="p">,</span><span class="n">x</span><span class="p">))</span><span class="o">/</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span> <span class="o">-</span><span class="mf">12156.150521445503</span><span class="o">+</span><span class="mf">12157.95054853</span> 
    
    <span class="k">def</span> <span class="nf">j</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">J</span> 
    <span class="k">def</span> <span class="nf">h</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">H</span>
    
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">J</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">find_CI_bound</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">track_x</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="test"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.test">[docs]</a><span class="k">def</span> <span class="nf">test</span><span class="p">():</span>
    
    <span class="n">Hm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">4.</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>  <span class="mf">4.</span><span class="p">],</span>
                   <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">1</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">4</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span>  <span class="mi">9</span><span class="p">]])</span>
    <span class="n">Hm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">1</span><span class="p">,</span>  <span class="mi">5</span> <span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span>  <span class="mf">3.</span><span class="p">],</span>
                   <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>  <span class="o">-</span><span class="mi">2</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>  <span class="mi">2</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">0</span><span class="p">,</span>  <span class="mi">3</span><span class="p">,</span>  <span class="mi">2</span><span class="p">,</span>  <span class="mi">5</span><span class="p">]])</span>
    <span class="n">Hm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">4.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span>   <span class="o">-</span><span class="mf">1.</span><span class="p">,</span>   <span class="mf">2.</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">1</span><span class="p">,</span>  <span class="o">.</span><span class="mi">25</span><span class="p">,</span> <span class="o">-.</span><span class="mi">25</span><span class="p">,</span>  <span class="o">.</span><span class="mi">5</span><span class="p">],</span>
                   <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="o">-.</span><span class="mi">25</span><span class="p">,</span>  <span class="mi">4</span><span class="p">,</span>   <span class="o">-.</span><span class="mi">5</span><span class="p">],</span>
                   <span class="p">[</span><span class="mi">2</span><span class="p">,</span>  <span class="o">.</span><span class="mi">5</span><span class="p">,</span> <span class="o">-.</span><span class="mi">5</span><span class="p">,</span>  <span class="mi">1</span><span class="p">]])</span>
    <span class="n">Dm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">4.00001</span><span class="p">))</span>
    <span class="n">multi_dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span>
    
    <span class="k">def</span> <span class="nf">f4</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="mf">1e-80</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mf">1e-20</span><span class="o">+</span><span class="n">algopy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="p">((</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">y</span><span class="o">+</span><span class="mf">0.2</span><span class="o">*</span><span class="n">z</span><span class="o">+</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">*</span><span class="n">y</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="p">((</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="p">(</span><span class="mi">5</span><span class="o">+</span><span class="n">y</span><span class="o">+</span><span class="mf">0.2</span><span class="o">*</span><span class="n">z</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">params</span><span class="p">,</span> <span class="n">Hm</span><span class="p">,</span> <span class="n">params</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Dm</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">z</span> <span class="o">+</span> <span class="n">a</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="n">z</span>
        <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">z</span><span class="o">-</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">algopy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="n">x</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="mi">5</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">6</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">algopy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="p">((</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="p">((</span><span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span>   
        <span class="k">return</span> <span class="o">-</span><span class="n">algopy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">10</span> <span class="o">+</span>  <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">z</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">/</span><span class="mi">10000</span> 
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span><span class="n">z</span><span class="o">*</span><span class="n">z</span>  <span class="o">+</span> <span class="n">y</span>
    
    
    <span class="k">def</span> <span class="nf">f3</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">a</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="n">z</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">-</span> <span class="n">x</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y</span> <span class="o">+</span><span class="mi">5</span><span class="o">*</span><span class="n">z</span>
    
    <span class="k">def</span> <span class="nf">f3a</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">params</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">a</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">a</span>
        <span class="k">return</span> <span class="n">f1</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
        
    
    <span class="k">def</span> <span class="nf">F1</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span>
    <span class="k">def</span> <span class="nf">F2</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">params</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span> <span class="c1">#y*y</span>
    
    <span class="n">arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))[:,</span><span class="kc">None</span><span class="p">,</span><span class="kc">None</span><span class="p">]</span>
    
    <span class="k">def</span> <span class="nf">f1</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">*</span><span class="mi">10</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">**</span><span class="mi">3</span>
        <span class="k">return</span> <span class="p">((</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="mi">100</span> <span class="o">+</span> <span class="p">((</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">4</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">y</span><span class="o">*</span><span class="n">y</span>    
        <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">algopy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">/</span><span class="mi">20</span><span class="o">+</span><span class="n">x</span><span class="o">**</span><span class="mi">4</span><span class="o">/</span><span class="mi">5</span><span class="o">-</span><span class="n">x</span><span class="o">**</span><span class="mi">6</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">-</span><span class="mi">30</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span>
        <span class="k">return</span> <span class="n">algopy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">return</span> <span class="n">algopy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mf">100.0</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.0</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)</span>
    
    
    <span class="k">def</span> <span class="nf">ffAppr</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">x</span>
        <span class="n">x</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">x</span>
        <span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">y</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">802.00011956</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="mf">400.00002891</span><span class="o">*</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mi">200</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span> <span class="o">-</span> <span class="mf">4.04854143e-06</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="mf">1.95198457e-06</span><span class="o">*</span><span class="n">y</span> <span class="o">-</span> <span class="mf">1.4750875345706636e-14</span>
    
    <span class="n">ln</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">log</span>
    <span class="c1">#def f6(x):</span>
    <span class="c1">#    k, q, ec, eo = x</span>
    <span class="k">def</span> <span class="nf">f6</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">eo</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">eo</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">eo</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">a1</span> <span class="o">=</span> <span class="n">ec</span><span class="o">*</span><span class="n">eo</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ec</span><span class="p">)</span><span class="o">/</span><span class="mi">100</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">ec</span><span class="o">*</span><span class="n">eo</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ec</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">ln</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="o">*</span><span class="n">ln</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">-</span><span class="p">(</span><span class="n">k</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">ln</span><span class="p">(</span><span class="n">a1</span><span class="o">*</span><span class="n">q</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">-</span><span class="n">k</span><span class="o">*</span><span class="n">ln</span><span class="p">(</span><span class="n">a2</span><span class="o">*</span><span class="n">q</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">+</span><span class="n">ln</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span><span class="o">+</span><span class="n">ln</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
    
    
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">4.</span><span class="p">])</span>
    <span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>
    <span class="n">n</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
    
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">])</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="mi">1</span>
    
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">.</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>
    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">beta</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span><span class="o">/</span><span class="mi">1</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">negative_binomial</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">,</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">eo</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">t</span><span class="o">*</span><span class="p">(</span><span class="n">ec</span><span class="o">*</span><span class="n">eo</span><span class="o">+</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ec</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">negative_binomial</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">q</span><span class="o">+</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">))</span>
    
    <span class="kn">from</span> <span class="nn">algopy_ext</span> <span class="kn">import</span> <span class="n">nbinom_logpmf</span>
    
    
    <span class="k">def</span> <span class="nf">f7</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">eo</span><span class="p">):</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">k</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">eo</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">eo</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span><span class="p">(</span> <span class="n">ec</span><span class="o">*</span><span class="n">eo</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ec</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">algopy</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nbinom_logpmf</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">q</span> <span class="o">+</span> <span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)),</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="c1">#def f(x):</span>
    <span class="c1">#    a, b = x</span>
    <span class="c1">#    return f7(a, 0, 0, b)</span>
    <span class="k">def</span> <span class="nf">f5</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">x</span>
        <span class="k">return</span> <span class="n">f7</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span>
    
    <span class="c1">#f = F1</span>
    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">f3a</span>
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="n">index</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    f = f1</span>
<span class="sd">    x0=np.zeros(2)+0.00000000001</span>
<span class="sd">    index = 0</span>
<span class="sd">    #&quot;&quot;&quot;</span>
    
    <span class="n">ff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">params</span><span class="p">:</span> <span class="o">-</span><span class="n">f</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">nd_algopy</span><span class="o">.</span><span class="n">Gradient</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">jj</span> <span class="o">=</span> <span class="n">nd_algopy</span><span class="o">.</span><span class="n">Gradient</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">nd_algopy</span><span class="o">.</span><span class="n">Hessian</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">hh</span> <span class="o">=</span> <span class="n">nd_algopy</span><span class="o">.</span><span class="n">Hessian</span><span class="p">(</span><span class="n">ff</span><span class="p">)</span>
    
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">hess</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">tt</span><span class="p">():</span>
        <span class="n">k</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">ec</span><span class="p">,</span> <span class="n">eo</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">x</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="o">*</span><span class="n">k</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">ec</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">ec</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">eo</span> <span class="o">=</span> <span class="n">algopy</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">eo</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">+</span><span class="mf">0.5</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">t</span> <span class="o">*</span><span class="p">(</span> <span class="n">ec</span><span class="o">*</span><span class="n">eo</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ec</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
        <span class="c1">#return np.sum(n-</span>
    
    <span class="n">x0</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">x</span> <span class="c1">#+ (np.random.rand(x0.size)-0.5)*0.0001</span>
    <span class="c1">#x0 = np.array([0.,0.])</span>
    
    <span class="c1">#jjj = lambda x: np.ones(3) + np.nan</span>
    
    <span class="c1">#profile_CI_investigation(x0, ff, jj, hh, [&quot;x&quot;, &quot;y&quot;, &quot;z&quot;, &quot;a&quot;], disp=True, vm=False)</span>
    <span class="c1">#print(find_profile_CI(0, x0, ff, jj, hh, -1, vm=False))</span>
    
    <span class="n">target</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">target</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span>
    <span class="n">target</span> <span class="o">=</span> <span class="o">-</span><span class="mi">20</span>
    <span class="c1">#target = -r.fun-2</span>
    
    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="n">r2</span> <span class="o">=</span> <span class="n">find_CI_bound</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">track_x</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r2</span><span class="p">)</span>
    <span class="n">r1</span> <span class="o">=</span> <span class="n">find_CI_bound</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">track_x</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r1</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    from optimize_ext import find_bound</span>
<span class="sd">    r2 = find_bound(index, target, x0, ff, jj, hh, True, nmax=300, track_x=True)</span>
<span class="sd">    print(r2)</span>
<span class="sd">    r1 = find_bound(index, target, x0, ff, jj, hh, False, nmax=300, track_x=True)</span>
<span class="sd">    print(r1)</span>
<span class="sd">    #&quot;&quot;&quot;</span>
    <span class="n">rr1</span> <span class="o">=</span> <span class="n">venzon_moolgavkar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">track_x</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">rr1</span><span class="p">)</span>
    <span class="n">rr2</span> <span class="o">=</span> <span class="n">venzon_moolgavkar</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">ff</span><span class="p">,</span> <span class="n">jj</span><span class="p">,</span> <span class="n">hh</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">track_x</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">rr2</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r1</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">r2</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">r1</span><span class="o">.</span><span class="n">nit</span><span class="p">,</span> <span class="n">r2</span><span class="o">.</span><span class="n">nit</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;[</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">]: </span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">rr1</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">rr2</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">rr1</span><span class="o">.</span><span class="n">nit</span><span class="p">,</span> <span class="n">rr2</span><span class="o">.</span><span class="n">nit</span><span class="p">))</span>
    
    <span class="c1">#print(np.arctan(r1.x[index])/np.pi+0.5, np.arctan(r2.x[index])/np.pi+0.5)</span>
    
    
    <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">z</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">r1</span><span class="o">.</span><span class="n">x_track</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
        
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">r2</span><span class="o">.</span><span class="n">x_track</span><span class="p">:</span>
        <span class="n">x</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">y</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="n">xx</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rr1</span><span class="o">.</span><span class="n">x_track</span><span class="p">:</span>
        <span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">yy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        
    <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rr2</span><span class="o">.</span><span class="n">x_track</span><span class="p">:</span>
        <span class="n">xx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">yy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="c1">#ax = fig.gca(projection=&#39;3d&#39;)</span>
    <span class="c1">#ax.plot(x, y, z)</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
    <span class="c1">#&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">r1</span><span class="o">.</span><span class="n">x_track</span><span class="p">:</span>
        <span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">z</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">r2</span><span class="o">.</span><span class="n">x_track</span><span class="p">:</span>
        <span class="n">z</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">a</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">a</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">z</span> <span class="o">+</span> <span class="n">a</span>
    <span class="c1">#&quot;&quot;&quot;</span>
    
    <span class="n">xmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">xmin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="n">ymax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">ymin</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">xdiff</span> <span class="o">=</span> <span class="n">xmax</span><span class="o">-</span><span class="n">xmin</span>
    <span class="n">ydiff</span> <span class="o">=</span> <span class="n">ymax</span><span class="o">-</span><span class="n">ymin</span>
    
    <span class="n">xmax</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">xdiff</span>
    <span class="n">xmin</span> <span class="o">-=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">xdiff</span>
    <span class="n">ymax</span> <span class="o">+=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">ydiff</span>
    <span class="n">ymin</span> <span class="o">-=</span> <span class="mf">0.1</span><span class="o">*</span><span class="n">ydiff</span>
    
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    xmax = 1.04</span>
<span class="sd">    xmin = 1</span>
<span class="sd">    ymax = -1.02</span>
<span class="sd">    ymin = -1.04</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="nf">qqq</span><span class="p">(</span><span class="n">args</span><span class="p">):</span> 
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">args</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="p">(</span><span class="mf">217.12168835</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mf">105.03247006</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="mf">217.12168835</span><span class="o">*</span><span class="n">x</span><span class="o">-</span><span class="mf">432.2433767</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mf">209.928</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="p">(</span><span class="o">-</span><span class="mf">429.3677</span><span class="p">)</span><span class="o">*</span><span class="n">y</span><span class="o">-</span><span class="mf">208.2143389700666</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>
    <span class="c1">#X = np.linspace(-1.8, -2.1, 300)</span>
    <span class="c1">#Y = np.linspace(-0.2, 1.5, 300)</span>
    <span class="c1">#X = np.linspace(-2, 2, 300)</span>
    <span class="c1">#Y = np.linspace(-2, 2, 300)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="c1">#Z = ff([X, Y])</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="o">-</span><span class="n">f1</span><span class="p">([</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">])</span>
    <span class="c1">#Z = np.maximum(ffAppr([X, Y]), target)</span>
    <span class="c1">#Z = qqq([X, Y])</span>
    <span class="c1">#cmapname = &quot;prism&quot; #&quot;jet&quot;        # ok, aber sehr bunt</span>
    <span class="c1">#cmap = plt.get_cmap(cmapname)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">Z</span><span class="p">,</span> <span class="n">target</span><span class="o">*</span><span class="mf">1.2</span><span class="p">),</span> <span class="n">shading</span><span class="o">=</span><span class="s1">&#39;gouraud&#39;</span><span class="p">)</span> <span class="c1">#cmap=cmap) #, </span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C5&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">Z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="n">target</span><span class="p">])</span> <span class="c1">#cmap=cmap) #, </span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x0</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">marker</span> <span class="o">=</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C3&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">X</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">X</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">Y</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Y</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;x1&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x0&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">xx</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">yy</span><span class="p">)</span>
    
    <span class="c1">#ax.plot_surface(X, Y, Z, rstride=1, cstride=1,</span>
    <span class="c1">#                   linewidth=0, antialiased=True)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="plot3d"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.plot3d">[docs]</a><span class="k">def</span> <span class="nf">plot3d</span><span class="p">():</span>
    <span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
    
    <span class="kn">from</span> <span class="nn">mayavi</span> <span class="kn">import</span> <span class="n">mlab</span>

    
    
    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">xx</span><span class="p">):</span>
        <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">xx</span>
        <span class="k">return</span> <span class="o">-</span><span class="mi">8</span><span class="o">*</span><span class="n">algopy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="n">y</span><span class="p">))</span><span class="o">-</span><span class="mi">4</span><span class="o">*</span><span class="n">algopy</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span><span class="o">+</span><span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">20</span><span class="o">+</span><span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">30</span>
        <span class="k">return</span> <span class="mi">100</span><span class="o">*</span><span class="p">(</span><span class="n">y</span><span class="o">-</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="n">ff</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="o">-</span><span class="n">f</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>
    <span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span> <span class="o">=</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">xmin</span><span class="p">,</span> <span class="n">xmax</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
    <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="mi">40</span><span class="p">)</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="n">Z</span> <span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
    <span class="c1">#Z[Z&lt;-20] = np.nan</span>
    <span class="c1">#plt.pcolormesh(X, Y, np.maximum(Z, -20), shading=&#39;gouraud&#39;) #cmap=cmap) #, </span>
    <span class="c1">#plt.show()    </span>
    
    <span class="n">j</span> <span class="o">=</span> <span class="n">nd_algopy</span><span class="o">.</span><span class="n">Gradient</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">nd_algopy</span><span class="o">.</span><span class="n">Hessian</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    
    
    <span class="n">x0</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">j</span><span class="p">,</span> <span class="n">hess</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">x</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span>
    <span class="n">x0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.65</span>
    
    <span class="n">H</span> <span class="o">=</span> <span class="o">-</span><span class="n">h</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">))</span>
    <span class="n">J</span> <span class="o">=</span> <span class="o">-</span><span class="n">j</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">))</span>
    <span class="n">f0</span> <span class="o">=</span> <span class="o">-</span><span class="n">f</span><span class="p">((</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">))</span>
    <span class="n">h00</span><span class="p">,</span> <span class="n">h01</span><span class="p">,</span> <span class="n">h10</span><span class="p">,</span> <span class="n">h11</span> <span class="o">=</span> <span class="n">H</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
    <span class="n">j0</span><span class="p">,</span> <span class="n">j1</span> <span class="o">=</span> <span class="n">J</span>
    <span class="n">multi_dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span>
    <span class="k">def</span> <span class="nf">fappr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">x0</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">y0</span>
        <span class="k">return</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">h00</span> <span class="o">+</span> <span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="o">*</span><span class="p">(</span><span class="n">h10</span><span class="o">+</span><span class="n">h01</span><span class="p">)</span> <span class="o">+</span> <span class="n">y</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">h11</span> <span class="o">+</span> <span class="n">j0</span><span class="o">*</span><span class="n">x</span> <span class="o">+</span> <span class="n">j1</span><span class="o">*</span><span class="n">y</span> <span class="o">+</span> <span class="n">f0</span> 
        <span class="k">return</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">xx</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">xx</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">xx</span><span class="p">,</span> <span class="n">J</span><span class="p">)</span> <span class="o">+</span> <span class="n">f0</span> 
    
    <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">xmin</span><span class="p">:</span><span class="n">xmax</span><span class="p">:</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">ymin</span><span class="p">:</span><span class="n">ymax</span><span class="p">:</span><span class="mf">0.05</span><span class="p">]</span>
    <span class="n">diff1</span> <span class="o">=</span> <span class="mf">0.7</span>
    <span class="n">diff1</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="n">diff2</span> <span class="o">=</span> <span class="mf">0.5</span>
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="n">x0</span><span class="o">-</span><span class="n">diff1</span><span class="p">:</span><span class="n">x0</span><span class="o">+</span><span class="n">diff1</span><span class="p">:</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">y0</span><span class="o">-</span><span class="n">diff2</span><span class="p">:</span><span class="n">y0</span><span class="o">+</span><span class="n">diff2</span><span class="p">:</span><span class="mf">0.05</span><span class="p">]</span>
    
    <span class="n">x1</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
    
    <span class="n">f1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="mi">0</span><span class="o">+</span><span class="mi">3</span>
    
    <span class="n">xCyl</span><span class="p">,</span> <span class="n">zCyl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mgrid</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="mf">1.02</span><span class="p">:</span><span class="mf">0.02</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="mi">3</span><span class="p">:</span><span class="mf">0.05</span><span class="p">]</span>
    <span class="n">yCyl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">xCyl</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    
    <span class="n">z</span> <span class="o">=</span> <span class="n">ff</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
    <span class="n">zApprox</span> <span class="o">=</span> <span class="n">fappr</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">z</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">zApprox</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">f0</span><span class="p">)</span>
    
    <span class="n">zApprox</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_or</span><span class="p">(</span><span class="n">zApprox</span><span class="o">&lt;-</span><span class="mi">3</span><span class="p">,</span> <span class="n">zApprox</span><span class="o">&gt;</span><span class="mi">8</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1">#zApprox[np.logical_or(zApprox&lt;-3, zApprox&gt;10)] = np.nan</span>
    
    <span class="n">fig</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">800</span><span class="p">),</span> <span class="n">bgcolor</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">fgcolor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">))</span>
    <span class="n">mlab</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    
    <span class="n">wScale</span> <span class="o">=</span> <span class="mf">0.4</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    s = mlab.surf(x, y, z, colormap=&#39;viridis&#39;, #extent=[0, 2, 0, 1, 0, 1],</span>
<span class="sd">             line_width=1, warp_scale=wScale,</span>
<span class="sd">             representation=&#39;surface&#39;, transparent=True, opacity=0.7)</span>
<span class="sd">    mlab.axes(nb_labels=0, xlabel=&quot;x1&quot;, ylabel=&quot;x2&quot;, zlabel=&quot;ln(L)&quot;,</span>
<span class="sd">              )</span>
<span class="sd">    sA = mlab.surf(x1, y1, zApprox, colormap=&#39;bone&#39;, #extent=[0, 2, 0, 1, 0, 1],</span>
<span class="sd">              line_width=1, warp_scale=wScale,</span>
<span class="sd">              representation=&#39;wireframe&#39;)</span>
<span class="sd">    #mlab.axes(nb_labels=0, xlabel=&quot;x1&quot;, ylabel=&quot;x2&quot;, zlabel=&quot;ln(L)&quot;,</span>
<span class="sd">    #          )</span>
<span class="sd">    mlab.points3d(x0, y0, f0*wScale, resolution=20, color=(.9, .5,.3), scale_factor=.1)</span>
<span class="sd">    #&#39;&#39;&#39;</span>
    <span class="n">sc1</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">xCyl</span><span class="p">,</span> <span class="n">y0</span><span class="o">+</span><span class="n">yCyl</span><span class="p">,</span> <span class="n">zCyl</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;bone&#39;</span><span class="p">,</span> <span class="c1">#extent=[0, 2, 0, 1, 0, 1],</span>
             <span class="n">line_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1">#warp_scale=wScale,</span>
             <span class="n">representation</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">sc2</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">mesh</span><span class="p">(</span><span class="n">x0</span><span class="o">+</span><span class="n">xCyl</span><span class="p">,</span> <span class="n">y0</span><span class="o">-</span><span class="n">yCyl</span><span class="p">,</span> <span class="n">zCyl</span><span class="p">,</span> <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;bone&#39;</span><span class="p">,</span> <span class="c1">#extent=[0, 2, 0, 1, 0, 1],</span>
             <span class="n">line_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="c1">#warp_scale=wScale,</span>
             <span class="n">representation</span><span class="o">=</span><span class="s1">&#39;surface&#39;</span><span class="p">,</span> <span class="n">transparent</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opacity</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">s1</span> <span class="o">=</span> <span class="n">mlab</span><span class="o">.</span><span class="n">surf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">*</span><span class="mi">0</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="c1">#8.2, </span>
                   <span class="n">colormap</span><span class="o">=</span><span class="s1">&#39;gist_earth&#39;</span><span class="p">,</span> 
              <span class="n">representation</span><span class="o">=</span><span class="s1">&#39;wireframe&#39;</span><span class="p">,</span> <span class="n">line_width</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">warp_scale</span><span class="o">=</span><span class="n">wScale</span> <span class="c1">#&#39;auto&#39;</span>
              <span class="c1">#extent=[0, 1, 0, 1, 0, 1]</span>
              <span class="p">)</span>
    <span class="n">mlab</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="c1">#mlab.axes()</span>
    <span class="c1">#mlab.outline()</span>
    <span class="n">mlab</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    fig = plt.figure()</span>
<span class="sd">    ax = fig.gca(projection=&#39;3d&#39;)</span>
<span class="sd">    </span>
<span class="sd">    #ax.plot_trisurf(X.ravel(), Y.ravel(), Z.ravel())</span>
<span class="sd">    ax.plot_trisurf(x.ravel(), y.ravel(), z.ravel())</span>
<span class="sd">    ax.plot_trisurf(x.ravel(), y.ravel(), zApprox.ravel())</span>
<span class="sd">    #ax.plot_trisurf(X.ravel(), Y.ravel(), (Z*0+3).ravel())</span>
<span class="sd">    ax.yaxis.set_major_locator(plt.NullLocator())</span>
<span class="sd">    ax.xaxis.set_major_formatter(plt.NullFormatter())</span>
<span class="sd">    #ax.set_zlim(-20, 20)</span>
<span class="sd">    </span>
<span class="sd">    #ax.plot_trisurf(X.ravel(), Y.ravel(), Z.ravel(), vmin=-20,</span>
<span class="sd">    #                linewidth=0.2, antialiased=True,</span>
<span class="sd">    #                )</span>
<span class="sd">    #&quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>    </div>

<div class="viewcode-block" id="test3"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.test3">[docs]</a><span class="k">def</span> <span class="nf">test3</span><span class="p">():</span>
    <span class="n">h</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
    <span class="n">j</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">,</span><span class="mi">0</span><span class="p">))</span>
    <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
    <span class="c1">#s = FlexibleSubproblem(x0, f, j, h)</span>
    <span class="c1">#print(s.solve(2))</span>
    
    
    <span class="n">r</span> <span class="o">=</span> <span class="n">find_CI_bound</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">r</span><span class="p">)</span></div>

<div class="viewcode-block" id="test4"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm_mpinv.html#ci_rvm.ci_rvm_mpinv.test4">[docs]</a><span class="k">def</span> <span class="nf">test4</span><span class="p">():</span>
    <span class="n">h</span> <span class="o">=</span> <span class="p">[[</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">]</span>
<span class="p">,[</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">]</span>
<span class="p">,[</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="mf">6.59765873e-07</span><span class="p">,</span><span class="o">-</span><span class="mf">7.95084287e-08</span><span class="p">,</span><span class="mf">7.97178695e-08</span><span class="p">]</span>
<span class="p">,[</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">7.95084287e-08</span><span class="p">,</span><span class="mf">8.32746616e-05</span><span class="p">,</span><span class="o">-</span><span class="mf">8.34294256e-05</span><span class="p">]</span>
<span class="p">,[</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span><span class="mf">7.97178695e-08</span><span class="p">,</span><span class="o">-</span><span class="mf">8.34294256e-05</span><span class="p">,</span><span class="mf">8.33989592e-05</span><span class="p">]]</span>
    <span class="n">j</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.00000000e+0</span><span class="p">,</span><span class="o">-</span><span class="mf">0.00000000e+00</span><span class="p">,</span> <span class="o">-</span><span class="mf">5.56847260e-04</span><span class="p">,</span>  <span class="mf">8.37653714e-05</span><span class="p">,</span><span class="o">-</span><span class="mf">8.34289217e-05</span><span class="p">]</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
    <span class="n">j</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
    <span class="n">hess</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">h</span>
    <span class="n">jac</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">j</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="mi">10</span>
    
    <span class="n">s</span> <span class="o">=</span> <span class="n">FlexibleSubproblem</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="mi">300</span><span class="p">))</span></div>
    
    
    
    

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="c1">#plot3d()</span>
    <span class="n">test</span><span class="p">()</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Packages</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../hybrid_vector_model.html">hybrid_vector_model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ci_rvm.html">ci_rvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lopaths.html">lopaths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vemomoto_core.html">vemomoto_core</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">VeMoMoTo</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Samuel M. Fischer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.0.
    </div>
  </body>
</html>