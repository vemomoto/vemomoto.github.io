
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ci_rvm.ci_rvm &#8212; Vector Movement Modelling Tools</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/nature.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/sphinx_highlight.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">VeMoMoTo</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ci_rvm.ci_rvm</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for ci_rvm.ci_rvm</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">&#39;&#39;&#39;</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Pool</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">count</span> <span class="k">as</span> <span class="n">itercount</span>
<span class="kn">import</span> <span class="nn">numdifftools</span> <span class="k">as</span> <span class="nn">nd</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">chi2</span>
<span class="kn">from</span> <span class="nn">scipy.optimize._trustregion_exact</span> <span class="kn">import</span> <span class="n">IterativeSubproblem</span>

<span class="kn">from</span> <span class="nn">vemomoto_core.tools.doc_utils</span> <span class="kn">import</span> <span class="n">inherit_doc</span>



<span class="k">def</span> <span class="nf">__round_str</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">full</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">after</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">and</span> <span class="n">n</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">digipre</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">after</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">full</span><span class="o">-</span><span class="n">digipre</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">after</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="s2">&quot;{:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">full</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;.&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">after</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;f}&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<div class="viewcode-block" id="is_negative_definite"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm.html#ci_rvm.ci_rvm.is_negative_definite">[docs]</a><span class="k">def</span> <span class="nf">is_negative_definite</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns whether the given Matrix is negative definite.</span>
<span class="sd">    </span>
<span class="sd">    Uses a Cholesky decomposition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="o">-</span><span class="n">M</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">det</span><span class="p">(</span><span class="n">r</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">tol</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="FlexibleSubproblem"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm.html#ci_rvm.ci_rvm.FlexibleSubproblem">[docs]</a><span class="k">class</span> <span class="nc">FlexibleSubproblem</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class representing constained quadratic subproblems</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">hessp</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">k_easy</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">k_hard</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        ``k_easy`` and ``k_hard`` are parameters used</span>
<span class="sd">        to determine the stop criteria to the iterative</span>
<span class="sd">        subproblem solver. Take a look at the IterativeSubproblem class</span>
<span class="sd">        for more info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">x</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jac</span> <span class="o">=</span> <span class="n">jac</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hess</span> <span class="o">=</span> <span class="n">hess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hessp</span> <span class="o">=</span> <span class="n">hessp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_easy</span> <span class="o">=</span> <span class="n">k_easy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_hard</span> <span class="o">=</span> <span class="n">k_hard</span>
        
<div class="viewcode-block" id="FlexibleSubproblem.solve"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm.html#ci_rvm.ci_rvm.FlexibleSubproblem.solve">[docs]</a>    <span class="k">def</span> <span class="nf">solve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">positiveDefinite</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-5</span><span class="p">,</span> <span class="n">jac0tol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">radius</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)),</span> <span class="kc">True</span>
        
        <span class="n">subproblem</span> <span class="o">=</span> <span class="n">IterativeSubproblem</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jac</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hess</span><span class="p">,</span> 
                                         <span class="bp">self</span><span class="o">.</span><span class="n">hessp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_easy</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">k_hard</span><span class="p">)</span>
        
        <span class="c1"># IterativeSubproblem runs into issues, if jac is too small</span>
        <span class="k">if</span> <span class="n">subproblem</span><span class="o">.</span><span class="n">jac_mag</span> <span class="o">&lt;=</span> <span class="nb">max</span><span class="p">(</span><span class="n">subproblem</span><span class="o">.</span><span class="n">CLOSE_TO_ZERO</span><span class="p">,</span> <span class="n">jac0tol</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jac</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">positiveDefinite</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">positiveDefinite</span> <span class="o">=</span> <span class="n">is_negative_definite</span><span class="p">(</span><span class="o">-</span><span class="n">h</span><span class="p">,</span> <span class="n">tol</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">positiveDefinite</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">j</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">vals</span><span class="p">,</span> <span class="n">vecs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">vecs</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">vals</span><span class="p">))]</span>
                <span class="n">x</span> <span class="o">*=</span> <span class="n">radius</span>
            <span class="n">jNorm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">j</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">jNorm</span><span class="p">:</span>
                <span class="n">x_alt</span> <span class="o">=</span> <span class="n">j</span> <span class="o">/</span> <span class="n">jNorm</span> <span class="o">*</span> <span class="n">radius</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">((</span><span class="n">x</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> 
                    <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span><span class="p">((</span><span class="n">x_alt</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">x_alt</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="n">x_alt</span><span class="p">)):</span>
                    <span class="k">return</span> <span class="n">x_alt</span><span class="p">,</span> <span class="kc">True</span>
            <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">subproblem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div></div>

<div class="viewcode-block" id="Flipper"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm.html#ci_rvm.ci_rvm.Flipper">[docs]</a><span class="k">class</span> <span class="nc">Flipper</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Flips an array in a specified component</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> 
            <span class="n">index</span><span class="p">:</span> <span class="s2">&quot;index in which the result should be flipped&quot;</span><span class="p">,</span>
            <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">x</span>
        <span class="n">index</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">index</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">ndim</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[:,</span> <span class="n">index</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="get_independent_row_indices"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm.html#ci_rvm.ci_rvm.get_independent_row_indices">[docs]</a><span class="k">def</span> <span class="nf">get_independent_row_indices</span><span class="p">(</span><span class="n">M</span><span class="p">:</span> <span class="s2">&quot;considered matrix&quot;</span><span class="p">,</span> 
                                <span class="n">jac</span><span class="p">:</span> <span class="s2">&quot;ordering vector&quot;</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                                <span class="n">tol</span><span class="p">:</span> <span class="s2">&quot;numerical tolerance&quot;</span> <span class="o">=</span> <span class="kc">None</span>
                                <span class="p">)</span> <span class="o">-&gt;</span> <span class="s2">&quot;boolean array of linearly independent rows&quot;</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns a boolean array arr with arr[i]==True if and only if</span>
<span class="sd">    the i-th row of M is linearly independent of all other rows j with </span>
<span class="sd">    arr[j]==True.</span>
<span class="sd">    The vector jac provides an ordering of the returned indices. </span>
<span class="sd">    If M[i] and M[j] are linearly dependent, then arr[i] will be True if</span>
<span class="sd">    jac[i] &gt;= jac[j]. Otherwise, arr[i] will be False and arr[j] will be True.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">M</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">jac</span><span class="p">))[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    
    <span class="n">rank</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">M</span><span class="p">[</span><span class="n">indices</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]],</span> <span class="n">tol</span><span class="o">=</span><span class="n">tol</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">rank</span><span class="p">:</span>
            <span class="n">rank</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">False</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">result</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
        <span class="n">result</span><span class="p">[</span><span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="CounterFun"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm.html#ci_rvm.ci_rvm.CounterFun">[docs]</a><span class="k">class</span> <span class="nc">CounterFun</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Counts how often a function has been called</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fun</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fun</span> <span class="o">=</span> <span class="n">fun</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evals</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">evals</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fun</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<span class="n">STATUS_MESSAGES</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s2">&quot;Success&quot;</span><span class="p">,</span>
                   <span class="mi">1</span><span class="p">:</span><span class="s2">&quot;Result on discontinuity&quot;</span><span class="p">,</span>
                   <span class="mi">2</span><span class="p">:</span><span class="s2">&quot;Result is unbounded&quot;</span><span class="p">,</span>
                   <span class="mi">3</span><span class="p">:</span><span class="s2">&quot;Iteration limit exceeded&quot;</span><span class="p">,</span>
                   <span class="mi">4</span><span class="p">:</span><span class="s2">&quot;Ill-conditioned matrix&quot;</span><span class="p">,</span>
                   <span class="mi">5</span><span class="p">:</span><span class="s2">&quot;Unspecified error&quot;</span>
                   <span class="p">}</span>

<div class="viewcode-block" id="find_CI_bound"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm.html#ci_rvm.ci_rvm.find_CI_bound">[docs]</a><span class="k">def</span> <span class="nf">find_CI_bound</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> 
        <span class="n">jac</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">hess</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">,</span>
        <span class="n">fun0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">jac0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">hess0</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
        <span class="n">customTarget</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">nmax</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span> 
        <span class="n">nchecks</span> <span class="o">=</span> <span class="mi">65</span><span class="p">,</span>
        <span class="n">apprxtol</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span>
        <span class="n">resulttol</span> <span class="o">=</span> <span class="mf">1e-3</span><span class="p">,</span>
        <span class="n">singtol</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span> 
        <span class="n">minstep</span> <span class="o">=</span> <span class="mf">1e-5</span><span class="p">,</span> 
        <span class="n">radiusFactor</span> <span class="o">=</span> <span class="mf">1.5</span><span class="p">,</span>
        <span class="n">infstep</span> <span class="o">=</span> <span class="mf">1e10</span><span class="p">,</span> 
        <span class="n">maxRadius</span> <span class="o">=</span> <span class="mf">1e4</span><span class="p">,</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
        <span class="n">track_x</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> 
        <span class="n">track_f</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Finds an end point of a profile likelihood confidence interval.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x0 : float[]</span>
<span class="sd">        Maximum likelihood estimate (MLE) of the paramters.</span>
<span class="sd">    fun : callable</span>
<span class="sd">        Log-likelihood function.</span>
<span class="sd">    index : int</span>
<span class="sd">        Index of the parameter of interest.</span>
<span class="sd">    direction : int or bool</span>
<span class="sd">        If ``&lt;=0``, the lower end point of the confidence interval is sought, </span>
<span class="sd">        else the upper end point is sought.</span>
<span class="sd">    jac : callable</span>
<span class="sd">        Gradient of :py:obj:`fun`. If `None`, it will be computed based on</span>
<span class="sd">        finite differences using numdifftools.</span>
<span class="sd">    hess : callable</span>
<span class="sd">        Hessian of :py:obj:`fun`. If `None`, it will be computed based on</span>
<span class="sd">        finite differences using numdifftools.</span>
<span class="sd">    alpha : float</span>
<span class="sd">        Desired confidence level. Must be in ``(0,1)``</span>
<span class="sd">    fun0 : float</span>
<span class="sd">        log-likelihood at the MLE.</span>
<span class="sd">    jac0 : float[]</span>
<span class="sd">        Gradient of the log-liekelihood at the MLE.</span>
<span class="sd">    hess0 : float[][]</span>
<span class="sd">        Hessian of the log-likelihood at the MLE.</span>
<span class="sd">    customTarget : float</span>
<span class="sd">        Custom target log-likelihood l*. If this is given, :py:obj:`alpha` will</span>
<span class="sd">        be ignored.</span>
<span class="sd">    nmax : int</span>
<span class="sd">        Maximal number of iterations.</span>
<span class="sd">    nchecks : int</span>
<span class="sd">        Maximal number of trust-region changes per iteration.</span>
<span class="sd">    apprxtol : float</span>
<span class="sd">        Relative tolerance between :py:obj:`fun` and its approximation.</span>
<span class="sd">    resulttol : float</span>
<span class="sd">        Tolerance of the result (``fun`` and ``norm(jac)``).</span>
<span class="sd">    singtol : float</span>
<span class="sd">        Tolerance for singularity checks.</span>
<span class="sd">    minstep : int</span>
<span class="sd">        Controls the minimal radius of the trust region. </span>
<span class="sd">    radiusFactor : float</span>
<span class="sd">        Controls how quickly the trust region decreases. Must be in ``[1, 2]``.</span>
<span class="sd">    infstep : float</span>
<span class="sd">        Stepsize after which a parameter is deemed unestimbale.</span>
<span class="sd">    maxRadius : float</span>
<span class="sd">        Rradius of the trust region in the last iteration.</span>
<span class="sd">    disp : bool</span>
<span class="sd">        Whether to print a status message in each iteration.</span>
<span class="sd">    track_x : bool</span>
<span class="sd">        Whether to return the parameter trace.</span>
<span class="sd">    track_f : bool</span>
<span class="sd">        Whether to return the log-likelihood trace.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nuisance_minstep</span> <span class="o">=</span> <span class="mf">1e-3</span>
    
    <span class="c1"># ----- PREPARATION --------------------------------------------------------</span>
    <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Gradient</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Hessian</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    
    
    <span class="c1"># Make sure arguments and returned values are of correct type</span>
    <span class="n">index</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>  <span class="c1"># in case the index is not given as integer</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span> <span class="c1"># in case x0 is not given as numpy array</span>
    
    <span class="n">forward</span> <span class="o">=</span> <span class="n">direction</span> <span class="o">&gt;</span> <span class="mi">0</span>
    
    <span class="c1"># wrap the functions so that the correct end point is found</span>
    <span class="n">jac2</span> <span class="o">=</span> <span class="n">jac</span>
    <span class="n">hess2</span> <span class="o">=</span> <span class="n">hess</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">forward</span><span class="p">:</span>
        <span class="n">fun2</span> <span class="o">=</span> <span class="n">fun</span>
        <span class="n">flip</span> <span class="o">=</span> <span class="n">Flipper</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
        <span class="n">fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">fun2</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> 
        <span class="n">jac</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">jac2</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">hess2</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">))))</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="n">x0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="c1"># this is just to ensure the results are traced and returned correctly</span>
        <span class="n">flip</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">jac2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">hess2</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    
    <span class="c1"># initial values</span>
    <span class="k">if</span> <span class="n">fun0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fun0</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jac0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jac0</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jac0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">jac0</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">hess0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hess0</span> <span class="o">=</span> <span class="n">hess</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">hess0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">hess0</span><span class="p">)</span>
    
    <span class="c1"># flip initial values if necessary</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">forward</span><span class="p">:</span>
        <span class="n">jac0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">hess0</span> <span class="o">=</span> <span class="n">flip</span><span class="p">(</span><span class="n">hess0</span><span class="p">)</span>
        
    <span class="c1"># compute the target</span>
    <span class="k">if</span> <span class="n">customTarget</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">fun0</span> <span class="o">-</span> <span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">customTarget</span>
    
    <span class="n">i</span><span class="p">:</span> <span class="s2">&quot;current iteration&quot;</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">x_track</span><span class="p">:</span> <span class="s2">&quot;trace of parameter values&quot;</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">f_track</span><span class="p">:</span> <span class="s2">&quot;trace of log-likelihood values&quot;</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">maximizing</span><span class="p">:</span> <span class="s2">&quot;flag controlling whether we are maximizing f w.r.t. x[index]&quot;</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">nuisanceRadius</span><span class="p">:</span> <span class="s2">&quot;search radius for unconstrained subproblems&quot;</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="c1"># counters to keep track how often functions have been called</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="n">jac</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">jac</span><span class="p">)</span>
    <span class="n">hess</span> <span class="o">=</span> <span class="n">CounterFun</span><span class="p">(</span><span class="n">hess</span><span class="p">)</span>
    
    <span class="n">multi_dot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">multi_dot</span>
    
    <span class="n">is_negative_definite_</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">is_negative_definite</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">fPredicted_fun</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Taylor approximation of f</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">xTmp</span><span class="o">-</span><span class="n">x</span>
        <span class="k">return</span> <span class="n">f</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">J</span><span class="p">,</span> <span class="n">dx</span><span class="p">)</span> <span class="o">+</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">dx</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">dx</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
    
    <span class="k">def</span> <span class="nf">JPredicted_fun</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Taylor approximation of jac</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">J</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">xTmp</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
    
    <span class="n">norm</span><span class="p">:</span> <span class="s2">&quot;applied norm&quot;</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">arr</span><span class="o">*</span><span class="n">arr</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">jac_approx_precise</span><span class="p">(</span><span class="n">JPredicted_</span><span class="p">,</span> <span class="n">JActual_</span><span class="p">,</span> <span class="n">J_</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">apprxtol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True, iff the predicted gradient is close to the</span>
<span class="sd">        actual one or, even better, closer to the target than predicted</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># note how far we are from the target likelihood</span>
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;normal&quot;</span> <span class="ow">or</span> <span class="n">maximizing</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">closeToDisc</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
            
        <span class="k">return</span> <span class="n">norm</span><span class="p">(</span><span class="n">JActual_</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">J_</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">bound</span> <span class="ow">or</span> <span class="n">norm</span><span class="p">(</span><span class="n">JPredicted_</span><span class="o">-</span><span class="n">JActual_</span><span class="p">)</span> <span class="o">/</span> <span class="n">norm</span><span class="p">(</span><span class="n">J_</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">bound</span>
    
    <span class="c1"># TODO Accept improvements only then always, if they are better by a certain constant (compare values - line search)</span>
    <span class="k">def</span> <span class="nf">f_approx_precise</span><span class="p">(</span><span class="n">fPredicted</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">apprxtol</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns True, iff the predicted log-likelihood value is close to the</span>
<span class="sd">        actual one or, even better, closer to the target than predicted</span>
<span class="sd">        &quot;&quot;&quot;</span>
            
        <span class="c1"># steps to negative predicted values cannot occur in theory and are </span>
        <span class="c1"># either due to numerical issues or because we tried a very long step. </span>
        <span class="c1"># Therefore, we reject these steps right away, if fActual is below the </span>
        <span class="c1"># target.</span>
        <span class="k">if</span> <span class="n">fPredicted</span> <span class="o">&lt;</span> <span class="n">target</span> <span class="o">-</span> <span class="n">resulttol</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="c1"># return True if result is better than expected</span>
        <span class="k">if</span> <span class="n">fActual</span> <span class="o">&gt;</span> <span class="n">fPredicted</span> <span class="ow">and</span> <span class="n">xiTmp</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        
        <span class="c1"># if we are maximizing w.r.t. the nuisance parameters, </span>
        <span class="k">if</span> <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;max_nuisance&quot;</span> <span class="ow">or</span> <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;max_nuisance_const&quot;</span> <span class="ow">or</span> <span class="n">maximizing</span><span class="p">:</span>
            <span class="c1"># we do not accept steps that are worse than the current stage</span>
            <span class="c1"># (we guarantee elsewhere that it IS possible to increase f)</span>
            <span class="k">if</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">f</span><span class="p">:</span> 
                <span class="k">if</span> <span class="ow">not</span> <span class="n">relax_maximum_constraint</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fPredicted</span><span class="o">-</span><span class="n">fActual</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">resulttol</span><span class="p">:</span>
                    <span class="k">return</span> <span class="kc">False</span>
            <span class="n">bound</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">relax_maximum_constraint</span><span class="p">:</span>
                <span class="n">bound</span> <span class="o">*=</span> <span class="mi">2</span>
        <span class="k">elif</span> <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;normal&quot;</span><span class="p">:</span>
            <span class="c1"># if we are outside the admissible region, we enforce that</span>
            <span class="c1"># we get closer to it again</span>
            <span class="k">if</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fActual</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="n">f</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fActual</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">resulttol</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fPredicted</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">resulttol</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">elif</span> <span class="n">fActual</span> <span class="o">&gt;</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                <span class="c1"># we relax the precision requirement, if the step is not of</span>
                <span class="c1"># disadvantage and brings us forward (we value progression in </span>
                <span class="c1"># the paramater of interest higher than a maximal likelihood)</span>
                <span class="n">bound</span> <span class="o">*=</span> <span class="mi">2</span>
                
        
        <span class="c1"># we require that the error relative to the distance from the target</span>
        <span class="c1"># is not larger than the given bound.</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fPredicted</span><span class="o">-</span><span class="n">fActual</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">target</span><span class="o">-</span><span class="n">f</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">bound</span>
    
    <span class="k">def</span> <span class="nf">test_precision</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="s2">&quot;True, if appxomiations are sufficiently precise&quot;</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tests the precision of the Taylor approximation at the suggested </span>
<span class="sd">        parameter vector.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
        <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">f_approx_precise</span><span class="p">(</span><span class="n">fPredicted</span><span class="p">,</span> <span class="n">fActual</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">resulttol</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">closeToDisc</span><span class="p">:</span> 
            <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="kc">None</span>
        
        <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
        <span class="n">JPredicted</span> <span class="o">=</span> <span class="n">JPredicted_fun</span><span class="p">()</span> 
        
        <span class="k">if</span> <span class="n">free_params_exist</span><span class="p">:</span> 
            <span class="n">JActual_</span> <span class="o">=</span> <span class="n">JActual</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">]</span>
            <span class="n">JPredicted_</span> <span class="o">=</span> <span class="n">JPredicted</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">]</span>
            
            <span class="c1"># the jacobian shall be mostly precise w.r.t. the changed parameters.</span>
            <span class="c1"># However, it shoudl not be totally imprecise with respect to the</span>
            <span class="c1"># remaining parameters, either.</span>
            <span class="n">jac_precise</span> <span class="o">=</span> <span class="p">(</span><span class="n">jac_approx_precise</span><span class="p">(</span><span class="n">JPredicted_</span><span class="p">,</span> <span class="n">JActual_</span><span class="p">,</span> <span class="n">J_</span><span class="p">)</span> <span class="ow">and</span>
                           <span class="n">jac_approx_precise</span><span class="p">(</span><span class="n">JPredicted</span><span class="p">[</span><span class="n">considered</span><span class="p">],</span> 
                                              <span class="n">JActual</span><span class="p">[</span><span class="n">considered</span><span class="p">],</span>
                                              <span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">],</span> 
                                              <span class="mi">20</span><span class="o">*</span><span class="n">apprxtol</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">JActual_</span> <span class="o">=</span> <span class="n">JActual</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
            <span class="n">JPredicted_</span> <span class="o">=</span> <span class="n">JPredicted</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
            <span class="n">jac_precise</span> <span class="o">=</span> <span class="n">jac_approx_precise</span><span class="p">(</span><span class="n">JPredicted_</span><span class="p">,</span> <span class="n">JActual_</span><span class="p">,</span> <span class="n">J_</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">jac_precise</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="n">JActual</span>
        
        
    
    <span class="k">def</span> <span class="nf">is_concave_down</span><span class="p">():</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Checks whether the profile likelihood function is concave down.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mi">0</span>
    
    <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
        <span class="k">def</span> <span class="nf">dispprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>        
        <span class="k">def</span> <span class="nf">dispprint</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="k">pass</span>
    
    
    <span class="c1"># variable definitions -------------------------------------------------</span>
    <span class="n">x</span><span class="p">:</span>      <span class="s2">&quot;parameter vector at current iteration&quot;</span>      <span class="o">=</span> <span class="n">x0</span>
    <span class="n">xTmp</span><span class="p">:</span>   <span class="s2">&quot;potential new parameter vector&quot;</span>
    <span class="n">xi</span><span class="p">:</span>     <span class="s2">&quot;parameter of interest at current iteration&quot;</span> <span class="o">=</span> <span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">f</span><span class="p">:</span>      <span class="s2">&quot;log-likelihood at current iteration&quot;</span>        <span class="o">=</span> <span class="n">fun0</span>
    <span class="n">J</span><span class="p">:</span>      <span class="s2">&quot;gradient at current iteration&quot;</span>              <span class="o">=</span> <span class="n">jac0</span>
    <span class="n">H</span><span class="p">:</span>      <span class="s2">&quot;Hessian at current iteration&quot;</span>               <span class="o">=</span> <span class="n">hess0</span>
    <span class="n">maxFun</span><span class="p">:</span> <span class="s2">&quot;maximal log-likelihood&quot;</span>                     <span class="o">=</span> <span class="n">fun0</span>
    <span class="n">xi_max</span><span class="p">:</span> <span class="s2">&quot;maximal value for the parameter of interest with f(xi, x_) &gt;= f*&quot;</span>    <span class="o">=</span> <span class="n">xi</span>
    <span class="n">x_max</span><span class="p">:</span>  <span class="s2">&quot;parameter vector where xi_max leads to a log-likelihood value &gt;= f*&quot;</span> <span class="o">=</span> <span class="n">x</span>
    <span class="n">considered</span><span class="p">:</span>     <span class="s2">&quot;Array indexing nuisance parameters&quot;</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
    <span class="n">considered</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>  <span class="o">=</span> <span class="kc">False</span>
    <span class="n">consideredOriginal</span> <span class="o">=</span> <span class="n">considered</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">hessConsidered</span><span class="p">:</span> <span class="s2">&quot;Array indexing nuisance Hessian&quot;</span>    <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">considered</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>
    <span class="n">H_</span><span class="p">:</span>     <span class="s2">&quot;nuisance Hessian&quot;</span>                           <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">hessConsidered</span><span class="p">]</span>
    <span class="n">H0_</span><span class="p">:</span>    <span class="s2">&quot;nuisance entries of Hessian row corresponding to the parameter of interest&quot;</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">index</span><span class="p">][</span><span class="n">considered</span><span class="p">]</span>
    <span class="n">discontinuity_counter</span><span class="p">:</span> <span class="s2">&quot;steps until discontinuous parameters are released&quot;</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">maximizing</span><span class="p">:</span> <span class="s2">&quot;flag to memorize whether the target has been changed temporarily&quot;</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">resultmode</span><span class="p">:</span> <span class="s2">&quot;denotes whether or what kind of result has been found&quot;</span> <span class="o">=</span> <span class="s2">&quot;searching&quot;</span>
    <span class="n">radius</span><span class="p">:</span> <span class="s2">&quot;radius of the trust region in the last iteration&quot;</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
    <span class="n">closeToDisc</span><span class="p">:</span> <span class="s2">&quot;True if we ar close to a discontinuity&quot;</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">xi_hist</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">f_hist</span> <span class="o">=</span> <span class="p">[]</span>
    
    
    <span class="n">subproblem</span> <span class="o">=</span> <span class="n">FlexibleSubproblem</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> 
             <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">f</span><span class="p">,</span> 
             <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">J_</span> <span class="o">-</span> <span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">)</span><span class="o">*</span><span class="n">H0_</span><span class="p">,</span>
             <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">H_</span>
             <span class="p">)</span>
    
    
    <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>                        <span class="c1"># just to prevent a possible name error...</span>
    <span class="n">xiRadius</span> <span class="o">=</span> <span class="n">nuisanceRadius</span>
        
    <span class="c1"># Wrapper to catch potential errors without braking down completely</span>
    <span class="k">try</span><span class="p">:</span>    
        <span class="c1"># ----- ITERATIONS -----------------------------------------------------</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">nmax</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            
            <span class="n">redoIteration</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">ballsearch</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">jacDiscont</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">free_params_exist</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">free_considered</span> <span class="o">=</span> <span class="o">~</span><span class="n">considered</span>
            <span class="n">infstepTmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">infstep</span><span class="p">,</span> <span class="mi">10</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]))</span>
            <span class="c1">#closeToDisc = False</span>
            
            <span class="k">if</span> <span class="n">track_x</span><span class="p">:</span>
                <span class="n">x_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">track_f</span><span class="p">:</span>
                <span class="n">f_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
            
            <span class="c1"># if discontinuities are found, some parameters are held constant</span>
            <span class="c1"># for a while. The discontinuity_counter keeps track of the time</span>
            <span class="k">if</span> <span class="n">discontinuity_counter</span><span class="p">:</span>
                <span class="n">discontinuity_counter</span> <span class="o">-=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">considered</span> <span class="o">=</span> <span class="n">consideredOriginal</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">hessConsidered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">considered</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>
                <span class="n">relax_maximum_constraint</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            
            <span class="c1"># determine approximation</span>
            <span class="n">J_</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">H0</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            <span class="n">H0_</span> <span class="o">=</span> <span class="n">H0</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
            <span class="n">H00</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">]</span>
            <span class="n">H_</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">hessConsidered</span><span class="p">]</span>
            
            <span class="c1"># Determine search mode:</span>
            <span class="c1"># max_nuisance:  set xi to specific value, maximize other parameters</span>
            <span class="c1"># max_nuisance_const:  hold xi constant, maximize other parameters</span>
            <span class="c1"># normal:        search x with f(x) = f*, J(x) = 0</span>
            <span class="c1"># binary search: get back to the adissible region with a binary </span>
            <span class="c1">#                search</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Infinite loop&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> 
                                       <span class="n">free_considered</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">is_negative_definite_</span><span class="p">(</span><span class="n">H_</span><span class="p">):</span>
                    <span class="n">H_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">H_</span><span class="p">)</span>
                    <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span>
                    <span class="k">break</span>
                
                <span class="n">free_considered_</span> <span class="o">=</span> <span class="o">~</span><span class="n">get_independent_row_indices</span><span class="p">(</span><span class="n">H_</span><span class="p">,</span> <span class="n">J_</span><span class="p">,</span> 
                                                                <span class="n">tol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span>
                <span class="n">free_considered</span> <span class="o">=</span> <span class="o">~</span><span class="n">considered</span>
                <span class="n">free_considered</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span> <span class="o">=</span> <span class="n">free_considered_</span>
                <span class="n">free_params_exist</span> <span class="o">=</span> <span class="n">free_considered_</span><span class="o">.</span><span class="n">any</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">free_params_exist</span><span class="p">:</span>
                    <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance&quot;</span>
                    <span class="k">break</span>
                
                <span class="n">H_dd</span> <span class="o">=</span> <span class="n">H_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="o">~</span><span class="n">free_considered_</span><span class="p">,</span> <span class="o">~</span><span class="n">free_considered_</span><span class="p">)]</span>
                
                <span class="c1"># special case for H_ = 0</span>
                <span class="k">if</span> <span class="n">H_dd</span><span class="o">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">H_dd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">):</span>
                    <span class="c1"># though H_ is singular, we set its inverse to a very large</span>
                    <span class="c1"># value to prevent NaNs that would mess up the result</span>
                    <span class="n">H_ddInv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="nb">max</span><span class="p">(</span><span class="o">-</span><span class="n">infstep</span><span class="o">/</span><span class="n">singtol</span><span class="p">,</span> <span class="mi">1</span><span class="o">/</span><span class="n">H_dd</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])]])</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">is_negative_definite_</span><span class="p">(</span><span class="n">H_dd</span><span class="p">):</span>
                    <span class="n">free_considered</span> <span class="o">=</span> <span class="o">~</span><span class="n">considered</span>
                    <span class="n">free_considered_</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance&quot;</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">H_ddInv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">H_dd</span><span class="p">)</span>
                
                
                
                <span class="n">H0_d</span> <span class="o">=</span> <span class="n">H0_</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered_</span><span class="p">]</span>
                <span class="n">J_d</span> <span class="o">=</span> <span class="n">J_</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered_</span><span class="p">]</span>
                
                <span class="n">H_inv</span> <span class="o">=</span> <span class="n">H_ddInv</span>
                <span class="n">H0_</span> <span class="o">=</span> <span class="n">H0_d</span>
                <span class="n">J_</span> <span class="o">=</span> <span class="n">J_d</span>
                <span class="n">H_</span> <span class="o">=</span> <span class="n">H_dd</span>
                
                <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;normal&quot;</span>
                <span class="k">break</span>
                
            <span class="c1"># ----- NORMAL SEARCH ----------------------------------------------   </span>
            <span class="k">while</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
                
                <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">H00</span> <span class="o">-</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">H0_</span><span class="p">,</span> <span class="n">H_inv</span><span class="p">,</span> <span class="n">H0_</span><span class="p">)))</span><span class="o">/</span><span class="mi">2</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">H0_</span><span class="p">,</span> <span class="n">H_inv</span><span class="p">,</span> <span class="n">J_</span><span class="p">))</span>
                <span class="n">fPL0</span><span class="p">:</span> <span class="s2">&quot;current value on profile log-likelihood&quot;</span> 
                <span class="n">fPL0</span> <span class="o">=</span> <span class="n">f</span> <span class="o">-</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">J_</span><span class="p">,</span> <span class="n">H_inv</span><span class="p">,</span> <span class="n">J_</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span>
                
                <span class="k">if</span> <span class="n">maximizing</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">is_concave_down</span><span class="p">()</span> 
                            <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span> <span class="ow">and</span> 
                                     <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(((</span><span class="n">fPL0</span><span class="o">-</span><span class="n">target</span><span class="p">)</span><span class="o">/</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> 
                                                 <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">))</span>
                            <span class="p">)</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
                        <span class="n">maximizing</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">targetTmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">fPL0</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">maxFun</span><span class="o">+</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="ow">not</span> <span class="n">maximizing</span><span class="p">:</span>
                    <span class="n">targetTmp</span> <span class="o">=</span> <span class="n">target</span>
                    
                <span class="n">q</span> <span class="o">=</span> <span class="n">fPL0</span> <span class="o">-</span> <span class="n">targetTmp</span>
                
                <span class="k">if</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">sqroot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">sqroot</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="o">/</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">q</span><span class="o">/</span><span class="n">a</span> 
                
                
                <span class="c1"># if desired point is not on approximation</span>
                <span class="k">if</span> <span class="n">sqroot</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span> 
                            <span class="ow">and</span> <span class="n">get_independent_row_indices</span><span class="p">(</span><span class="n">H</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="n">singtol</span>
                                                            <span class="p">)[</span><span class="n">index</span><span class="p">]):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">maximizing</span> <span class="ow">and</span> <span class="n">a</span><span class="o">&lt;</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">targetTmp</span><span class="p">:</span>
                            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The current function value is not on the approximation. &quot;</span>
                                          <span class="o">+</span> <span class="s2">&quot;This may be due to a too large singtol. &quot;</span>
                                          <span class="o">+</span> <span class="s2">&quot;The algorithm may not converge. Index=&quot;</span> 
                                          <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;; forward=&quot;</span> 
                                          <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">forward</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;; a=&quot;</span> 
                                          <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;; f=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                                          <span class="o">+</span> <span class="s2">&quot;; root=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sqroot</span><span class="p">))</span>
                        
                        <span class="k">assert</span> <span class="ow">not</span> <span class="n">maximizing</span>
                        
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_concave_down</span><span class="p">()</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                            <span class="c1"># if beyond or very close to a local min</span>
                            <span class="k">if</span> <span class="n">p</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="o">-</span><span class="n">p</span><span class="o">/</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">singtol</span><span class="p">:</span>
                                <span class="n">maximizing</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="k">continue</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># jump over minimum by factor 2</span>
                                <span class="n">p</span> <span class="o">*=</span> <span class="mi">2</span>
                            
                        <span class="n">sqroot</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="c1"># if f is approximately constant, we do not trust the </span>
                    <span class="c1"># quadratic approximation too much and jsut try a very long</span>
                    <span class="c1"># step, even if it goes beyond the predicted admissible </span>
                    <span class="c1"># region</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">a</span> <span class="o">=</span> <span class="mi">0</span>
                        <span class="n">sqroot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">else</span><span class="p">:</span>    
                    <span class="n">sqroot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sqroot</span><span class="p">)</span>
                
                <span class="c1"># if Hessian is singular in the considered component</span>
                <span class="c1"># this control is important to prevent numerical errors if</span>
                <span class="c1"># |a| &lt;&lt; 1 and the summands of the root are equal order of </span>
                <span class="c1"># magnitude</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span> <span class="ow">and</span> 
                        <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">((</span><span class="n">q</span><span class="o">/</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">a</span><span class="o">/</span><span class="n">p</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">maximizing</span> <span class="ow">and</span> <span class="n">q</span><span class="o">*</span><span class="n">p</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="n">maximizing</span> <span class="ow">and</span> 
                                                    <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">q</span><span class="o">*</span><span class="n">p</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                        <span class="n">maximizing</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">maximizing</span>
                        <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">-</span> <span class="n">q</span><span class="o">/</span><span class="n">p</span>
                <span class="c1"># control for NaN case</span>
                <span class="k">elif</span> <span class="n">p</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">a</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span> 
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xi1</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="o">/</span><span class="n">a</span> <span class="o">+</span> <span class="n">sqroot</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">xi2</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="p">(</span><span class="o">-</span><span class="n">p</span><span class="o">/</span><span class="n">a</span> <span class="o">-</span> <span class="n">sqroot</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    
                    <span class="c1"># check which root is closer to current value</span>
                    <span class="k">if</span> <span class="n">is_concave_down</span><span class="p">():</span> <span class="c1">#not maximizing</span>
                        <span class="k">assert</span> <span class="ow">not</span> <span class="n">maximizing</span>
                        <span class="n">xiTmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">p</span><span class="o">*</span><span class="n">a</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">maximizing</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                        <span class="n">maximizing</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">maximizing</span> <span class="ow">and</span> <span class="n">p</span><span class="o">/</span><span class="n">a</span> <span class="o">&lt;</span> <span class="o">-</span><span class="n">singtol</span><span class="p">:</span>
                        <span class="n">maximizing</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">maximizing</span><span class="p">:</span>
                        <span class="n">xiTmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xi1</span><span class="p">,</span> <span class="n">xi2</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">xi1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">xi2</span><span class="p">):</span> 
                            <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi2</span>
                
                <span class="c1"># if likelihood is independent of parameter</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">infstep</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">singtol</span><span class="p">):</span>
                    
                    
                    <span class="c1"># try a very large xi value</span>
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">infstepTmp</span>
                    <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">xiTmp</span>
                    <span class="n">xTmp</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H_inv</span><span class="p">,</span> <span class="n">H0_</span><span class="o">*</span><span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">)</span><span class="o">+</span><span class="n">J_</span><span class="p">)</span>
                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                    
                    <span class="c1"># if still larger than target</span>
                    <span class="k">if</span> <span class="n">fActual</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                        <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                        <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;unbounded&quot;</span>
                        <span class="k">break</span> 
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">J_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">singtol</span><span class="p">:</span>
                            <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance&quot;</span>
                            <span class="k">break</span> 
                        
                        <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;binary_search&quot;</span>
                        <span class="k">break</span> 
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xiTmp</span><span class="o">/</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">xi</span><span class="o">/</span><span class="mi">4</span>
                
                <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">xiTmp</span>
                <span class="n">xTmp</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">]</span> <span class="o">+=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">H_inv</span><span class="p">,</span> <span class="n">H0_</span><span class="o">*</span><span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">)</span><span class="o">+</span><span class="n">J_</span><span class="p">)</span>
                
                <span class="n">xx</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">]</span>
                <span class="n">upperRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">xx</span><span class="o">-</span><span class="n">xTmp</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">])</span>
                
                <span class="c1"># Test precision</span>
                <span class="n">stop</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="n">JActual</span> <span class="o">=</span> <span class="n">test_precision</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
                    <span class="n">radius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">radius</span><span class="p">,</span> <span class="n">upperRadius</span><span class="p">)</span>
                    <span class="k">break</span>
                
                <span class="k">if</span> <span class="n">radius</span> <span class="o">&gt;=</span> <span class="n">upperRadius</span><span class="p">:</span>
                    <span class="n">lowerRadius</span> <span class="o">=</span> <span class="n">upperRadius</span><span class="o">/</span><span class="mi">2</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">lowerRadius</span> <span class="o">=</span> <span class="n">radius</span>
                
                <span class="k">if</span> <span class="n">upperRadius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">radius</span> <span class="o">=</span> <span class="n">upperRadius</span>
                
                <span class="n">tmpRadius</span> <span class="o">=</span> <span class="n">lowerRadius</span>
                <span class="n">xiStep</span> <span class="o">=</span> <span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span>
                
                <span class="k">if</span> <span class="n">tmpRadius</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="nb">min</span><span class="p">(</span><span class="n">xiStep</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">infstep</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">xiStep</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">tmpRadius</span><span class="o">/</span><span class="n">radius</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radiusFactor</span><span class="p">))</span>
                
                <span class="n">ballsearch</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">break</span>
                    
            <span class="k">if</span> <span class="ow">not</span> <span class="n">resultmode</span><span class="o">==</span><span class="s2">&quot;searching&quot;</span><span class="p">:</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">xTmp</span>
                <span class="n">J</span> <span class="o">=</span> <span class="n">JActual</span>
                <span class="n">JActual_</span> <span class="o">=</span> <span class="n">JActual</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
                <span class="n">f</span> <span class="o">=</span> <span class="n">fActual</span>
                <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span> <span class="ow">and</span> <span class="n">free_params_exist</span><span class="p">:</span>
                <span class="n">J_new</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">JPredicted_fun</span><span class="p">()[</span><span class="n">considered</span><span class="p">])</span>
                <span class="n">J_current</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">])</span>
                
                <span class="c1"># consider adjusted scenario with xiTmp = 0</span>
                <span class="n">J_f</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">][</span><span class="n">free_considered_</span><span class="p">]</span>
                <span class="n">H_df</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">hessConsidered</span><span class="p">][</span><span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="o">~</span><span class="n">free_considered_</span><span class="p">,</span> <span class="n">free_considered_</span><span class="p">)]</span>
                <span class="n">J_new2</span> <span class="o">=</span> <span class="n">J_f</span> <span class="o">-</span> <span class="n">multi_dot</span><span class="p">((</span><span class="n">H_df</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">H_ddInv</span><span class="p">,</span> <span class="n">J_d</span><span class="p">))</span>
                <span class="n">J_new2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">J_new2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">J_</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                
                <span class="c1"># if ignoring the free parameters hinders us from making an </span>
                <span class="c1"># improvement w.r.t. the gradient</span>
                <span class="n">abstol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">)</span>
                             <span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">maxFun</span><span class="o">-</span><span class="n">target</span><span class="p">),</span> <span class="n">resulttol</span><span class="p">)</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">J_new</span> <span class="o">&gt;</span> <span class="n">abstol</span> <span class="ow">and</span> <span class="n">J_new</span><span class="o">/</span><span class="n">J_current</span> <span class="o">&gt;</span> <span class="n">apprxtol</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span>
                        <span class="n">J_new2</span> <span class="o">&gt;</span> <span class="n">abstol</span> <span class="ow">and</span> <span class="n">J_new2</span><span class="o">/</span><span class="n">J_current</span> <span class="o">&gt;</span> <span class="n">apprxtol</span><span class="p">):</span>
                    <span class="n">free_considered</span> <span class="o">=</span> <span class="o">~</span><span class="n">considered</span>
                    <span class="n">free_considered_</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">free_params_exist</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">J_</span> <span class="o">=</span> <span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
                    <span class="n">H_</span> <span class="o">=</span> <span class="n">H</span><span class="p">[</span><span class="n">hessConsidered</span><span class="p">]</span>
                    <span class="n">H0_</span> <span class="o">=</span> <span class="n">H0</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
                    <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance&quot;</span>
            
            
            <span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">repeat</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">while</span> <span class="n">repeat</span><span class="p">:</span>
                <span class="n">repeat</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="k">if</span> <span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Infinite loop&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">J</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> 
                                       <span class="n">free_considered</span><span class="p">)</span>
                
                <span class="c1"># ----- CONSTRAINED MAXIMIZATION -----------------------------------</span>
                <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span> <span class="ow">or</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span><span class="p">:</span>
                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span>
                    <span class="n">tmpRadius</span> <span class="o">=</span> <span class="n">nuisanceRadius</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">J_</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                    <span class="n">ballsearch</span> <span class="o">=</span> <span class="kc">True</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="p">:</span>
                            <span class="n">xiTmp</span> <span class="o">+=</span> <span class="n">xiRadius</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance_const&quot;</span>
                
                <span class="c1"># ----- BALL SEARCH ------------------------------------------------   </span>
                <span class="k">if</span> <span class="n">ballsearch</span><span class="p">:</span>
                    <span class="n">increaseTrustRegion</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">xiPrev</span> <span class="o">=</span> <span class="n">xi</span>
                    <span class="n">nAdjustement</span> <span class="o">=</span> <span class="mi">5</span>
                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchecks</span><span class="p">):</span>
                        
                        <span class="c1"># it can happen that the radius is so conservative that</span>
                        <span class="c1"># the nuisance parameters cannot be maximized </span>
                        <span class="c1"># sufficiently far to keep f in the admissible region</span>
                        <span class="n">nRatioAdjustement</span> <span class="o">=</span> <span class="mi">10</span>
                        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nRatioAdjustement</span><span class="p">):</span>
                            <span class="c1">#print(&quot;tmpRadius&quot;, tmpRadius)</span>
                            <span class="n">xTmp_diff</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">subproblem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">tmpRadius</span><span class="p">,</span> 
                                                            <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;normal&quot;</span><span class="p">,</span>
                                                            <span class="n">jac0tol</span><span class="o">=</span><span class="n">singtol</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">xi</span> <span class="o">&gt;</span> <span class="n">xiTmp</span> <span class="ow">and</span> <span class="n">f</span><span class="o">&gt;</span><span class="n">target</span><span class="p">:</span>
                                <span class="c1"># Somethong went wrong. Print debug information.</span>
                                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Something went wrong. Please report this error &quot;</span>
                                              <span class="s2">&quot;and the information below to the bugtracker. &quot;</span>
                                              <span class="s2">&quot;Presumably the result is correct anyway.&quot;</span><span class="p">)</span>
                                <span class="k">try</span><span class="p">:</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;searchmode, maximizing&quot;</span><span class="p">,</span> <span class="n">searchmode</span><span class="p">,</span> <span class="n">maximizing</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;a, p =&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;q, fPL0 =&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">fPL0</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;f, target, targetTmp =&quot;</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>  <span class="n">targetTmp</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xiTmp, xi =&quot;</span><span class="p">,</span> <span class="n">xiTmp</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">xi</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xi1, xi2 =&quot;</span><span class="p">,</span> <span class="n">xi1</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">xi2</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xiStep, infstep =&quot;</span><span class="p">,</span> <span class="n">xiStep</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">infstep</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;tmpRadius, radius =&quot;</span><span class="p">,</span> <span class="n">tmpRadius</span><span class="p">,</span> <span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">radius</span><span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;index, direction, k, l =&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">forward</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">l</span> <span class="p">)</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;xTmp[index]&quot;</span><span class="p">,</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;---------------------&quot;</span><span class="p">)</span>
                                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                                    <span class="k">pass</span>
                            <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">xiTmp</span>
                            <span class="n">xTmp</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">]</span> <span class="o">+=</span> <span class="n">xTmp_diff</span>
                            <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
                            <span class="c1"># if we maximize w.r.t. the nuisance parameters,</span>
                            <span class="c1"># we want to assure that f gets increased to get</span>
                            <span class="c1"># back to the likelihood ridge</span>
                            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span> <span class="ow">and</span> 
                                    <span class="ow">not</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span><span class="p">):</span>
                                <span class="k">break</span>
                            <span class="n">precise</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="n">JActual</span> <span class="o">=</span> <span class="n">test_precision</span><span class="p">()</span>
                            <span class="k">if</span> <span class="n">fPredicted</span> <span class="o">&gt;=</span> <span class="n">f</span><span class="p">:</span>
                                <span class="k">break</span>
                            <span class="c1"># if the step is super close and f still does not </span>
                            <span class="c1"># increase, there must be a numerical issue. We</span>
                            <span class="c1"># leave the treatment of this issue to the procedures</span>
                            <span class="c1"># below.</span>
                            <span class="k">elif</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">xiTmp</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">minstep</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="ow">and</span> <span class="n">tmpRadius</span><span class="o">&lt;</span><span class="n">minstep</span><span class="o">/</span><span class="mi">100</span><span class="p">):</span>
                                <span class="k">break</span>
                            
                            <span class="k">if</span> <span class="n">l</span> <span class="o">==</span> <span class="n">nRatioAdjustement</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>
                                <span class="n">xiPrev</span> <span class="o">=</span> <span class="n">xiTmp</span>
                                <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># we either increase the search radius for the</span>
                                <span class="c1"># nuisance parameters or decrease the search</span>
                                <span class="c1"># radius for the parameter of interest dependent</span>
                                <span class="c1"># on whether the approximation is precise and</span>
                                <span class="c1"># we can increase the trust region or not</span>
                                <span class="k">if</span> <span class="n">increaseTrustRegion</span> <span class="ow">and</span> <span class="n">precise</span> <span class="ow">and</span> <span class="n">tmpRadius</span> <span class="o">&lt;</span> <span class="n">maxRadius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xTmp_diff</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                                    <span class="n">tmpRadius</span> <span class="o">*=</span> <span class="mi">2</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># if the error occurs even though xi is </span>
                                    <span class="c1"># constant, there must be an error in the </span>
                                    <span class="c1"># approximate solution and we decrease the</span>
                                    <span class="c1"># search radius</span>
                                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isclose</span><span class="p">(</span><span class="n">xiTmp</span><span class="p">,</span> <span class="n">xi</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">minstep</span><span class="o">/</span><span class="mi">100</span><span class="p">):</span>
                                        <span class="n">tmpRadius</span> <span class="o">/=</span> <span class="mi">5</span>
                                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="o">+</span><span class="n">xiTmp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                                    
                        <span class="c1"># if maximizing w.r.t. the nuisance parameters,</span>
                        <span class="c1"># adjust the trust region</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span> <span class="ow">or</span> 
                                <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span><span class="p">):</span>
                            <span class="k">if</span> <span class="n">precise</span><span class="p">:</span>
                                <span class="c1"># update trust region</span>
                                <span class="n">nuisanceRadius</span> <span class="o">=</span> <span class="n">tmpRadius</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">J_</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                                <span class="c1"># update xiRadius only if we have changed xi</span>
                                <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span><span class="p">:</span>
                                    <span class="k">if</span> <span class="n">xi</span> <span class="o">!=</span> <span class="n">xiTmp</span><span class="p">:</span>
                                        <span class="n">xiRadius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xiTmp</span><span class="o">-</span><span class="n">xi</span><span class="p">,</span> <span class="n">minstep</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># if we had to set xiRadius to 0, we set </span>
                                        <span class="c1"># it to the last non-zero value</span>
                                        <span class="n">xiRadius</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xiPrev</span><span class="o">-</span><span class="n">xi</span><span class="p">,</span> <span class="n">minstep</span><span class="p">)</span>
                                    <span class="c1"># since the xiRadius cannot recover on its</span>
                                    <span class="c1"># own, we always gradually increase it</span>
                                    <span class="k">if</span> <span class="mi">2</span><span class="o">*</span><span class="n">xiRadius</span> <span class="o">&lt;</span> <span class="n">nuisanceRadius</span><span class="p">:</span>
                                        <span class="n">xiRadius</span> <span class="o">*=</span> <span class="mi">2</span>
                                
                                <span class="c1"># if we have not decreased the trust region </span>
                                <span class="c1"># before, try to increase it</span>
                                <span class="k">if</span> <span class="n">increaseTrustRegion</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">nAdjustement</span><span class="p">:</span>
                                    <span class="n">xTmp2</span> <span class="o">=</span> <span class="n">xTmp</span>
                                    <span class="n">fActual2</span> <span class="o">=</span> <span class="n">fActual</span>
                                    <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">xiRadius</span>
                                    <span class="n">tmpRadius</span> <span class="o">*=</span> <span class="mi">2</span>
                                    <span class="n">tmpRadius</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxRadius</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">xTmp_diff</span><span class="o">.</span><span class="n">size</span><span class="p">),</span>
                                                    <span class="n">tmpRadius</span><span class="p">)</span>
                                    <span class="k">continue</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">stop</span> <span class="o">=</span> <span class="kc">False</span>
                                <span class="k">if</span> <span class="n">increaseTrustRegion</span><span class="p">:</span> 
                                    <span class="k">if</span> <span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  
                                        <span class="c1"># if in the first iteration, note that </span>
                                        <span class="c1"># we are decreasing the trust region</span>
                                        <span class="n">increaseTrustRegion</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="c1"># set xTmp to the last precise value</span>
                                        <span class="n">fActual</span> <span class="o">=</span> <span class="n">fActual2</span>
                                        <span class="n">xTmp</span> <span class="o">=</span> <span class="n">xTmp2</span>
                                        <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                        <span class="n">stop</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>    
                            <span class="n">stop</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> <span class="n">JActual</span> <span class="o">=</span> <span class="n">test_precision</span><span class="p">()</span>
                        
                        <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
                            
                            <span class="k">if</span> <span class="n">stop</span><span class="p">:</span>
                                <span class="c1"># if the approximation is precise, we may increase</span>
                                <span class="c1"># the radius, but save the largest current result</span>
                                <span class="c1"># to fall back to</span>
                                <span class="n">xTmp2</span> <span class="o">=</span> <span class="n">xTmp</span>
                                <span class="n">fActual2</span> <span class="o">=</span> <span class="n">fActual</span>
                                <span class="n">lowerRadius</span> <span class="o">=</span> <span class="n">tmpRadius</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">upperRadius</span> <span class="o">=</span> <span class="n">tmpRadius</span>
                                
                            <span class="c1"># if we have to decrease the trust region</span>
                            <span class="k">if</span> <span class="n">upperRadius</span> <span class="o">&lt;=</span> <span class="n">lowerRadius</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">stop</span><span class="p">:</span>
                                <span class="c1"># continue with the continuity checks and</span>
                                <span class="c1"># cut the trust trust region by half</span>
                                <span class="k">pass</span>
                            <span class="c1"># if precision of geometric binary search is as </span>
                            <span class="c1"># desired (first equality necessary to prevent NaNs)</span>
                            <span class="k">elif</span> <span class="n">upperRadius</span><span class="o">==</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">upperRadius</span><span class="o">/</span><span class="n">lowerRadius</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="c1"># stop iteration and set xTmp to the optimal </span>
                                <span class="c1"># value</span>
                                <span class="k">if</span> <span class="n">lowerRadius</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                                    <span class="n">radius</span> <span class="o">=</span> <span class="n">lowerRadius</span>
                                <span class="n">fActual</span> <span class="o">=</span> <span class="n">fActual2</span>
                                <span class="n">xTmp</span> <span class="o">=</span> <span class="n">xTmp2</span>
                                <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                                <span class="k">break</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="c1"># update xiTmp and radius</span>
                                <span class="n">tmpRadius</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">lowerRadius</span><span class="o">*</span><span class="n">upperRadius</span><span class="p">)</span>
                                <span class="n">xiTmp</span> <span class="o">=</span> <span class="n">xi</span> <span class="o">+</span> <span class="n">xiStep</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">tmpRadius</span><span class="o">/</span><span class="n">radius</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">radiusFactor</span><span class="p">))</span>
                                <span class="k">continue</span>
                        <span class="k">elif</span> <span class="n">stop</span><span class="p">:</span>
                            <span class="k">break</span>
                        
                        <span class="n">minstepTmp</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">minstep</span> <span class="o">/</span> <span class="nb">max</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">J_</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="mf">1e-12</span><span class="p">)</span>
                        
                        <span class="c1"># if the step is too small</span>
                        <span class="n">diffs</span> <span class="o">=</span> <span class="n">xTmp</span> <span class="o">-</span> <span class="n">x</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">stop</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">xTmp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">atol</span><span class="o">=</span><span class="n">minstepTmp</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="mf">1e-14</span><span class="p">):</span>
                            
                            <span class="c1"># if we are not really on a discontinuity but only </span>
                            <span class="c1"># on a local maximum with a non-negative definite</span>
                            <span class="c1"># Hessian, we may just release the constraint</span>
                            <span class="c1"># that we need to get to a larger function value</span>
                            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">searchmode</span><span class="o">==</span><span class="s2">&quot;normal&quot;</span> <span class="ow">or</span> <span class="n">maximizing</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">closeToDisc</span><span class="p">:</span> 
                                <span class="n">relax_maximum_constraint</span> <span class="o">=</span> <span class="kc">True</span>
                                <span class="n">discontinuity_counter</span> <span class="o">=</span> <span class="mi">20</span>
                                <span class="k">if</span> <span class="n">test_precision</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="k">break</span>
                                
                            <span class="c1"># check parameter of interest first</span>
                            <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diffs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
                            
                            <span class="c1"># if small change in parameter of interest makes </span>
                            <span class="c1"># approximation imprecise</span>
                            <span class="k">if</span> <span class="n">diffs</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">test_precision</span><span class="p">()[</span><span class="mi">0</span><span class="p">]:</span>
                                
                                <span class="c1"># make sure discontinuity happens on </span>
                                <span class="c1"># profile function</span>
                                <span class="k">if</span> <span class="n">norm</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">resulttol</span><span class="p">:</span>
                                    <span class="n">relax_maximum_constraint</span> <span class="o">=</span> <span class="kc">False</span>
                                    <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;max_nuisance_const&quot;</span>
                                    <span class="n">closeToDisc</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">xiDisc</span> <span class="o">=</span> <span class="n">xi</span>
                                    <span class="n">repeat</span> <span class="o">=</span> <span class="kc">True</span>
                                    <span class="n">radius</span> <span class="o">=</span> <span class="n">tmpRadius</span>
                                    <span class="k">break</span>
                                
                                <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                                <span class="n">fCloseTarget</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> 
                                                            <span class="n">atol</span><span class="o">=</span><span class="n">resulttol</span><span class="p">)</span> <span class="ow">and</span>
                                                <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">fActual</span><span class="p">,</span> 
                                                                <span class="n">atol</span><span class="o">=</span><span class="n">resulttol</span><span class="p">))</span>
                                
                                <span class="c1"># if step is favourable or benign, we accept </span>
                                <span class="c1"># depending on the distance measure this case</span>
                                <span class="c1"># will never occur, as favourable steps may </span>
                                <span class="c1"># always be classified as precise</span>
                                <span class="k">if</span> <span class="n">fActual</span> <span class="o">&gt;=</span> <span class="n">target</span> <span class="ow">or</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="n">fActual</span><span class="p">:</span>
                                    <span class="k">pass</span>
                                <span class="c1"># if the target is on the jump</span>
                                <span class="k">elif</span> <span class="p">((</span><span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span> <span class="ow">or</span> <span class="n">fCloseTarget</span><span class="p">)</span>
                                      <span class="ow">and</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">):</span>
                                    <span class="c1"># stop here</span>
                                    <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
                                    <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;discontinuous&quot;</span>
                                    <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span>
                                    <span class="n">JActual</span> <span class="o">=</span> <span class="n">J</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="c1"># get back to the feasible region by </span>
                                    <span class="c1"># conducting a binary search</span>
                                    <span class="n">searchmode</span> <span class="o">=</span> <span class="s2">&quot;binary_search&quot;</span>
                                    
                                <span class="n">dispprint</span><span class="p">(</span><span class="s2">&quot;iter </span><span class="si">{:3d}{}</span><span class="s2">: ***discontinuity of </span><span class="si">{}</span><span class="s2"> in x_</span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2">***&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">f</span><span class="o">-</span><span class="n">fActual</span><span class="p">,</span> 
                                            <span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="p">))</span>
                                <span class="k">break</span>
                            
                            <span class="c1"># check for discontinuities in nuisance parameters</span>
                            <span class="n">discontinuities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">free_considered</span><span class="p">)</span>
                            <span class="n">discontinuities_rejected</span> <span class="o">=</span> <span class="n">discontinuities</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="n">f_approx_precise</span><span class="p">(</span><span class="n">fPredicted</span><span class="p">,</span> <span class="n">fActual</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">diffs</span><span class="p">[</span><span class="n">index</span><span class="p">]:</span>
                                    <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
                                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fActual</span> <span class="o">=</span> <span class="n">f</span>
                                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">free_considered</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="n">xTmp</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diffs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                                    <span class="n">fActual_previous</span> <span class="o">=</span> <span class="n">fActual</span>
                                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                                    <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">f_approx_precise</span><span class="p">(</span><span class="n">fPredicted</span><span class="p">,</span> <span class="n">fActual</span><span class="p">):</span>
                                        <span class="n">discontinuities</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">if</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">fActual_previous</span><span class="p">:</span>
                                            <span class="n">discontinuities_rejected</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="n">xTmp</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                                            <span class="n">fActual</span> <span class="o">=</span> <span class="n">fActual_previous</span>
                                <span class="n">jacDiscont</span> <span class="o">=</span> <span class="kc">False</span>
                            <span class="c1"># if the gradient is responsible for the rejection</span>
                            <span class="c1"># we require a smaller steap</span>
                            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">resulttol</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">xTmp</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">rtol</span><span class="o">=</span><span class="n">minstepTmp</span><span class="o">/</span><span class="mi">10</span><span class="p">):</span>
                                <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="o">~</span><span class="n">free_considered</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                                    <span class="n">xTmp</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">+=</span> <span class="n">diffs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                                    <span class="n">JActual_previous</span> <span class="o">=</span> <span class="n">JActual</span>
                                    <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span> 
                                    <span class="n">JPredicted</span> <span class="o">=</span> <span class="n">JPredicted_fun</span><span class="p">()</span>
                                    <span class="n">jac_precise</span> <span class="o">=</span> <span class="n">jac_approx_precise</span><span class="p">(</span><span class="n">JPredicted</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">],</span> <span class="n">JActual</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">],</span> <span class="n">J</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">])</span> 
                                    <span class="k">if</span> <span class="ow">not</span> <span class="n">jac_precise</span><span class="p">:</span>
                                        <span class="n">discontinuities</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">JActual_previous</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">*</span> <span class="n">J</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> 
                                                <span class="ow">or</span> <span class="n">diffs</span><span class="p">[</span><span class="n">l</span><span class="p">]</span><span class="o">*</span><span class="n">J</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
                                            <span class="n">discontinuities_rejected</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                                            <span class="n">xTmp</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">l</span><span class="p">]</span>
                                            <span class="n">JActual</span> <span class="o">=</span> <span class="n">JActual_previous</span>
                                <span class="n">jacDiscont</span> <span class="o">=</span> <span class="kc">True</span>
                            

                            <span class="k">if</span> <span class="n">discontinuities</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                
                                <span class="n">varStr</span> <span class="o">=</span> <span class="s2">&quot;variables&quot;</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">jacDiscont</span> <span class="k">else</span> <span class="s2">&quot;gradient entries&quot;</span>
                                    
                                <span class="n">dispprint</span><span class="p">(</span><span class="s2">&quot;iter </span><span class="si">{:3d}{}</span><span class="s2">: ***index=</span><span class="si">{}</span><span class="s2">: discontinuities in </span><span class="si">{}</span><span class="s2"> </span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2">***&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                            <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">varStr</span><span class="p">,</span>
                                            <span class="nb">tuple</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">discontinuities</span><span class="p">)[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">x</span><span class="p">))</span>
                                
                                <span class="n">redoIteration</span> <span class="o">=</span> <span class="n">discontinuities</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">==</span> <span class="n">discontinuities_rejected</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                                
                                <span class="k">if</span> <span class="n">discontinuities_rejected</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                                    <span class="n">discontinuity_counter</span> <span class="o">=</span> <span class="mi">25</span>
                                    <span class="n">considered</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">discontinuities_rejected</span>
                                    <span class="n">free_considered</span> <span class="o">|=</span> <span class="n">discontinuities_rejected</span>
                                    <span class="n">free_considered_</span> <span class="o">=</span> <span class="n">free_considered</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
                                    <span class="n">hessConsidered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">considered</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>
                                    <span class="n">relax_maximum_constraint</span> <span class="o">=</span> <span class="kc">False</span>
                                
                                <span class="k">break</span>
                        <span class="k">if</span> <span class="n">tmpRadius</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">radiusFactor</span><span class="o">**</span><span class="n">nchecks</span><span class="o">-</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">minstep</span><span class="p">:</span>
                            <span class="n">tmpRadius</span> <span class="o">/=</span> <span class="mi">5</span>
                            <span class="n">xiTmp</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">xi</span><span class="o">+</span><span class="n">xiTmp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">5</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">tmpRadius</span> <span class="o">/=</span> <span class="n">radiusFactor</span>
                            <span class="n">xiTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">xi</span><span class="o">+</span><span class="n">xiTmp</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">xTmp</span> <span class="o">=</span> <span class="n">x</span>
                        <span class="n">JActual</span> <span class="o">=</span> <span class="n">J</span>
                        <span class="n">fActual</span> <span class="o">=</span> <span class="n">f</span>
            
            <span class="k">if</span> <span class="n">redoIteration</span><span class="p">:</span>
                <span class="k">continue</span>
                    
            <span class="c1"># ----- BINARY SEARCH ----------------------------------------------</span>
            <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;binary_search&quot;</span><span class="p">:</span>
                <span class="n">tol</span> <span class="o">=</span> <span class="mf">0.01</span>
                <span class="n">bin_min</span> <span class="o">=</span> <span class="n">x</span>
                <span class="n">bin_max</span> <span class="o">=</span> <span class="n">x_max</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchecks</span><span class="p">):</span>
                    <span class="n">xTmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">bin_max</span><span class="o">+</span><span class="n">bin_min</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                    
                    <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">fActual</span> <span class="o">-</span> <span class="n">target</span> <span class="o">&lt;</span> <span class="n">tol</span><span class="p">:</span>
                        <span class="k">break</span>
                    
                    <span class="k">if</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">target</span><span class="p">:</span>
                        <span class="n">bin_min</span> <span class="o">=</span> <span class="n">xTmp</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">bin_max</span> <span class="o">=</span> <span class="n">xTmp</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">xTmp</span> <span class="o">=</span> <span class="n">bin_max</span>
                <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                        
                        
            <span class="c1"># ----- UPDATES &amp; CEHCKS -------------------------------------------</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">xTmp</span> <span class="o">==</span> <span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">jacDiscont</span> <span class="ow">and</span> <span class="n">resultmode</span><span class="o">==</span><span class="s2">&quot;searching&quot;</span><span class="p">:</span>
                <span class="n">dispprint</span><span class="p">(</span><span class="s2">&quot;iter </span><span class="si">{:3d}{}</span><span class="s2">: ***no improvement when optimizing x_</span><span class="si">{}</span><span class="s2"> at </span><span class="si">{}</span><span class="s2">***&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;discontinuous&quot;</span>
            
            
            
            <span class="n">xiChange</span> <span class="o">=</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="n">xi</span>
            <span class="n">xChange</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">xTmp</span><span class="p">)</span>
            
            <span class="c1"># when we are maximizing the nuisance parameters, we may step </span>
            <span class="c1"># farther than the allowedbound</span>
            <span class="k">if</span> <span class="n">xiChange</span> <span class="o">&gt;=</span> <span class="n">infstep</span> <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;=</span> <span class="n">target</span><span class="p">:</span>
                <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;unbounded&quot;</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span> <span class="ow">or</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span>
                  <span class="ow">or</span> <span class="n">maximizing</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">xiChange</span> <span class="o">&lt;</span> <span class="n">nuisance_minstep</span> 
                                      <span class="ow">and</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span><span class="o">+</span><span class="n">resulttol</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xi_hist</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xi_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span> <span class="o">-</span> <span class="n">xi</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nuisance_minstep</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span>
                    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_hist</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:])</span> <span class="o">-</span> <span class="n">f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">nuisance_minstep</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
                    
                    <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nuisance_minstep</span>
                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">fActual_previous</span> <span class="o">=</span> <span class="n">fActual</span>
                    <span class="n">xTmp_previous</span> <span class="o">=</span> <span class="n">xTmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">while</span> <span class="n">fActual</span> <span class="o">&gt;</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                        <span class="n">fActual_previous</span> <span class="o">=</span> <span class="n">fActual</span>
                        <span class="n">xTmp_previous</span> <span class="o">=</span> <span class="n">xTmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nuisance_minstep</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">m</span>
                        <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                        <span class="n">m</span> <span class="o">+=</span> <span class="mi">1</span>
                    
                    <span class="n">xTmp</span> <span class="o">=</span> <span class="n">xTmp_previous</span>
                    <span class="n">fActual</span> <span class="o">=</span> <span class="n">fActual_previous</span>
                    
                    <span class="n">m</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                    <span class="k">while</span> <span class="n">fActual</span> <span class="o">&lt;</span> <span class="n">target</span><span class="o">-</span><span class="mi">50</span> <span class="ow">and</span> <span class="n">m</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">:</span>
                        <span class="n">fActual_previous</span> <span class="o">=</span> <span class="n">fActual</span>
                        <span class="n">xTmp_previous</span> <span class="o">=</span> <span class="n">xTmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">+=</span> <span class="n">nuisance_minstep</span> <span class="o">*</span> <span class="mi">2</span><span class="o">**</span><span class="n">m</span>
                        <span class="n">fActual</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                        <span class="n">m</span> <span class="o">-=</span> <span class="mi">1</span>
                    
                    
                    <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
                    
                    <span class="n">dispprint</span><span class="p">(</span><span class="s2">&quot;iter </span><span class="si">{:3d}{}</span><span class="s2">: ***taking additional step in x_</span><span class="si">{}</span><span class="s2"> to avoid convergence issues. f=</span><span class="si">{:6.3}</span><span class="s2">***&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">fActual</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">):</span>
                        <span class="n">xi_hist</span><span class="p">[</span><span class="o">-</span><span class="n">m</span><span class="p">]</span> <span class="o">+=</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">-</span><span class="n">xi</span>
                <span class="n">xi_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
                <span class="n">f_hist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fActual</span><span class="p">)</span>
            
            <span class="n">x</span> <span class="o">=</span> <span class="n">xTmp</span>
            <span class="n">xi</span> <span class="o">=</span> <span class="n">xTmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="n">JActual</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">JActual</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">xTmp</span><span class="p">)</span>
            <span class="n">JImprovement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">J</span><span class="p">[</span><span class="n">considered</span><span class="p">])</span><span class="o">/</span><span class="n">norm</span><span class="p">(</span><span class="n">JActual</span><span class="p">[</span><span class="n">considered</span><span class="p">]))</span>
            <span class="n">fImprovement</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">fActual</span><span class="o">-</span><span class="n">target</span><span class="p">)))</span>
            
            <span class="n">J</span> <span class="o">=</span> <span class="n">JActual</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">fActual</span>
            <span class="n">JActual_</span> <span class="o">=</span> <span class="n">JActual</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
            
            <span class="c1"># reset maximal value</span>
            <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">target</span> <span class="ow">and</span> <span class="n">xi</span> <span class="o">&gt;</span> <span class="n">xi_max</span><span class="p">:</span>
                <span class="n">xi_max</span> <span class="o">=</span> <span class="n">xi</span>
                <span class="n">x_max</span> <span class="o">=</span> <span class="n">x</span>
            
            <span class="n">fPredicted</span> <span class="o">=</span> <span class="n">fPredicted_fun</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">disp</span><span class="p">:</span>
                <span class="n">radius_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="k">if</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;normal&quot;</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">maximizing</span><span class="p">:</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;maximizing&quot;</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;searching&quot;</span>
                <span class="k">elif</span> <span class="p">(</span><span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance&quot;</span> 
                      <span class="ow">or</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;max_nuisance_const&quot;</span><span class="p">):</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;maximizing nuisance parameters&quot;</span>
                    <span class="n">radius_str</span> <span class="o">=</span> <span class="s2">&quot;; step=</span><span class="si">{}</span><span class="s2">; radius=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                        <span class="n">__round_str</span><span class="p">(</span><span class="n">xiRadius</span><span class="p">),</span> <span class="n">__round_str</span><span class="p">(</span><span class="n">nuisanceRadius</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">searchmode</span> <span class="o">==</span> <span class="s2">&quot;binary_search&quot;</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;binary search&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;other&quot;</span>
                
                <span class="n">ndiscont</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">considered</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">ndiscont</span><span class="p">:</span>
                    <span class="n">discontStr</span> <span class="o">=</span> <span class="s2">&quot;; ndisct=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ndiscont</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">discontStr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    
                <span class="k">if</span> <span class="n">free_params_exist</span> <span class="ow">and</span> <span class="n">free_considered_</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">mode</span> <span class="o">+=</span> <span class="s2">&quot; with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">free_considered_</span><span class="p">)</span>
                                           <span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; free params&quot;</span>
                    <span class="n">jac_cnsStr</span> <span class="o">=</span> <span class="s2">&quot;; jac_cns=</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">__round_str</span><span class="p">(</span>
                            <span class="n">norm</span><span class="p">(</span><span class="n">JActual</span><span class="p">[</span><span class="o">~</span><span class="n">free_considered</span><span class="p">])))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">jac_cnsStr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                    
                <span class="n">dispprint</span><span class="p">((</span><span class="s2">&quot;iter </span><span class="si">{:3d}{}</span><span class="s2">: x_</span><span class="si">{}</span><span class="s2">_d=</span><span class="si">{}</span><span class="s2">; f_d=</span><span class="si">{}</span><span class="s2">; jac_d=</span><span class="si">{}</span><span class="s2">; &quot;</span> <span class="o">+</span> 
                       <span class="s2">&quot;nsteps=</span><span class="si">{:2d}</span><span class="s2">; x_d=</span><span class="si">{}</span><span class="s2">; f_impr=</span><span class="si">{}</span><span class="s2">; jac_impr=</span><span class="si">{}</span><span class="s2">; &quot;</span> <span class="o">+</span>
                       <span class="s2">&quot;f_e=</span><span class="si">{}{}{}{}</span><span class="s2"> - </span><span class="si">{}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> 
                                                 <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> 
                                                 <span class="n">__round_str</span><span class="p">(</span><span class="n">xi</span><span class="o">-</span><span class="n">x0</span><span class="p">[</span><span class="n">index</span><span class="p">]),</span> 
                                                 <span class="n">__round_str</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">),</span> 
                                                 <span class="n">__round_str</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">JActual_</span><span class="p">)),</span> <span class="n">k</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> 
                                                 <span class="n">__round_str</span><span class="p">(</span><span class="n">xChange</span><span class="p">),</span> 
                                                 <span class="n">__round_str</span><span class="p">(</span><span class="n">fImprovement</span><span class="p">),</span> 
                                                 <span class="n">__round_str</span><span class="p">(</span><span class="n">JImprovement</span><span class="p">),</span> 
                                                 <span class="n">__round_str</span><span class="p">(</span><span class="n">fActual</span><span class="o">-</span><span class="n">fPredicted</span><span class="p">),</span> 
                                                 <span class="n">jac_cnsStr</span><span class="p">,</span> <span class="n">discontStr</span><span class="p">,</span> 
                                                 <span class="n">radius_str</span><span class="p">,</span> <span class="n">mode</span><span class="p">))</span>
            
            
            <span class="k">if</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;searching&quot;</span><span class="p">:</span>
                <span class="n">resViol</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">norm</span><span class="p">(</span><span class="n">JActual_</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">f</span><span class="o">-</span><span class="n">target</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">resViol</span> <span class="o">&lt;=</span> <span class="n">resulttol</span><span class="p">:</span>
                    <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            
            <span class="k">if</span> <span class="n">f</span> <span class="o">&gt;</span> <span class="n">maxFun</span><span class="p">:</span>
                <span class="n">dispprint</span><span class="p">(</span><span class="s2">&quot;-&gt; iter </span><span class="si">{:3d}{}</span><span class="s2">: !!!found NEW MAXIMUM for x_</span><span class="si">{}</span><span class="s2"> of </span><span class="si">{:6.3f}</span><span class="s2"> (+</span><span class="si">{:6.3f}</span><span class="s2">) at </span><span class="si">{}</span><span class="s2">!!!&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">i</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span> <span class="k">if</span> <span class="n">forward</span> <span class="k">else</span> <span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">f</span><span class="o">-</span><span class="n">fun0</span><span class="p">,</span> <span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
                <span class="n">maxFun</span> <span class="o">=</span> <span class="n">f</span>
            
            <span class="k">if</span> <span class="n">closeToDisc</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xi</span> <span class="o">-</span> <span class="n">xiDisc</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">minstep</span><span class="p">:</span>
                    <span class="n">closeToDisc</span> <span class="o">=</span> <span class="kc">False</span>
            
            <span class="n">H</span> <span class="o">=</span> <span class="n">hess</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        
        <span class="k">else</span><span class="p">:</span>
            <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;exceeded&quot;</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;linalg_error&quot;</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">,</span>
                                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">resultmode</span> <span class="o">=</span> <span class="s2">&quot;error&quot;</span>
        <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">,</span>
                                  <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>

    
    <span class="k">if</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;success&quot;</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;discontinuous&quot;</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;unbounded&quot;</span><span class="p">:</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">2</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">elif</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;exceeded&quot;</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">status</span> <span class="o">=</span> <span class="mi">3</span>
    <span class="k">elif</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span> <span class="ow">or</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;linalg_error&quot;</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>        
            <span class="n">JActual_</span> <span class="o">=</span> <span class="n">J_</span>
        <span class="k">except</span> <span class="ne">UnboundLocalError</span><span class="p">:</span>
            <span class="n">JActual_</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">considered</span><span class="p">]</span>
        <span class="n">success</span><span class="o">=</span><span class="kc">False</span>
        <span class="k">if</span> <span class="n">resultmode</span> <span class="o">==</span> <span class="s2">&quot;error&quot;</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span> <span class="o">=</span> <span class="mi">4</span>
    
    <span class="n">dispprint</span><span class="p">(</span><span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                         <span class="n">fun</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                         <span class="n">jac</span><span class="o">=</span><span class="n">JActual_</span><span class="p">,</span>
                         <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                         <span class="n">nfev</span><span class="o">=</span><span class="n">fun</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="n">jac</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="n">hess</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> 
                         <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                         <span class="n">message</span><span class="o">=</span><span class="n">STATUS_MESSAGES</span><span class="p">[</span><span class="n">status</span><span class="p">]</span>
                         <span class="p">))</span>
    
    <span class="k">if</span> <span class="n">track_f</span><span class="p">:</span>
        <span class="n">f_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">track_x</span><span class="p">:</span>
        <span class="n">x_track</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">flip</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> 
                             <span class="n">fun</span><span class="o">=</span><span class="n">f</span><span class="p">,</span>
                             <span class="n">jac</span><span class="o">=</span><span class="n">JActual_</span><span class="p">,</span>
                             <span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="n">status</span><span class="p">,</span>
                             <span class="n">nfev</span><span class="o">=</span><span class="n">fun</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="n">jac</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> <span class="n">nhev</span><span class="o">=</span><span class="n">hess</span><span class="o">.</span><span class="n">evals</span><span class="p">,</span> 
                             <span class="n">nit</span><span class="o">=</span><span class="n">i</span><span class="p">,</span>
                             <span class="n">x_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x_track</span><span class="p">),</span>
                             <span class="n">f_track</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">f_track</span><span class="p">),</span>
                             <span class="n">message</span><span class="o">=</span><span class="n">STATUS_MESSAGES</span><span class="p">[</span><span class="n">status</span><span class="p">]</span>
                             <span class="p">)</span></div>

<span class="k">def</span> <span class="nf">__parallel_helper_fun</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">find_CI_bound</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="o">**</span><span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

<div class="viewcode-block" id="find_CI"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm.html#ci_rvm.ci_rvm.find_CI">[docs]</a><span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">find_CI_bound</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">find_CI</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">directions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.95</span><span class="p">,</span> 
            <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_full_results</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">return_success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the profile likelihood confidence interval(s) for one or </span>
<span class="sd">    multiple parameters.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    indices : int[]</span>
<span class="sd">        Indices of the parameters of interest. If not given, all paramters</span>
<span class="sd">        will be considered.</span>
<span class="sd">    directions : float[][]</span>
<span class="sd">        Search directions. If not given, both end points of the confidence</span>
<span class="sd">        intervals will be determined. If given as a scalar, only lower</span>
<span class="sd">        end points will be returned if ``directions&lt;=0`` and upper end points </span>
<span class="sd">        otherwise. If given as an array, the confidence interval end points </span>
<span class="sd">        specified in row ``i`` will be returned for parameter ``i``. Entries ``&lt;=0``</span>
<span class="sd">        indicate that lower end points are desired, whereas positive entries </span>
<span class="sd">        will result in upper end points.</span>
<span class="sd">    parallel : bool</span>
<span class="sd">        If ``True``, results will be computed in parallel using ``multiprocessing.Pool``.</span>
<span class="sd">        Note that this requires that all arguments are pickable.</span>
<span class="sd">    return_full_results : bool</span>
<span class="sd">        If ``True``, an ``OptimizeResult`` object will be returned for each </span>
<span class="sd">        confidence interval bound. Otherwise, only the confidence interval </span>
<span class="sd">        bounds for the parameters in question will be returned.</span>
<span class="sd">    return_success : bool</span>
<span class="sd">        If ``True``, an array of the same shape as the result will be returned</span>
<span class="sd">        in addition, indicating for each confidence interval bound whether it </span>
<span class="sd">        was determined successfully. </span>
<span class="sd">    **kwargs : keyword arguments</span>
<span class="sd">        Other keyword arguments passed to :py:meth:`find_CI_bound`. Look at </span>
<span class="sd">        the documentation there.</span>
<span class="sd">        </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">indices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">indices</span><span class="p">):</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="p">(</span><span class="n">indices</span><span class="p">,)</span>
    
    <span class="k">if</span> <span class="n">directions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="mi">2</span><span class="p">))</span>
        <span class="n">directions</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">directions</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">directions</span><span class="p">):</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="mi">1</span><span class="p">),</span> <span class="n">directions</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">directions</span><span class="p">)</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">directions</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">directions</span> <span class="o">=</span> <span class="n">directions</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">directions</span> <span class="o">=</span> <span class="p">[[</span><span class="n">i</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">i</span> 
                      <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">directions</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="s2">&quot;fun0&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;fun0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fun</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;jac0&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">jac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;jac0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Gradient</span><span class="p">(</span><span class="n">fun</span><span class="p">)(</span><span class="n">x0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;jac0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;hess0&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">hess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;hess0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Hessian</span><span class="p">(</span><span class="n">fun</span><span class="p">)(</span><span class="n">x0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;hess0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">hess</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    
    <span class="n">task_chain</span> <span class="o">=</span> <span class="p">[]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">directions_</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">itercount</span><span class="p">(),</span> <span class="n">indices</span><span class="p">,</span> <span class="n">directions</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">direction</span> <span class="ow">in</span> <span class="n">directions_</span><span class="p">:</span>
            <span class="n">task_chain</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">i</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> 
                               <span class="n">alpha</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">parallel</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">Pool</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">__parallel_helper_fun</span><span class="p">,</span> <span class="n">task_chain</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">result_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">__parallel_helper_fun</span><span class="p">,</span> <span class="n">task_chain</span><span class="p">))</span>
    
    <span class="n">result</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">directions</span><span class="p">)))]</span>
    <span class="k">if</span> <span class="n">return_success</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="p">[[]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">indices</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">directions</span><span class="p">)))]</span>
    
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">res</span> <span class="ow">in</span> <span class="n">result_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">return_success</span><span class="p">:</span>
            <span class="n">success</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">return_full_results</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">return_success</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">success</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">success</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">success</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">success</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">result</span></div>

<div class="viewcode-block" id="find_function_CI"><a class="viewcode-back" href="../../ci_rvm/ci_rvm.ci_rvm.html#ci_rvm.ci_rvm.find_function_CI">[docs]</a><span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">find_CI</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">find_function_CI</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">logL</span><span class="p">,</span> 
                     <span class="n">functionJac</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">functionHess</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">logLJac</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> 
                     <span class="n">logLHess</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="n">relativeError</span> <span class="o">=</span> <span class="mf">1e-4</span><span class="p">,</span> 
                     <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Returns the profile likelihood confidence interval(s) for a function </span>
<span class="sd">    of parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    function : callable</span>
<span class="sd">       Function of the parameters for which the confidence interval shall be </span>
<span class="sd">       computed</span>
<span class="sd">    logL : callable</span>
<span class="sd">        Log-likelihood function.</span>
<span class="sd">    functionJac : callable</span>
<span class="sd">        Gradient of :py:obj:`function`. If `None`, it will be computed based on</span>
<span class="sd">        finite differences using numdifftools.</span>
<span class="sd">    functionHess : callable</span>
<span class="sd">        Hessian of :py:obj:`function`. If `None`, it will be computed based on</span>
<span class="sd">        finite differences using numdifftools.</span>
<span class="sd">    logLJac : callable</span>
<span class="sd">        Gradient of :py:obj:`logL`. If `None`, it will be computed based on</span>
<span class="sd">        finite differences using numdifftools.</span>
<span class="sd">    logLHess : callable</span>
<span class="sd">        Hessian of :py:obj:`logL`. If `None`, it will be computed based on</span>
<span class="sd">        finite differences using numdifftools.</span>
<span class="sd">    relativeError : float</span>
<span class="sd">        Permitted relative error in the confidence interval bound.</span>
<span class="sd">    **kwargs : keyword arguments</span>
<span class="sd">        Other keyword arguments passed to :py:meth:`find_CI` and</span>
<span class="sd">        :py:meth:`find_CI_bound`. Look at the documentation there.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">function0</span> <span class="o">=</span> <span class="n">function</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    <span class="n">error</span> <span class="o">=</span> <span class="n">function0</span> <span class="o">*</span> <span class="n">relativeError</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">function0</span><span class="p">)</span>
    
    <span class="n">fun_2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">((</span><span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="n">error</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">fun</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">logL</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="n">fun_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">functionJac</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">logLJac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">jac</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Gradient</span><span class="p">(</span><span class="n">fun</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">functionJac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">jac_2</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Gradient</span><span class="p">(</span><span class="n">fun_2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">jac_2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">x0</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="n">diffTerm</span> <span class="o">=</span> <span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">error</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">diffTerm</span>
                <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">functionJac</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="n">diffTerm</span>
                <span class="k">return</span> <span class="n">result</span>
        
        <span class="k">if</span> <span class="n">logLJac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">logLJac</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Gradient</span><span class="p">(</span><span class="n">logL</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">jac</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">jac_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">logLJac</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> 
            <span class="k">return</span> <span class="n">result</span>
        
    <span class="k">if</span> <span class="n">functionHess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">hess_2</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Hessian</span><span class="p">(</span><span class="n">fun_2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">functionJac</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">functionJac</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Gradient</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">hess_2</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">x0</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">x0</span><span class="o">.</span><span class="n">size</span><span class="p">))</span>
            <span class="n">functionJacX</span> <span class="o">=</span> <span class="n">functionJac</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> 
            <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">error</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="o">-</span><span class="n">functionJacX</span> <span class="o">/</span> <span class="n">error</span><span class="o">**</span><span class="mi">2</span>
            <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">functionHess</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">*</span> <span class="p">(</span><span class="n">function</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                              <span class="o">+</span> <span class="n">functionJacX</span> <span class="o">*</span> <span class="n">functionJacX</span><span class="p">[:,</span><span class="kc">None</span><span class="p">])</span> <span class="o">/</span> <span class="n">error</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">return</span> <span class="n">result</span>
        
    <span class="k">if</span> <span class="n">logLHess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logLHess</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">Hessian</span><span class="p">(</span><span class="n">logL</span><span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">hess</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
        <span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">hess_2</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">+=</span> <span class="n">logLHess</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="c1"># These arguments could lead to wrong results if passed on.</span>
    <span class="c1"># Hence, we ignore them.</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fun0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;jac0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;hess0&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">find_CI</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">fun</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">indices</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>
</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <div>
    <h3><a href="../../index.html">Table of Contents</a></h3>
    <ul>
<li class="toctree-l1"><a class="reference internal" href="../../hybrid_vector_model.html">hybrid_vector_model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ci_rvm.html">ci_rvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lopaths.html">lopaths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vemomoto_core.html">vemomoto_core</a></li>
</ul>

  </div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">VeMoMoTo</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">ci_rvm.ci_rvm</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Samuel M. Fischer.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 6.1.3.
    </div>
  </body>
</html>