
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta charset="utf-8" />
    <title>hybrid_vector_model.hybrid_vector_model &#8212; Vector Movement Modelling Tools</title>
    <link rel="stylesheet" href="../../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">VeMoMoTo</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hybrid_vector_model.hybrid_vector_model</h1><div class="highlight"><pre>
<span></span><span class="sd">&#39;&#39;&#39;</span>


<span class="sd">.. note:: This program was created with the motivation to model the traffic</span>
<span class="sd">    of boaters potentially carrying aquatic invasive species. Nonetheless,</span>
<span class="sd">    the tools are applicable to assess and control any vector road traffic. </span>
<span class="sd">    Due to the initial motivation, however, the wording within this file may at</span>
<span class="sd">    some places still be specific to the motivating scenario:</span>
<span class="sd">            </span>
<span class="sd">    - We may refer to `vectors` as `boaters` or `agents`. </span>
<span class="sd">    - We may refer to the origins of vectors as `origin`, `source`, or simply `jurisdiction`. </span>
<span class="sd">    - We may refer to the destinations of vectors as `destination`, `sink`, </span>
<span class="sd">      or `lake`.</span>


<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">copy</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">exists</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span> <span class="k">as</span> <span class="n">iterproduct</span><span class="p">,</span> <span class="n">repeat</span><span class="p">,</span> <span class="n">count</span> <span class="k">as</span> <span class="n">itercount</span><span class="p">,</span> \
                        <span class="n">chain</span> <span class="k">as</span> <span class="n">iterchain</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">defaultdict</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.lib.recfunctions</span> <span class="k">as</span> <span class="nn">rf</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">sparse</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">op</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">nbinom</span><span class="p">,</span> <span class="n">norm</span> <span class="k">as</span> <span class="n">normaldist</span><span class="p">,</span> <span class="n">f</span> <span class="k">as</span> <span class="n">fdist</span><span class="p">,</span> <span class="n">linregress</span><span class="p">,</span> \
                        <span class="n">vonmises</span><span class="p">,</span> <span class="n">chi2</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">autograd.numpy</span> <span class="k">as</span> <span class="nn">ag</span>
<span class="kn">from</span> <span class="nn">autograd</span> <span class="kn">import</span> <span class="n">grad</span><span class="p">,</span> <span class="n">hessian</span>
<span class="kn">from</span> <span class="nn">statsmodels.distributions.empirical_distribution</span> <span class="kn">import</span> <span class="n">ECDF</span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span>


<span class="kn">from</span> <span class="nn">vemomoto_core.npcollections.npext</span> <span class="kn">import</span> <span class="n">add_fields</span><span class="p">,</span> <span class="n">list_to_csr_matrix</span><span class="p">,</span> <span class="n">sparsepowersum</span><span class="p">,</span> \
    <span class="n">sparsepower</span><span class="p">,</span> <span class="n">sparsesum</span><span class="p">,</span> <span class="n">convert_R_0_1</span><span class="p">,</span> \
    <span class="n">convert_R_pos</span><span class="p">,</span> <span class="n">FlexibleArrayDict</span>
<span class="kn">from</span> <span class="nn">vemomoto_core.tools</span> <span class="kn">import</span> <span class="n">saveobject</span>
<span class="kn">from</span> <span class="nn">vemomoto_core.npcollections.npextc</span> <span class="kn">import</span> <span class="n">FlexibleArray</span>
<span class="kn">from</span> <span class="nn">vemomoto_core.tools.hrprint</span> <span class="kn">import</span> <span class="n">HierarchichalPrinter</span>
<span class="kn">from</span> <span class="nn">vemomoto_core.tools.tee</span> <span class="kn">import</span> <span class="n">Tee</span>
<span class="kn">from</span> <span class="nn">vemomoto_core.tools.doc_utils</span> <span class="kn">import</span> <span class="n">DocMetaSuperclass</span><span class="p">,</span> <span class="n">inherit_doc</span><span class="p">,</span> <span class="n">staticmethod_inherit_doc</span>
<span class="kn">from</span> <span class="nn">vemomoto_core.concurrent.concurrent_futures_ext</span> <span class="kn">import</span> <span class="n">ProcessPoolExecutor</span>
<span class="kn">from</span> <span class="nn">vemomoto_core.concurrent.nicepar</span> <span class="kn">import</span> <span class="n">Counter</span>
<span class="kn">from</span> <span class="nn">lopaths</span> <span class="kn">import</span> <span class="n">FlowPointGraph</span><span class="p">,</span> <span class="n">FlexibleGraph</span>
<span class="kn">from</span> <span class="nn">ci_rvm</span> <span class="kn">import</span> <span class="n">find_profile_CI_bound</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">.traveltime_model</span> <span class="kn">import</span> <span class="n">TrafficDensityVonMises</span>
    <span class="kn">from</span> <span class="nn">.statsutils</span> <span class="kn">import</span> <span class="n">anderson_darling_test_discrete</span><span class="p">,</span> <span class="n">anderson_darling_NB</span><span class="p">,</span> <span class="n">anderson_darling_P</span><span class="p">,</span> <span class="n">R2</span>
    <span class="kn">from</span> <span class="nn">._autograd_ext</span> <span class="kn">import</span> <span class="n">nbinom_logpmf</span>
    <span class="kn">from</span> <span class="nn">.route_choice_model</span> <span class="kn">import</span> <span class="n">RouteChoiceModel</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">traveltime_model</span> <span class="kn">import</span> <span class="n">TrafficDensityVonMises</span>
    <span class="kn">from</span> <span class="nn">statsutils</span> <span class="kn">import</span> <span class="n">anderson_darling_test_discrete</span><span class="p">,</span> <span class="n">anderson_darling_NB</span><span class="p">,</span> <span class="n">anderson_darling_P</span><span class="p">,</span> <span class="n">R2</span>
    <span class="kn">from</span> <span class="nn">_autograd_ext</span> <span class="kn">import</span> <span class="n">nbinom_logpmf</span>
    <span class="kn">from</span> <span class="nn">route_choice_model</span> <span class="kn">import</span> <span class="n">RouteChoiceModel</span>


<span class="c1"># general settings --------------------------------------------------------</span>
<span class="c1"># The first command line argument specifies the output file to which all output</span>
<span class="c1"># will be written.                     </span>
<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
    <span class="n">teeObject</span> <span class="o">=</span> <span class="n">Tee</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">np</span><span class="o">.</span><span class="n">set_printoptions</span><span class="p">(</span><span class="n">linewidth</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">simplefilter</span><span class="p">(</span><span class="s1">&#39;always&#39;</span><span class="p">,</span> <span class="ne">UserWarning</span><span class="p">)</span> 
<span class="c1"># -------------------------------------------------------------------------</span>

<span class="n">CPU_COUNT</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span> 
<span class="s2">&quot;Number of processes for parallel processing.&quot;</span>

<span class="n">IDTYPE</span> <span class="o">=</span> <span class="s2">&quot;|S11&quot;</span>
<span class="sd">&quot;&quot;&quot;Type of IDs of origins and destinations. Alpha-numerical code with at most 9 </span>
<span class="sd">digets. </span>

<span class="sd">2 digets remain reserved for internal use.</span>

<span class="sd">&quot;&quot;&quot;</span>

<span class="k">def</span> <span class="nf">_non_join</span><span class="p">(</span><span class="n">string1</span><span class="p">,</span> <span class="n">string2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Joins two strings if they are not ``None``.</span>
<span class="sd">    </span>
<span class="sd">    Returns ``None`` if either of the input strings is ``None``.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    string1 : str </span>
<span class="sd">        First string</span>
<span class="sd">    string2 : str </span>
<span class="sd">        Second string</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">string1</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">string2</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">string1</span> <span class="o">+</span> <span class="n">string2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>

<div class="viewcode-block" id="create_observed_predicted_mean_error_plot"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.create_observed_predicted_mean_error_plot">[docs]</a><span class="k">def</span> <span class="nf">create_observed_predicted_mean_error_plot</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">observed</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">constError</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">errorFunctions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">regressionResult</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                              <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">saveFileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">comparisonFileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                              <span class="n">logScale</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an observed vs. predicted plot.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    predicted : float[]</span>
<span class="sd">        Array of predicted values.</span>
<span class="sd">    observed : float[]</span>
<span class="sd">        Array of observed values.</span>
<span class="sd">    errorFunctions : callable[]</span>
<span class="sd">        Two methods for the lower and the upper predicted error (e.g. 95% </span>
<span class="sd">        confidence interval). Both of these methods must take the predicted</span>
<span class="sd">        value and return the repsective expected bound for the observations.</span>
<span class="sd">        If given, the area between these function will be plotted as a shaded </span>
<span class="sd">        area.</span>
<span class="sd">    regressionResult : float[]</span>
<span class="sd">        Slope and intercept of an observed vs. prediction regression. If given,</span>
<span class="sd">        the regression line will be plotted.</span>
<span class="sd">    labels : str[]</span>
<span class="sd">        Labels for the data points.</span>
<span class="sd">    title : str</span>
<span class="sd">        Title of the plot</span>
<span class="sd">    saveFileName : str</span>
<span class="sd">        Name of the file where the plot and the data used to generate it will</span>
<span class="sd">        be saved.</span>
<span class="sd">        </span>
<span class="sd">        ~+~</span>
<span class="sd">        </span>
<span class="sd">        .. note:: Note that only predicted and observed values will be saved.</span>
<span class="sd">    comparisonFileName : str</span>
<span class="sd">        Name of the file where alternative results are saved. These results will</span>
<span class="sd">        be loaded and plotted for comparison.</span>
<span class="sd">    logScale : bool</span>
<span class="sd">        Whether to plot on a log-log scale.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">logScale</span><span class="p">:</span>
        <span class="n">addition</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">observed</span> <span class="o">=</span> <span class="n">observed</span> <span class="o">+</span> <span class="n">addition</span>
        <span class="n">predicted</span> <span class="o">=</span> <span class="n">predicted</span> <span class="o">+</span> <span class="n">addition</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">error2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">error2</span> <span class="o">=</span> <span class="n">error</span>
        
    <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="s2">&quot;R2:&quot;</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">observed</span><span class="p">))</span>
    <span class="n">xMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">predicted</span><span class="o">+</span><span class="n">error2</span><span class="p">)</span>
    <span class="n">yMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">observed</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">comparisonFileName</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="o">+</span><span class="s2">&quot;_pred.vmdat&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)</span> 
        <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="o">+</span><span class="s2">&quot;_obs.vmdat&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">)):</span>
        <span class="n">predicted2</span> <span class="o">=</span> <span class="n">saveobject</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="o">+</span><span class="s2">&quot;_pred.vmdat&quot;</span><span class="p">)</span>
        <span class="n">observed2</span> <span class="o">=</span> <span class="n">saveobject</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="o">+</span><span class="s2">&quot;_obs.vmdat&quot;</span><span class="p">)</span>
        <span class="n">comparison</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="s2">&quot;R2 (comparison):&quot;</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">predicted2</span><span class="p">,</span> <span class="n">observed2</span><span class="p">))</span>
        <span class="n">xMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">xMax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">predicted2</span><span class="p">))</span>
        <span class="n">yMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">yMax</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">observed2</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">comparison</span> <span class="o">=</span> <span class="kc">False</span>
        
    <span class="n">addFact</span> <span class="o">=</span> <span class="mf">1.15</span>
    
    <span class="k">if</span> <span class="n">regressionResult</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="n">regressionResult</span>
        <span class="n">xMax</span> <span class="o">*=</span> <span class="n">addFact</span>
        <span class="n">yMax</span> <span class="o">*=</span> <span class="n">addFact</span>
        <span class="n">x</span> <span class="o">=</span> <span class="nb">min</span><span class="p">((</span><span class="n">yMax</span><span class="o">-</span><span class="n">intercept</span><span class="p">)</span> <span class="o">/</span> <span class="n">slope</span><span class="p">,</span> <span class="n">xMax</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">slope</span> <span class="o">+</span> <span class="n">intercept</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="p">(</span><span class="n">intercept</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> 
                 <span class="n">linewidth</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
    
    <span class="n">upperRight</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">yMax</span><span class="p">,</span> <span class="n">xMax</span><span class="p">)</span> <span class="o">*</span> <span class="n">addFact</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">upperRight</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">upperRight</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="n">linestyle</span><span class="p">,</span> 
             <span class="n">linewidth</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Predicted&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Observed&quot;</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">constError</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="n">upperRight</span><span class="p">),</span> <span class="p">(</span><span class="n">constError</span><span class="p">,</span> <span class="n">upperRight</span><span class="o">+</span><span class="n">constError</span><span class="p">),</span>
                         <span class="p">(</span><span class="o">-</span><span class="n">constError</span><span class="p">,</span> <span class="n">upperRight</span><span class="o">-</span><span class="n">constError</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.15</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">errorFunctions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">lowerError</span><span class="p">,</span> <span class="n">upperError</span> <span class="o">=</span> <span class="n">errorFunctions</span>
        <span class="n">xError</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">upperRight</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">xError</span><span class="p">,</span> <span class="n">lowerError</span><span class="p">(</span><span class="n">xError</span><span class="p">),</span>
                         <span class="n">upperError</span><span class="p">(</span><span class="n">xError</span><span class="p">),</span> <span class="n">facecolor</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                         <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">error</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">observed</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">comparison</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">predicted2</span><span class="p">,</span> <span class="n">observed2</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;^&#39;</span><span class="p">,</span> <span class="n">facecolors</span><span class="o">=</span><span class="s1">&#39;none&#39;</span><span class="p">,</span> 
                        <span class="n">edgecolors</span><span class="o">=</span><span class="s1">&#39;g&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">observed</span><span class="p">,</span> <span class="n">xerr</span><span class="o">=</span><span class="n">error</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">elinewidth</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                     <span class="n">capsize</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">capthick</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    
    
    <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">label</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">labels</span><span class="p">,</span> <span class="n">predicted</span><span class="p">,</span> <span class="n">observed</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">label</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">label</span><span class="p">,</span>
                <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span> <span class="mi">20</span><span class="p">),</span>
                <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
                <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;round,pad=0.5&#39;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;yellow&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span> <span class="o">=</span> <span class="s1">&#39;-&gt;&#39;</span><span class="p">,</span> 
                                <span class="n">connectionstyle</span><span class="o">=</span><span class="s1">&#39;arc3,rad=0&#39;</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">saveFileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">saveobject</span><span class="o">.</span><span class="n">save_object</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">saveFileName</span><span class="o">+</span><span class="s2">&quot;_pred.vmdat&quot;</span><span class="p">)</span>
        <span class="n">saveobject</span><span class="o">.</span><span class="n">save_object</span><span class="p">(</span><span class="n">observed</span><span class="p">,</span> <span class="n">saveFileName</span><span class="o">+</span><span class="s2">&quot;_obs.vmdat&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveFileName</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">saveFileName</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span></div>
    
    
<div class="viewcode-block" id="create_distribution_plot"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.create_distribution_plot">[docs]</a><span class="k">def</span> <span class="nf">create_distribution_plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">observed</span><span class="p">,</span> <span class="n">predicted</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">best</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                             <span class="n">yLabel</span><span class="o">=</span><span class="s2">&quot;PMF&quot;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a plot of a given discrete distribution.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    X : float[]</span>
<span class="sd">        Values that could be observed.</span>
<span class="sd">    observed : float[]</span>
<span class="sd">        Observed cumulative density (non-parametric estimate of the cumulative </span>
<span class="sd">        mass function).</span>
<span class="sd">    predicted : float[]</span>
<span class="sd">        Predicted cumulative density.</span>
<span class="sd">    best : float[]</span>
<span class="sd">        Second predicted cumulative density (different prediction method).</span>
<span class="sd">    yLabel : str</span>
<span class="sd">        Label of the y axis.</span>
<span class="sd">    title : str</span>
<span class="sd">        Title of the plot.</span>
<span class="sd">    fileName : str</span>
<span class="sd">        Name of the file that the plot shall be saved to.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
    
    <span class="n">plotArr</span> <span class="o">=</span> <span class="p">[</span><span class="n">observed</span><span class="p">]</span>
    <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Observed&quot;</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="n">predicted</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plotArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">predicted</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Model Prediction&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">best</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plotArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">best</span><span class="p">)</span>
        <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Best Fit&quot;</span><span class="p">)</span>
    
    <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;C0&#39;</span><span class="p">,</span> <span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="s1">&#39;C2&#39;</span><span class="p">]</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">Y</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">plotArr</span><span class="p">,</span> <span class="n">colors</span><span class="p">):</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">step</span><span class="o">=</span><span class="s1">&#39;post&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=.</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">Y</span><span class="p">,</span> <span class="n">color</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">plotArr</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">labels</span><span class="p">):</span>
        <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">Y</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">Y</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">yy</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">label</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">yLabel</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="create_observed_predicted_mean_error_plot_from_files"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.create_observed_predicted_mean_error_plot_from_files">[docs]</a><span class="k">def</span> <span class="nf">create_observed_predicted_mean_error_plot_from_files</span><span class="p">(</span><span class="n">fileName1</span><span class="p">,</span> <span class="n">fileName2</span><span class="p">,</span> 
                                                         <span class="n">extension</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates an observed vs. predicted plot from saved data.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileName1 : str</span>
<span class="sd">        Name of the file from which the primary data shall be loaded.</span>
<span class="sd">    fileName2 : str</span>
<span class="sd">        Name of the file from which comparison data shall be loaded.</span>
<span class="sd">    extension : str</span>
<span class="sd">        Extension to add to both file names.</span>
<span class="sd">    **kwargs : kwargs</span>
<span class="sd">        Keyword arguments passed to :py:meth:`create_observed_predicted_mean_error_plot`.</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fileName1</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileName1</span><span class="p">,</span> <span class="n">fileName1</span><span class="o">+</span><span class="n">extension</span><span class="p">)</span>
    <span class="n">fileName2</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileName2</span><span class="p">,</span> <span class="n">fileName2</span><span class="o">+</span><span class="n">extension</span><span class="p">)</span>
    <span class="n">predicted</span> <span class="o">=</span> <span class="n">saveobject</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">fileName1</span><span class="o">+</span><span class="s2">&quot;_pred.vmdat&quot;</span><span class="p">)</span>
    <span class="n">observed</span> <span class="o">=</span> <span class="n">saveobject</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">fileName1</span><span class="o">+</span><span class="s2">&quot;_obs.vmdat&quot;</span><span class="p">)</span>
    <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span><span class="n">predicted</span><span class="p">,</span> <span class="n">observed</span><span class="p">,</span>
                                              <span class="n">saveFileName</span><span class="o">=</span><span class="n">fileName1</span><span class="p">,</span> 
                                              <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">fileName2</span><span class="p">,</span> 
                                              <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="nbinom_fit"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.nbinom_fit">[docs]</a><span class="k">def</span> <span class="nf">nbinom_fit</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Fits a negative binomial distribution to given data&quot;&quot;&quot;</span>
    <span class="n">f</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nbinom</span><span class="o">.</span><span class="n">logpmf</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])))</span> 
    
    <span class="n">x0</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;disp&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>
    
    
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>

<div class="viewcode-block" id="redraw_predicted_observed"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.redraw_predicted_observed">[docs]</a><span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">create_observed_predicted_mean_error_plot_from_files</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">redraw_predicted_observed</span><span class="p">(</span><span class="n">fileName1</span><span class="p">,</span> <span class="n">fileName2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Redraws predicted versus oberved plots generated earlier.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="s2">&quot;Regression&quot;</span><span class="p">,</span> <span class="s2">&quot;Regression_scaled&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot_from_files</span><span class="p">(</span><span class="n">fileName1</span><span class="p">,</span> 
                                                             <span class="n">fileName2</span><span class="p">,</span>
                                                             <span class="n">ext</span><span class="p">,</span>
                                                             <span class="n">constError</span><span class="o">=</span><span class="mf">1.96</span><span class="p">)</span>
    
    <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;Stations_raw&quot;</span><span class="p">,</span> <span class="s2">&quot;Stations_scaled&quot;</span><span class="p">,</span> <span class="s2">&quot;Pairs_raw&quot;</span><span class="p">,</span> <span class="s2">&quot;Pairs_scaled&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Destinations_raw&quot;</span><span class="p">,</span> <span class="s2">&quot;Destinations_scaled&quot;</span><span class="p">,</span> <span class="s2">&quot;Origins_raw&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Origins_scaled&quot;</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Plotting&quot;</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot_from_files</span><span class="p">(</span><span class="n">fileName1</span><span class="p">,</span> 
                                                             <span class="n">fileName2</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
    
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
    


<div class="viewcode-block" id="TransportNetwork"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.TransportNetwork">[docs]</a><span class="k">class</span> <span class="nc">TransportNetwork</span><span class="p">(</span><span class="n">FlowPointGraph</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A graph representation of the road network.</span>
<span class="sd">    </span>
<span class="sd">    In contrast to the general graph class :py:class:`lopaths.graph.FlowPointGraph`,</span>
<span class="sd">    :py:class:`TransportNetwork` implements invasion-specific functionalities</span>
<span class="sd">    needed for the vector movement model</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileNameEdges : str </span>
<span class="sd">        Name of a csv file containing the road network. The file must be a </span>
<span class="sd">        csv with header and the following columns, separated by ``,``:</span>
<span class="sd">        </span>
<span class="sd">        ================================================== ============================== =========</span>
<span class="sd">        Field                                              Type                           Description</span>
<span class="sd">        ================================================== ============================== =========</span>
<span class="sd">        RoadID                                             :py:data:`IDTYPE`              ID of the road section</span>
<span class="sd">        VertexFromID                                       :py:data:`IDTYPE`              Starting vertex of the road section</span>
<span class="sd">        VertexToID                                         :py:data:`IDTYPE`              End vertex of the road section</span>
<span class="sd">        Lenght                                             float                          Length (or travel time) of the road section</span>
<span class="sd">        Survey location for forward traffic                :py:data:`IDTYPE`, `optional`  ID of the location</span>
<span class="sd">                                                                                          where forward traffic can be inspected</span>
<span class="sd">        Survey location for forward traffic                :py:data:`IDTYPE`, `optional`  ID of the station </span>
<span class="sd">                                                                                          where backward traffic can be inspected</span>
<span class="sd">        Survey location for forward and backward traffic   :py:data:`IDTYPE`, `optional`  ID of the station where forward and backward traffic can be inspected</span>
<span class="sd">        DestinationID                                      :py:data:`IDTYPE`, `optional`  ID of the destination that can be accessed via this</span>
<span class="sd">                                                                                          road section</span>
<span class="sd">        ================================================== ============================== =========</span>
<span class="sd">              </span>
<span class="sd">    fileNameVertices : str</span>
<span class="sd">        Name of a csv file stating which vertices are origins and destinations.</span>
<span class="sd">        The file must be a csv with header and the following columns, </span>
<span class="sd">        separated by ``,``:</span>
<span class="sd">        </span>
<span class="sd">        ==================== ================= =========</span>
<span class="sd">        Field                Type              Description</span>
<span class="sd">        ==================== ================= =========</span>
<span class="sd">        VertexID             :py:data:`IDTYPE` ID of the vertex</span>
<span class="sd">        potentialViaVertex   bool              whether the vertex could be a potential </span>
<span class="sd">                                               intermediate destination for boaters </span>
<span class="sd">                                               (should be ``True`` by default,</span>
<span class="sd">                                               but can be set to ``False`` for many </span>
<span class="sd">                                               vertices to reduce computational complexity)</span>
<span class="sd">        vertexType           int               type identifier for the vertex; see below</span>
<span class="sd">                                                  - ``1``: origin</span>
<span class="sd">                                                  - ``2``: destination</span>
<span class="sd">                                                  - ``3``: postal code area center </span>
<span class="sd">                                                    (used to determine whether destinations are </span>
<span class="sd">                                                    located in populated areas)</span>
<span class="sd">                                                  - `other`: no specific role for the vertex</span>
<span class="sd">        ==================== ================= =========</span>
<span class="sd">                             </span>
<span class="sd">    destinationToDestination : bool</span>
<span class="sd">        ``True`` iff destination to destination traffic is modelled, i.e. if</span>
<span class="sd">        the sets of origins and destinations are equal.</span>
<span class="sd">        Note: a gravity model for destination to destination traffic is not yet </span>
<span class="sd">        implemented, but could be added easily.</span>
<span class="sd">    preprocessingArgs : tuple</span>
<span class="sd">        Arguments for preprocessing of the road network. Refer to </span>
<span class="sd">        :py:class:`lopaths.graph.FlowPointGraph` for further </span>
<span class="sd">        documentation</span>
<span class="sd">    edgeLengthRandomization : float</span>
<span class="sd">        Maximum random perturbation to road lengths. Needed to make it </span>
<span class="sd">        likely that distinct paths have distinct length.</span>
<span class="sd">    printerArgs</span>
<span class="sd">        Arguments passed to </span>
<span class="sd">        :py:class:`vemomoto_core.tools.hrprint.HierarchichalPrinter`</span>
<span class="sd">    </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="c1"># labels that are going to be put at the beginning of origin IDs to avoid</span>
    <span class="c1"># overlapping with other IDs</span>
    <span class="n">_DESTINATION_SOURCE_LABEL</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;l&#39;</span>
    <span class="n">_DESTINATION_SOURCE_EDGE_LABEL</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;_l&#39;</span>
    <span class="n">_DESTINATION_SINK_LABEL</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;L&#39;</span>
    <span class="n">_DESTINATION_SINK_EDGE_LABEL</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;_L&#39;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileNameEdges</span><span class="p">,</span> <span class="n">fileNameVertices</span><span class="p">,</span> 
                 <span class="n">destinationToDestination</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="n">preprocessingArgs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">edgeLengthRandomization</span><span class="o">=.</span><span class="mi">001</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">printerArgs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor</span>
<span class="sd">        </span>
<span class="sd">        See class docs for documentation.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">HierarchichalPrinter</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">printerArgs</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessingArgs</span> <span class="o">=</span> <span class="n">preprocessingArgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Reading road network file&quot;</span><span class="p">,</span> <span class="n">fileNameEdges</span><span class="p">)</span>
        <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fileNameEdges</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>  
                                   <span class="n">skip_header</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                                   <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;from_to_original&quot;</span><span class="p">,</span> 
                                                     <span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;inspection&quot;</span><span class="p">,</span> 
                                                     <span class="s2">&quot;destinationID&quot;</span><span class="p">],</span> 
                                            <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="n">IDTYPE</span><span class="p">,</span> 
                                                       <span class="s1">&#39;2&#39;</span> <span class="o">+</span> <span class="n">IDTYPE</span><span class="p">,</span> 
                                                       <span class="s2">&quot;double&quot;</span><span class="p">,</span> 
                                                       <span class="s2">&quot;3&quot;</span> <span class="o">+</span> <span class="n">IDTYPE</span><span class="p">,</span> 
                                                       <span class="n">IDTYPE</span><span class="p">]},</span>
                              <span class="n">autostrip</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Reading vertex file&quot;</span><span class="p">,</span> <span class="n">fileNameVertices</span><span class="p">)</span>
        <span class="n">vertexData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fileNameVertices</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>  
                                   <span class="n">skip_header</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                                   <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;potentialViaVertex&quot;</span><span class="p">,</span>
                                                     <span class="s2">&quot;type&quot;</span><span class="p">],</span> 
                                            <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="n">IDTYPE</span><span class="p">,</span> <span class="s1">&#39;bool&#39;</span><span class="p">,</span> <span class="s1">&#39;int&#39;</span><span class="p">]},</span>
                                   <span class="n">autostrip</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">vertexData</span><span class="o">.</span><span class="n">ndim</span><span class="p">:</span>
            <span class="n">vertexData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">vertexData</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">destinationToDestination</span><span class="p">:</span>
            <span class="c1"># since destination access is given directly in the road network file, </span>
            <span class="c1"># we ignore the given vertexData</span>
            <span class="n">vertexData</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">][</span><span class="n">vertexData</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span><span class="o">==</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">edgeLengthRandomization</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">))</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span> 
                                <span class="o">*</span> <span class="n">edgeLengthRandomization</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Processing the input&quot;</span><span class="p">)</span>
        
        <span class="c1"># double the edges to create directed graph from undirected graph</span>
        <span class="n">from_to</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">edges</span><span class="p">[</span><span class="s2">&quot;from_to_original&quot;</span><span class="p">],</span> 
                             <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;from_to_original&quot;</span><span class="p">][:,::</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
        
        <span class="n">edgeData</span> <span class="o">=</span> <span class="n">rf</span><span class="o">.</span><span class="n">repack_fields</span><span class="p">(</span><span class="n">edges</span><span class="p">[[</span><span class="s2">&quot;ID&quot;</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;destinationID&quot;</span><span class="p">]])</span>
        <span class="n">edgeData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">edgeData</span><span class="p">,</span> <span class="n">edgeData</span><span class="p">))</span>
        
        <span class="n">edgeData</span> <span class="o">=</span> <span class="n">add_fields</span><span class="p">(</span><span class="n">edgeData</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;inspection&quot;</span><span class="p">],</span> <span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="p">[</span><span class="kc">None</span><span class="p">])</span>
        
        <span class="n">inspectionStationIDs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="s2">&quot;inspection&quot;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">inspectionStationIDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">inspectionStationIDs</span> <span class="o">=</span> <span class="n">inspectionStationIDs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">stationIndexToStationID</span> <span class="o">=</span> <span class="n">inspectionStationIDs</span>
        
        <span class="n">inspectionStationIndices</span> <span class="o">=</span> <span class="p">{</span><span class="n">iD</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iD</span> 
                                    <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inspectionStationIDs</span><span class="p">)}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">stationIDToStationIndex</span> <span class="o">=</span> <span class="n">inspectionStationIndices</span> 
        <span class="n">edgesLen</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)</span>
        
        <span class="n">inspectionData</span> <span class="o">=</span> <span class="n">edgeData</span><span class="p">[</span><span class="s2">&quot;inspection&quot;</span><span class="p">]</span>
        <span class="n">consideredIndices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="s2">&quot;inspection&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">inspectionData</span><span class="p">[</span><span class="n">consideredIndices</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="n">inspectionStationIndices</span><span class="p">[</span><span class="n">iD</span><span class="p">]}</span>
                                             <span class="k">for</span> <span class="n">iD</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;inspection&quot;</span><span class="p">][</span>
                                                        <span class="n">consideredIndices</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>
        <span class="n">consideredIndices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="s2">&quot;inspection&quot;</span><span class="p">][:,</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">inspectionData</span><span class="p">[</span><span class="n">edgesLen</span><span class="p">:][</span><span class="n">consideredIndices</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="p">{</span><span class="n">inspectionStationIndices</span><span class="p">[</span><span class="n">iD</span><span class="p">]}</span> <span class="k">for</span> <span class="n">iD</span> <span class="ow">in</span> 
                <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;inspection&quot;</span><span class="p">][</span><span class="n">consideredIndices</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="p">]</span>
        <span class="n">consideredIndices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">edges</span><span class="p">[</span><span class="s2">&quot;inspection&quot;</span><span class="p">][:,</span><span class="mi">2</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iD</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">consideredIndices</span><span class="p">,</span> 
                         <span class="n">edges</span><span class="p">[</span><span class="s2">&quot;inspection&quot;</span><span class="p">][</span><span class="n">consideredIndices</span><span class="p">,</span> <span class="mi">2</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">edgesLen</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inspectionData</span><span class="p">[</span><span class="n">j</span><span class="p">]:</span> 
                    <span class="n">inspectionData</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">inspectionStationIndices</span><span class="p">[</span><span class="n">iD</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">inspectionData</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">inspectionStationIndices</span><span class="p">[</span><span class="n">iD</span><span class="p">]}</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating graph&quot;</span><span class="p">)</span>
        <span class="n">graph</span> <span class="o">=</span> <span class="n">FlexibleGraph</span><span class="p">(</span><span class="n">from_to</span><span class="p">,</span> <span class="n">edgeData</span><span class="p">,</span> <span class="n">vertexData</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">],</span> 
                              <span class="n">vertexData</span><span class="p">[[</span><span class="s2">&quot;potentialViaVertex&quot;</span><span class="p">,</span> <span class="s2">&quot;type&quot;</span><span class="p">]],</span>
                              <span class="n">replacementMode</span><span class="o">=</span><span class="s2">&quot;shortest&quot;</span><span class="p">,</span> <span class="n">lengthLabel</span><span class="o">=</span><span class="s2">&quot;length&quot;</span><span class="p">)</span>
        
        <span class="n">graph</span><span class="o">.</span><span class="n">add_vertex_attributes</span><span class="p">((</span><span class="s2">&quot;destinationID&quot;</span><span class="p">,</span> <span class="s2">&quot;significant&quot;</span><span class="p">),</span> 
                                    <span class="p">(</span><span class="n">IDTYPE</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
                                    <span class="p">(</span><span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
        <span class="n">graph</span><span class="o">.</span><span class="n">set_default_vertex_data</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
        
        <span class="c1"># adding virtual edges to represent destinations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__add_virtual_destination_vertices</span><span class="p">(</span><span class="n">graph</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">destinationToDestination</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__add_virtual_destination_vertices</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="n">graph</span><span class="o">.</span><span class="n">remove_insignificant_dead_ends</span><span class="p">(</span><span class="s2">&quot;significant&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating fast graph&quot;</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">graph</span><span class="p">,</span> <span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;significant&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">array</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">size</span><span class="p">][</span><span class="s2">&quot;significant&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">get_array_indices</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToSinkID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">][</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span><span class="p">]</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToSinkID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToSinkID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToSinkID</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sinkIDToSinkIndex</span> <span class="o">=</span> <span class="p">{</span><span class="n">iD</span><span class="p">:</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">iD</span> 
                                  <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToSinkID</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rawSinkIndexToVertexIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">get_array_indices</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">][</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span><span class="p">]</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span><span class="p">[</span><span class="n">order</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rawSourceIndexToVertexIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">sourceIDToSourceIndex</span> <span class="o">=</span> <span class="p">{</span><span class="n">iD</span><span class="p">:</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">iD</span> 
                                      <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span><span class="p">)}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourcesConsidered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> 
                                         <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">postalCodeIndexToVertexIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">get_array_indices</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Transport network creation finished.&quot;</span><span class="p">)</span>
        
<div class="viewcode-block" id="TransportNetwork.preprocessing"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.TransportNetwork.preprocessing">[docs]</a>    <span class="k">def</span> <span class="nf">preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">preprocessingArgs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Preprocesses the graph to make path search queries more efficient.</span>
<span class="sd">        </span>
<span class="sd">        This step is a necessary prerequisite to all path queries as implemented</span>
<span class="sd">        here.</span>
<span class="sd">        </span>
<span class="sd">        The &#39;reach&#39; of each vertex is computed. The &#39;reach&#39; is high if a vertex</span>
<span class="sd">        is at the center of a long shortest path (e.g. a highway).</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        preprocessingArgs : dict or iterable </span>
<span class="sd">            Contains the arguments for </span>
<span class="sd">            :py:class:`lopaths.graph.FlowPointGraph.preprocessing`. </span>
<span class="sd">            If ``None``, reasonable default arguments will be chosen. </span>
<span class="sd">            Refer to </span>
<span class="sd">            :py:class:`lopaths.graph.FlowPointGraph.preprocessing`</span>
<span class="sd">            for a list of the possible arguments and their meaning</span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="k">if</span> <span class="n">preprocessingArgs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">preprocessingArgs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessingArgs</span>
        
        <span class="k">if</span> <span class="n">preprocessingArgs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">FlowPointGraph</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> 
                                         <span class="n">expansionBounds</span><span class="o">=</span><span class="p">(</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">),</span>
                                         <span class="n">maxEdgeLength</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">preprocessingArgs</span><span class="p">)</span> <span class="o">==</span> <span class="nb">dict</span><span class="p">:</span>
                <span class="n">FlowPointGraph</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">preprocessingArgs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">FlowPointGraph</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">preprocessingArgs</span><span class="p">)</span></div>
                
 
    <span class="k">def</span> <span class="nf">__add_virtual_destination_vertices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">graph</span><span class="p">,</span> <span class="n">vertexType</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;        Creates vertices that represent the destinations</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">edges</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">edges</span>
        <span class="n">edgeArr</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="n">consideredEdges</span> <span class="o">=</span> <span class="n">edgeArr</span><span class="p">[</span><span class="n">edgeArr</span><span class="p">[</span><span class="s2">&quot;destinationID&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">IDTYPE</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="n">vertexType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">destinationLabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DESTINATION_SOURCE_LABEL</span>
            <span class="n">destinationEdgeLabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DESTINATION_SOURCE_EDGE_LABEL</span>
        <span class="k">elif</span> <span class="n">vertexType</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">destinationLabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DESTINATION_SINK_LABEL</span>
            <span class="n">destinationEdgeLabel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_DESTINATION_SINK_EDGE_LABEL</span>
                                  
        <span class="n">consideredEdges</span> <span class="o">=</span> <span class="n">consideredEdges</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">consideredEdges</span><span class="p">[</span><span class="s2">&quot;destinationID&quot;</span><span class="p">])]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">consideredEdges</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Adding virtual edges to represent destinations&quot;</span><span class="p">)</span>
        <span class="n">lastdestinationID</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        
        <span class="n">newVertexLines</span> <span class="o">=</span> <span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">space</span>
                          <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">consideredEdges</span><span class="p">[</span><span class="s2">&quot;destinationID&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">newVertexLines</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">newVertexLines</span><span class="p">)</span>
        
        <span class="n">newEdgeLines</span> <span class="o">=</span> <span class="p">(</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">size</span><span class="o">-</span><span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">space</span>
                          <span class="o">+</span> <span class="n">consideredEdges</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">newEdgeLines</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">graph</span><span class="o">.</span><span class="n">edges</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">newEdgeLines</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">consideredEdges</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">lastdestinationID</span> <span class="o">!=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;destinationID&quot;</span><span class="p">]:</span>
                <span class="n">lastdestinationID</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;destinationID&quot;</span><span class="p">]</span>
                <span class="n">newVertexID</span> <span class="o">=</span> <span class="n">destinationLabel</span> <span class="o">+</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;destinationID&quot;</span><span class="p">]</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">add_vertex</span><span class="p">(</span><span class="n">newVertexID</span><span class="p">,</span> <span class="p">(</span><span class="n">newVertexID</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">vertexType</span><span class="p">,</span>
                                               <span class="n">lastdestinationID</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">vertex</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;fromID&quot;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">vertexType</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">fromTo</span> <span class="o">=</span> <span class="p">(</span><span class="n">newVertexID</span><span class="p">,</span> <span class="n">vertex</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fromTo</span> <span class="o">=</span> <span class="p">(</span><span class="n">vertex</span><span class="p">,</span> <span class="n">newVertexID</span><span class="p">)</span>
                <span class="n">graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span><span class="o">*</span><span class="n">fromTo</span><span class="p">,</span> <span class="p">(</span><span class="n">destinationEdgeLabel</span> <span class="o">+</span> <span class="nb">bytes</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s1">&#39;utf8&#39;</span><span class="p">),</span>
                                         <span class="n">row</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">],</span> <span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">edgeData</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get_edge_data</span><span class="p">(</span><span class="o">*</span><span class="n">fromTo</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">edgeData</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]:</span>
                    <span class="n">edgeData</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;length&quot;</span><span class="p">]</span>
                    
<div class="viewcode-block" id="TransportNetwork.find_shortest_distances"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.TransportNetwork.find_shortest_distances">[docs]</a>    <span class="k">def</span> <span class="nf">find_shortest_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines the shortest distances between all origins and destinations</span>
<span class="sd">        and from all postal code centres to the destinations</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">dists</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_shortest_distance_array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span><span class="p">,</span> 
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span><span class="p">)</span>
        <span class="c1"># treat disconnected sources and sinks well</span>
        <span class="n">sourcesConsidered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="n">sinksConsidered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">dists</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">sourcesConsidered</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="n">sinksConsidered</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
            <span class="n">dists</span> <span class="o">=</span> <span class="n">dists</span><span class="p">[</span><span class="n">sourcesConsidered</span><span class="p">][:,</span><span class="n">sinksConsidered</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span><span class="p">[</span>
                                                                <span class="n">sinksConsidered</span><span class="p">]</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToSinkID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">][</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span><span class="p">]</span>
        
            <span class="bp">self</span><span class="o">.</span><span class="n">sinkIDToSinkIndex</span> <span class="o">=</span> <span class="p">{</span><span class="n">iD</span><span class="p">:</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">iD</span> 
                                      <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToSinkID</span><span class="p">)}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">update_sources_considered</span><span class="p">(</span><span class="n">considered</span><span class="o">=</span><span class="n">sourcesConsidered</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="n">dists</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Some sources and sinks are disconnected though &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;no source is separated from all sinks and &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;vice versa. That is, the graph has separate &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;subgraphs.&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">postalCodeDistances</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_shortest_distance_array</span><span class="p">(</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">postalCodeIndexToVertexIndex</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">postalCodeDistances</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Some postal code areas and sinks are disconnected.&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">shortestDistances</span> <span class="o">=</span> <span class="n">dists</span>
        
        <span class="k">if</span> <span class="s2">&quot;sinksConsidered&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sinksConsidered</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">~</span><span class="n">sinksConsidered</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sinksConsidered</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sinksConsidered</span> <span class="o">=</span> <span class="n">sinksConsidered</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pair_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">shortestDistances</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span></div>
    
<div class="viewcode-block" id="TransportNetwork.update_sources_considered"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.TransportNetwork.update_sources_considered">[docs]</a>    <span class="k">def</span> <span class="nf">update_sources_considered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">rawConsidered</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">considered</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Changes which origins are considered to fit the model. </span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        If long-distance traffic is assumed to follow different mechanisms than </span>
<span class="sd">        intermediate-distance traffic, it can be beneficial to fit two distinct</span>
<span class="sd">        models for traffic from different origins. </span>
<span class="sd">        `update_sources_considered` determines which of the origins are </span>
<span class="sd">        considered to fit the model. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        rawConsidered : bool[] </span>
<span class="sd">            Boolean array determining which of the sources are considered.</span>
<span class="sd">            Must have the same size as the number of sources.</span>
<span class="sd">        considered : bool[]</span>
<span class="sd">            Boolean array determining which of the currently considered </span>
<span class="sd">            sources remain considered. Must have the same size as the number </span>
<span class="sd">            of currently considered sources</span>
<span class="sd">                </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="s2">&quot;sourcesConsidered&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sourcesConsidered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> 
                                             <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">rawConsidered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sourcesConsidered</span> <span class="o">=</span> <span class="n">rawConsidered</span>
        
        <span class="k">if</span> <span class="n">considered</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sourcesConsidered</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="o">~</span><span class="n">considered</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sourcesConsidered</span><span class="p">[</span><span class="n">tmp</span><span class="p">]</span> <span class="o">=</span> <span class="kc">False</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawSourceIndexToVertexIndex</span><span class="p">[</span>
                                                        <span class="bp">self</span><span class="o">.</span><span class="n">sourcesConsidered</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">][</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span><span class="p">]</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">sourceIDToSourceIndex</span> <span class="o">=</span> <span class="p">{</span><span class="n">iD</span><span class="p">:</span><span class="n">index</span> <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">iD</span> 
                                      <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span><span class="p">)}</span>
        <span class="k">if</span> <span class="s2">&quot;shortestDistances&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;shortestDistances&quot;</span><span class="p">]</span></div>
        
<div class="viewcode-block" id="TransportNetwork.find_potential_routes"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.TransportNetwork.find_potential_routes">[docs]</a>    <span class="k">def</span> <span class="nf">find_potential_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">stretchConstant</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
            <span class="n">localOptimalityConstant</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> 
            <span class="n">acceptionFactor</span><span class="o">=</span><span class="mf">0.667</span><span class="p">,</span>
            <span class="n">rejectionFactor</span><span class="o">=</span><span class="mf">1.333</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Searches potential routes of boaters. </span>
<span class="sd">        </span>
<span class="sd">        For detailed documentation on the arguments, refer to </span>
<span class="sd">        :py:class:`lopaths.graph.FlowPointGraph.find_alternative_paths`</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stretchConstant : &gt;=1</span>
<span class="sd">            Maximal length of the admissible paths in relation to shortest </span>
<span class="sd">            path. Controls the length of the admissible paths. ``1`` refers</span>
<span class="sd">            to shortest paths only, `infinity` to all paths.</span>
<span class="sd">        localOptimalityConstant : [0, 1] </span>
<span class="sd">            Fraction of the path that must be optimal. Controls how optimal </span>
<span class="sd">            the admissible paths shall be. ``0`` refers to all paths, ``1`` </span>
<span class="sd">            refers to shortest paths only.</span>
<span class="sd">        acceptionFactor : (0,1] </span>
<span class="sd">            Relaxation factor for local optimality constraint. Approximation </span>
<span class="sd">            factor to speed up the local optimality check. ``0`` accepts all </span>
<span class="sd">            paths, ``1`` performs an exact check. Choose the</span>
<span class="sd">            largest feasible value. ``1`` is often possible.</span>
<span class="sd">        rejectionFactor : [1,2] </span>
<span class="sd">            False rejection factor for local optimality constraint. </span>
<span class="sd">            Approximation factor to speed up the local optimality</span>
<span class="sd">            check. ``1`` performs exact checks, ``2`` may reject paths that </span>
<span class="sd">            are admissible but not locally optimal twice as much as required.</span>
<span class="sd">            Choose the smallest feasible value. ``1`` is often possible.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;shortestDistances&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_shortest_distances</span><span class="p">()</span>
        
        <span class="n">routeLengths</span><span class="p">,</span> <span class="n">inspectedRoutes</span><span class="p">,</span> <span class="n">stationCombinations</span> <span class="o">=</span> \
            <span class="n">FlowPointGraph</span><span class="o">.</span><span class="n">find_alternative_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                                                <span class="bp">self</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span><span class="p">,</span> 
                                                <span class="bp">self</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">shortestDistances</span><span class="p">,</span> 
                                                <span class="n">stretchConstant</span><span class="p">,</span> 
                                                <span class="n">localOptimalityConstant</span><span class="p">,</span> 
                                                <span class="n">acceptionFactor</span><span class="p">,</span>
                                                <span class="n">rejectionFactor</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">admissibilityParameters</span> <span class="o">=</span> <span class="p">(</span><span class="n">stretchConstant</span><span class="p">,</span> <span class="n">localOptimalityConstant</span><span class="p">,</span> 
                                        <span class="n">acceptionFactor</span><span class="p">,</span> <span class="n">rejectionFactor</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lengthsOfPotentialRoutes</span> <span class="o">=</span> <span class="n">routeLengths</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inspectedPotentialRoutes</span> <span class="o">=</span> <span class="n">inspectedRoutes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stationCombinations</span> <span class="o">=</span> <span class="n">stationCombinations</span></div>
        
    
    <span class="k">def</span> <span class="nf">_pair_to_pair_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts a tuple (OriginIndex, DesitnationIndex) to an integer index</span>
<span class="sd">        of the pair.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pair_factor</span><span class="o">*</span><span class="n">pair</span><span class="p">)</span></div>


<div class="viewcode-block" id="BaseTrafficFactorModel"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.BaseTrafficFactorModel">[docs]</a><span class="k">class</span> <span class="nc">BaseTrafficFactorModel</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">DocMetaSuperclass</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Base class for traffic factor models.</span>
<span class="sd">    </span>
<span class="sd">    The traffic factor model is a gravity model yielding factors proportional</span>
<span class="sd">    to the vector flow between different origins and destinations. Admissible</span>
<span class="sd">    models should inherit this class and overwrite/implement its variables and</span>
<span class="sd">    methods.</span>
<span class="sd">    </span>
<span class="sd">    Objects of this class save the given covariate data as object variables </span>
<span class="sd">    that can later be used to compute a factor proportional to the mean traffic </span>
<span class="sd">    flow between sources and sinks.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sourceData : Struct[] </span>
<span class="sd">        Array containing source covariates </span>
<span class="sd">    sinkData : Struct[] </span>
<span class="sd">        Array containing sink covariates</span>
<span class="sd">    postalCodeAreaData : Struct[] </span>
<span class="sd">        Array containing population counts of postal code areas</span>
<span class="sd">    distances : double[] </span>
<span class="sd">        Shortest distances between sources and sinks</span>
<span class="sd">    postalCodeDistances : double[] </span>
<span class="sd">        Shortest distances between postal code areas and sinks</span>
<span class="sd">            </span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">SIZE</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="s2">&quot;(`int`) -- Maximal number of parameters in the implemented model.&quot;</span>
    
    <span class="c1"># If only the name of the covariate is given, the data type will be assumed</span>
    <span class="c1"># to be double</span>
    <span class="n">ORIGIN_COVARIATES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="sd">&quot;&quot;&quot;(`(str, type)[]`) -- The names and types of the covariates for the sources.</span>
<span class="sd">    If the type is not spcified, it will default to float.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">DESTINATION_COVARIATES</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="s2">&quot;(`(str, type=double)[]`) -- The names and types of the covariates for the sinks.&quot;</span>
    
    <span class="n">PERMUTATIONS</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="sd">&quot;&quot;&quot;(`bool[][]`) -- Parameter combinations to be considered when selecting the optimal model.</span>
<span class="sd">    </span>
<span class="sd">    The number of columns must match the maximal number of parameters of the </span>
<span class="sd">    model (see :py:attr:`SIZE`).&quot;&quot;&quot;</span>
            
    <span class="n">LABELS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;(`str[]`) -- The names of the parameters in the implemented model.</span>
<span class="sd">    </span>
<span class="sd">    The length must match the maximal number of parameters of the </span>
<span class="sd">    model (see :py:attr:`SIZE`).&quot;&quot;&quot;</span>
    
    <span class="n">BOUNDS</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
    <span class="sd">&quot;&quot;&quot;(`(float, float)[]`) -- Reasonable bounds for the parameters (before conversion).</span>
<span class="sd">    </span>
<span class="sd">    The length must match the maximal number of parameters of the </span>
<span class="sd">    model (see :py:attr:`SIZE`).&quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sourceData</span><span class="p">,</span> <span class="n">sinkData</span><span class="p">,</span> <span class="n">postalCodeAreaData</span><span class="p">,</span> <span class="n">distances</span><span class="p">,</span> 
                 <span class="n">postalCodeDistances</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span>
        <span class="k">pass</span>
    
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_check_integrity</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether derived classes are implementing the class correctly.&quot;&quot;&quot;</span>
        
        <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SIZE</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">LABELS</span><span class="p">)</span>
        <span class="k">assert</span> <span class="bp">cls</span><span class="o">.</span><span class="n">SIZE</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">BOUNDS</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span> 
            <span class="bp">cls</span><span class="o">.</span><span class="n">get_mean_factor</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">NotImplementedError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
    
<div class="viewcode-block" id="BaseTrafficFactorModel.convert_parameters"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.BaseTrafficFactorModel.convert_parameters">[docs]</a>    <span class="k">def</span> <span class="nf">convert_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dynamicParameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Converts an array of given parameters to an array of standard (maximal)</span>
<span class="sd">        length and in the parameter domain of the model.</span>
<span class="sd">        </span>
<span class="sd">        Not all parameters may be considered in the model (to avoid overfitting)</span>
<span class="sd">        Furthermore, some parameters must be constrained to be positive or </span>
<span class="sd">        within a certain interval. In this method, the parameter vector </span>
<span class="sd">        (containing only the values of the free parameters) is transformed to </span>
<span class="sd">        a vector in the parameter space of the model</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dynamicParameters : float[] </span>
<span class="sd">            Free parameters. The parameters that are not held constant.</span>
<span class="sd">        considered : bool[] </span>
<span class="sd">            Which parameters are free? Is ``True`` at the entries corresponding </span>
<span class="sd">            to the parameters that are free. ``considered`` must have exactly as </span>
<span class="sd">            many ``True`` entries as the length of ``dynamicParameters``</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">considered</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span> <span class="o">=</span> <span class="n">dynamicParameters</span>
        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="BaseTrafficFactorModel.get_mean_factor"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.BaseTrafficFactorModel.get_mean_factor">[docs]</a>    <span class="k">def</span> <span class="nf">get_mean_factor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">pair</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns a factor proportional to the mean traveller flow between the</span>
<span class="sd">        source-sink pair ``pair`` or all sources and sinks (if ``pair is None``)</span>
<span class="sd">        </span>
<span class="sd">        ~+~</span>
<span class="sd">        </span>
<span class="sd">        This method MUST be overwritten. Otherwise the model will through an </span>
<span class="sd">        error.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters : double[] </span>
<span class="sd">            Contains the free model parameters.</span>
<span class="sd">        considered : bool[] </span>
<span class="sd">            Which parameters are free? Is ``True`` at the entries corresponding </span>
<span class="sd">            to the parameters that are free. ``considered`` must have exactly as </span>
<span class="sd">            many ``True`` entries as the length of ``dynamicParameters``.</span>
<span class="sd">        pair : (int, int) </span>
<span class="sd">            Source-sink pair for which the factor shall be determined.</span>
<span class="sd">            This is the source-sink pair of interest (the indices of the source and</span>
<span class="sd">            the sink, NOT their IDs. If ``None``, the factors for all source-sink</span>
<span class="sd">            combinations are computed).</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="BaseTrafficFactorModel.get_mean_factor_autograd"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.BaseTrafficFactorModel.get_mean_factor_autograd">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">get_mean_factor</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_mean_factor_autograd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Same as :py:meth:`get_mean_factor`, but must use autograd&#39;s functions </span>
<span class="sd">        instead of numpy. </span>
<span class="sd">        </span>
<span class="sd">        This function is necessary to compute derivatives with automatic </span>
<span class="sd">        differentiation.</span>
<span class="sd">        </span>
<span class="sd">        ~+~</span>
<span class="sd">        </span>
<span class="sd">        To write this function, copy the content of :py:meth:`get_mean_factor` </span>
<span class="sd">        and exchange ``np.[...]`` with ``ag.[...]``</span>
<span class="sd">        </span>
<span class="sd">        .. note:: autograd functions so not support in-place operations. </span>
<span class="sd">            Therefore, an autograd-compatible implementation may be less efficient.</span>
<span class="sd">            If efficiency is not of greater concern, just use the autograd functions</span>
<span class="sd">            in `get_mean_factor` already and leave this method untouched.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_mean_factor</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="BaseTrafficFactorModel.process_source_covariates"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.BaseTrafficFactorModel.process_source_covariates">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">process_source_covariates</span><span class="p">(</span><span class="n">covariates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process source covariates before saving them.</span>
<span class="sd">        </span>
<span class="sd">        This method is applied to the source covariates before they are saved.</span>
<span class="sd">        The method can be used to compute derived covariates</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        covariates : float[]</span>
<span class="sd">            Covariates describing the repulsiveness of sources</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">covariates</span></div>
    
<div class="viewcode-block" id="BaseTrafficFactorModel.process_sink_covariates"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.BaseTrafficFactorModel.process_sink_covariates">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">process_sink_covariates</span><span class="p">(</span><span class="n">covariates</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process sink covariates before saving them.</span>
<span class="sd">        </span>
<span class="sd">        This method is applied to the sink covariates before they are saved.</span>
<span class="sd">        The method can be used to compute derived covariates</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        covariates : float[]</span>
<span class="sd">            Covariates describing the attractiveness of sinks</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">covariates</span></div></div>
    
    

   

<div class="viewcode-block" id="HybridVectorModel"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel">[docs]</a><span class="k">class</span> <span class="nc">HybridVectorModel</span><span class="p">(</span><span class="n">HierarchichalPrinter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class for the hybrid vector model.</span>
<span class="sd">    </span>
<span class="sd">    Brings the model compoents together and provides functionality to fit,</span>
<span class="sd">    analyze, and  apply the model.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fileName : str</span>
<span class="sd">        Name (without extension) of the file to which the model shall be saved.</span>
<span class="sd">    trafficFactorModel_class : class</span>
<span class="sd">        Class representing the gravity model; </span>
<span class="sd">        must be inherited from :py:class:`BaseTrafficFactorModel`.</span>
<span class="sd">    destinationToDestination : bool</span>
<span class="sd">        If ``True``, the given origins will be ignored and</span>
<span class="sd">        routes will be sought from destinations to destinations. Note that destination to destination model </span>
<span class="sd">        is not yet implemented to an extent that allows the fit of the gravity</span>
<span class="sd">        model.</span>
<span class="sd">    printerArgs : tuple </span>
<span class="sd">        Arguments for the hierarchical printer. Can be ignored ingeneral.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="p">,</span> 
                 <span class="n">trafficFactorModel_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">destinationToDestination</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                 <span class="o">**</span><span class="n">printerArgs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructor&quot;&quot;&quot;</span>
        <span class="n">HierarchichalPrinter</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">printerArgs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_traffic_factor_model_class</span><span class="p">(</span><span class="n">trafficFactorModel_class</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">destinationToDestination</span> <span class="o">=</span> <span class="n">destinationToDestination</span>
    
<div class="viewcode-block" id="HybridVectorModel.save"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.save">[docs]</a>    <span class="k">def</span> <span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Saves the model to the file ``fileName``.vmm</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileName : str</span>
<span class="sd">            File name (without extension). If ``None``, the model&#39;s default </span>
<span class="sd">            file name will be used.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Saving the model as file&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="o">+</span><span class="s2">&quot;.vmm&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;roadNetwork&quot;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">saveobject</span><span class="o">.</span><span class="n">save_object</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="o">+</span><span class="s2">&quot;.vmm&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.create_road_network"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.create_road_network">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">TransportNetwork</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_road_network</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">fileNameEdges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">fileNameVertices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">preprocessingArgs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">edgeLengthRandomization</span><span class="o">=</span><span class="mf">0.001</span>
            <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates and preprocesses a route network&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span> <span class="o">=</span> <span class="n">TransportNetwork</span><span class="p">(</span><span class="n">fileNameEdges</span><span class="p">,</span> 
                                                     <span class="n">fileNameVertices</span><span class="p">,</span> 
                                                     <span class="bp">self</span><span class="o">.</span><span class="n">destinationToDestination</span><span class="p">,</span>
                                                     <span class="n">preprocessingArgs</span><span class="p">,</span>
                                                     <span class="n">edgeLengthRandomization</span><span class="p">,</span>
                                                     <span class="n">parentPrinter</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>  
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_origin_road_match</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_destination_road_match</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_postal_code_road_match</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">preprocessing</span><span class="p">(</span><span class="n">preprocessingArgs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="s2">&quot;shortestDistances&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The road network changes. The previous model&quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;and processing result are therefore inconsistent &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;and will be removed.&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.set_compliance_rate"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.set_compliance_rate">[docs]</a>    <span class="k">def</span> <span class="nf">set_compliance_rate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">complianceRate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the boaters&#39; compliance rate (for stopping at inspection/survey </span>
<span class="sd">        locations) </span>
<span class="sd">        </span>
<span class="sd">        The rate is used for both fitting the model and optimizing inspection </span>
<span class="sd">        station operation</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        complianceRate : float</span>
<span class="sd">            Proportion of agents stopping at survey/inspection stations.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span> <span class="o">=</span> <span class="n">complianceRate</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_flow_model_fit</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.read_postal_code_area_data"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.read_postal_code_area_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_postal_code_area_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileNamePostalCodeAreas</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads and saves data on postal code regions.</span>
<span class="sd">        </span>
<span class="sd">        Creates and saves an array with postal code area center vertex ID,  </span>
<span class="sd">        postal code, and population</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileNamePostalCodeAreas : str</span>
<span class="sd">            Name of a csv file with (ignored) header and columns separated by </span>
<span class="sd">            ``,``. The following columns must be present in the specified order:</span>
<span class="sd">            </span>
<span class="sd">            ============ ================== =========</span>
<span class="sd">            Field        Type               Description</span>
<span class="sd">            ============ ================== =========</span>
<span class="sd">            Postal code  :py:data:`IDTYPE`  ID of the postal code area</span>
<span class="sd">            Vertex ID    :py:data:`IDTYPE`  ID of a vertex representing the postal code area (e.g.</span>
<span class="sd">                                            a vertex at the centre or population centre)</span>
<span class="sd">            population   int                population living in the postal code area. Can be the</span>
<span class="sd">                                            actual population count or the number in hundrets, thousands, etc.</span>
<span class="sd">                                            the results just have to be interpreted accordingly</span>
<span class="sd">            ============ ================== =========</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Reading postal code area data file&quot;</span><span class="p">,</span> <span class="n">fileNamePostalCodeAreas</span><span class="p">)</span>
        <span class="n">popData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fileNamePostalCodeAreas</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>  
                                <span class="n">skip_header</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                                <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;postal_code&quot;</span><span class="p">,</span> 
                                                  <span class="s2">&quot;vertexID&quot;</span><span class="p">,</span> <span class="s2">&quot;population&quot;</span><span class="p">],</span> 
                                         <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="n">IDTYPE</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">,</span> <span class="nb">int</span><span class="p">]})</span>
        <span class="n">popData</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;vertexID&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">postalCodeAreaData</span> <span class="o">=</span> <span class="n">popData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_postal_code_road_match</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_traffic_factor_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_flow_model_fit</span><span class="p">()</span></div>
            
<div class="viewcode-block" id="HybridVectorModel.read_origin_data"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.read_origin_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_origin_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileNameOrigins</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads and saves data that can be used to determine the repulsiveness of origins in the vector traffic model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileNameOrigins : str</span>
<span class="sd">            Name of a csv file with (ignored) header and columns separated by </span>
<span class="sd">            ``,``. The following columns must be present in the specified order</span>
<span class="sd">            </span>
<span class="sd">            ======================================================================= ============================== =========</span>
<span class="sd">            Field                                                                   Type                           Description</span>
<span class="sd">            ======================================================================= ============================== =========</span>
<span class="sd">            Origin ID                                                               :py:data:`IDTYPE`              ID of the origin. Must be coinciding with the </span>
<span class="sd">                                                                                                                   respective ID used in the road network</span>
<span class="sd">            :py:attr:`ORIGIN_COVARIATES &lt;BaseTrafficFactorModel.ORIGIN_COVARIATES&gt;` ...                            Columns with the information and types specified</span>
<span class="sd">                                                                                                                   in the :py:class:`TrafficFactorModel` class. See                  </span>
<span class="sd">                                                                                                                   :py:attr:`BaseTrafficFactorModel.ORIGIN_COVARIATES`     </span>
<span class="sd">            ...</span>
<span class="sd">            ======================================================================= ============================== =========</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Reading origin data file&quot;</span><span class="p">,</span> <span class="n">fileNameOrigins</span><span class="p">)</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;originID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;infested&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">nameType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trafficFactorModel_class</span><span class="o">.</span><span class="n">ORIGIN_COVARIATES</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nameType</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">nameType</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span> 
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nameType</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">dtype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nameType</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dtype</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nameType</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;double&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dtype</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nameType</span><span class="p">,</span> <span class="s2">&quot;double&quot;</span><span class="p">))</span>
        
        
        <span class="n">popData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fileNameOrigins</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">skip_header</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span> 
        <span class="n">popData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trafficFactorModel_class</span><span class="o">.</span><span class="n">process_source_covariates</span><span class="p">(</span><span class="n">popData</span><span class="p">)</span>
        <span class="n">popData</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;originID&quot;</span><span class="p">)</span>
        <span class="c1">#self.jurisdictionPopulationFactor = np.max(popData[&quot;population&quot;])</span>
        <span class="c1">#popData[&quot;population&quot;] /= self.jurisdictionPopulationFactor</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rawOriginData</span> <span class="o">=</span> <span class="n">popData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_origin_road_match</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_flow_model_fit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_traffic_factor_model</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;roadNetwork&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">originData</span> <span class="o">=</span> <span class="n">popData</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sourcesConsidered</span><span class="p">]</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.read_destination_data"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.read_destination_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_destination_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileNameDestinations</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads and saves data that can be used to determine the attractiveness of destinations in the vector traffic model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileNameDestinations : str</span>
<span class="sd">            Name of a csv file with (ignored) header and columns separated by </span>
<span class="sd">            ``,``. The following columns must be present in the specified order</span>
<span class="sd">            </span>
<span class="sd">            ================================================================================= ============================== =========</span>
<span class="sd">            Field                                                                             Type                           Description</span>
<span class="sd">            ================================================================================= ============================== =========</span>
<span class="sd">            Destination ID                                                                    :py:data:`IDTYPE`              ID of the destination. Must be coinciding with the </span>
<span class="sd">                                                                                                                             respective ID used in the road network</span>
<span class="sd">            :py:attr:`DESTINATION_COVARIATES &lt;BaseTrafficFactorModel.DESTINATION_COVARIATES&gt;` ...                            Columns with the information and types specified</span>
<span class="sd">                                                                                                                             in the :py:class:`TrafficFactorModel` class. See                  </span>
<span class="sd">                                                                                                                             :py:attr:`BaseTrafficFactorModel.DESTINATION_COVARIATES`     </span>
<span class="sd">            ...</span>
<span class="sd">            ================================================================================= ============================== =========</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Reading destination data file&quot;</span><span class="p">,</span> <span class="n">fileNameDestinations</span><span class="p">)</span>
        
        <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;destinationID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">nameType</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trafficFactorModel_class</span><span class="o">.</span><span class="n">DESTINATION_COVARIATES</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">nameType</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">str</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">nameType</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span> 
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nameType</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">dtype</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nameType</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dtype</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nameType</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s2">&quot;double&quot;</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dtype</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nameType</span><span class="p">,</span> <span class="s2">&quot;double&quot;</span><span class="p">))</span>
                
        
        <span class="n">destinationData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fileNameDestinations</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">skip_header</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                                 <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="n">destinationData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trafficFactorModel_class</span><span class="o">.</span><span class="n">process_sink_covariates</span><span class="p">(</span><span class="n">destinationData</span><span class="p">)</span>
        <span class="n">destinationData</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;destinationID&quot;</span><span class="p">)</span>

        
        <span class="bp">self</span><span class="o">.</span><span class="n">rawDestinationData</span> <span class="o">=</span> <span class="n">destinationData</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__check_destination_road_match</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_flow_model_fit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_traffic_factor_model</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;roadNetwork&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> 
                <span class="ow">and</span> <span class="s2">&quot;sinksConsidered&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">destinationData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawDestinationData</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sinksConsidered</span><span class="p">]</span></div>
    
    
<div class="viewcode-block" id="HybridVectorModel.set_infested"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.set_infested">[docs]</a>    <span class="k">def</span> <span class="nf">set_infested</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">originID</span><span class="p">,</span> <span class="n">infested</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Chenges the infestation state of an origin with the given ID.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        originID : :py:data:`IDTYPE` </span>
<span class="sd">            ID of the origin whose state shall be changed</span>
<span class="sd">        infested : bool</span>
<span class="sd">            Infestation state. ``True`` means infested.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">inds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">[</span><span class="s2">&quot;originID&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">originID</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">inds</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;A jursidiction with ID </span><span class="si">{}</span><span class="s2"> does not exist&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">originID</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">[</span><span class="s2">&quot;infested&quot;</span><span class="p">][</span><span class="n">inds</span><span class="p">]</span> <span class="o">=</span> <span class="n">infested</span></div>
        
    <span class="k">def</span> <span class="nf">__check_postal_code_road_match</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether the given vertex IDs in the postal code area data are </span>
<span class="sd">        present in the road network</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;roadNetwork&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> 
                <span class="s2">&quot;postalCodeAreaData&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">):</span>
            <span class="n">popData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">postalCodeAreaData</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">popData</span><span class="p">[</span><span class="s2">&quot;vertexID&quot;</span><span class="p">]</span> 
                    <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">get_array</span><span class="p">()[</span><span class="s2">&quot;ID&quot;</span><span class="p">][</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">postalCodeIndexToVertexIndex</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The vertexIDs of the postal code area centers&quot;</span>
                                 <span class="o">+</span> <span class="s2">&quot; and the road network do not match.</span><span class="se">\n</span><span class="s2">&quot;</span> 
                                 <span class="o">+</span> <span class="s2">&quot;Maybe some postal code area data are &quot;</span>
                                 <span class="o">+</span> <span class="s2">&quot;missing?&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__check_origin_road_match</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether the vertices given in the origin data are present </span>
<span class="sd">        in the road network and vice versa</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">destinationToDestination</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;roadNetwork&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> 
            <span class="s2">&quot;rawOriginData&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">):</span>
            <span class="n">popData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawOriginData</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">popData</span><span class="p">[</span><span class="s2">&quot;originID&quot;</span><span class="p">]</span> 
                    <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">get_array</span><span class="p">()[</span><span class="s2">&quot;ID&quot;</span><span class="p">][</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">rawSourceIndexToVertexIndex</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The originIDs of the population data and &quot;</span>
                                 <span class="o">+</span> <span class="s2">&quot;the road network do not match.</span><span class="se">\n</span><span class="s2">&quot;</span> 
                                 <span class="o">+</span> <span class="s2">&quot;Maybe some population data are missing?&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__check_destination_road_match</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether all destinations for which we have covariates are present in the</span>
<span class="sd">        road network and vice versa</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;roadNetwork&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="s2">&quot;rawDestinationData&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">):</span>
            <span class="n">destinationData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawDestinationData</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">destinationData</span><span class="o">.</span><span class="n">size</span> 
                    <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">rawSinkIndexToVertexIndex</span><span class="o">.</span><span class="n">size</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The numbers of destinations in the destination data &quot;</span> 
                                 <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">destinationData</span><span class="p">[</span><span class="s2">&quot;destinationID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> 
                                 <span class="o">+</span> <span class="s2">&quot; and the road network &quot;</span> 
                                 <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sinkIndexToSinkID</span><span class="o">.</span><span class="n">size</span><span class="p">)</span> 
                                 <span class="o">+</span> <span class="s2">&quot; do not match. Maybe some destination data are&quot;</span>
                                 <span class="o">+</span> <span class="s2">&quot; missing?&quot;</span><span class="p">)</span>
            <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">_DESTINATION_SINK_LABEL</span>
            <span class="k">for</span> <span class="n">ID1</span><span class="p">,</span> <span class="n">ID2</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">destinationData</span><span class="p">[</span><span class="s2">&quot;destinationID&quot;</span><span class="p">],</span> 
                                <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">get_array</span><span class="p">(</span>
                                    <span class="p">)[</span><span class="s2">&quot;ID&quot;</span><span class="p">][</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">rawSinkIndexToVertexIndex</span><span class="p">]):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">L</span> <span class="o">+</span> <span class="n">ID1</span> <span class="o">==</span> <span class="n">ID2</span><span class="p">:</span> <span class="c1"># and False:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The destinationIDs of the destination data and the road&quot;</span>
                                     <span class="o">+</span> <span class="s2">&quot; network do not match.</span><span class="se">\n</span><span class="s2">&quot;</span>
                                     <span class="o">+</span> <span class="s2">&quot;Maybe some destination data are missing?&quot;</span><span class="p">)</span>
    
<div class="viewcode-block" id="HybridVectorModel.find_shortest_distances"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.find_shortest_distances">[docs]</a>    <span class="k">def</span> <span class="nf">find_shortest_distances</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines the shortest distances between all considered origins and </span>
<span class="sd">        destinations, and destinations and postal code area centres</span>
<span class="sd">        </span>
<span class="sd">        See :py:meth:`TransportNetwork.find_shortest_distances`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">roadNetwork</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span>
        
        <span class="n">reset</span> <span class="o">=</span> <span class="s2">&quot;shortestDistances&quot;</span> <span class="ow">in</span> <span class="n">roadNetwork</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="n">oldSinksConsidered</span> <span class="o">=</span> <span class="n">roadNetwork</span><span class="o">.</span><span class="n">sinksConsidered</span>
            <span class="n">oldSourcesConsidered</span> <span class="o">=</span> <span class="n">roadNetwork</span><span class="o">.</span><span class="n">sourcesConsidered</span>
        
        <span class="n">roadNetwork</span><span class="o">.</span><span class="n">find_shortest_distances</span><span class="p">()</span>
        <span class="n">sourcesConsidered</span> <span class="o">=</span> <span class="n">roadNetwork</span><span class="o">.</span><span class="n">sourcesConsidered</span>
        <span class="n">sinksConsidered</span> <span class="o">=</span> <span class="n">roadNetwork</span><span class="o">.</span><span class="n">sinksConsidered</span>
        
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">((</span><span class="n">sourcesConsidered</span> <span class="o">==</span> <span class="n">oldSourcesConsidered</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                    <span class="ow">and</span> <span class="p">(</span><span class="n">sinksConsidered</span> <span class="o">==</span> <span class="n">oldSinksConsidered</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()):</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;The road network must have changed. &quot;</span> <span class="o">+</span>
                              <span class="s2">&quot;Previous results are therefore inconsistent &quot;</span> <span class="o">+</span>
                              <span class="s2">&quot;and will be removed.&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">__erase_processed_survey_data</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">reset</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">reset</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="k">if</span> <span class="n">reset</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;rawOriginData&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">originData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawOriginData</span><span class="p">[</span>
                                                        <span class="n">sourcesConsidered</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;rawDestinationData&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">destinationData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawDestinationData</span><span class="p">[</span><span class="n">sinksConsidered</span><span class="p">]</span></div>
                
    
<div class="viewcode-block" id="HybridVectorModel.set_origins_considered"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.set_origins_considered">[docs]</a>    <span class="k">def</span> <span class="nf">set_origins_considered</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">considered</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">infested</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines which origins are considered in the model fit.</span>
<span class="sd">        </span>
<span class="sd">        It can happen that the model is to be fitted to model vectors coming </span>
<span class="sd">        from specific origins, e.g. a model for long-distance traffic and</span>
<span class="sd">        a model for intermediate-distance traffic. In this case, ``considered`` </span>
<span class="sd">        can be used to specify the origins considered to fit the model. </span>
<span class="sd">        </span>
<span class="sd">        If ``infested`` is given and ``considered`` is NOT specified, then the model</span>
<span class="sd">        will be fitted to the origins with the given infestation status.</span>
<span class="sd">        E.g. ``infested=True`` will result in the model being fitted to estimate</span>
<span class="sd">        traffic from infested jursidictions only. All other data will be </span>
<span class="sd">        ignored.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        considered : bool[]</span>
<span class="sd">            Array determining which of the sources are considered</span>
<span class="sd">        infested : bool</span>
<span class="sd">            Select considered sources based on the infestation status</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">considered</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">infested</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">considered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rawOriginData</span><span class="p">[</span><span class="s2">&quot;infested&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                                     <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">considered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawOriginData</span><span class="p">[</span><span class="s2">&quot;infested&quot;</span><span class="p">]</span><span class="o">==</span><span class="n">infested</span>
    
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">considered</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sourcesConsidered</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">update_sources_considered</span><span class="p">(</span><span class="n">considered</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__erase_survey_data</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.find_potential_routes"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.find_potential_routes">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">TransportNetwork</span><span class="o">.</span><span class="n">find_potential_routes</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">find_potential_routes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
            <span class="n">stretchConstant</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> 
            <span class="n">localOptimalityConstant</span><span class="o">=.</span><span class="mi">2</span><span class="p">,</span> 
            <span class="n">acceptionFactor</span><span class="o">=</span><span class="mf">0.667</span><span class="p">,</span>
            <span class="n">rejectionFactor</span><span class="o">=</span><span class="mf">1.333</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;# Find potential vector routes.&quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">find_potential_routes</span><span class="p">(</span><span class="n">stretchConstant</span><span class="p">,</span> 
                                                     <span class="n">localOptimalityConstant</span><span class="p">,</span> 
                                                     <span class="n">acceptionFactor</span><span class="p">,</span>
                                                     <span class="n">rejectionFactor</span><span class="p">)</span></div>
        
            
    <span class="k">def</span> <span class="nf">__create_travel_time_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">longDist</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                          <span class="n">trafficData</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create and fit the travel time model.</span>
<span class="sd">        </span>
<span class="sd">        .. todo:: Complete parameter documentation.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters : float[]</span>
<span class="sd">            If given, this will be the parameters of the travel time </span>
<span class="sd">            distribution. If not given, the optimal parameters will be </span>
<span class="sd">            determined via a maximum likelihood fit. </span>
<span class="sd">            See :py:class:`traveltime_model.TrafficDensityVonMises`</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">TrafficDensityVonMises</span><span class="p">(</span><span class="o">*</span><span class="n">parameters</span><span class="p">)</span>
        
        <span class="n">travelTimeModel</span> <span class="o">=</span> <span class="n">TrafficDensityVonMises</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">trafficData</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">longDist</span><span class="p">:</span>
                <span class="n">trafficData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;longDistTimeData&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">trafficData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;restTimeData&quot;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">index</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timeData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">td</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> <span class="k">for</span> <span class="n">td</span> 
                                       <span class="ow">in</span> <span class="n">trafficData</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
        <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
            <span class="n">timeData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">trafficData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> 
                                       <span class="ow">in</span> <span class="n">index</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">timeData</span> <span class="o">=</span> <span class="n">trafficData</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        
            
        <span class="n">travelTimeModel</span><span class="o">.</span><span class="n">maximize_likelihood</span><span class="p">(</span><span class="n">timeData</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> 
                                            <span class="n">timeData</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">],</span> 
                                            <span class="n">timeData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">],</span>
                                            <span class="n">getCI</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">travelTimeModel</span>
                        
<div class="viewcode-block" id="HybridVectorModel.create_travel_time_model"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.create_travel_time_model">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">__create_travel_time_model</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_travel_time_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create and fit the travel time model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileName : str</span>
<span class="sd">            If given, a plot with the density function of the distribution will</span>
<span class="sd">            be saved under the given name as pdf and png. </span>
<span class="sd">            Do not include the file name extension.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Fitting the travel time model&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">travelTimeModel</span> <span class="o">=</span> <span class="n">travelTimeModel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_travel_time_model</span><span class="p">(</span><span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_processed_survey_data</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">travelTimeModel</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Temporal traffic distribution found.&quot;</span><span class="p">)</span></div>
        
        
<div class="viewcode-block" id="HybridVectorModel.read_survey_data"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.read_survey_data">[docs]</a>    <span class="k">def</span> <span class="nf">read_survey_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileNameObservations</span><span class="p">,</span> <span class="n">pruneStartTime</span><span class="o">=</span><span class="mi">11</span><span class="p">,</span> 
                              <span class="n">pruneEndTime</span><span class="o">=</span><span class="mi">16</span><span class="p">,</span> <span class="n">properDataRate</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reads the survey observation data.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileNameObservations : str </span>
<span class="sd">            Name of a csv file containing the road network. The file must be a </span>
<span class="sd">            have a header (will be ignored) and the following columns, </span>
<span class="sd">            separated by ``,``:</span>
<span class="sd">            </span>
<span class="sd">            ============ ============================== =========</span>
<span class="sd">            Field        Type                           Description</span>
<span class="sd">            ============ ============================== =========</span>
<span class="sd">            stationID    :py:data:`IDTYPE`              ID of the survey location</span>
<span class="sd">            dayID        :py:data:`IDTYPE`              ID for the day of the survey (e.g. the date)</span>
<span class="sd">            shiftStart   [0, 24), `optional`            Start time of the survey shift</span>
<span class="sd">            shiftEnd     [0, 24), `optional`            End time of the survey shift</span>
<span class="sd">            time         [0, 24), `optional`            Time when the agent was observed</span>
<span class="sd">            fromID       :py:data:`IDTYPE`, `optional`  ID of the origin of the agent </span>
<span class="sd">            toID         :py:data:`IDTYPE`, `optional`  ID of the destination of the agent</span>
<span class="sd">            relevant     bool                           Whether or not this agent is a potential vector</span>
<span class="sd">            ============ ============================== =========</span>
<span class="sd">            </span>
<span class="sd">            The times must be given in the 24h format. For example, 2:30PM </span>
<span class="sd">            translates to ``14.5``.</span>
<span class="sd">            </span>
<span class="sd">            Missing or inconsistent data will either be ignored </span>
<span class="sd">            (if ``relevant==False``) or incorporated as &#39;unknown&#39; </span>
<span class="sd">            (if ``relevant==True``). All applicable data will be used to fit</span>
<span class="sd">            the temporal traffic distribution. </span>
<span class="sd">            If a survey shift has been conducted without any agent being </span>
<span class="sd">            observed, include at least one observation with origin and </span>
<span class="sd">            destination left blank and ``relevant`` set to ``False``.</span>
<span class="sd">        pruneStartTime : float</span>
<span class="sd">            Some parts of the extended model analysis require that only data </span>
<span class="sd">            collected within the same time frame are considered. </span>
<span class="sd">            ``pruneStartTime`` gives the start time of this time frame. </span>
<span class="sd">            It should be chosen so that many survey shifts include the entire </span>
<span class="sd">            time interval [``pruneStartTime``, ``pruneEndTime``].</span>
<span class="sd">        pruneEndTime : float</span>
<span class="sd">            End of the unified time frame (see :py:obj:`pruneStartTime`).</span>
<span class="sd">        properDataRate : float</span>
<span class="sd">            Fraction of agents providing inconsistent, incomplete, or wrong</span>
<span class="sd">            data. I not given, the rate will be estimated from the data.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Reading boater data&quot;</span><span class="p">,</span> <span class="n">fileNameObservations</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_processed_survey_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_flow_model_fit</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_travel_time_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_route_choice_model</span><span class="p">()</span>
        
        <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;stationID&quot;</span><span class="p">,</span> <span class="s2">&quot;dayID&quot;</span><span class="p">,</span> <span class="s2">&quot;shiftStart&quot;</span><span class="p">,</span> <span class="s2">&quot;shiftEnd&quot;</span><span class="p">,</span> 
                          <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;fromID&quot;</span><span class="p">,</span> <span class="s2">&quot;toID&quot;</span><span class="p">,</span> <span class="s2">&quot;relevant&quot;</span><span class="p">],</span> 
                 <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="n">IDTYPE</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> 
                            <span class="n">IDTYPE</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]}</span>
        
        <span class="n">surveyData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">genfromtxt</span><span class="p">(</span><span class="n">fileNameObservations</span><span class="p">,</span> <span class="n">delimiter</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span>  
                                   <span class="n">skip_header</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> 
                                   <span class="n">dtype</span> <span class="o">=</span> <span class="n">dtype</span><span class="p">)</span>
        <span class="n">surveyData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">surveyData</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">surveyData</span><span class="o">.</span><span class="n">dtype</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Determining observed daily boater counts&quot;</span><span class="p">)</span>
        
        <span class="n">pairCountData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> 
                                  <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span><span class="o">.</span><span class="n">size</span><span class="p">),</span> 
                                  <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="n">shiftDType</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;dayIndex&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;countData&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;prunedCountData&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;totalCount&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                      <span class="p">(</span><span class="s2">&quot;prunedCount&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                      <span class="p">]</span>
        
        
        <span class="n">dayDType</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;shifts&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                    <span class="p">(</span><span class="s2">&quot;countData&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="p">),</span>
                    <span class="p">]</span>
        
        <span class="n">dayData</span> <span class="o">=</span> <span class="n">FlexibleArray</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dayDType</span><span class="p">)</span>
        <span class="n">shiftData</span> <span class="o">=</span> <span class="n">FlexibleArray</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">shiftDType</span><span class="p">)</span>
        
        <span class="n">timeDType</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">,</span> <span class="s2">&quot;shiftEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">],</span> 
                      <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">]}</span>
        <span class="n">longDistTimeData</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">FlexibleArray</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">timeDType</span><span class="p">))</span>
        <span class="n">restTimeData</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">FlexibleArray</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">timeDType</span><span class="p">))</span>
        <span class="n">dayIDToDayIndex</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        
        <span class="n">considered</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;stationID&quot;</span><span class="p">]</span> <span class="o">!=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="n">surveyData</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
        
        <span class="n">dayArr</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;dayID&quot;</span><span class="p">]</span>
        <span class="n">stationArr</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;stationID&quot;</span><span class="p">]</span>
        <span class="n">shiftStartArr</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">]</span>
        <span class="n">shiftEndArr</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">]</span>
        <span class="n">fromArr</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;fromID&quot;</span><span class="p">]</span>
        <span class="n">toArr</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;toID&quot;</span><span class="p">]</span>
        <span class="n">timeArr</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
        <span class="n">relevantArr</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;relevant&quot;</span><span class="p">]</span>
        <span class="n">sourceIndices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sourceIDToSourceIndex</span>
        <span class="n">sinkIndices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sinkIDToSinkIndex</span>
        
        <span class="n">a</span> <span class="o">=</span> <span class="n">surveyData</span><span class="p">[[</span><span class="s2">&quot;stationID&quot;</span><span class="p">,</span> <span class="s2">&quot;dayID&quot;</span><span class="p">,</span> <span class="s2">&quot;shiftStart&quot;</span><span class="p">,</span> <span class="s2">&quot;shiftEnd&quot;</span><span class="p">]]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">newShift</span> <span class="o">=</span> <span class="o">~</span><span class="p">((</span><span class="n">a</span> <span class="o">==</span> <span class="n">b</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">a</span> <span class="o">!=</span> <span class="n">a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">b</span> <span class="o">!=</span> <span class="n">b</span><span class="p">)))</span> 
        <span class="n">newShift</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">shiftStartIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">_DESTINATION_SOURCE_LABEL</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">destinationToDestination</span> <span class="k">else</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
        <span class="n">L</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">_DESTINATION_SINK_LABEL</span>
        
        <span class="n">rejectedCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">acceptedCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">shiftEndIndex</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">newShift</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">obsdict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">stationIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIDToStationIndex</span><span class="p">[</span>
                                                    <span class="n">stationArr</span><span class="p">[</span><span class="n">shiftStartIndex</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">shiftStartIndex</span> <span class="o">=</span> <span class="n">shiftEndIndex</span>
                <span class="k">continue</span>
            
            <span class="k">if</span> <span class="n">dayArr</span><span class="p">[</span><span class="n">shiftStartIndex</span><span class="p">]</span> <span class="o">==</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">shiftStartIndex</span> <span class="o">=</span> <span class="n">shiftEndIndex</span>
                <span class="k">continue</span>
            
            <span class="n">shiftStart</span> <span class="o">=</span> <span class="n">shiftStartArr</span><span class="p">[</span><span class="n">shiftStartIndex</span><span class="p">]</span>
            <span class="n">shiftEnd</span> <span class="o">=</span> <span class="n">shiftEndArr</span><span class="p">[</span><span class="n">shiftStartIndex</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">shiftStart</span> <span class="o">&gt;=</span> <span class="n">shiftEnd</span><span class="p">:</span>
                <span class="n">shiftStart</span> <span class="o">-=</span> <span class="mi">24</span>
                
                <span class="c1"># we assume that we have no shifts longer than 12 hours</span>
                <span class="c1"># therefore, too long over night shifts are considered an error.</span>
                <span class="k">if</span> <span class="n">shiftEnd</span> <span class="o">-</span> <span class="n">shiftStart</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">shiftStart</span> <span class="o">=</span> <span class="n">shiftEnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            
            <span class="n">validObservationCount</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">timeArr</span><span class="p">[</span><span class="n">shiftStartIndex</span><span class="p">:</span><span class="n">shiftEndIndex</span><span class="p">])</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">shiftStart</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">validObservationCount</span><span class="p">:</span>
                    <span class="n">shiftStartIndex</span> <span class="o">=</span> <span class="n">shiftEndIndex</span>
                    <span class="k">continue</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">timeArr</span><span class="p">[</span><span class="n">shiftStartIndex</span><span class="p">:</span><span class="n">shiftEndIndex</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">shiftEnd</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">shiftEnd</span><span class="o">-</span><span class="mi">12</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">shiftEnd</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span><span class="o">%</span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="n">shiftStart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">t</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">shiftEnd</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span><span class="o">%</span><span class="mi">24</span><span class="p">])</span> <span class="o">-</span> <span class="mi">24</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">shiftStart</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">t</span><span class="p">)])</span>
                    <span class="n">diffs</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="o">%</span> <span class="mi">24</span>
                    <span class="n">switch</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">diffs</span><span class="p">)</span>
                    <span class="n">shiftStart</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">switch</span><span class="p">]</span>
                    <span class="n">shiftEnd</span> <span class="o">=</span> <span class="n">t</span><span class="p">[</span><span class="n">switch</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">switch</span><span class="p">:</span>
                        <span class="n">shiftStart</span> <span class="o">-=</span> <span class="mi">24</span>
            <span class="k">elif</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">shiftEnd</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">validObservationCount</span><span class="p">:</span>
                    <span class="n">shiftStartIndex</span> <span class="o">=</span> <span class="n">shiftEndIndex</span>
                    <span class="k">continue</span>
                <span class="n">t</span> <span class="o">=</span> <span class="n">timeArr</span><span class="p">[</span><span class="n">shiftStartIndex</span><span class="p">:</span><span class="n">shiftEndIndex</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">shiftStart</span><span class="o">+</span><span class="mi">12</span> <span class="o">&gt;</span> <span class="mi">24</span> <span class="ow">and</span> <span class="p">(</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">shiftStart</span><span class="o">+</span><span class="mi">12</span><span class="p">)</span><span class="o">%</span><span class="mi">24</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">shiftEnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">t</span><span class="p">[</span><span class="n">t</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="n">shiftStart</span><span class="o">+</span><span class="mi">12</span><span class="p">)</span><span class="o">%</span><span class="mi">24</span><span class="p">])</span>
                    <span class="n">shiftStart</span> <span class="o">-=</span> <span class="mi">24</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">shiftEnd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    
            <span class="k">if</span> <span class="ow">not</span> <span class="n">shiftStart</span> <span class="o">&lt;</span> <span class="n">shiftEnd</span><span class="p">:</span>
                <span class="n">shiftStartIndex</span> <span class="o">=</span> <span class="n">shiftEndIndex</span>
                <span class="k">continue</span>
             
            <span class="k">if</span> <span class="n">shiftStart</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">timeArr</span><span class="p">[</span><span class="n">shiftStartIndex</span><span class="p">:</span><span class="n">shiftEndIndex</span><span class="p">][</span>
                    <span class="n">timeArr</span><span class="p">[</span><span class="n">shiftStartIndex</span><span class="p">:</span><span class="n">shiftEndIndex</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">shiftEnd</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">24</span>
            
            <span class="c1"># Here we assume that pruneStartTime and pruneEndTime are &gt;= 0</span>
            <span class="k">if</span> <span class="p">((</span><span class="n">shiftStart</span> <span class="o">&lt;=</span> <span class="n">pruneStartTime</span> <span class="ow">and</span> <span class="n">shiftEnd</span> <span class="o">&gt;=</span> <span class="n">pruneEndTime</span><span class="p">)</span> <span class="ow">or</span>
                    <span class="p">(</span><span class="n">shiftStart</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">shiftStart</span><span class="o">+</span><span class="mi">24</span> <span class="o">&lt;=</span> <span class="n">pruneStartTime</span><span class="p">)):</span>
                <span class="n">prunedCount</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">includePrunedShift</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">prunedObsdict</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">includePrunedShift</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">prunedObsdict</span> <span class="o">=</span> <span class="kc">None</span>
            
            <span class="n">totalCount</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shiftStartIndex</span><span class="p">,</span> <span class="n">shiftEndIndex</span><span class="p">):</span>
                <span class="n">time</span> <span class="o">=</span> <span class="n">timeArr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                
                <span class="k">if</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">includeTime</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">includePrunedShift</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">time</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">shiftStart</span> <span class="o">&lt;</span> <span class="n">time</span> <span class="o">&lt;</span> <span class="n">shiftEnd</span><span class="p">:</span>
                        <span class="c1">#shiftStartIndex = shiftEndIndex</span>
                        <span class="k">continue</span>
                    <span class="n">includeTime</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span> 
                    <span class="n">includeTime</span> <span class="o">=</span> <span class="kc">False</span>
                
                <span class="c1"># put totalCount here, if observations that were not included</span>
                <span class="c1"># in the optimization shall be counted as well</span>
                <span class="c1">#totalCount += 1</span>
                
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">relevantArr</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">()</span>
                    
                    <span class="n">fromIndex</span> <span class="o">=</span> <span class="n">sourceIndices</span><span class="p">[</span><span class="n">l</span><span class="o">+</span><span class="n">fromArr</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    <span class="n">toIndex</span> <span class="o">=</span> <span class="n">sinkIndices</span><span class="p">[</span><span class="n">L</span><span class="o">+</span><span class="n">toArr</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    
                    <span class="c1"># comment, if not infested jursidictions shall be included</span>
                    <span class="c1">#if not self.originData[fromIndex][&quot;infested&quot;]:</span>
                    <span class="c1">#if self.originData[fromIndex][&quot;infested&quot;]:</span>
                    <span class="c1">#    raise KeyError()</span>
                    
                    <span class="n">obsdict</span><span class="p">[(</span><span class="n">fromIndex</span><span class="p">,</span> <span class="n">toIndex</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">pairCountData</span><span class="p">[</span><span class="n">fromIndex</span><span class="p">,</span> <span class="n">toIndex</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">totalCount</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">includePrunedShift</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">pruneStartTime</span> <span class="o">&lt;=</span> <span class="n">time</span> <span class="o">&lt;=</span> <span class="n">pruneEndTime</span><span class="p">:</span>
                            <span class="n">prunedCount</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">prunedObsdict</span><span class="p">[(</span><span class="n">fromIndex</span><span class="p">,</span> <span class="n">toIndex</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">includeTime</span><span class="p">:</span>
                        <span class="n">longDistTimeData</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span><span class="o">.</span><span class="n">add_tuple</span><span class="p">((</span><span class="n">shiftStart</span><span class="p">,</span> 
                                                                  <span class="n">shiftEnd</span><span class="p">,</span> 
                                                                  <span class="n">time</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">includeTime</span><span class="p">:</span>
                        <span class="n">restTimeData</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span><span class="o">.</span><span class="n">add_tuple</span><span class="p">((</span><span class="n">shiftStart</span><span class="p">,</span> 
                                                              <span class="n">shiftEnd</span><span class="p">,</span> <span class="n">time</span><span class="p">))</span>
                    <span class="n">rejectedCount</span> <span class="o">+=</span> <span class="n">relevantArr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                
            <span class="k">if</span> <span class="ow">not</span> <span class="n">includePrunedShift</span><span class="p">:</span>
                <span class="n">prunedCount</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            
            <span class="n">dayID</span> <span class="o">=</span> <span class="n">dayArr</span><span class="p">[</span><span class="n">shiftStartIndex</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">dayID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dayIDToDayIndex</span><span class="p">:</span>
                <span class="n">dayIndex</span> <span class="o">=</span> <span class="n">dayData</span><span class="o">.</span><span class="n">add_tuple</span><span class="p">(([],</span> <span class="n">obsdict</span><span class="p">))</span>
                <span class="n">dayIDToDayIndex</span><span class="p">[</span><span class="n">dayID</span><span class="p">]</span> <span class="o">=</span> <span class="n">dayIndex</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">dayIndex</span> <span class="o">=</span> <span class="n">dayIDToDayIndex</span><span class="p">[</span><span class="n">dayID</span><span class="p">]</span>
                <span class="n">dayObsdict</span> <span class="o">=</span> <span class="n">dayData</span><span class="p">[</span><span class="n">dayIndex</span><span class="p">][</span><span class="s2">&quot;countData&quot;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">obsdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">dayObsdict</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
            
            <span class="n">shiftIndex</span> <span class="o">=</span> <span class="n">shiftData</span><span class="o">.</span><span class="n">add_tuple</span><span class="p">((</span><span class="n">dayIndex</span><span class="p">,</span> <span class="n">stationIndex</span><span class="p">,</span> 
                                              <span class="n">shiftStart</span><span class="p">,</span> <span class="n">shiftEnd</span><span class="p">,</span> 
                                              <span class="nb">dict</span><span class="p">(</span><span class="n">obsdict</span><span class="p">),</span> 
                                              <span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">prunedObsdict</span><span class="p">)</span> <span class="k">if</span> 
                                                 <span class="n">prunedObsdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> 
                                                 <span class="k">else</span> <span class="kc">None</span><span class="p">),</span> 
                                 <span class="n">totalCount</span><span class="p">,</span> <span class="n">prunedCount</span><span class="p">))</span>
            
            <span class="n">acceptedCount</span> <span class="o">+=</span> <span class="n">totalCount</span>
            <span class="n">dayData</span><span class="p">[</span><span class="n">dayIndex</span><span class="p">][</span><span class="s2">&quot;shifts&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">shiftIndex</span><span class="p">)</span> 
            <span class="n">shiftStartIndex</span> <span class="o">=</span> <span class="n">shiftEndIndex</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span> <span class="o">=</span> <span class="p">{}</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pruneStartTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pruneStartTime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pruneEndTime&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pruneEndTime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;longDistTimeData&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">longDistTimeData</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;restTimeData&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">restTimeData</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">shiftData</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;dayData&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dayData</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="n">_properDataRate</span> <span class="o">=</span> <span class="n">acceptedCount</span><span class="o">/</span><span class="p">(</span><span class="n">rejectedCount</span><span class="o">+</span><span class="n">acceptedCount</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Fraction of complete data:&quot;</span><span class="p">,</span> <span class="n">_properDataRate</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">properDataRate</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properDataRate</span> <span class="o">=</span> <span class="n">_properDataRate</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">properDataRate</span> <span class="o">=</span> <span class="n">properDataRate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Set properDataRate to given value&quot;</span><span class="p">,</span> <span class="n">properDataRate</span><span class="p">)</span>
        
        <span class="n">dayCountData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;dayData&quot;</span><span class="p">][</span><span class="s2">&quot;countData&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">d</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dayCountData</span><span class="p">):</span>
            <span class="n">dayCountData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pairCountData&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pairCountData</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Daily boater counts and time data determined.&quot;</span><span class="p">)</span></div>
    
    
    <span class="k">def</span> <span class="nf">__erase_flow_model_fit</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resets the gravity model to an unfitted state.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;flowModelData&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__erase_traffic_factor_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Erases the gravity model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;trafficFactorModel&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_flow_model_fit</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">__erase_travel_time_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Erases the travel time model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_route_choice_model</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;travelTimeModel&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">__erase_route_choice_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Erases the route choice model.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;routeChoiceModel&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_traffic_factor_model</span><span class="p">()</span>
            
    <span class="k">def</span> <span class="nf">__erase_survey_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot;Erases the survey data.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;surveyData&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_processed_survey_data</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_travel_time_model</span><span class="p">()</span>
    
    <span class="k">def</span> <span class="nf">__erase_processed_survey_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>    
        <span class="sd">&quot;&quot;&quot;Erases the observation data prepared for the model fit.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;processedSurveyData&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_route_choice_model</span><span class="p">()</span>
        
    
<div class="viewcode-block" id="HybridVectorModel.create_route_choice_model"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.create_route_choice_model">[docs]</a>    <span class="k">def</span> <span class="nf">create_route_choice_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates and fits the route choice model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        redo : bool</span>
<span class="sd">            Whether the route choice model shall be refitted if it has been </span>
<span class="sd">            fitted already. If set to ``True``, the previous fit will be ignored.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating route choice model&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">redo</span> <span class="ow">and</span> <span class="s2">&quot;routeChoiceModel&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Route model has already been created.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;inspectedPotentialRoutes&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Route candidates must be computed before a route &quot;</span>
                          <span class="o">+</span> <span class="s2">&quot;model can be created. Nothing has been done. Call&quot;</span>
                          <span class="o">+</span> <span class="s2">&quot;model.find_potential_routes(...)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        <span class="n">shiftData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Preparing road model&quot;</span><span class="p">)</span>
        
        <span class="n">routeChoiceModel</span> <span class="o">=</span> <span class="n">RouteChoiceModel</span><span class="p">(</span><span class="n">parentPrinter</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">set_fitting_data</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;dayData&quot;</span><span class="p">],</span> <span class="n">shiftData</span><span class="p">,</span> 
                                          <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">inspectedPotentialRoutes</span><span class="p">,</span> 
                                          <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span> 
                                          <span class="bp">self</span><span class="o">.</span><span class="n">travelTimeModel</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properDataRate</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span> <span class="o">=</span> <span class="n">routeChoiceModel</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span>    </div>
            
        
<div class="viewcode-block" id="HybridVectorModel.preprocess_survey_data"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.preprocess_survey_data">[docs]</a>    <span class="k">def</span> <span class="nf">preprocess_survey_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">redo</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes the raw survey data and preprocesses them for the model fit.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        redo : bool</span>
<span class="sd">            Whether the task shall be repeated if it had been done before.</span>
<span class="sd">            If set to ``True``, the earlier result be ignored.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Extrapolating the boater count data&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">redo</span> <span class="ow">and</span> <span class="s2">&quot;processedSurveyData&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Count data have already been prepared.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;inspectedPotentialRoutes&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Route candidates must be computed before a route &quot;</span>
                          <span class="o">+</span> <span class="s2">&quot;model can be created. Nothing has been done. Call&quot;</span>
                          <span class="o">+</span> <span class="s2">&quot;model.find_potential_routes(...)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Extrapolating the count data&quot;</span><span class="p">)</span>
        <span class="n">sourceIndexToSourceID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span>
        <span class="n">sinkIndexToSinkID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sinkIndexToSinkID</span>
        <span class="n">stationIndexToStationID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIndexToStationID</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Extrapolating boater count data&quot;</span><span class="p">)</span>
        
        <span class="n">countDType</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;pairIndex&quot;</span><span class="p">,</span> <span class="s2">&quot;p_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">],</span> 
                      <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">]}</span>
        <span class="n">fullCountData</span> <span class="o">=</span> <span class="n">FlexibleArray</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">countDType</span><span class="p">)</span>
        
        <span class="n">shiftDType</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;p_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;usedStationIndex&quot;</span><span class="p">,</span> <span class="s2">&quot;shiftStart&quot;</span><span class="p">,</span>
                               <span class="s2">&quot;shiftEnd&quot;</span><span class="p">],</span> 
                      <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]}</span>
        <span class="n">shiftData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">shiftDType</span><span class="p">)</span>
        
        <span class="n">noiseDType</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;pairIndex&quot;</span><span class="p">,</span> <span class="s2">&quot;p_shift&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">],</span> 
                      <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">]}</span>
        <span class="n">observedNoiseData</span> <span class="o">=</span> <span class="n">FlexibleArray</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">noiseDType</span><span class="p">)</span>
        
        
        <span class="n">inspectedRoutes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">inspectedPotentialRoutes</span>
        <span class="n">routeLengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">lengthsOfPotentialRoutes</span>
        <span class="n">countData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">shortestDistances</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
        
        <span class="n">usedStationIndexToStationIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">countData</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">]</span>
                                                   <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">usedStationIndexToStationIndex</span> <span class="o">=</span> <span class="n">usedStationIndexToStationIndex</span>
        
        <span class="n">stationIndexToUsedStationIndex</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">index</span> <span class="ow">in</span> 
                                  <span class="nb">enumerate</span><span class="p">(</span><span class="n">usedStationIndexToStationIndex</span><span class="p">)}</span>
            
        <span class="n">stationDType</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;pairIndices&quot;</span><span class="p">,</span> <span class="s2">&quot;consideredPathLengths&quot;</span><span class="p">],</span> 
                        <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">object</span><span class="p">]}</span>
        <span class="n">stationData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">usedStationIndexToStationIndex</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> 
                               <span class="n">dtype</span><span class="o">=</span><span class="n">stationDType</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stationIndex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">usedStationIndexToStationIndex</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">stationIndex</span> <span class="ow">in</span> <span class="n">inspectedRoutes</span><span class="p">:</span>
                <span class="n">consideredPathLengths</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="p">[</span><span class="n">routeLengths</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pathIndex</span><span class="p">]</span> <span class="k">for</span> <span class="n">pathIndex</span> 
                    <span class="ow">in</span> <span class="n">pathIndices</span><span class="p">]</span> <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">pathIndices</span> 
                    <span class="ow">in</span> <span class="n">inspectedRoutes</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">consideredPathLengths</span> <span class="o">=</span> <span class="p">[]</span>
                
            <span class="k">if</span> <span class="n">stationIndex</span> <span class="ow">in</span> <span class="n">inspectedRoutes</span><span class="p">:</span>
                <span class="n">pairIndices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">factor</span><span class="o">*</span><span class="n">pair</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> 
                                        <span class="n">inspectedRoutes</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()],</span>
                                       <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pairIndices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            <span class="n">stationData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">pairIndices</span><span class="p">,</span> 
                              <span class="n">list_to_csr_matrix</span><span class="p">(</span><span class="n">consideredPathLengths</span><span class="p">))</span>
        
        <span class="n">consideredPathLengths</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">travelTimeModel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">travelTimeModel</span><span class="o">.</span><span class="n">interval_probability</span>
        <span class="n">allObservations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">falseObservations</span> <span class="o">=</span> <span class="n">FlexibleArray</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> 
                                          <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;stationID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">),</span>
                                                 <span class="p">(</span><span class="s2">&quot;fromID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">),</span>
                                                 <span class="p">(</span><span class="s2">&quot;toID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">)])</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">countData</span><span class="p">):</span>
            <span class="n">p_shift</span> <span class="o">=</span> <span class="n">travelTimeModel</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">])</span>
            <span class="n">stationIndex</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">]</span>
            <span class="n">obsdict</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;countData&quot;</span><span class="p">]</span>
            <span class="n">percentage</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">percentage</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">percentage</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
            <span class="n">inspectedRoutesDict</span> <span class="o">=</span> <span class="n">inspectedRoutes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stationIndex</span><span class="p">,</span> <span class="p">[])</span>
            <span class="n">fullCountData</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">factor</span><span class="o">*</span><span class="n">pair</span><span class="p">),</span> <span class="n">p_shift</span><span class="p">,</span> 
                                   <span class="n">count</span><span class="p">)</span> <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> 
                                  <span class="n">obsdict</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> 
                                  <span class="k">if</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">inspectedRoutesDict</span><span class="p">]</span>
                                 <span class="p">)</span>
            
            <span class="n">consideredPathLengths</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="p">[</span><span class="n">routeLengths</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pathIndex</span><span class="p">]</span> <span class="k">for</span> <span class="n">pathIndex</span> 
                 <span class="ow">in</span> <span class="n">inspectedRoutesDict</span><span class="p">[</span><span class="n">pair</span><span class="p">]]</span> <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">obsdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                                         <span class="k">if</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">inspectedRoutesDict</span>
                                         <span class="p">)</span>
            
            <span class="n">observedNoise</span> <span class="o">=</span> <span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">obsdict</span><span class="p">)</span> 
                             <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">inspectedRoutes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">stationIndex</span><span class="p">,</span> <span class="nb">set</span><span class="p">()))</span>
                             <span class="p">)</span>
            <span class="n">observedNoiseData</span><span class="o">.</span><span class="n">extend</span><span class="p">([(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">factor</span><span class="o">*</span><span class="n">pair</span><span class="p">),</span> <span class="n">p_shift</span><span class="p">,</span> 
                                       <span class="n">obsdict</span><span class="p">[</span><span class="n">pair</span><span class="p">])</span> 
                                      <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">observedNoise</span><span class="p">])</span>
            
            <span class="c1"># number of all possible pairs - number of covered pairs</span>
            <span class="c1">#  + number of false observations                          </span>
            <span class="n">shiftData</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">p_shift</span><span class="p">,</span> 
                            <span class="n">stationIndexToUsedStationIndex</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">],</span>
                            <span class="n">row</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">])</span>
            <span class="n">allObservations</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">obsdict</span><span class="p">)</span>
            
            <span class="n">stationID</span> <span class="o">=</span> <span class="n">stationIndexToStationID</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">observedNoise</span><span class="p">:</span>
                <span class="n">falseObservations</span><span class="o">.</span><span class="n">add_tuple</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">stationID</span><span class="p">,</span> <span class="n">sourceIndexToSourceID</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                     <span class="n">sinkIndexToSinkID</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]))</span>
            
        <span class="n">consideredPathLengths</span> <span class="o">=</span> <span class="n">list_to_csr_matrix</span><span class="p">(</span><span class="n">consideredPathLengths</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">falseObservations</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="s2">&quot;out of&quot;</span><span class="p">,</span> <span class="n">allObservations</span><span class="p">,</span> 
                  <span class="s2">&quot;boaters were observed at an unexpected location.&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;(</span><span class="si">{:6.2%}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">falseObservations</span><span class="o">.</span><span class="n">size</span><span class="o">/</span>
                                     <span class="n">allObservations</span><span class="p">))</span>
        
        <span class="n">falseObservations</span> <span class="o">=</span> <span class="n">falseObservations</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="n">falseObservations</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">falseObservations</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;FalseObservations.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">processedSurveyData</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;fullCountData&quot;</span><span class="p">:</span> <span class="n">fullCountData</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
            <span class="s2">&quot;consideredPathLengths&quot;</span><span class="p">:</span> <span class="n">consideredPathLengths</span><span class="p">,</span>
            <span class="s2">&quot;observedNoiseData&quot;</span><span class="p">:</span> <span class="n">observedNoiseData</span><span class="o">.</span><span class="n">get_array</span><span class="p">(),</span>
            <span class="s2">&quot;shiftData&quot;</span><span class="p">:</span> <span class="n">shiftData</span><span class="p">,</span>
            <span class="s2">&quot;stationData&quot;</span><span class="p">:</span> <span class="n">stationData</span>
            <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>
    
    <span class="c1">#@staticmethod</span>
    <span class="c1">#@inherit_doc(BaseTrafficFactorModel.get_mean_factor)</span>
    <span class="nd">@staticmethod_inherit_doc</span><span class="p">(</span><span class="n">BaseTrafficFactorModel</span><span class="o">.</span><span class="n">get_mean_factor</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_k_value_static</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">,</span> <span class="n">pair</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the ``k`` parameter of the negative binomial distribution.</span>
<span class="sd">        </span>
<span class="sd">        The value is computed accoring to the gravity model implemented in the</span>
<span class="sd">        ``trafficFactorModel``.</span>
<span class="sd">        </span>
<span class="sd">        Note that in contrast to the ``trafficFactorModel``,  Similarly, ``considered`` must have entries</span>
<span class="sd">        for these parameters, which will be assumed to be ``True``.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        trafficFactorModel : :py:class:`BaseTrafficFactorModel`</span>
<span class="sd">            Traffic factor model that is to be used to compute the ``k`` value.</span>
<span class="sd">        parameters #</span>
<span class="sd">            &gt;!The first two entries must refer to the proportionality constant </span>
<span class="sd">            and the parameter ``q``, which is `1-mean/variance`. The remaining </span>
<span class="sd">            parameters are used to compute the traffic factor.</span>
<span class="sd">        considered #</span>
<span class="sd">            &gt;!The first two entries must refer to the proportionality constant </span>
<span class="sd">            and the parameter ``q`` and will be assumed to be ``True``.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   
        <span class="n">c0</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="n">q</span>  <span class="c1"># reparameterization k-&gt;mu</span>
        <span class="k">return</span> <span class="n">trafficFactorModel</span><span class="o">.</span><span class="n">get_mean_factor</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> <span class="n">considered</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> 
                                                  <span class="n">pair</span><span class="p">)</span> <span class="o">*</span> <span class="n">c0</span>
    
    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">_get_k_value_static</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_k_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">pair</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;#Returns the ``k`` parameter of the negative binomial distribution.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_get_k_value_static</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficFactorModel</span><span class="p">,</span> <span class="n">pair</span><span class="p">)</span>
    
    <span class="nd">@staticmethod_inherit_doc</span><span class="p">(</span><span class="n">_get_k_value_static</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_k_value_autograd_static</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Same as :py:meth:`_get_k_value_static`, but must use autograd&#39;s </span>
<span class="sd">        functions instead of numpy. &quot;&quot;&quot;</span>
        
        <span class="n">q</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>   
        <span class="n">c0</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span> <span class="o">/</span> <span class="n">q</span>  <span class="c1"># reparameterization k-&gt;mu</span>
        <span class="k">return</span> <span class="n">trafficFactorModel</span><span class="o">.</span><span class="n">get_mean_factor_autograd</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> 
                                                           <span class="n">considered</span><span class="p">[</span><span class="mi">2</span><span class="p">:])</span> <span class="o">*</span> <span class="n">c0</span>
    
    <span class="nd">@staticmethod_inherit_doc</span><span class="p">(</span><span class="n">BaseTrafficFactorModel</span><span class="o">.</span><span class="n">convert_parameters</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_convert_parameters_static</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        parameters : float[] </span>
<span class="sd">            Free parameters. The parameters that are not held constant.</span>
<span class="sd">        trafficFactorModel : :py:class:`BaseTrafficFactorModel`</span>
<span class="sd">            Traffic factor model that is to be used.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">return</span> <span class="p">([</span><span class="n">convert_R_pos</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">convert_R_0_1</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">])]</span> 
                 <span class="o">+</span> <span class="n">trafficFactorModel</span><span class="o">.</span><span class="n">convert_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">[</span><span class="mi">2</span><span class="p">:],</span> 
                                                         <span class="n">considered</span><span class="p">[</span><span class="mi">2</span><span class="p">:]))</span>
    
    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">_convert_parameters_static</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_convert_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_convert_parameters_static</span><span class="p">(</span>
            <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficFactorModel</span><span class="p">)</span>
        
    <span class="c1">#@staticmethod</span>
    <span class="c1">#@inherit_doc(_get_k_value_static)</span>
    <span class="nd">@staticmethod_inherit_doc</span><span class="p">(</span><span class="n">_get_k_value_static</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_negLogLikelihood</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">routeChoiceParameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> 
                          <span class="n">pairIndices</span><span class="p">,</span> <span class="n">stationPairIndices</span><span class="p">,</span> <span class="n">observedNoisePairs</span><span class="p">,</span>
                          <span class="n">routeProbabilities</span><span class="p">,</span> 
                          <span class="n">stationRouteProbabilities</span><span class="p">,</span>
                          <span class="n">stationIndices</span><span class="p">,</span>
                          <span class="n">p_shift</span><span class="p">,</span> <span class="n">shiftDataP_shift</span><span class="p">,</span> <span class="n">observedNoiseP_shift</span><span class="p">,</span> 
                          <span class="n">p_shift_mean</span><span class="p">,</span> <span class="n">stationKs</span><span class="p">,</span> 
                          <span class="n">kSumNotObserved</span><span class="p">,</span>
                          <span class="n">approximationNumber</span><span class="p">,</span>
                          <span class="n">counts</span><span class="p">,</span> <span class="n">observedNoiseCounts</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;Returns the negative log-likelihood of the model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        routeChoiceParameters : float[]</span>
<span class="sd">            Route choice parameters. The first entry is the probability to </span>
<span class="sd">            select an inadmissible path. The second entry is the exponent</span>
<span class="sd">            controlling the preference for shorter paths. The third entry is</span>
<span class="sd">            the probability that a given suvey location is on a randomly </span>
<span class="sd">            selected inadmissible path.</span>
<span class="sd">        pairIndices : int[]</span>
<span class="sd">            For each set of agents who were (1) suveyed during the </span>
<span class="sd">            same survey shift and (2) travelling between the smae </span>
<span class="sd">            origin-destination pair the index of the origin-destination pair.</span>
<span class="sd">            The index for an origin-dedtination pair </span>
<span class="sd">            `(fromIndex, toIndex)` is computed as </span>
<span class="sd">            `fromIndex * #destinations + toIndex`.</span>
<span class="sd">        stationPairIndices : int[][]</span>
<span class="sd">            ``stationPairIndices[i]`` contains an int[] with the indices of pairs </span>
<span class="sd">            that have an admissible path via survey station ``i``.</span>
<span class="sd">        observedNoisePairs : int[]</span>
<span class="sd">            For each agent that has been observed at a location that it is not</span>
<span class="sd">            on any admissible path between the agent&#39;s origin and destination,</span>
<span class="sd">            :py:obj:`observedNoisePairs` contains the repsective origin-destination</span>
<span class="sd">            pair index.</span>
<span class="sd">        routeProbabilities : float[]</span>
<span class="sd">            Contains for each agent set (see :py:obj:`pairIndices`)</span>
<span class="sd">            the probability that any given agent from this set </span>
<span class="sd">            chooses a route via the location where they were observed. </span>
<span class="sd">        stationRouteProbabilities : float[][]</span>
<span class="sd">            ``stationRouteProbabilities[i]`` contains a float[] with the </span>
<span class="sd">            respective probabilities to drive via survey station i for all </span>
<span class="sd">            origin-destination pairs in ``stationPairIndices``. That is,</span>
<span class="sd">            ``stationRouteProbabilities[i][j]`` is the probability that an agent</span>
<span class="sd">            will travel via location ``i`` on their trip between </span>
<span class="sd">            origin-dsetination pair ``j``. </span>
<span class="sd">        stationIndices : int[]</span>
<span class="sd">            Contains for each survey shift the index of the location where the</span>
<span class="sd">            survey was conducted.</span>
<span class="sd">        p_shift : float[]</span>
<span class="sd">            Contains for each agent set (see :py:obj:`pairIndices`)</span>
<span class="sd">            the probability that they timed their journey in a way that they </span>
<span class="sd">            would pass the survey location while a survey was conducted there.</span>
<span class="sd">        shiftDataP_shift : float[]</span>
<span class="sd">            Contains for each survey shift the probability that an agent that is</span>
<span class="sd">            known to pass the respective survey location at some time does</span>
<span class="sd">            so while the survey was conducted.</span>
<span class="sd">        observedNoiseP_shift : float[]</span>
<span class="sd">            Contains for each set of agents that who was (1) surveyed in the</span>
<span class="sd">            same survey shift and (2) `not` observed on an</span>
<span class="sd">            admissible route between their origin and destination </span>
<span class="sd">            the probability that they timed their journey in a way that they </span>
<span class="sd">            would pass the survey location while a survey was conducted there.</span>
<span class="sd">        p_shift_mean : float</span>
<span class="sd">            Mean of :py:obj:`shiftDataP_shift`.</span>
<span class="sd">        stationKs : float[][]</span>
<span class="sd">            An empty array of dimension `(stationNumber, approximationNumber+1)`,</span>
<span class="sd">            whereby `stationNumber` is the number of used survey locations and</span>
<span class="sd">            approximationNumber the degree of the Tailor approximation that is</span>
<span class="sd">            to be used (see below).</span>
<span class="sd">        kSumNotObserved : float[]</span>
<span class="sd">            An empty array whose length coincides with the number of used</span>
<span class="sd">            survey locations.</span>
<span class="sd">        approximationNumber : int</span>
<span class="sd">            Degree of the Taylor approximation that is to be used. The higher </span>
<span class="sd">            this number the more precise the likelihood will be but also the</span>
<span class="sd">            longer will the computation take. Must be `&gt;= 1`.</span>
<span class="sd">        counts : int[]</span>
<span class="sd">            The size of each agent set described in the explanation for</span>
<span class="sd">            :py:obj:`pairIndices`.</span>
<span class="sd">        observedNoiseCounts :</span>
<span class="sd">            The size of each agent set described in the explanation for </span>
<span class="sd">            :py:obj:`observedNoiseP_shift` .</span>
<span class="sd">        trafficFactorModel : :py:class:`BaseTrafficFactorModel`</span>
<span class="sd">            Traffic factor model used to determine the strengths of the agent</span>
<span class="sd">            flows between the individual origin-destination pairs.</span>
<span class="sd">        </span>
<span class="sd">        ~+~</span>
<span class="sd">        </span>
<span class="sd">        The rationale for passing empty arrays to :py:meth:`_negLogLikelihood`</span>
<span class="sd">        is to save the computation time for object creation. This may be an</span>
<span class="sd">        unnecessary optimization.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_convert_parameters_static</span><span class="p">(</span>
                                    <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
        
        <span class="n">c1</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">c2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c4</span> <span class="o">=</span> <span class="n">routeChoiceParameters</span>
        
        <span class="n">kMatrix</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_get_k_value_static</span><span class="p">(</span>
                    <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
        
        
        <span class="n">kMatrix</span> <span class="o">=</span> <span class="n">kMatrix</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> 
        <span class="n">k</span> <span class="o">=</span> <span class="n">kMatrix</span><span class="p">[</span><span class="n">pairIndices</span><span class="p">]</span>
        
        
        <span class="n">aq</span> <span class="o">=</span> <span class="n">routeProbabilities</span> <span class="o">*</span> <span class="n">p_shift</span> <span class="o">*</span> <span class="n">c1</span>
        <span class="n">qqm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="o">+</span><span class="n">aq</span><span class="p">)</span> 
        
        <span class="c1"># Liekelihood associated with observations &gt; 0 on expected routes</span>
        <span class="n">likelihoodOnWays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nbinom</span><span class="o">.</span><span class="n">logpmf</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">qqm</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stPairIndices</span><span class="p">,</span> <span class="n">sRP</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">itercount</span><span class="p">(),</span>
                                         <span class="n">stationPairIndices</span><span class="p">,</span> 
                                         <span class="n">stationRouteProbabilities</span><span class="p">):</span>
            <span class="n">qr</span> <span class="o">=</span> <span class="n">sRP</span> <span class="o">*</span> <span class="n">c1</span>
            <span class="n">ks</span> <span class="o">=</span> <span class="n">kMatrix</span><span class="p">[</span><span class="n">stPairIndices</span><span class="p">]</span>
            <span class="n">x4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_shift_mean</span> <span class="o">*</span> <span class="n">qr</span><span class="p">)</span>
            <span class="n">x4</span> <span class="o">*=</span> <span class="n">ks</span>
            <span class="n">stationKs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            
            <span class="n">tmpFact</span> <span class="o">=</span> <span class="o">-</span><span class="n">qr</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span> <span class="o">+</span> <span class="n">qr</span><span class="o">*</span><span class="n">p_shift_mean</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmpFact</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">stationKs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="n">ks</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">approximationNumber</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">*=</span> <span class="n">tmpFact</span>
                <span class="n">stationKs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="n">ks</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">kSumNotObserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">shiftP_shiftAppr</span> <span class="o">=</span> <span class="n">shiftDataP_shift</span> <span class="o">-</span> <span class="n">p_shift_mean</span>
        <span class="n">p_shiftAppr</span> <span class="o">=</span> <span class="n">p_shift</span> <span class="o">-</span> <span class="n">p_shift_mean</span>
        
        <span class="c1"># Likelihood associated with obervations = 0 on expected routes</span>
        <span class="c1"># (here: assume all observations have been 0)</span>
        <span class="n">likelihoodNotObservedOnWays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stationKs</span><span class="p">[</span><span class="n">stationIndices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Compute the share of likelihoodNotObservedOnWays that is wrong, </span>
        <span class="c1"># because we actually observed something</span>
        <span class="n">qr</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">routeProbabilities</span>
        <span class="n">likelihoodNotObservedOnWaysNeg</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span>
                                          <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">qr</span><span class="o">*</span><span class="n">p_shift_mean</span><span class="p">))</span>
                                          <span class="p">)</span>
        
        <span class="c1">#print(&quot;np.isfinite(likelihoodNotObservedOnWaysNeg).all()&quot;, np.isfinite(likelihoodNotObservedOnWaysNeg).all())</span>
        
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">approximationNumber</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">likelihoodNotObservedOnWays</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">shiftP_shiftAppr</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span><span class="o">*</span><span class="n">stationKs</span><span class="p">[</span><span class="n">stationIndices</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> 
                <span class="o">/</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span>
                <span class="p">)</span>
            <span class="n">likelihoodNotObservedOnWaysNeg</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="o">-</span><span class="n">qr</span><span class="o">*</span><span class="n">p_shiftAppr</span>
                                                       <span class="o">/</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span>
                                                          <span class="o">+</span><span class="n">qr</span><span class="o">*</span><span class="n">p_shift_mean</span><span class="p">),</span> 
                                                       <span class="n">j</span><span class="p">)</span> <span class="o">/</span> <span class="n">j</span>
        <span class="n">likelihoodNotObservedOnWaysNeg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                                        <span class="n">k</span><span class="o">*</span><span class="n">likelihoodNotObservedOnWaysNeg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">likelihoodNotObservedOnWays</span> <span class="o">-=</span> <span class="n">likelihoodNotObservedOnWaysNeg</span>
        
        
        <span class="c1"># Likelihood associated with observations = 0 on not expected</span>
        <span class="c1"># routes (assume first that all pairs have no route via this spot)</span>
        <span class="n">aq</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2</span> <span class="o">*</span> <span class="n">c4</span> <span class="o">*</span> <span class="n">c1</span><span class="p">)</span> <span class="o">*</span> <span class="n">shiftDataP_shift</span>
        <span class="n">qq2ml</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="o">+</span><span class="n">aq</span><span class="p">)</span>
        <span class="n">likelihoodRestWays</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">qq2ml</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kMatrix</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
                              <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">qq2ml</span><span class="o">*</span><span class="n">kSumNotObserved</span><span class="p">[</span><span class="n">stationIndices</span><span class="p">],</span>
                                       <span class="mi">0</span><span class="p">))</span>
        
        
        <span class="n">aq</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2</span> <span class="o">*</span> <span class="n">c4</span> <span class="o">*</span> <span class="n">c1</span><span class="p">)</span> <span class="o">*</span> <span class="n">observedNoiseP_shift</span>
        <span class="n">qq3m</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="o">+</span><span class="n">aq</span><span class="p">)</span>  
        <span class="n">k2</span> <span class="o">=</span> <span class="n">kMatrix</span><span class="p">[</span><span class="n">observedNoisePairs</span><span class="p">]</span>
        <span class="n">likelihoodFalseWays</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nbinom</span><span class="o">.</span><span class="n">logpmf</span><span class="p">(</span><span class="n">observedNoiseCounts</span><span class="p">,</span>
                                       <span class="n">k2</span><span class="p">,</span> <span class="n">qq3m</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">likelihoodRestWays</span> <span class="o">-=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">qq3m</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">likelihoodOnWays</span> <span class="o">-</span> <span class="n">likelihoodRestWays</span> 
                  <span class="o">-</span> <span class="n">likelihoodFalseWays</span> <span class="o">-</span> <span class="n">likelihoodNotObservedOnWays</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="p">)):</span> 
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span> 
        
        <span class="k">return</span> <span class="n">result</span>
    
    <span class="nd">@staticmethod_inherit_doc</span><span class="p">(</span><span class="n">_negLogLikelihood</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_negLogLikelihood_autograd</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">routeChoiceParameters</span><span class="p">,</span>
                                   <span class="n">considered</span><span class="p">,</span> <span class="n">pairIndices</span><span class="p">,</span> 
                                   <span class="n">stationPairIndices</span><span class="p">,</span> <span class="n">observedNoisePairs</span><span class="p">,</span>
                                   <span class="n">routeProbabilities</span><span class="p">,</span> 
                                   <span class="n">stationRouteProbabilities</span><span class="p">,</span>
                                   <span class="n">stationIndices</span><span class="p">,</span>
                                   <span class="n">p_shift</span><span class="p">,</span> <span class="n">shiftDataP_shift</span><span class="p">,</span> 
                                   <span class="n">observedNoiseP_shift</span><span class="p">,</span> 
                                   <span class="n">p_shift_mean</span><span class="p">,</span> <span class="n">stationNumber</span><span class="p">,</span> 
                                   <span class="n">approximationNumber</span><span class="p">,</span>
                                   <span class="n">counts</span><span class="p">,</span> <span class="n">observedNoiseCounts</span><span class="p">,</span> 
                                   <span class="n">trafficFactorModel</span><span class="p">,</span> 
                                   <span class="n">convertParameters</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> 
        <span class="sd">&quot;&quot;&quot;Returns the negative log-likelihood of the model, thereby using the</span>
<span class="sd">        functions provided by :py:mod:`autograd`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">log</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">log</span>
        
        <span class="k">if</span> <span class="n">convertParameters</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_convert_parameters_static</span><span class="p">(</span>
                                <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span>
        
        <span class="n">c1</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">c2</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">c4</span> <span class="o">=</span> <span class="n">routeChoiceParameters</span>
            
        <span class="n">kMatrix</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_get_k_value_autograd_static</span><span class="p">(</span>
                    <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
        
        <span class="n">kMatrix</span> <span class="o">=</span> <span class="n">kMatrix</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">kMatrix</span><span class="o">.</span><span class="n">size</span><span class="p">,))</span> 
        
        <span class="n">k</span> <span class="o">=</span> <span class="n">kMatrix</span><span class="p">[</span><span class="n">pairIndices</span><span class="p">]</span>
        
        <span class="n">aq</span> <span class="o">=</span> <span class="n">routeProbabilities</span> <span class="o">*</span> <span class="n">p_shift</span> <span class="o">*</span> <span class="n">c1</span>
        <span class="n">qqm</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="o">+</span><span class="n">aq</span><span class="p">)</span> <span class="c1"># = 1-aq/(1-c1+aq)</span>
        
        <span class="n">stationKs</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">stationNumber</span><span class="p">,</span> <span class="n">approximationNumber</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> 
                             <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c1</span><span class="p">,</span> <span class="n">ag</span><span class="o">.</span><span class="n">float</span><span class="p">):</span>
            <span class="n">kSumNotObserved</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stationNumber</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">kSumNotObserved</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stationNumber</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;object&quot;</span><span class="p">)</span>
            <span class="c1">#kSumNotObserved = AutogradStorage(stationNumber) #ag.zeros(stationNumber, dtype=&quot;object&quot;)</span>
        
        <span class="c1"># Liekelihood associated with observations &gt; 0 on expected routes</span>
        <span class="n">likelihoodOnWays</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nbinom_logpmf</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">qqm</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stPairIndices</span><span class="p">,</span> <span class="n">sRP</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">itercount</span><span class="p">(),</span>
                                                 <span class="n">stationPairIndices</span><span class="p">,</span> 
                                                 <span class="n">stationRouteProbabilities</span><span class="p">):</span>
            <span class="n">qr</span> <span class="o">=</span> <span class="n">sRP</span> <span class="o">*</span> <span class="n">c1</span>
            
            <span class="n">ks</span> <span class="o">=</span> <span class="n">kMatrix</span><span class="p">[</span><span class="n">stPairIndices</span><span class="p">]</span>
            <span class="n">x4</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">-</span><span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span> <span class="o">+</span> <span class="n">p_shift_mean</span> <span class="o">*</span> <span class="n">qr</span><span class="p">)</span>
            <span class="n">x4</span> <span class="o">*=</span> <span class="n">ks</span>
            <span class="n">stationKs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x4</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">tmpFact</span> <span class="o">=</span> <span class="o">-</span><span class="n">qr</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span> <span class="o">+</span> <span class="n">qr</span><span class="o">*</span><span class="n">p_shift_mean</span><span class="p">)</span>
            <span class="n">tmp</span> <span class="o">=</span> <span class="n">tmpFact</span> <span class="o">+</span> <span class="mi">0</span>
            <span class="n">stationKs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="n">ks</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">approximationNumber</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">tmp</span> <span class="o">*=</span> <span class="n">tmpFact</span>
                <span class="n">stationKs</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="n">ks</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">kSumNotObserved</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ks</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">shiftP_shiftAppr</span> <span class="o">=</span> <span class="n">shiftDataP_shift</span> <span class="o">-</span> <span class="n">p_shift_mean</span>
        <span class="n">p_shiftAppr</span> <span class="o">=</span> <span class="n">p_shift</span> <span class="o">-</span> <span class="n">p_shift_mean</span>
        
        <span class="c1"># Likelihood associated with obervations = 0 on expected routes</span>
        <span class="c1"># (here: assume all observations have been 0)</span>
        <span class="n">likelihoodNotObservedOnWays</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">stationKs</span><span class="p">[</span><span class="n">stationIndices</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># Compute the share of likelihoodNotObservedOnWays that is wrong, </span>
        <span class="c1"># because we actually observed something</span>
        <span class="n">qr</span> <span class="o">=</span> <span class="n">c1</span> <span class="o">*</span> <span class="n">routeProbabilities</span>
        <span class="n">likelihoodNotObservedOnWaysNeg</span> <span class="o">=</span> <span class="p">(</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span>
                                          <span class="o">-</span> <span class="n">log</span><span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">+</span><span class="p">(</span><span class="n">qr</span><span class="o">*</span><span class="n">p_shift_mean</span><span class="p">))</span>
                                          <span class="p">)</span>
        
        <span class="n">likelihoodNotObservedOnWays</span> <span class="o">+=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">shiftP_shiftAppr</span>
                                              <span class="o">*</span><span class="n">stationKs</span><span class="p">[</span><span class="n">stationIndices</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">likelihoodNotObservedOnWaysNegTmp</span> <span class="o">=</span> <span class="o">-</span><span class="n">qr</span><span class="o">*</span><span class="n">p_shiftAppr</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span>
                                                               <span class="o">+</span> <span class="n">qr</span><span class="o">*</span><span class="n">p_shift_mean</span><span class="p">)</span>
        <span class="n">likelihoodNotObservedOnWaysNeg</span> <span class="o">+=</span> <span class="n">likelihoodNotObservedOnWaysNegTmp</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">approximationNumber</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">shiftP_shiftAppr</span> <span class="o">*=</span> <span class="n">shiftP_shiftAppr</span>
            <span class="n">likelihoodNotObservedOnWays</span> <span class="o">+=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span>
                <span class="n">shiftP_shiftAppr</span><span class="o">*</span><span class="n">stationKs</span><span class="p">[</span><span class="n">stationIndices</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> 
                <span class="o">/</span> <span class="n">j</span><span class="p">,</span> <span class="mi">0</span>
                <span class="p">)</span>
            <span class="n">likelihoodNotObservedOnWaysNegTmp</span> <span class="o">*=</span> <span class="n">likelihoodNotObservedOnWaysNegTmp</span>
            <span class="n">likelihoodNotObservedOnWaysNeg</span> <span class="o">+=</span> <span class="n">likelihoodNotObservedOnWaysNegTmp</span> <span class="o">/</span> <span class="n">j</span>
        <span class="n">likelihoodNotObservedOnWaysNeg</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">likelihoodNotObservedOnWaysNeg</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">likelihoodNotObservedOnWays</span> <span class="o">-=</span> <span class="n">likelihoodNotObservedOnWaysNeg</span>
        
        
        <span class="c1"># Likelihood associated with observations = 0 on not expected</span>
        <span class="c1"># routes (assume first that all pairs have no route via this spot)</span>
        <span class="n">aq</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2</span> <span class="o">*</span> <span class="n">c4</span> <span class="o">*</span> <span class="n">c1</span><span class="p">)</span> <span class="o">*</span> <span class="n">shiftDataP_shift</span>
        <span class="n">qq2ml</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span> <span class="o">-</span> <span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="o">+</span><span class="n">aq</span><span class="p">)</span>
        
        <span class="n">prd</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">I</span><span class="p">,</span> <span class="n">K</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stationIndices</span><span class="p">):</span>
            <span class="n">prd</span> <span class="o">=</span> <span class="n">prd</span> <span class="o">+</span> <span class="n">qq2ml</span><span class="p">[</span><span class="n">I</span><span class="p">]</span> <span class="o">*</span> <span class="n">kSumNotObserved</span><span class="p">[</span><span class="n">K</span><span class="p">]</span>
            <span class="c1">#prd = prd + kSumNotObserved[K]</span>
            
        <span class="n">likelihoodRestWays</span> <span class="o">=</span> <span class="p">(</span><span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">qq2ml</span><span class="p">)</span> <span class="o">*</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kMatrix</span><span class="p">)</span> <span class="c1"># * shiftNumber </span>
                              <span class="o">-</span> <span class="n">prd</span><span class="p">)</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        likelihoodRestWays = (ag.sum(qq2ml) * ag.sum(kMatrix, 0) # * shiftNumber </span>
<span class="sd">                              - ag.sum(qq2ml*kSumNotObserved[stationIndices],</span>
<span class="sd">                                       0))</span>
<span class="sd">        if type(kSumNotObserved) == AutogradStorage:</span>
<span class="sd">            kSumNotObserved = kSumNotObserved.data #to_autograd_array(kSumNotObserved)</span>
<span class="sd">        likelihoodRestWays = (ag.sum(qq2ml) * ag.sum(kMatrix, 0) # * shiftNumber </span>
<span class="sd">                              #- ag.sum(kSumNotObserved*qq2ml[0]))</span>
<span class="sd">                              - sum(qq2ml*kSumNotObserved[stationIndices]))</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">aq</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2</span> <span class="o">*</span> <span class="n">c4</span> <span class="o">*</span> <span class="n">c1</span><span class="p">)</span> <span class="o">*</span> <span class="n">observedNoiseP_shift</span>
        <span class="n">qq3m</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c1</span><span class="o">+</span><span class="n">aq</span><span class="p">)</span>  
        <span class="n">k2</span> <span class="o">=</span> <span class="n">kMatrix</span><span class="p">[</span><span class="n">observedNoisePairs</span><span class="p">]</span>
        <span class="n">likelihoodFalseWays</span> <span class="o">=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nbinom_logpmf</span><span class="p">(</span><span class="n">observedNoiseCounts</span><span class="p">,</span>
                                       <span class="n">k2</span><span class="p">,</span> <span class="n">qq3m</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">likelihoodRestWays</span> <span class="o">-=</span> <span class="n">ag</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">k2</span> <span class="o">*</span> <span class="n">log</span><span class="p">(</span><span class="n">qq3m</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span> <span class="n">likelihoodOnWays</span> <span class="o">-</span> <span class="n">likelihoodRestWays</span> 
                  <span class="o">-</span> <span class="n">likelihoodFalseWays</span> <span class="o">-</span> <span class="n">likelihoodNotObservedOnWays</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">ag</span><span class="o">.</span><span class="n">float</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ag</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">result</span><span class="p">):</span> 
            <span class="k">return</span> <span class="n">ag</span><span class="o">.</span><span class="n">inf</span> 
        
        <span class="k">return</span> <span class="n">result</span>

    <span class="nd">@staticmethod_inherit_doc</span><span class="p">(</span><span class="n">_negLogLikelihood</span><span class="p">,</span> <span class="n">set_compliance_rate</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_nLL_funs</span><span class="p">(</span><span class="n">processedSurveyData</span><span class="p">,</span> <span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">,</span>
                      <span class="n">routeChoiceParameters</span><span class="p">,</span> <span class="n">complianceRate</span><span class="p">,</span> <span class="n">properDataRate</span><span class="p">,</span>
                      <span class="n">considered</span><span class="p">,</span> <span class="n">approximationNumber</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the model&#39;s negative log-likelihood function and its </span>
<span class="sd">        derivatives.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        processedSurveyData : dict</span>
<span class="sd">            Processed survey data, which are computed with :py:meth:`preprocess_survey_data`</span>
<span class="sd">        lengthsOfPotentialRoutes : :py:class:`csr_matrix_nd &lt;vemomoto_core.npcollections.npext.csr_matrix_nd&gt;`</span>
<span class="sd">            For each origin-destination pair the lengths of all potential</span>
<span class="sd">            (i.e. admissible) agent routes.</span>
<span class="sd">        properDataRate : float</span>
<span class="sd">            Fraction of agents providing inconsistent, incomplete, or wrong</span>
<span class="sd">            data.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">considered</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">considered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        
        <span class="n">fullCountData</span> <span class="o">=</span> <span class="n">processedSurveyData</span><span class="p">[</span><span class="s2">&quot;fullCountData&quot;</span><span class="p">]</span>
        <span class="n">consideredPathLengths</span> <span class="o">=</span> <span class="n">processedSurveyData</span><span class="p">[</span><span class="s2">&quot;consideredPathLengths&quot;</span><span class="p">]</span> 
        <span class="n">observedNoiseData</span> <span class="o">=</span> <span class="n">processedSurveyData</span><span class="p">[</span><span class="s2">&quot;observedNoiseData&quot;</span><span class="p">]</span> 
        <span class="n">shiftDataP_shift</span> <span class="o">=</span> <span class="n">processedSurveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">][</span><span class="s2">&quot;p_shift&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">complianceRate</span> <span class="o">*</span> <span class="n">properDataRate</span>
        <span class="n">stationIndices</span> <span class="o">=</span> <span class="n">processedSurveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">][</span><span class="s2">&quot;usedStationIndex&quot;</span><span class="p">]</span>
        <span class="n">stationPathLengths</span> <span class="o">=</span> <span class="n">processedSurveyData</span><span class="p">[</span><span class="s2">&quot;stationData&quot;</span><span class="p">][</span>
                                                        <span class="s2">&quot;consideredPathLengths&quot;</span><span class="p">]</span>
        <span class="n">stationPairIndices</span> <span class="o">=</span> <span class="n">processedSurveyData</span><span class="p">[</span><span class="s2">&quot;stationData&quot;</span><span class="p">][</span><span class="s2">&quot;pairIndices&quot;</span><span class="p">]</span>
        
        <span class="n">p_shift</span> <span class="o">=</span> <span class="n">fullCountData</span><span class="p">[</span><span class="s2">&quot;p_shift&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">complianceRate</span> <span class="o">*</span> <span class="n">properDataRate</span>
        <span class="n">pairIndices</span> <span class="o">=</span> <span class="n">fullCountData</span><span class="p">[</span><span class="s2">&quot;pairIndex&quot;</span><span class="p">]</span>
        <span class="n">counts</span> <span class="o">=</span> <span class="n">fullCountData</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
        <span class="n">routeLengths</span> <span class="o">=</span> <span class="n">lengthsOfPotentialRoutes</span><span class="o">.</span><span class="n">data</span>
        
        <span class="n">observedNoiseP_shift</span> <span class="o">=</span> <span class="n">observedNoiseData</span><span class="p">[</span><span class="s2">&quot;p_shift&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">complianceRate</span> <span class="o">*</span> <span class="n">properDataRate</span>
        <span class="n">observedNoiseCounts</span> <span class="o">=</span> <span class="n">observedNoiseData</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span>
        <span class="n">observedNoisePairs</span> <span class="o">=</span> <span class="n">observedNoiseData</span><span class="p">[</span><span class="s2">&quot;pairIndex&quot;</span><span class="p">]</span>
        <span class="n">p_shift_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">shiftDataP_shift</span><span class="p">)</span>
        <span class="n">stationNumber</span> <span class="o">=</span> <span class="n">stationPairIndices</span><span class="o">.</span><span class="n">size</span>
        <span class="n">stationKs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">stationNumber</span><span class="p">,</span> <span class="n">approximationNumber</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">kSumNotObserved</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">stationNumber</span><span class="p">)</span>
        
        <span class="n">_negLogLikelihood</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_negLogLikelihood</span>
        <span class="n">_negLogLikelihood_autograd</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_negLogLikelihood_autograd</span>
        
        
        <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span> <span class="o">=</span> <span class="n">routeChoiceParameters</span>
        
        <span class="n">normConstants</span> <span class="o">=</span> <span class="n">sparsepowersum</span><span class="p">(</span><span class="n">routeLengths</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span>
        <span class="n">routeProbabilities</span> <span class="o">=</span> <span class="n">sparsepowersum</span><span class="p">(</span><span class="n">consideredPathLengths</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span>
        <span class="n">routeProbabilities</span> <span class="o">=</span> <span class="p">(</span><span class="n">routeProbabilities</span> 
                              <span class="o">/</span> <span class="n">normConstants</span><span class="p">[</span><span class="n">pairIndices</span><span class="p">]</span>  
                              <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span> <span class="o">+</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">c4</span><span class="p">)</span>
        
        <span class="n">stationRouteProbabilities</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">stPairIndices</span><span class="p">,</span> <span class="n">pathLengths</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stationPairIndices</span><span class="p">,</span> 
                                              <span class="n">stationPathLengths</span><span class="p">):</span>
            <span class="n">x1</span> <span class="o">=</span> <span class="n">sparsepowersum</span><span class="p">(</span><span class="n">pathLengths</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span>
            <span class="n">x2</span> <span class="o">=</span> <span class="n">normConstants</span><span class="p">[</span><span class="n">stPairIndices</span><span class="p">]</span>
            <span class="n">stationRouteProbabilities</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">,</span> <span class="n">x2</span><span class="p">),</span> 
                                   <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c2</span><span class="p">),</span> <span class="n">x2</span><span class="p">),</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">c4</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
                <span class="p">)</span>
        
        
        <span class="k">def</span> <span class="nf">negLogLikelihood</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span> 
            <span class="k">return</span> <span class="n">_negLogLikelihood</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">routeChoiceParameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> 
                   <span class="n">pairIndices</span><span class="p">,</span> <span class="n">stationPairIndices</span><span class="p">,</span> 
                   <span class="n">observedNoisePairs</span><span class="p">,</span> <span class="n">routeProbabilities</span><span class="p">,</span> 
                   <span class="n">stationRouteProbabilities</span><span class="p">,</span> <span class="n">stationIndices</span><span class="p">,</span> <span class="n">p_shift</span><span class="p">,</span> 
                   <span class="n">shiftDataP_shift</span><span class="p">,</span> <span class="n">observedNoiseP_shift</span><span class="p">,</span> <span class="n">p_shift_mean</span><span class="p">,</span> 
                   <span class="n">stationKs</span><span class="p">,</span> <span class="n">kSumNotObserved</span><span class="p">,</span> 
                   <span class="n">approximationNumber</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> <span class="n">observedNoiseCounts</span><span class="p">,</span> 
                   <span class="n">trafficFactorModel</span><span class="p">)</span>
        
        <span class="k">def</span> <span class="nf">negLogLikelihood_autograd</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">convertParameters</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_negLogLikelihood_autograd</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">routeChoiceParameters</span><span class="p">,</span>
                   <span class="n">considered</span><span class="p">,</span> <span class="n">pairIndices</span><span class="p">,</span> <span class="n">stationPairIndices</span><span class="p">,</span> 
                   <span class="n">observedNoisePairs</span><span class="p">,</span> <span class="n">routeProbabilities</span><span class="p">,</span> 
                   <span class="n">stationRouteProbabilities</span><span class="p">,</span> <span class="n">stationIndices</span><span class="p">,</span> <span class="n">p_shift</span><span class="p">,</span> 
                   <span class="n">shiftDataP_shift</span><span class="p">,</span> <span class="n">observedNoiseP_shift</span><span class="p">,</span> <span class="n">p_shift_mean</span><span class="p">,</span> 
                   <span class="n">stationNumber</span><span class="p">,</span> <span class="n">approximationNumber</span><span class="p">,</span> <span class="n">counts</span><span class="p">,</span> 
                   <span class="n">observedNoiseCounts</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">,</span>
                   <span class="n">convertParameters</span><span class="o">=</span><span class="n">convertParameters</span><span class="p">)</span>
        
        <span class="n">jac</span> <span class="o">=</span> <span class="n">grad</span><span class="p">(</span><span class="n">negLogLikelihood_autograd</span><span class="p">)</span>
        <span class="n">hess</span> <span class="o">=</span> <span class="n">hessian</span><span class="p">(</span><span class="n">negLogLikelihood_autograd</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">negLogLikelihood</span><span class="p">,</span> <span class="n">negLogLikelihood_autograd</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="kc">None</span>
    
<div class="viewcode-block" id="HybridVectorModel.maximize_log_likelihood_static"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.maximize_log_likelihood_static">[docs]</a>    <span class="nd">@staticmethod_inherit_doc</span><span class="p">(</span><span class="n">_get_nLL_funs</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">maximize_log_likelihood_static</span><span class="p">(</span><span class="n">processedSurveyData</span><span class="p">,</span> 
                                       <span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span>
                                       <span class="n">trafficFactorModel</span><span class="p">,</span>
                                       <span class="n">routeChoiceParameters</span><span class="p">,</span>
                                       <span class="n">complianceRate</span><span class="p">,</span>
                                       <span class="n">properDataRate</span><span class="p">,</span>
                                       <span class="n">considered</span><span class="p">,</span> 
                                       <span class="n">approximationNumber</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                       <span class="n">flowParameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                       <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Maximizes the likelihood of the hybrid model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        flowParameters : float[]</span>
<span class="sd">            If given, a model with these parameters will be used and assumed</span>
<span class="sd">            as being the best-fitting model.</span>
<span class="sd">        x0 : float[]</span>
<span class="sd">            Will be used as initial guess if given and if</span>
<span class="sd">            :py:obj:`flowParameters` is not given.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="n">negLogLikelihood</span><span class="p">,</span> <span class="n">negLogLikelihood_autograd</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">hessp</span> <span class="o">=</span> \
                <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_get_nLL_funs</span><span class="p">(</span><span class="n">processedSurveyData</span><span class="p">,</span> 
                                                <span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span> 
                                                      <span class="n">trafficFactorModel</span><span class="p">,</span> 
                                                      <span class="n">routeChoiceParameters</span><span class="p">,</span>
                                                      <span class="n">complianceRate</span><span class="p">,</span>
                                                      <span class="n">properDataRate</span><span class="p">,</span>
                                                      <span class="n">considered</span><span class="p">,</span> 
                                                      <span class="n">approximationNumber</span><span class="p">)</span>
        
        
        <span class="k">if</span> <span class="n">flowParameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">15</span><span class="p">,</span> <span class="mi">15</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)]</span>
            
            <span class="n">considered</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">trafficFactorModel</span><span class="o">.</span><span class="n">BOUNDS</span><span class="p">[</span><span class="n">considered</span><span class="p">[</span><span class="mi">2</span><span class="p">:]]:</span>
                <span class="n">bounds</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">tuple</span><span class="p">(</span><span class="n">bound</span><span class="p">))</span>
                
            <span class="k">if</span> <span class="n">x0</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">()</span>
                
                <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">considered</span><span class="p">))</span>
                <span class="n">negLogLikelihood</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
                <span class="n">negLogLikelihood_autograd</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
                
                <span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">negLogLikelihood</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> 
                                                   <span class="n">popsize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="c1">#300, </span>
                                                   <span class="c1">#popsize=20, maxiter=2, </span>
                                                   <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">considered</span><span class="p">)</span>          
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;GA result&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">result</span><span class="o">.</span><span class="n">xOriginal</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_convert_parameters_static</span><span class="p">(</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">jacOriginal</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">xOriginal</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> 
                                           <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                           <span class="n">fun</span><span class="o">=</span><span class="n">negLogLikelihood</span><span class="p">(</span><span class="n">x0</span><span class="p">),</span> 
                                           <span class="n">nfev</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                           <span class="n">nhev</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">nit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                           <span class="n">message</span><span class="o">=</span><span class="s2">&quot;parameters checked&quot;</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">xOriginal</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_convert_parameters_static</span><span class="p">(</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
                <span class="n">result</span><span class="o">.</span><span class="n">jacOriginal</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">xOriginal</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
            
            
            <span class="nb">print</span><span class="p">(</span><span class="n">negLogLikelihood</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">negLogLikelihood_autograd</span><span class="p">(</span><span class="n">x0</span><span class="p">))</span>
            
            <span class="n">result2</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">negLogLikelihood_autograd</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span>
                                  <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="o">=</span><span class="n">hess</span><span class="p">,</span>
                                  <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span><span class="mi">800</span><span class="p">,</span>
                                                        <span class="s2">&quot;iprint&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">})</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">considered</span><span class="p">)</span>          
            <span class="n">result2</span><span class="o">.</span><span class="n">xOriginal</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_convert_parameters_static</span><span class="p">(</span>
                    <span class="n">result2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
            <span class="n">result2</span><span class="o">.</span><span class="n">jacOriginal</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">result2</span><span class="o">.</span><span class="n">xOriginal</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;L-BFGS-B&quot;</span><span class="p">,</span> <span class="n">result2</span><span class="p">)</span>
            
            <span class="c1">#if result2.fun &lt; result.fun:</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">result2</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result2</span>
            
            <span class="n">result2</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">negLogLikelihood_autograd</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">,</span> 
                                  <span class="n">hess</span><span class="o">=</span><span class="n">hess</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                  <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span><span class="mi">800</span><span class="p">,</span> 
                                           <span class="s2">&quot;iprint&quot;</span><span class="p">:</span><span class="mi">2</span><span class="p">},</span>
                                  <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">considered</span><span class="p">)</span>          
            <span class="n">result2</span><span class="o">.</span><span class="n">xOriginal</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_convert_parameters_static</span><span class="p">(</span>
                    <span class="n">result2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
            <span class="n">result2</span><span class="o">.</span><span class="n">jacOriginal</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">result2</span><span class="o">.</span><span class="n">xOriginal</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span> <span class="n">result2</span><span class="p">)</span>         
            <span class="k">if</span> <span class="n">result2</span><span class="o">.</span><span class="n">fun</span> <span class="o">&lt;</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">:</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="n">result2</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result2</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="n">result2</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">negLogLikelihood_autograd</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">,</span> 
                                      <span class="n">hess</span><span class="o">=</span><span class="n">hess</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                      <span class="n">method</span><span class="o">=</span><span class="s2">&quot;trust-exact&quot;</span><span class="p">,</span>
                                      <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span><span class="mi">500</span><span class="p">,</span> 
                                               <span class="s2">&quot;disp&quot;</span><span class="p">:</span><span class="kc">True</span><span class="p">})</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()</span>
                <span class="n">traceback</span><span class="o">.</span><span class="n">print_exception</span><span class="p">(</span><span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">exc_traceback</span><span class="p">,</span>
                                          <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
                <span class="n">result2</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> 
                                            <span class="n">success</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                            <span class="n">fun</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> 
                                            <span class="n">message</span><span class="o">=</span><span class="s2">&quot;ValueError thrown&quot;</span><span class="p">)</span>
                
            <span class="nb">print</span><span class="p">(</span><span class="n">considered</span><span class="p">)</span>          
            <span class="n">result2</span><span class="o">.</span><span class="n">xOriginal</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_convert_parameters_static</span><span class="p">(</span>
                    <span class="n">result2</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
            <span class="n">result2</span><span class="o">.</span><span class="n">jacOriginal</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">result2</span><span class="o">.</span><span class="n">xOriginal</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trust-exact&quot;</span><span class="p">,</span> <span class="n">result2</span><span class="p">)</span>         
            <span class="k">if</span> <span class="n">result2</span><span class="o">.</span><span class="n">fun</span> <span class="o">&lt;</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="n">result2</span>
            
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">OptimizeResult</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">flowParameters</span><span class="p">,</span> 
                                       <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                       <span class="n">fun</span><span class="o">=</span><span class="n">negLogLikelihood</span><span class="p">(</span><span class="n">flowParameters</span><span class="p">),</span> 
                                       <span class="n">jac</span><span class="o">=</span><span class="n">jac</span><span class="p">(</span><span class="n">flowParameters</span><span class="p">),</span> 
                                       <span class="n">nfev</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">njev</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                       <span class="n">nhev</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nit</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                       <span class="n">message</span><span class="o">=</span><span class="s2">&quot;parameters checked&quot;</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">xOriginal</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_convert_parameters_static</span><span class="p">(</span>
                <span class="n">flowParameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">jacOriginal</span> <span class="o">=</span> <span class="n">jac</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">xOriginal</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            
            <span class="n">checkParametersO</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_convert_parameters_static</span><span class="p">(</span>
                <span class="n">flowParameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.maximize_log_likelihood"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.maximize_log_likelihood">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">maximize_log_likelihood_static</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">maximize_log_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">considered</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">approximationNumber</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                <span class="n">flowParameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;# Maximizes the likelihood of the hybrid model&quot;&quot;&quot;</span>
        <span class="n">routeChoiceParameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">parameters</span>
        
        <span class="k">return</span> <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">maximize_log_likelihood_static</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">processedSurveyData</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trafficFactorModel</span><span class="p">,</span> <span class="n">routeChoiceParameters</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properDataRate</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span> 
                <span class="n">approximationNumber</span><span class="p">,</span> <span class="n">flowParameters</span><span class="p">,</span> <span class="n">x0</span><span class="p">)</span></div>
    
    
    <span class="nd">@staticmethod_inherit_doc</span><span class="p">(</span><span class="n">_get_nLL_funs</span><span class="p">,</span> <span class="n">find_profile_CI_bound</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_find_profile_CI_static</span><span class="p">(</span><span class="n">processedSurveyData</span><span class="p">,</span> <span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span> 
                                <span class="n">trafficFactorModel</span><span class="p">,</span> <span class="n">routeChoiceParameters</span><span class="p">,</span>
                                <span class="n">complianceRate</span><span class="p">,</span>
                                <span class="n">properDataRate</span><span class="p">,</span>
                                <span class="n">considered</span><span class="p">,</span> 
                                <span class="n">index</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span>
                                <span class="n">approximationNumber</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> 
                                <span class="n">profile_LL_args</span><span class="o">=</span><span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot;Searches the profile likelihood confidence interval for a given</span>
<span class="sd">        parameter.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        profile_LL_args : dict</span>
<span class="sd">            Keyword arguments to be passed to :py:meth:`find_profile_CI_bound`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">negLogLikelihood</span><span class="p">,</span> <span class="n">negLogLikelihood_autograd</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">hessp</span> <span class="o">=</span> \
                <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_get_nLL_funs</span><span class="p">(</span><span class="n">processedSurveyData</span><span class="p">,</span> 
                                                <span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span> 
                                                      <span class="n">trafficFactorModel</span><span class="p">,</span> 
                                                      <span class="n">routeChoiceParameters</span><span class="p">,</span>
                                                      <span class="n">complianceRate</span><span class="p">,</span>
                                                      <span class="n">properDataRate</span><span class="p">,</span>
                                                      <span class="n">considered</span><span class="p">,</span> 
                                                      <span class="n">approximationNumber</span><span class="p">)</span> 
        
        <span class="n">negLogLikelihood_autograd_</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">negLogLikelihood_autograd</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   
        <span class="n">jac_</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">jac</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   
        <span class="n">hess_</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">hess</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>   
        
        <span class="k">return</span> <span class="n">find_profile_CI_bound</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">negLogLikelihood_autograd_</span><span class="p">,</span> <span class="n">jac_</span><span class="p">,</span> <span class="n">hess_</span><span class="p">,</span> 
                                     <span class="o">**</span><span class="n">profile_LL_args</span><span class="p">)</span>
    
    
<div class="viewcode-block" id="HybridVectorModel.investigate_profile_likelihood"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.investigate_profile_likelihood">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">_find_profile_CI_static</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">investigate_profile_likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">processedSurveyData</span><span class="p">,</span> 
                                       <span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span> 
                                       <span class="n">trafficFactorModel</span><span class="p">,</span> <span class="n">routeChoiceParameters</span><span class="p">,</span>
                                       <span class="n">complianceRate</span><span class="p">,</span>
                                       <span class="n">properDataRate</span><span class="p">,</span>
                                       <span class="n">considered</span><span class="p">,</span> 
                                       <span class="n">approximationNumber</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                       <span class="o">**</span><span class="n">profile_LL_args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;# Searches the profile likelihood confidence interval for a given</span>
<span class="sd">        parameter.&quot;&quot;&quot;</span>
        
        <span class="n">negLogLikelihood</span><span class="p">,</span> <span class="n">negLogLikelihood_autograd</span><span class="p">,</span> <span class="n">jac</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">hessp</span> <span class="o">=</span> \
                <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_get_nLL_funs</span><span class="p">(</span><span class="n">processedSurveyData</span><span class="p">,</span> 
                                                <span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span> 
                                                      <span class="n">trafficFactorModel</span><span class="p">,</span> 
                                                      <span class="n">routeChoiceParameters</span><span class="p">,</span>
                                                      <span class="n">complianceRate</span><span class="p">,</span>
                                                      <span class="n">properDataRate</span><span class="p">,</span>
                                                      <span class="n">considered</span><span class="p">,</span> 
                                                      <span class="n">approximationNumber</span><span class="p">)</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Investigating the profile likelihood&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;fun0&quot;</span> <span class="ow">in</span> <span class="n">profile_LL_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Determining logLikelihood&quot;</span><span class="p">)</span>
            <span class="n">profile_LL_args</span><span class="p">[</span><span class="s2">&quot;fun0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">negLogLikelihood_autograd</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="s2">&quot;hess0&quot;</span> <span class="ow">in</span> <span class="n">profile_LL_args</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Determining Hessian of logLikelihood&quot;</span><span class="p">)</span>
            <span class="n">profile_LL_args</span><span class="p">[</span><span class="s2">&quot;hess0&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">hess</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        
        <span class="n">dim</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">dim</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;c0&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trafficFactorModel</span><span class="o">.</span><span class="n">LABELS</span><span class="p">[</span><span class="n">considered</span><span class="p">[</span><span class="mi">2</span><span class="p">:]])</span>
        
        <span class="n">indices</span><span class="p">,</span> <span class="n">directions</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">iterproduct</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">dim</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
        
        
        <span class="n">const_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">processedSurveyData</span><span class="p">,</span> <span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span> <span class="n">trafficFactorModel</span><span class="p">,</span> 
                      <span class="n">routeChoiceParameters</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properDataRate</span><span class="p">,</span>
                      <span class="n">considered</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating confidence intervals&quot;</span><span class="p">)</span>
        <span class="c1">#try: #, max_workers=13</span>
        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">const_args</span><span class="o">=</span><span class="n">const_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">mapObj</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_find_profile_CI_static</span><span class="p">,</span> 
                              <span class="n">indices</span><span class="p">,</span> <span class="n">repeat</span><span class="p">(</span><span class="n">x0</span><span class="p">),</span> <span class="n">directions</span><span class="p">,</span> 
                              <span class="n">repeat</span><span class="p">(</span><span class="n">approximationNumber</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="n">profile_LL_args</span><span class="p">))</span>
            
            
            <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">direction</span><span class="p">,</span> <span class="n">r</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">indices</span><span class="p">,</span> <span class="n">directions</span><span class="p">,</span> <span class="n">mapObj</span><span class="p">):</span>
                <span class="n">result</span><span class="p">[</span><span class="n">index</span><span class="p">][(</span><span class="mi">0</span> <span class="k">if</span> <span class="n">direction</span><span class="o">==-</span><span class="mi">1</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)</span>
                              <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_parameters</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> 
                                        <span class="n">considered</span><span class="p">))[</span><span class="n">considered</span><span class="p">][</span><span class="n">index</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Printing confidence intervals and creating profile plots&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="n">x0Orig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_convert_parameters</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">considered</span><span class="p">))[</span><span class="n">considered</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">intv</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">result</span><span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">intv</span>
            <span class="n">strs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">start</span><span class="p">,</span> <span class="n">x0Orig</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="n">end</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="mf">0.01</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mf">1e6</span><span class="p">)</span> <span class="ow">or</span> <span class="n">v</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:10.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">strs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{:&lt;10}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;CI for </span><span class="si">{:&lt;40}</span><span class="s2">: [</span><span class="si">{}</span><span class="s2"> --- </span><span class="si">{}</span><span class="s2"> --- </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="o">*</span><span class="n">strs</span><span class="p">))</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.fit_route_choice_model"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.fit_route_choice_model">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">RouteChoiceModel</span><span class="o">.</span><span class="n">fit</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">fit_route_choice_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">guess</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                               <span class="n">improveGuess</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">get_CI</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fits the route choice model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        refit : bool</span>
<span class="sd">            Whether the model shall be refitted if it has already been fitted </span>
<span class="sd">            earlier.</span>
<span class="sd">        get_CI : bool</span>
<span class="sd">            Whether confidence intervals for the parameters shall be computed</span>
<span class="sd">            after the model has been fitted.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="s2">&quot;routeChoiceModel&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;A route choice model must be created before it can &quot;</span>
                          <span class="s2">&quot;be fitted. Call create_route_choice_model!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">refit</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">fitted</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;A route choice model does already exist. I skip&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;this step. Enforce fitting with the argument&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;refit=True&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">prepared</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;The route choice model has not been prepared for model&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;fit. I ignore it.&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;Call create_route_choice_model if you want to&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;use the model.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Fitting route choice model&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">guess</span><span class="p">,</span> <span class="n">improveGuess</span><span class="p">,</span> <span class="n">disp</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Constructing confidence intervals for route&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;choice model&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">guess</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">improveGuess</span><span class="o">==</span><span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">get_CI</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">fileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">get_confidence_intervals</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        
        <span class="k">return</span> <span class="kc">True</span></div>
    
    
<div class="viewcode-block" id="HybridVectorModel.set_traffic_factor_model_class"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.set_traffic_factor_model_class">[docs]</a>    <span class="k">def</span> <span class="nf">set_traffic_factor_model_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">trafficFactorModel_class</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sets the class representing the traffic factor (gravity) model.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        trafficFactorModel_class : class</span>
<span class="sd">            Class of the traffic factor model. Must inherit from </span>
<span class="sd">            :py:class:`BaseTrafficFactorModel`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">trafficFactorModel_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;__trafficFactorModel_class&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="o">==</span> <span class="n">trafficFactorModel_class</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">trafficFactorModel_class</span><span class="o">.</span><span class="n">_check_integrity</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">__trafficFactorModel_class</span> <span class="o">=</span> <span class="n">trafficFactorModel_class</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;destinationData&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;rawDestinationData&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;originData&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;rawOriginData&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__erase_traffic_factor_model</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.prepare_traffic_factor_model"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.prepare_traffic_factor_model">[docs]</a>    <span class="k">def</span> <span class="nf">prepare_traffic_factor_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Prepares the traffic factor model.</span>
<span class="sd">        </span>
<span class="sd">        This may be necessary if derived covariates shall be used and these</span>
<span class="sd">        derived covariates do not depend on paramters that shall be fitted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trafficFactorModel_class</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;__trafficFactorModel_class is not specified. Call &quot;</span> 
                             <span class="o">+</span> <span class="s2">&quot;`model.set_traffic_factor_model_class(...)`&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">trafficFactorModel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__trafficFactorModel_class</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">destinationData</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">postalCodeAreaData</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">shortestDistances</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">postalCodeDistances</span><span class="p">)</span></div>
        
<div class="viewcode-block" id="HybridVectorModel.fit_flow_model"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.fit_flow_model">[docs]</a>    <span class="k">def</span> <span class="nf">fit_flow_model</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permutations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">refit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                       <span class="n">flowParameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">continueFlowOptimization</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
                       <span class="n">get_CI</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Fits the traffic flow (gravity) model.</span>
<span class="sd">        </span>
<span class="sd">        Fits one or multiple candidates for the traffic flow model and selects</span>
<span class="sd">        the model with minimal AIC value. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        permutations : bool[][]</span>
<span class="sd">            Each row corresponds to a parameter combination of a models that </span>
<span class="sd">            is to be considered. For each parameter that could be potentially </span>
<span class="sd">            included, the row must contain a boolean value. Do only include </span>
<span class="sd">            parameters included in the traffic factor model. If ``None``,</span>
<span class="sd">            the :py:attr:`PERMUTATIONS &lt;BaseTrafficModel.PERMUTATIONS&gt;` given</span>
<span class="sd">            in the traffic factor model class will be considered. If this </span>
<span class="sd">            attribute is not implemented, only the full model will be considered.</span>
<span class="sd">        refit : bool</span>
<span class="sd">            Whether to repeat the fitting procedure if the model has been </span>
<span class="sd">            fitted earlier.</span>
<span class="sd">        flowParameters : dict</span>
<span class="sd">            Dictionary with the keys ``&quot;covariates&quot;`` and ``&quot;paramters&quot;`` </span>
<span class="sd">            that provides an initial guess for the optimization or the </span>
<span class="sd">            corresponding solution. ``&quot;covariates&quot;`` contains a `bool[]` with </span>
<span class="sd">            the considered parameter combination (see :py:obj:`permutations`);</span>
<span class="sd">            ``&quot;covariates&quot;`` contains a `float[]` with the values for the </span>
<span class="sd">            parameters where ``flowParameters[&quot;considered&quot;]`` is ``True``.</span>
<span class="sd">        continueFlowOptimization : bool</span>
<span class="sd">            If ``True``, the :py:obj:`flowParameters` will be used as initial </span>
<span class="sd">            guess. Otherwise, they will be considered as the optimal </span>
<span class="sd">            parameters.</span>
<span class="sd">        get_CI : bool</span>
<span class="sd">            Whether confidence intervals shall be computed after the model</span>
<span class="sd">            has been fitted. Note that no confidence intervals will be computed,</span>
<span class="sd">            if ``continueFlowOptimization is False``.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Fitting flow models.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="n">fittedModel</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">refit</span> <span class="ow">and</span> <span class="s2">&quot;flowModelData&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;A model does already exist. I skip&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;this step. Enforce fitting with the argument&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;refit=True&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;processedSurveyData&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;The model has no extrapolated boater data. I stop.&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;Call preprocess_survey_data if you want to&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;use the model.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="s2">&quot;trafficFactorModel&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;No traffic factor model has been specified. Call &quot;</span>
                      <span class="s2">&quot;model.set_traffic_factor_model(...)!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Fitting the traffic factor model&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">permutations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">permutations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">trafficFactorModel</span><span class="o">.</span><span class="n">PERMUTATIONS</span>
        
        
        <span class="k">if</span> <span class="n">permutations</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">permutations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trafficFactorModel</span><span class="o">.</span><span class="n">SIZE</span><span class="p">,</span> 
                                    <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)[</span><span class="kc">None</span><span class="p">,:]</span>
        
        <span class="n">permutationsFull</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">permutations</span><span class="p">:</span>
            <span class="n">permutationsFull</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">l</span><span class="p">))</span>
        
        <span class="n">permutations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">permutationsFull</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">AICs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">LLs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="k">if</span> <span class="n">flowParameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;flowModelData&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span>  
                    <span class="ow">and</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span> 
                    <span class="ow">and</span> <span class="s2">&quot;covariates&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span>
                    <span class="ow">and</span> <span class="s2">&quot;AIC&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span><span class="p">):</span>
                <span class="n">x0</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]]</span>
                <span class="n">permutations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span><span class="p">[</span><span class="s2">&quot;considered&quot;</span><span class="p">]])</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">x0</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            
            <span class="n">const_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">processedSurveyData</span><span class="p">,</span> 
                          <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">trafficFactorModel</span><span class="p">,</span> 
                          <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> 
                          <span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">properDataRate</span><span class="p">]</span>
            <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">const_args</span><span class="o">=</span><span class="n">const_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">mapObj</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                        <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">maximize_log_likelihood_static</span><span class="p">,</span>
                        <span class="n">permutations</span><span class="p">,</span>
                        <span class="n">repeat</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span>
                        <span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                        <span class="n">x0</span><span class="p">,</span>
                        <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                
                
                <span class="k">for</span> <span class="n">permutation</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">permutations</span><span class="p">,</span> <span class="n">mapObj</span><span class="p">):</span>
                    <span class="n">x</span><span class="p">,</span> <span class="n">xOrig</span><span class="p">,</span> <span class="n">nLL</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">xOriginal</span><span class="p">,</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span>
                    <span class="n">AIC</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">permutation</span><span class="p">)</span> <span class="o">+</span> <span class="n">nLL</span><span class="p">)</span>
                    <span class="n">AICs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AIC</span><span class="p">)</span>
                    <span class="n">LLs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nLL</span><span class="p">)</span>
                    <span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">permutation</span><span class="p">,</span> <span class="s2">&quot;| AIC:&quot;</span><span class="p">,</span> <span class="n">AIC</span><span class="p">,</span> 
                              <span class="n">x</span><span class="p">,</span> <span class="n">xOrig</span><span class="p">)</span>
            <span class="n">fittedModel</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">continueFlowOptimization</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximize_log_likelihood</span><span class="p">(</span>
                                  <span class="n">flowParameters</span><span class="p">[</span><span class="s2">&quot;considered&quot;</span><span class="p">],</span> 
                                  <span class="n">x0</span><span class="o">=</span><span class="n">flowParameters</span><span class="p">[</span><span class="s2">&quot;paramters&quot;</span><span class="p">])</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">result</span><span class="o">.</span><span class="n">x</span><span class="p">]</span>
                <span class="n">fittedModel</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">maximize_log_likelihood</span><span class="p">(</span>
                                  <span class="n">flowParameters</span><span class="p">[</span><span class="s2">&quot;considered&quot;</span><span class="p">],</span> 
                                  <span class="n">flowParameters</span><span class="o">=</span><span class="n">flowParameters</span><span class="p">[</span><span class="s2">&quot;paramters&quot;</span><span class="p">])</span>
                <span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">flowParameters</span><span class="p">[</span><span class="s2">&quot;paramters&quot;</span><span class="p">]]</span>
            <span class="n">nLL</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">fun</span>
            <span class="n">LLs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nLL</span><span class="p">)</span>
            <span class="n">AICs</span> <span class="o">=</span> <span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flowParameters</span><span class="p">[</span><span class="s2">&quot;considered&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="n">nLL</span><span class="p">)]</span>
            <span class="n">permutations</span> <span class="o">=</span> <span class="p">[</span><span class="n">flowParameters</span><span class="p">[</span><span class="s2">&quot;considered&quot;</span><span class="p">]]</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        
        <span class="n">bestIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">AICs</span><span class="p">)</span>
        <span class="n">AIC</span> <span class="o">=</span> <span class="n">AICs</span><span class="p">[</span><span class="n">bestIndex</span><span class="p">]</span>
        <span class="n">LL</span> <span class="o">=</span> <span class="n">LLs</span><span class="p">[</span><span class="n">bestIndex</span><span class="p">]</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="n">bestIndex</span><span class="p">]</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="n">permutations</span><span class="p">[</span><span class="n">bestIndex</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Choose the following covariates:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">covariates</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Parameters (transformed):&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Parameters (original):&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">bestIndex</span><span class="p">]</span><span class="o">.</span><span class="n">xOriginal</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Negative log-likelihood:&quot;</span><span class="p">,</span> <span class="n">LL</span><span class="p">,</span> <span class="s2">&quot;AIC:&quot;</span><span class="p">,</span> <span class="n">AIC</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">results</span> <span class="ow">and</span> <span class="n">fittedModel</span> <span class="ow">and</span> <span class="n">get_CI</span><span class="p">:</span> <span class="c1"># or True:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">investigate_profile_likelihood</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">processedSurveyData</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">lengthsOfPotentialRoutes</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">trafficFactorModel</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">parameters</span><span class="p">,</span> 
                                            <span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">properDataRate</span><span class="p">,</span>
                                            <span class="n">covariates</span><span class="p">,</span> 
                                            <span class="n">disp</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vm</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                 
            
        <span class="k">if</span> <span class="p">(</span><span class="n">flowParameters</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="s2">&quot;flowModelData&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">or</span>
            <span class="s2">&quot;AIC&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span><span class="p">[</span><span class="s2">&quot;AIC&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">AIC</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;AIC&quot;</span><span class="p">:</span> <span class="n">AIC</span><span class="p">,</span>
                <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="n">parameters</span><span class="p">,</span>
                <span class="s2">&quot;covariates&quot;</span><span class="p">:</span> <span class="n">permutations</span><span class="p">[</span><span class="n">bestIndex</span><span class="p">]</span>
                <span class="p">}</span>
                    
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">fittedModel</span></div>
        
<div class="viewcode-block" id="HybridVectorModel.get_station_mean_variance"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.get_station_mean_variance">[docs]</a>    <span class="k">def</span> <span class="nf">get_station_mean_variance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stationIndices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="n">shiftStart</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">shiftEnd</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>
                                  <span class="n">getStationResults</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                  <span class="n">getPairResults</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">fullCompliance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">correctData</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the mean agent traffic that could be observed at survey </span>
<span class="sd">        locations and the respective vairances. </span>
<span class="sd">        </span>
<span class="sd">        The values are returned both for all agents and the agents</span>
<span class="sd">        coming from infested origins only, respectively. </span>
<span class="sd">        </span>
<span class="sd">        The traffic can be returned either per survey location or per </span>
<span class="sd">        origin-destination pair (assuming that surveys were conducted at the</span>
<span class="sd">        given locations and time intervals). </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stationIndices : int[]</span>
<span class="sd">            Indices of the locations for which the traffic estimate is desired.</span>
<span class="sd">            If ``None``, the traffic for all potential survey locations will</span>
<span class="sd">            be returned. The same location can be mentioned multiple times to </span>
<span class="sd">            model multiple inspection shifts on different days.</span>
<span class="sd">        shiftStart : [0, 24)</span>
<span class="sd">            The start of the time interval for which the agent counts shall be</span>
<span class="sd">            estimated. Must be given in a 24h format. That is, 14.5 represents</span>
<span class="sd">            2:30PM. Can also be an array, which then must have the same length </span>
<span class="sd">            as :py:obj:`stationIndices`.</span>
<span class="sd">        shiftStart : [0, 24)</span>
<span class="sd">            The end of the time interval for which the agent counts shall be</span>
<span class="sd">            estimated. Must be given in a 24h format. That is, 14.5 represents</span>
<span class="sd">            2:30PM. Can also be an array, which then must have the same length </span>
<span class="sd">            as :py:obj:`stationIndices`.</span>
<span class="sd">        getStationResults : bool</span>
<span class="sd">            Whether the estimates shall be returned by survey location.</span>
<span class="sd">        getPairResults : bool</span>
<span class="sd">            Whether estimates shall be returned by origin-destination pair.</span>
<span class="sd">        </span>
<span class="sd">        ~+~</span>
<span class="sd">        </span>
<span class="sd">        .. todo:: This method can be made much more efficient, if the road </span>
<span class="sd">            choice probabilities and the k values are computed once for each </span>
<span class="sd">            origin-destination pair or inspection location only. That is,</span>
<span class="sd">            we would not need to reconsider teh same location multiple times.</span>
<span class="sd">            This would speed up this method by orders of magnitude.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Computing the mean and the variance of the traffic at the&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;given locations.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">getStationResults</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">getPairResults</span><span class="p">:</span> 
            <span class="k">return</span>
        
        <span class="k">if</span> <span class="n">stationIndices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">stationIndices</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIDToStationIndex</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">fullCompliance</span><span class="p">:</span>
            <span class="n">complianceRate</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">complianceRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span>
        
        <span class="k">if</span> <span class="n">correctData</span><span class="p">:</span>
            <span class="n">properDataRate</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">properDataRate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properDataRate</span>
            
        <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">parameters</span>
        
        <span class="n">infested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">[</span><span class="s2">&quot;infested&quot;</span><span class="p">]</span>
        
        <span class="n">kMatrix</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_k_q</span><span class="p">()</span>
        <span class="n">timeFactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">travelTimeModel</span><span class="o">.</span><span class="n">interval_probability</span><span class="p">(</span><span class="n">shiftStart</span><span class="p">,</span> <span class="n">shiftEnd</span>
                                                            <span class="p">)</span> <span class="o">*</span> <span class="n">complianceRate</span> <span class="o">*</span> <span class="n">properDataRate</span>
        
        <span class="n">constantTime</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">timeFactor</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">)</span>
        
        <span class="n">aq</span> <span class="o">=</span> <span class="n">q</span> <span class="o">*</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">c4</span> <span class="o">*</span> <span class="n">timeFactor</span>
        <span class="n">qq</span> <span class="o">=</span> <span class="n">aq</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="o">+</span><span class="n">aq</span><span class="p">)</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">timeFactor</span>
        <span class="n">addition</span> <span class="o">=</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">c4</span> <span class="o">*</span> <span class="n">q</span> <span class="o">*</span> <span class="n">timeFactor</span>
        
        <span class="k">if</span> <span class="n">constantTime</span><span class="p">:</span>
            <span class="n">blindMeans</span> <span class="o">=</span> <span class="n">kMatrix</span> <span class="o">*</span> <span class="p">(</span><span class="n">qq</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">qq</span><span class="p">))</span>
            <span class="n">blindVariances</span> <span class="o">=</span> <span class="n">blindMeans</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">qq</span><span class="p">)</span>
            <span class="n">blindMeanSum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">blindMeans</span><span class="p">)</span>
            <span class="n">blindVarianceSum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">blindVariances</span><span class="p">)</span>
            <span class="n">blindMeanInfestedSum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">blindMeans</span><span class="p">[</span><span class="n">infested</span><span class="p">])</span>
            <span class="n">blindVarianceInfestedSum</span> <span class="o">=</span> <span class="n">blindMeanInfestedSum</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">qq</span><span class="p">)</span>
            <span class="n">blinds</span> <span class="o">=</span> <span class="p">[</span><span class="n">blindMeans</span><span class="p">,</span> <span class="n">blindVariances</span><span class="p">,</span> <span class="n">blindMeanSum</span><span class="p">,</span> 
                      <span class="n">blindVarianceSum</span><span class="p">,</span> <span class="n">blindMeanInfestedSum</span><span class="p">,</span> 
                      <span class="n">blindVarianceInfestedSum</span><span class="p">]</span>
            <span class="n">qqBase</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">qq</span><span class="p">)</span>
            <span class="n">factorBase</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">factor</span><span class="p">)</span>
            <span class="n">additionBase</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">(</span><span class="n">addition</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">qqBase</span> <span class="o">=</span> <span class="n">qq</span>
            <span class="n">factorBase</span> <span class="o">=</span> <span class="n">factor</span>
            <span class="n">additionBase</span> <span class="o">=</span> <span class="n">addition</span> 
            <span class="n">blinds</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span>
        
        <span class="n">routeLengthsPowers</span> <span class="o">=</span> <span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">lengthsOfPotentialRoutes</span><span class="p">)</span>
        <span class="n">routeLengthsPowers</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">routeLengthsPowers</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">c3</span><span class="p">)</span>
        <span class="n">routeLengthsNorm</span> <span class="o">=</span> <span class="n">routeLengthsPowers</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">kMatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">inspectedRoutes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">inspectedPotentialRoutes</span>
        <span class="n">stationIDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIndexToStationID</span>
        
        <span class="k">if</span> <span class="n">getStationResults</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;stationID&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;meanInfested&quot;</span><span class="p">,</span> <span class="s2">&quot;variance&quot;</span><span class="p">,</span> 
                              <span class="s2">&quot;varianceInfested&quot;</span><span class="p">],</span> 
                     <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="n">IDTYPE</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">]}</span>
            <span class="n">stationResult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stationIndices</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">getPairResults</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;variance&quot;</span><span class="p">],</span>
                     <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">]}</span>
            <span class="n">pairResult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">kMatrix</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stationIndices</span><span class="p">),</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="n">const_args</span> <span class="o">=</span> <span class="p">[</span><span class="n">routeLengthsPowers</span><span class="p">,</span> <span class="n">routeLengthsNorm</span><span class="p">,</span> <span class="n">kMatrix</span><span class="p">,</span> <span class="n">infested</span><span class="p">,</span>
                      <span class="n">q</span><span class="p">,</span> <span class="n">constantTime</span><span class="p">,</span> <span class="n">getStationResults</span><span class="p">,</span> <span class="n">getPairResults</span><span class="p">]</span> <span class="o">+</span> \
                     <span class="n">blinds</span>
        <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">(</span><span class="n">const_args</span><span class="o">=</span><span class="n">const_args</span><span class="p">)</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="p">[(</span><span class="n">inspectedRoutes</span><span class="p">[</span><span class="n">ind</span><span class="p">]</span> <span class="k">if</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">inspectedRoutes</span> <span class="k">else</span> <span class="p">{})</span>
                  <span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="n">stationIndices</span><span class="p">]</span>
            <span class="n">mapObj</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
                    <span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">_get_station_mean_variance_partial</span><span class="p">,</span>
                    <span class="n">l</span><span class="p">,</span> <span class="n">qqBase</span><span class="p">,</span> <span class="n">factorBase</span><span class="p">,</span> <span class="n">additionBase</span><span class="p">,</span>
                    <span class="n">chunksize</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stationIndex</span><span class="p">,</span> <span class="n">result</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">itercount</span><span class="p">(),</span> <span class="n">stationIndices</span><span class="p">,</span> 
                                               <span class="n">mapObj</span><span class="p">):</span>
                <span class="n">percentage</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">percentage</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">percentage</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">getStationResults</span><span class="p">:</span>
                    <span class="n">mean</span><span class="p">,</span> <span class="n">meanInfested</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">varianceInfested</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">stationResult</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">stationIDs</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">],</span> <span class="n">mean</span><span class="p">,</span> 
                                        <span class="n">meanInfested</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> 
                                        <span class="n">varianceInfested</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">getPairResults</span><span class="p">:</span>
                    <span class="n">means</span><span class="p">,</span> <span class="n">variances</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">pairResult</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">means</span>
                    <span class="n">pairResult</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">variances</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">getStationResults</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">getPairResults</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">stationResult</span><span class="p">,</span> <span class="n">pairResult</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">stationResult</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pairResult</span></div>
        
    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_get_station_mean_variance_partial</span><span class="p">(</span><span class="n">routeLengthsPowers</span><span class="p">,</span>
                                            <span class="n">routeLengthsNorm</span><span class="p">,</span>
                                            <span class="n">kMatrix</span><span class="p">,</span>
                                            <span class="n">infested</span><span class="p">,</span>
                                            <span class="n">q</span><span class="p">,</span>
                                            <span class="n">constantTime</span><span class="p">,</span>
                                            <span class="n">getStationResults</span><span class="p">,</span>
                                            <span class="n">getPairResults</span><span class="p">,</span>
                                            <span class="n">blindMeans</span><span class="p">,</span> 
                                            <span class="n">blindVariances</span><span class="p">,</span> 
                                            <span class="n">blindMeanSum</span><span class="p">,</span> 
                                            <span class="n">blindVarianceSum</span><span class="p">,</span> 
                                            <span class="n">blindMeanInfestedSum</span><span class="p">,</span> 
                                            <span class="n">blindVarianceInfestedSum</span><span class="p">,</span>
                                            <span class="n">inspectedRoutesDict</span><span class="p">,</span> <span class="n">qq</span><span class="p">,</span> <span class="n">factor</span><span class="p">,</span>
                                            <span class="n">addition</span><span class="p">,</span>
                                            <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A subroutine of the algorithm for :py:meth:`get_station_mean_variance`</span>
<span class="sd">        for parallelization.</span>
<span class="sd">        </span>
<span class="sd">        .. todo:: Argument documentation</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#tedRoutesDict = inspectedRoutes[stationIndex]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">constantTime</span><span class="p">:</span>
            <span class="c1">#qq = qqBase[i]</span>
            <span class="n">blindMeans</span> <span class="o">=</span> <span class="n">kMatrix</span> <span class="o">*</span> <span class="p">(</span><span class="n">qq</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">qq</span><span class="p">))</span>
            <span class="n">blindVariances</span> <span class="o">=</span> <span class="n">blindMeans</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">qq</span><span class="p">)</span>
            <span class="c1">#factor = factorBase[i]</span>
            <span class="c1">#addition = additionBase[i]</span>
            <span class="k">if</span> <span class="n">getStationResults</span><span class="p">:</span>
                <span class="n">blindMeanSum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">blindMeans</span><span class="p">)</span>
                <span class="n">blindVarianceSum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">blindVariances</span><span class="p">)</span>
                <span class="n">blindMeanInfestedSum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">blindMeans</span><span class="p">[</span><span class="n">infested</span><span class="p">])</span>
                <span class="n">blindVarianceInfestedSum</span> <span class="o">=</span> <span class="n">blindMeanInfestedSum</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">qq</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspectedRoutesDict</span><span class="p">):</span>
            <span class="n">routeProbabilities</span> <span class="o">=</span> <span class="p">[</span><span class="n">routeLengthsPowers</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">pathIndices</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                                  <span class="o">/</span> <span class="n">routeLengthsNorm</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span> 
                                  <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">pathIndices</span> 
                                  <span class="ow">in</span> <span class="n">inspectedRoutesDict</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
            
            <span class="n">pairs</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">inspectedRoutesDict</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
            
            <span class="n">aq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">routeProbabilities</span><span class="p">)</span> <span class="o">*</span> <span class="n">factor</span> <span class="o">+</span> <span class="n">addition</span>
            <span class="n">qq</span> <span class="o">=</span> <span class="n">aq</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="o">+</span><span class="n">aq</span><span class="p">)</span>
            <span class="n">qqm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">qq</span>
            
            <span class="n">means</span> <span class="o">=</span> <span class="n">kMatrix</span><span class="p">[</span><span class="n">pairs</span><span class="p">]</span> <span class="o">*</span> <span class="n">qq</span> <span class="o">/</span> <span class="n">qqm</span>
            <span class="n">variances</span> <span class="o">=</span> <span class="n">means</span> <span class="o">/</span> <span class="n">qqm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">means</span> <span class="o">=</span> <span class="n">variances</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="k">if</span> <span class="n">getStationResults</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspectedRoutesDict</span><span class="p">):</span>
            <span class="n">infestedRoutes</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pair</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">inspectedRoutesDict</span><span class="p">)</span>
                              <span class="k">if</span> <span class="n">infested</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]]]</span>
            <span class="n">infestedSources</span> <span class="o">=</span> <span class="p">[</span><span class="n">pairs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">infestedRoutes</span><span class="p">]</span>
            <span class="n">infestedSinks</span> <span class="o">=</span> <span class="p">[</span><span class="n">pairs</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">infestedRoutes</span><span class="p">]</span>
            
            <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">means</span><span class="p">)</span> <span class="o">+</span> <span class="n">blindMeanSum</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">blindMeans</span><span class="p">[</span><span class="n">pairs</span><span class="p">])</span>
            <span class="n">variance</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">variances</span><span class="p">)</span> <span class="o">+</span> <span class="n">blindVarianceSum</span> 
                        <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">blindVariances</span><span class="p">[</span><span class="n">pairs</span><span class="p">]))</span>
            <span class="n">meanInfested</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">means</span><span class="p">[</span><span class="n">infestedRoutes</span><span class="p">])</span> <span class="o">+</span> 
                            <span class="n">blindMeanInfestedSum</span>  
                            <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">blindMeans</span><span class="p">[</span><span class="n">infestedSources</span><span class="p">,</span>
                                                <span class="n">infestedSinks</span><span class="p">]))</span>
            <span class="n">varianceInfested</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">variances</span><span class="p">[</span><span class="n">infestedRoutes</span><span class="p">])</span> 
                                <span class="o">+</span> <span class="n">blindVarianceInfestedSum</span> 
                                <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">blindVariances</span><span class="p">[</span><span class="n">infestedSources</span><span class="p">,</span>
                                                        <span class="n">infestedSinks</span><span class="p">]))</span>
            
            <span class="n">stationResult</span> <span class="o">=</span> <span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">meanInfested</span><span class="p">,</span> <span class="n">variance</span><span class="p">,</span> <span class="n">varianceInfested</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">getStationResults</span><span class="p">:</span>
            <span class="n">stationResult</span> <span class="o">=</span> <span class="p">(</span><span class="n">blindMeanSum</span><span class="p">,</span> <span class="n">blindMeanInfestedSum</span><span class="p">,</span> 
                             <span class="n">blindVarianceSum</span><span class="p">,</span> <span class="n">blindVarianceInfestedSum</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">stationResult</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">if</span> <span class="n">getPairResults</span><span class="p">:</span>
            <span class="n">pairResultMean</span> <span class="o">=</span> <span class="n">blindMeans</span>
            <span class="n">pairResultVariance</span> <span class="o">=</span> <span class="n">blindVariances</span>
            <span class="k">if</span>  <span class="nb">len</span><span class="p">(</span><span class="n">inspectedRoutesDict</span><span class="p">):</span>
                <span class="n">pairResultMean</span><span class="p">[</span><span class="n">pairs</span><span class="p">]</span> <span class="o">+=</span> <span class="n">means</span> <span class="o">-</span> <span class="n">blindMeans</span><span class="p">[</span><span class="n">pairs</span><span class="p">]</span>
                <span class="n">pairResultVariance</span><span class="p">[</span><span class="n">pairs</span><span class="p">]</span> <span class="o">+=</span> <span class="n">variances</span> <span class="o">-</span> <span class="n">blindVariances</span><span class="p">[</span><span class="n">pairs</span><span class="p">]</span>
            <span class="n">pairResult</span> <span class="o">=</span> <span class="p">(</span><span class="n">pairResultMean</span><span class="p">,</span> <span class="n">pairResultVariance</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pairResult</span> <span class="o">=</span> <span class="kc">None</span>
        
        <span class="k">return</span> <span class="n">stationResult</span><span class="p">,</span> <span class="n">pairResult</span>
        
    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">_get_k_value</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_k_q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pair</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shiftStart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shiftEnd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                 <span class="n">stationIndex</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the parameters `k` and `q` for the (negative binomial)</span>
<span class="sd">        traffic distribution between origin-destination pairs.</span>
<span class="sd">        </span>
<span class="sd">        The arguments can also be provided as arrays of matching dimensions.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shiftStart : [0, 24)</span>
<span class="sd">            The start of the time interval(s) for which the parameters shall be</span>
<span class="sd">            computed. Must be given in a 24h format. That is, 14.5 represents</span>
<span class="sd">            2:30PM. If not given, travel timing will be neglected and the </span>
<span class="sd">            complete daily traffic flow will be considered.</span>
<span class="sd">        shiftStart : [0, 24)</span>
<span class="sd">            The end of the time interval(s) for which the parameters shall be</span>
<span class="sd">            computed. Must be given in a 24h format. That is, 14.5 represents</span>
<span class="sd">            2:30PM. If not given, travel timing will be neglected and the </span>
<span class="sd">            complete daily traffic flow will be considered.</span>
<span class="sd">        stationIndex : int</span>
<span class="sd">            Index of the survey location to be considered. If not given,</span>
<span class="sd">            route choice will be neglected and the complete traffic flow will</span>
<span class="sd">            be computed.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span><span class="p">[</span><span class="s2">&quot;considered&quot;</span><span class="p">]</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> 
                                              <span class="n">covariates</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_k_value</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">covariates</span><span class="p">,</span> <span class="n">pair</span><span class="p">)</span>
        
        <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">stationIndex</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">parameters</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">routeLengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">lengthsOfPotentialRoutes</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
                <span class="n">stationPathLengths</span> <span class="o">=</span> <span class="p">[</span><span class="n">routeLengths</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> 
                                      <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">inspectedPotentialRoutes</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">][</span><span class="n">pair</span><span class="p">]]</span>
                
                <span class="n">stationPathLengths</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">stationPathLengths</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">normConstant</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">routeLengths</span><span class="p">,</span> <span class="n">c3</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span><span class="o">*</span><span class="n">stationPathLengths</span><span class="o">/</span><span class="n">normConstant</span> <span class="o">+</span> <span class="n">c2</span><span class="o">*</span><span class="n">c4</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="n">c2</span><span class="o">*</span><span class="n">c4</span>
        
        <span class="k">if</span> <span class="n">shiftStart</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">shiftEnd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">timeFactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">travelTimeModel</span><span class="o">.</span><span class="n">interval_probability</span><span class="p">(</span><span class="n">shiftStart</span><span class="p">,</span> 
                                                                <span class="n">shiftEnd</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">*=</span> <span class="n">timeFactor</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">factor</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="n">factor</span><span class="o">*</span><span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="o">+</span><span class="n">factor</span><span class="o">*</span><span class="n">q</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">k</span><span class="p">,</span> <span class="n">q</span>
    
    
<div class="viewcode-block" id="HybridVectorModel.optimize_inspection_station_operation"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.optimize_inspection_station_operation">[docs]</a>    <span class="k">def</span> <span class="nf">optimize_inspection_station_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> 
                <span class="n">costShift</span><span class="p">,</span>          <span class="c1"># costs per inspection shift</span>
                <span class="n">costSite</span><span class="p">,</span>           <span class="c1"># costs per used inspection site</span>
                <span class="n">costBound</span><span class="p">,</span>          <span class="c1"># cost budget</span>
                <span class="n">shiftLength</span><span class="p">,</span>        <span class="c1"># length of shift measured in time steps, </span>
                                    <span class="c1"># if float: approx. length</span>
                <span class="n">nightPremium</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>  <span class="c1">#(nightcost, start, end) </span>
                                    <span class="c1"># shift costs in time interval [start, end]</span>
                <span class="n">allowedShifts</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="c1"># list of allowed shift starting times </span>
                                    <span class="c1"># measured in time units</span>
                                    <span class="c1"># if floats: approx. shift starting times</span>
                <span class="n">costRoundCoeff</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>   <span class="c1"># specifies up to which fraction of the </span>
                                    <span class="c1"># smallest cost the costs are rounded</span>
                <span class="n">baseTimeInv</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span>     <span class="c1"># number of time intervals, </span>
                                    <span class="c1"># if float: approx. interval</span>
                <span class="n">ignoreRandomFlow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># indicates whether we should ignore </span>
                                        <span class="c1"># randomly moving boaters</span>
                <span class="n">integer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>       <span class="c1"># if True, the solver solves the integer </span>
                                    <span class="c1"># problem directly. Otherwise, we use our</span>
                                    <span class="c1"># own rounding scheme.</span>
                <span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                <span class="n">perturbation</span><span class="o">=</span><span class="mf">1e-6</span><span class="p">,</span>
                <span class="n">fancyRounding</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">full_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">extended_info</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">init_greedy</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">saveFile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">loadFile</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">fileNameAddition</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes the optimal locations for agent inspections.</span>
<span class="sd">        </span>
<span class="sd">        Maximizes the number of agents who are inspected at least once given a </span>
<span class="sd">        certain budget and other constraints for operation.</span>
<span class="sd">        </span>
<span class="sd">        The inspections are assumed to be conducted in shifts of given lengths.</span>
<span class="sd">        The best results will be obtained, if the number of possible shifts per</span>
<span class="sd">        day is an integer. However, other shift lengths are possible as well.</span>
<span class="sd">        </span>
<span class="sd">        The day will need to be discretized. The method will take efforts to </span>
<span class="sd">        make the input match a discretization scheme so that not more time</span>
<span class="sd">        intervals than necessary need to be considered.        </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        costShift : float</span>
<span class="sd">            Costs per (daytime) inspection shift.</span>
<span class="sd">        costSite : float</span>
<span class="sd">            Costs per used inspection site.</span>
<span class="sd">        costBound : float</span>
<span class="sd">            Budget for the overall costs.</span>
<span class="sd">        shiftLength : int/float</span>
<span class="sd">            If given as `int`, length of an inspection shift measured in time steps;</span>
<span class="sd">            if given as `float`, approximate length of an inspection shift.</span>
<span class="sd">        nightPremium : (&gt;=0, [0,24), [0,24))</span>
<span class="sd">            Describes additional costs for overnight inspections. Must be </span>
<span class="sd">            given as a tuple ``(nightcost, start, end)``, whereby ``nightcost``</span>
<span class="sd">            is the cost for an overnight inspection shift, and ``start`` and </span>
<span class="sd">            ``start`` and ``end`` denote the time interval in which the </span>
<span class="sd">            additional costs are due (24h format). Note that ``nightcost`` </span>
<span class="sd">            refers to a complete inspection shift conducted in the time interval </span>
<span class="sd">            of additional costs. In practice, however, the costs will only </span>
<span class="sd">            increased for the fraction of a shift that overlaps with the given </span>
<span class="sd">            time interval of additional costs.</span>
<span class="sd">        allowedShifts : int[]/float[]</span>
<span class="sd">            List of permitted shift starting times measured in time units (if</span>
<span class="sd">            given as `int[]`) or as time points in the 24h format (if given as</span>
<span class="sd">            `float[]`).</span>
<span class="sd">        costRoundCoeff : float</span>
<span class="sd">            Specifies up to which fraction of the smallest cost the costs are </span>
<span class="sd">            rounded. Rounding can increase the efficiency of the approach </span>
<span class="sd">            significantly.</span>
<span class="sd">        baseTimeInv : int/float</span>
<span class="sd">            Number of time intervals per day (if given as `int`) or approximate</span>
<span class="sd">            length of one time interval in the 24h format (if given as `float`).</span>
<span class="sd">        ignoreRandomFlow : bool</span>
<span class="sd">            Indicates whether traffic via inadmissibe routes shall be ignored.</span>
<span class="sd">            This traffic noise adds uncertainty to the results but may lead to</span>
<span class="sd">            overall more precise estimates.</span>
<span class="sd">        integer : bool</span>
<span class="sd">            If ``True``, the solver applies an integer programming algorithm</span>
<span class="sd">            to solve the optimization problem. Otherwise a greedy rounding </span>
<span class="sd">            scheme based on linear programming will be used (potentially faster </span>
<span class="sd">            but with lower performance guarantee).</span>
<span class="sd">        timeout : float</span>
<span class="sd">            Timeout for internal optimization routines (in seconds).</span>
<span class="sd">        perturbation : float</span>
<span class="sd">            Perturbation added to make one inspection shift slightly more </span>
<span class="sd">            effective. This is needed for tie breaking only.</span>
<span class="sd">        fancyRounding : bool</span>
<span class="sd">            If ``True`` a more sophisticated rounding scheme will be applied.</span>
<span class="sd">        full_result : bool</span>
<span class="sd">            If ``True``, the optimized variables will be returned in addition</span>
<span class="sd">            to the expected numer of inspected agents under the optimal </span>
<span class="sd">            solution.</span>
<span class="sd">        extended_info : bool</span>
<span class="sd">            If ``True``, the covered fraction of the total agent flow and the</span>
<span class="sd">            used inspection locations (according to the optimal solution) will</span>
<span class="sd">            be returned in addition to other results.</span>
<span class="sd">        init_greedy : bool</span>
<span class="sd">            If ``True``, the greedy rounding algorithm will be used as initial </span>
<span class="sd">            condition for the integer optimization algorithm. Use in conjunction</span>
<span class="sd">            with ``integer=True``.</span>
<span class="sd">        saveFile : bool</span>
<span class="sd">            Whether to save the optimization results to a file.</span>
<span class="sd">        loadFile : boold</span>
<span class="sd">            Whetehr the results may be loaded from a file if available.</span>
<span class="sd">        fileNameAddition : str</span>
<span class="sd">            Addition to the generated file name.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        
        <span class="c1"># Checking of a result had already been computed earlier</span>
        
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">baseTimeInv</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">baseTimeInv</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">:</span>
            <span class="n">baseTimeInv</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="mi">24</span> <span class="o">/</span> <span class="n">baseTimeInv</span><span class="p">))</span>
        <span class="n">baseTime</span> <span class="o">=</span> <span class="mi">24</span> <span class="o">/</span> <span class="n">baseTimeInv</span>
        <span class="k">if</span> <span class="n">allowedShifts</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">allowedShifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">baseTimeInv</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">allowedShifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">allowedShifts</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">allowedShifts</span><span class="o">.</span><span class="n">dtype</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">:</span>
            <span class="n">allowedShifts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">allowedShifts</span> <span class="o">/</span> <span class="n">baseTime</span>
                                     <span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">shiftLength</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">int</span> <span class="ow">and</span> <span class="nb">type</span><span class="p">(</span><span class="n">shiftLength</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">:</span>
            <span class="n">shiftLength</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">shiftLength</span> <span class="o">/</span> <span class="n">baseTime</span><span class="p">))</span>
        
        <span class="c1"># transforming the input</span>
        
        <span class="n">timeIntervalBreaks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">(</span><span class="n">allowedShifts</span><span class="p">,</span> 
                                        <span class="p">(</span><span class="n">allowedShifts</span> <span class="o">+</span> <span class="n">shiftLength</span><span class="p">)</span> 
                                        <span class="o">%</span> <span class="n">baseTimeInv</span><span class="p">)</span>
        <span class="n">timeIntervalStarts</span> <span class="o">=</span> <span class="n">timeIntervalBreaks</span> <span class="o">*</span> <span class="n">baseTime</span>
        <span class="n">timeIntervalEnds</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">timeIntervalBreaks</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">timeIntervalEnds</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">baseTimeInv</span> <span class="c1"># careful: This time exceeds 24!</span>
        <span class="n">timeIntervalEnds</span> <span class="o">=</span> <span class="n">timeIntervalEnds</span><span class="o">*</span><span class="n">baseTime</span>
        
        <span class="n">shiftTimeIntervals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">allowedShifts</span><span class="o">*</span><span class="n">baseTime</span><span class="p">,</span> 
                                <span class="p">((</span><span class="n">allowedShifts</span><span class="o">+</span><span class="n">shiftLength</span><span class="p">)</span><span class="o">*</span><span class="n">baseTime</span><span class="p">)</span><span class="o">%</span><span class="mi">24</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
            
        <span class="k">if</span> <span class="n">costRoundCoeff</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">costSite</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">costRoundCoeff</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">costRoundCoeffInv</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="n">costRoundCoeff</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">costRoundCoeffInv</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">costRoundCoeff</span>
            
            <span class="k">if</span> <span class="n">costShift</span> <span class="o">&lt;</span> <span class="n">costSite</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">costSite</span><span class="p">:</span>
                <span class="n">baseCost</span> <span class="o">=</span> <span class="n">costShift</span>
                <span class="n">costShift</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">costSite</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">costSite</span> <span class="o">/</span> <span class="n">baseCost</span> <span class="o">*</span> <span class="n">costRoundCoeffInv</span><span class="p">)</span> 
                            <span class="o">/</span> <span class="n">costRoundCoeffInv</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">baseCost</span> <span class="o">=</span> <span class="n">costSite</span>
                <span class="n">costSite</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">costShift</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">costShift</span> <span class="o">/</span> <span class="n">baseCost</span> <span class="o">*</span> <span class="n">costRoundCoeffInv</span><span class="p">)</span> 
                             <span class="o">/</span> <span class="n">costRoundCoeffInv</span><span class="p">)</span>
            
            <span class="n">costBound</span> <span class="o">=</span> <span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">costBound</span> <span class="o">/</span> <span class="n">baseCost</span> <span class="o">*</span> <span class="n">costRoundCoeffInv</span><span class="p">)</span> 
                         <span class="o">/</span> <span class="n">costRoundCoeffInv</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">baseCost</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">if</span> <span class="n">extended_info</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">full_result</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span>
            
            <span class="n">fileName</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">+</span> <span class="n">fileNameAddition</span> <span class="o">+</span>
                        <span class="nb">str</span><span class="p">([</span><span class="n">costShift</span><span class="p">,</span> <span class="n">costSite</span><span class="p">,</span> <span class="n">costBound</span><span class="p">,</span> <span class="n">shiftLength</span><span class="p">,</span>
                             <span class="n">nightPremium</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ignoreRandomFlow</span><span class="p">)])</span> <span class="o">+</span> <span class="s2">&quot;.dat&quot;</span><span class="p">)</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fileName</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">loadFile</span> <span class="ow">and</span> <span class="n">exists</span><span class="p">(</span><span class="n">fileName</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">saveobject</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">fileName</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saveFile</span> <span class="o">=</span> <span class="kc">False</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Optimizing inspection station placement&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;and operating times.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Using the following parameters:&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Cost per shift:&quot;</span><span class="p">,</span> <span class="n">baseCost</span><span class="o">*</span><span class="n">costShift</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Cost per site:&quot;</span><span class="p">,</span> <span class="n">baseCost</span><span class="o">*</span><span class="n">costSite</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Budget:&quot;</span><span class="p">,</span> <span class="n">baseCost</span><span class="o">*</span><span class="n">costBound</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Length of the shifts:&quot;</span><span class="p">,</span> <span class="n">baseTime</span><span class="o">*</span><span class="n">shiftLength</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Shift start times:&quot;</span><span class="p">,</span> <span class="n">baseTime</span><span class="o">*</span><span class="n">allowedShifts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Interval start times:&quot;</span><span class="p">,</span> <span class="n">timeIntervalStarts</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Interval end times:&quot;</span><span class="p">,</span> <span class="n">timeIntervalEnds</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Time unit:&quot;</span><span class="p">,</span> <span class="n">baseTime</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Cost unit:&quot;</span><span class="p">,</span> <span class="n">baseCost</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Perturbation:&quot;</span><span class="p">,</span> <span class="n">perturbation</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Ignore random boater flow:&quot;</span><span class="p">,</span> <span class="n">ignoreRandomFlow</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        
        <span class="c1"># prepare problem matrices and vectors</span>
        
        <span class="n">roadNetwork</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span>
        
        <span class="n">stationCombinations</span> <span class="o">=</span> <span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationCombinations</span>
        <span class="n">stationIndexToRelevantStationIndex</span> <span class="o">=</span> <span class="p">{</span><span class="n">spot</span><span class="p">:</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">spot</span> <span class="ow">in</span> 
                        <span class="nb">enumerate</span><span class="p">(</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">inspectedPotentialRoutes</span><span class="o">.</span><span class="n">keys</span><span class="p">())}</span>
        <span class="n">relevantStationIndexToStationIndex</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span>
                            <span class="nb">len</span><span class="p">(</span><span class="n">stationIndexToRelevantStationIndex</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">spot</span><span class="p">,</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">stationIndexToRelevantStationIndex</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">relevantStationIndexToStationIndex</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">spot</span>
        
        <span class="n">originInfested</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">[</span><span class="s2">&quot;infested&quot;</span><span class="p">]</span>
        <span class="n">covariates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span><span class="p">[</span><span class="s2">&quot;considered&quot;</span><span class="p">]</span> 
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_parameters</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">],</span> <span class="n">covariates</span><span class="p">)</span>
        <span class="n">routeLengths</span> <span class="o">=</span> <span class="n">roadNetwork</span><span class="o">.</span><span class="n">lengthsOfPotentialRoutes</span><span class="o">.</span><span class="n">data</span>
        
        <span class="n">q</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">c2</span><span class="p">,</span> <span class="n">c3</span><span class="p">,</span> <span class="n">c4</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">parameters</span>
        
        
        <span class="n">intervalTimeFactors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">travelTimeModel</span><span class="o">.</span><span class="n">interval_probability</span><span class="p">(</span>
                                        <span class="n">timeIntervalStarts</span><span class="p">,</span> <span class="n">timeIntervalEnds</span><span class="p">)</span>
        <span class="n">shiftTimeFactors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">travelTimeModel</span><span class="o">.</span><span class="n">interval_probability</span><span class="p">(</span>
                                        <span class="n">baseTime</span><span class="o">*</span><span class="n">allowedShifts</span><span class="p">,</span> 
                                        <span class="n">baseTime</span><span class="o">*</span><span class="p">(</span><span class="n">allowedShifts</span><span class="o">+</span><span class="n">shiftLength</span><span class="p">))</span>

        
        <span class="n">routePowers</span> <span class="o">=</span> <span class="n">routeLengths</span><span class="o">.</span><span class="n">power</span><span class="p">(</span><span class="n">c3</span><span class="p">)</span>
        <span class="n">routeNormConsts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">routePowers</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        
        <span class="n">stationArrI</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">stationArrJ</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">sinkNumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">shortestDistances</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">kArray</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_k_value</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">covariates</span><span class="p">)</span>
        
        <span class="n">kArrayInfested</span> <span class="o">=</span> <span class="n">kArray</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">[</span><span class="s2">&quot;infested&quot;</span><span class="p">]]</span>
        <span class="n">totalRandomFlow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kArrayInfested</span><span class="p">)</span> <span class="o">*</span> <span class="n">c2</span> <span class="o">*</span> <span class="n">q</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span>
        
        <span class="n">kArray</span> <span class="o">=</span> <span class="n">kArray</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        
        <span class="c1"># List of full-day flows</span>
        <span class="n">fullFlowList</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1"># iterate over path sets with distinct station sets</span>
        <span class="k">for</span> <span class="n">stationSet</span><span class="p">,</span> <span class="n">flowInfos</span> <span class="ow">in</span> <span class="n">stationCombinations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">stationSet</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="c1"># contains the pair index and the flow index for all considered </span>
            <span class="c1"># flows</span>
            <span class="n">tmpArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">sinkNumber</span><span class="o">*</span><span class="n">source</span> <span class="o">+</span> <span class="n">sink</span><span class="p">,</span> <span class="n">flowIndex</span><span class="p">)</span> 
                               <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span> <span class="n">flowIndex</span> <span class="ow">in</span> <span class="n">flowInfos</span>
                               <span class="k">if</span> <span class="n">originInfested</span><span class="p">[</span><span class="n">source</span><span class="p">]],</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmpArr</span><span class="p">):</span>
                <span class="n">i</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fullFlowList</span><span class="p">)</span>
                
                <span class="n">pairIndices</span><span class="p">,</span> <span class="n">flowIndices</span> <span class="o">=</span> <span class="n">tmpArr</span><span class="o">.</span><span class="n">T</span>
                
                <span class="c1"># proportional to full-day flow</span>
                <span class="n">flow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kArray</span><span class="p">[</span><span class="n">pairIndices</span><span class="p">]</span>
                              <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">routePowers</span><span class="p">[</span><span class="n">pairIndices</span><span class="p">,</span> <span class="n">flowIndices</span><span class="p">]</span>
                                           <span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                              <span class="o">/</span> <span class="n">routeNormConsts</span><span class="p">[</span><span class="n">pairIndices</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">q</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c2</span><span class="p">))</span>
                
                <span class="n">fullFlowList</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flow</span><span class="p">)</span>
                
                <span class="c1"># note the flow-station pairs that are related</span>
                <span class="c1"># Y_ij = 1, iff stationArrI[k]=i and stationArrJ[k]=1 for some k</span>
                <span class="n">stationArrI</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">stationSet</span><span class="p">))</span>
                <span class="n">stationArrJ</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                        <span class="n">stationIndexToRelevantStationIndex</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span> <span class="k">for</span>
                        <span class="n">stationIndex</span> <span class="ow">in</span> <span class="n">stationSet</span><span class="p">)</span>
            
        <span class="n">flowNumber</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">fullFlowList</span><span class="p">)</span>
        <span class="n">spotNumber</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stationIndexToRelevantStationIndex</span><span class="p">)</span>
        <span class="n">timeNumber</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">intervalTimeFactors</span><span class="p">)</span>
        <span class="n">shiftNumber</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">shiftTimeFactors</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;We optimize </span><span class="si">{}</span><span class="s2"> flows at </span><span class="si">{}</span><span class="s2"> times over </span><span class="si">{}</span><span class="s2"> locations and </span><span class="si">{}</span><span class="s2"> shifts.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">flowNumber</span><span class="p">,</span> <span class="n">timeNumber</span><span class="p">,</span> <span class="n">spotNumber</span><span class="p">,</span> <span class="n">shiftNumber</span><span class="p">))</span>
        
        <span class="n">flowDim</span> <span class="o">=</span> <span class="n">flowNumber</span> <span class="o">*</span> <span class="n">timeNumber</span>
        <span class="n">inspectionDim</span> <span class="o">=</span> <span class="n">shiftNumber</span> <span class="o">*</span> <span class="n">spotNumber</span>
        
        <span class="n">fullFlowList</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">fullFlowList</span><span class="p">)</span>
        
        <span class="n">intervalFlows</span> <span class="o">=</span> <span class="n">fullFlowList</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">intervalTimeFactors</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span><span class="p">)</span>
        <span class="n">flowCoefficients</span> <span class="o">=</span> <span class="n">intervalFlows</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">totalPredictableFlow</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kArrayInfested</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">c2</span><span class="p">)</span>
        <span class="n">totalFlow</span> <span class="o">=</span> <span class="p">(</span><span class="n">totalPredictableFlow</span> 
                     <span class="o">+</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ignoreRandomFlow</span><span class="p">)</span><span class="o">*</span><span class="n">totalRandomFlow</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;The total reducable predictable flow is </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">intervalFlows</span><span class="p">)))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;The total predictable flow is </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                                        <span class="n">totalPredictableFlow</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;The total random flow is </span><span class="si">{}</span><span class="s2">.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">totalRandomFlow</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating subSubMatrixTime&quot;</span><span class="p">)</span>
        
        <span class="c1"># subMatrixTime[i, j] = 1, iff shift j covers time interval i</span>
        <span class="n">subSubMatrixTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">timeNumber</span><span class="p">,</span> <span class="n">shiftNumber</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">timeIntervalBreaks</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">tStart</span><span class="p">,</span> <span class="n">tEnd</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">itercount</span><span class="p">(),</span> <span class="n">allowedShifts</span><span class="p">,</span> 
                                       <span class="p">(</span><span class="n">allowedShifts</span><span class="o">+</span><span class="n">shiftLength</span><span class="p">)</span> 
                                                                <span class="o">%</span> <span class="n">baseTimeInv</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">tStart</span> <span class="o">&lt;</span> <span class="n">tEnd</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">tStart</span> <span class="ow">and</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tEnd</span><span class="p">:</span>
                        <span class="n">subSubMatrixTime</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">t</span> <span class="o">&gt;=</span> <span class="n">tStart</span> <span class="ow">or</span> <span class="n">t</span> <span class="o">&lt;</span> <span class="n">tEnd</span><span class="p">:</span>
                        <span class="n">subSubMatrixTime</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
        
        <span class="k">def</span> <span class="nf">setSubmatrix</span><span class="p">(</span><span class="n">spm</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">subm</span><span class="p">,</span> <span class="n">grid</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">grid</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">dim1</span><span class="p">,</span> <span class="n">dim2</span> <span class="o">=</span> <span class="n">subm</span><span class="o">.</span><span class="n">size</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">pos</span>
                <span class="n">spm</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">dim1</span><span class="p">,</span> <span class="n">j</span><span class="p">:</span><span class="n">j</span><span class="o">+</span><span class="n">dim2</span><span class="p">]</span> <span class="o">=</span> <span class="n">subm</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">i</span><span class="p">,</span> <span class="n">j</span> <span class="o">=</span> <span class="n">pos</span>
                <span class="n">fact1</span><span class="p">,</span> <span class="n">fact2</span> <span class="o">=</span> <span class="n">grid</span>
                <span class="n">spm</span><span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">fact1</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">fact1</span><span class="p">,</span> <span class="n">j</span><span class="o">*</span><span class="n">fact2</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">fact2</span><span class="p">]</span> <span class="o">=</span> <span class="n">subm</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating matrixFlowConstraint&quot;</span><span class="p">)</span>
        <span class="n">matrixFlowConstraint</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">dok_matrix</span><span class="p">((</span><span class="n">flowDim</span><span class="p">,</span> <span class="n">inspectionDim</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stationArrI</span><span class="p">,</span> <span class="n">stationArrJ</span><span class="p">,</span> <span class="n">itercount</span><span class="p">()):</span>
            <span class="n">setSubmatrix</span><span class="p">(</span><span class="n">matrixFlowConstraint</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">),</span> <span class="n">subSubMatrixTime</span><span class="p">,</span> 
                         <span class="n">subSubMatrixTime</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span> <span class="o">%</span> <span class="mi">500</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">k</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">stationArrI</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating matrixTimeConstraint&quot;</span><span class="p">)</span>
        <span class="n">matrixTimeConstraint</span> <span class="o">=</span> <span class="n">sparse</span><span class="o">.</span><span class="n">dok_matrix</span><span class="p">((</span><span class="n">spotNumber</span><span class="o">*</span><span class="n">timeNumber</span><span class="p">,</span> 
                                                       <span class="n">inspectionDim</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spotNumber</span><span class="p">):</span>
            <span class="n">setSubmatrix</span><span class="p">(</span><span class="n">matrixTimeConstraint</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">),</span> <span class="n">subSubMatrixTime</span><span class="p">,</span>
                         <span class="n">subSubMatrixTime</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">10</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">i</span><span class="o">/</span><span class="n">spotNumber</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">integer</span><span class="p">:</span>
            <span class="n">operations</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">inspectionDim</span><span class="p">,</span> <span class="n">boolean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">spotusage</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">spotNumber</span><span class="p">)</span> <span class="c1">#, boolean=True)</span>
            <span class="n">flows</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">flowDim</span><span class="p">)</span> <span class="c1">#, integer=True)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flows</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">flowDim</span><span class="p">)</span>
            <span class="n">spotusage</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">spotNumber</span><span class="p">)</span>
            <span class="n">operations</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">inspectionDim</span><span class="p">)</span>
        <span class="c1">#operations = cp.Variable(inspectionDim, integer=True)</span>
        
        <span class="k">if</span> <span class="n">integer</span> <span class="ow">and</span> <span class="n">init_greedy</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Applying greedy rounding to determine good initial guess&quot;</span><span class="p">)</span>
            <span class="n">flows_</span><span class="p">,</span> <span class="n">operations_</span><span class="p">,</span> <span class="n">spotusage_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_inspection_station_operation</span><span class="p">(</span>
                <span class="n">costShift</span><span class="p">,</span> <span class="n">costSite</span><span class="p">,</span> <span class="n">costBound</span><span class="p">,</span> <span class="n">shiftLength</span><span class="p">,</span> <span class="n">nightPremium</span><span class="p">,</span> 
                <span class="n">allowedShifts</span><span class="p">,</span> <span class="n">costRoundCoeff</span><span class="p">,</span> <span class="n">baseTimeInv</span><span class="p">,</span> <span class="n">ignoreRandomFlow</span><span class="p">,</span> 
                <span class="kc">False</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">perturbation</span><span class="p">,</span> <span class="n">fancyRounding</span><span class="p">,</span> <span class="kc">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">flows</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">flows_</span>
            <span class="n">spotusage</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">spotusage_</span>
            <span class="n">operations</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">operations_</span>
            <span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">warm_start</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="n">spotusageConstr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spotusage</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
            <span class="n">operationConstr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
        
        
        <span class="c1">#coveredFlow = flowCoefficients@flows + operationCoefficients@operations</span>
        
        <span class="k">if</span> <span class="n">nightPremium</span><span class="p">:</span>
            <span class="n">costShiftNight</span><span class="p">,</span> <span class="n">nightStart</span><span class="p">,</span> <span class="n">nightEnd</span> <span class="o">=</span> <span class="n">nightPremium</span>
            <span class="n">transformedShiftStart</span> <span class="o">=</span> <span class="n">allowedShifts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">transformedShiftStart</span><span class="p">[</span><span class="n">transformedShiftStart</span><span class="o">&lt;</span><span class="n">nightEnd</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">24</span>
            <span class="k">if</span> <span class="n">nightStart</span> <span class="o">&lt;</span> <span class="n">nightEnd</span><span class="p">:</span>
                <span class="n">nightStart</span> <span class="o">+=</span> <span class="mi">24</span>
            <span class="n">nightEnd</span> <span class="o">+=</span> <span class="mi">24</span>
            <span class="n">left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">transformedShiftStart</span><span class="p">,</span> <span class="n">nightStart</span><span class="p">)</span>
            <span class="n">right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">transformedShiftStart</span><span class="o">+</span><span class="n">shiftLength</span><span class="p">,</span> <span class="n">nightEnd</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">right</span><span class="o">-</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="n">shiftLength</span>
            <span class="n">costShift_</span> <span class="o">=</span> <span class="n">factor</span><span class="o">*</span><span class="n">costShiftNight</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">factor</span><span class="p">)</span><span class="o">*</span><span class="n">costShift</span>
            <span class="n">costShift__</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">costShift_</span><span class="p">,</span> <span class="n">spotNumber</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">costShift__</span> <span class="o">=</span> <span class="n">costShift</span>
            
        <span class="n">coveredReducableFlow</span> <span class="o">=</span> <span class="n">flowCoefficients</span><span class="nd">@flows</span>
        
        <span class="k">if</span> <span class="n">ignoreRandomFlow</span><span class="p">:</span>
            <span class="n">coveredFlow</span> <span class="o">=</span> <span class="n">coveredReducableFlow</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">randomFlows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">kArrayInfested</span><span class="p">)</span> <span class="o">*</span> <span class="n">shiftTimeFactors</span> <span class="o">*</span> <span class="p">(</span><span class="n">c2</span><span class="o">*</span><span class="n">c4</span><span class="o">*</span><span class="n">q</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span><span class="p">)</span>
            <span class="n">operationCoefficients</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">randomFlows</span><span class="p">,</span> <span class="n">spotNumber</span><span class="p">)</span>
            <span class="n">coveredRandomFlow</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">operationCoefficients</span><span class="nd">@operations</span><span class="p">,</span> 
                                           <span class="n">totalRandomFlow</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span><span class="p">)</span>
            <span class="n">coveredFlow</span> <span class="o">=</span> <span class="n">coveredReducableFlow</span> <span class="o">+</span> <span class="n">coveredRandomFlow</span>
            
            <span class="c1">#coveredFlow = flowCoefficients@flows + operationCoefficients@operations</span>
        <span class="k">if</span> <span class="n">perturbation</span><span class="p">:</span>
            <span class="n">coveredFlow</span> <span class="o">+=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">operations</span><span class="p">[::</span><span class="n">shiftNumber</span><span class="p">])</span><span class="o">*</span><span class="n">perturbation</span>
                
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating cost constraint&quot;</span><span class="p">)</span>
        
        <span class="n">remainingBudget</span> <span class="o">=</span> <span class="p">(</span><span class="n">costBound</span> <span class="o">-</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">operations</span> <span class="o">*</span> <span class="n">costShift__</span><span class="p">)</span>
                                     <span class="o">-</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">spotusage</span><span class="p">)</span> <span class="o">*</span> <span class="n">costSite</span><span class="p">)</span>
        <span class="n">costConstraint</span> <span class="o">=</span> <span class="p">[</span><span class="n">remainingBudget</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        update locOperated to exclude locations that have been chosen to be used. </span>
<span class="sd">        Determine the best location first, then set it to be chosen, </span>
<span class="sd">        reduce the remaining budget but remove the location cost for this location</span>
<span class="sd">        </span>
<span class="sd">        determine for each station the maximal usage value. For the station with the maximal</span>
<span class="sd">        usage value remove the cost constraint, if not done already.</span>
<span class="sd">        if done already, register highest value.</span>
<span class="sd">        #&quot;&quot;&quot;</span>
        <span class="n">operatingTimeSums</span> <span class="o">=</span> <span class="n">matrixTimeConstraint</span><span class="o">*</span><span class="n">operations</span>
        
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">flows</span> <span class="o">&lt;=</span> <span class="n">matrixFlowConstraint</span><span class="o">*</span><span class="n">operations</span><span class="p">,</span>
                <span class="n">flows</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">,</span>
                <span class="n">operations</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">,</span>
                <span class="c1">#spotusage &lt;= 1</span>
                <span class="p">]</span>
        
        <span class="n">constraints</span> <span class="o">+=</span> <span class="p">[</span><span class="n">operatingTimeSums</span><span class="p">[</span><span class="n">i</span><span class="p">::</span><span class="n">timeNumber</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">spotusage</span> <span class="k">for</span> <span class="n">i</span>
                        <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">timeNumber</span><span class="p">)]</span>
        
        <span class="n">equalityConstraints</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">coveredFlowValues</span> <span class="o">=</span> <span class="p">[]</span>
        
        <span class="c1">#co.solvers.options[&#39;interior&#39;] = False</span>
        <span class="n">locationUsed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">spotNumber</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">noNewSpot</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">relaxAffordable</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">fixedLocations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">repetition</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating optimizer&quot;</span><span class="p">)</span>
            <span class="n">optimizer</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">coveredFlow</span><span class="p">),</span> <span class="n">costConstraint</span>
                                   <span class="o">+</span><span class="n">constraints</span><span class="o">+</span><span class="n">equalityConstraints</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">integer</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Solving ILP&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Solving LP&quot;</span><span class="p">)</span>
            
            <span class="k">try</span><span class="p">:</span>
                <span class="c1">#if integer:</span>
                <span class="c1">#    optimizer.solve(verbose=True, warm_start=warm_start, solver=cp.SCS)</span>
                <span class="c1">#else:</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">warm_start</span><span class="o">=</span><span class="n">warm_start</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="n">cp</span><span class="o">.</span><span class="n">MOSEK</span><span class="p">,</span> 
                                <span class="n">mosek_params</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">MSK_DPAR_MIO_MAX_TIME</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
                                                  <span class="n">MSK_DPAR_MIO_TOL_REL_GAP</span><span class="o">=</span><span class="mf">0.005</span><span class="p">))</span>
            <span class="k">except</span> <span class="n">cp</span><span class="o">.</span><span class="n">error</span><span class="o">.</span><span class="n">SolverError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Solver error&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">pass</span>
            <span class="n">warm_start</span> <span class="o">=</span> <span class="kc">True</span>
            
            <span class="k">if</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s2">&quot;optimal&quot;</span> <span class="ow">or</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">solver_stats</span><span class="o">.</span><span class="n">solve_time</span><span class="o">&gt;=</span><span class="n">timeout</span><span class="p">:</span> 
                <span class="n">coveredFlowValues</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">coveredFlow</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Optimization was successful. Covered flow:&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;</span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:6.2%}</span><span class="s2"> of optimal value)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> 
                              <span class="n">coveredFlowValues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> 
                              <span class="n">coveredFlowValues</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">coveredFlowValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
                
                <span class="n">operatingTimeSumsOriginal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operatingTimeSums</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">operationResult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">operations</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">operationResult</span>
                <span class="n">operationResultReshaped</span> <span class="o">=</span> <span class="n">operationResult</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">spotNumber</span><span class="p">,</span><span class="n">shiftNumber</span><span class="p">))</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">ignoreRandomFlow</span><span class="p">:</span>
                    <span class="n">coveredRandomFlowCorrect</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">operationResultReshaped</span><span class="o">*</span><span class="n">shiftTimeFactors</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                                  <span class="o">*</span><span class="n">c4</span><span class="p">))</span><span class="o">*</span><span class="n">totalRandomFlow</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">((</span><span class="s2">&quot;Random flow: </span><span class="si">{:6.2f}</span><span class="s2"> (</span><span class="si">{:6.2%}</span><span class="s2"> of total covered flow; &quot;</span>
                               <span class="s2">&quot;actual random flow: </span><span class="si">{:6.2f}</span><span class="s2"> (</span><span class="si">{:6.2%}</span><span class="s2"> overestimate)&quot;</span>
                               <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coveredRandomFlow</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">coveredRandomFlow</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">coveredFlow</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">coveredRandomFlowCorrect</span><span class="p">,</span>
                                        <span class="p">(</span><span class="n">coveredRandomFlow</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">coveredRandomFlowCorrect</span><span class="p">)</span><span class="o">/</span>
                                        <span class="n">coveredRandomFlowCorrect</span>
                                        <span class="p">))</span>
                
                <span class="c1">#print(operationResultReshaped[np.any(operationResultReshaped &gt; 0, 1)])</span>
                <span class="c1">#print(np.array(spotusage.value)[np.any(operationResultReshaped &gt; 0, 1)])</span>
                
                <span class="k">if</span> <span class="p">((</span><span class="n">operationResult</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">operationResult</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    
                    <span class="c1"># just because there could be multiple feasible solutions</span>
                    <span class="n">spotusage</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">spotNumber</span><span class="p">,</span> <span class="n">shiftNumber</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Reached integer solution&quot;</span><span class="p">)</span>
                    
                    <span class="k">break</span>
                
                <span class="n">operations</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">operationResult</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">spotusageOriginal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spotusage</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
                <span class="n">spotusage</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">spotNumber</span><span class="p">,</span> <span class="n">shiftNumber</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                
                
                <span class="n">remainingBudgetValue</span> <span class="o">=</span> <span class="n">remainingBudget</span><span class="o">.</span><span class="n">value</span>
                
                <span class="n">locationUsed</span> <span class="o">|=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spotusage</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">locationUsed_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">locationUsed</span><span class="p">,</span> <span class="p">(</span><span class="n">shiftNumber</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                <span class="n">affordable</span> <span class="o">=</span> <span class="p">(</span><span class="n">costShift__</span><span class="o">+</span><span class="p">(</span><span class="o">~</span><span class="n">locationUsed_</span><span class="p">)</span><span class="o">*</span><span class="n">costSite</span> <span class="o">&lt;=</span> <span class="n">remainingBudgetValue</span><span class="p">)</span>
                <span class="c1">#covered = np.array(operatingTimeSums.value).astype(bool)</span>
                <span class="n">covered</span> <span class="o">=</span> <span class="p">(</span><span class="n">matrixTimeConstraint</span><span class="o">.</span><span class="n">T</span><span class="nd">@operationConstr</span> <span class="o">+</span> <span class="n">matrixTimeConstraint</span><span class="nd">@operationConstr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">covered</span> <span class="o">|</span> <span class="p">(</span><span class="o">~</span><span class="n">affordable</span><span class="p">)</span> <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">nonIntegralSpot</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e-4</span> <span class="o">&lt;</span> <span class="n">spotusageOriginal</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">spotusageOriginal</span> <span class="o">&lt;</span> <span class="mf">0.999</span><span class="p">)</span>
                <span class="c1">#nonIntegralSpotCosts = (spotusageOriginal[nonIntegralSpot].sum()*costSite</span>
                <span class="c1">#                        +(operationResultReshaped[nonIntegralSpot]*costShift_).sum())</span>
                <span class="n">nonIntegralShift</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1e-4</span> <span class="o">&lt;</span> <span class="n">operatingTimeSumsOriginal</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">operatingTimeSumsOriginal</span> <span class="o">&lt;</span> <span class="mf">0.999</span><span class="p">)</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                addCostSpot = (spotusageOriginal-spotusage.value).round(4).any() * costSite</span>
<span class="sd">                print(remainingBudgetValue, addCostSpot,</span>
<span class="sd">                      2*costShift+addCostSpot-0.0001,</span>
<span class="sd">                      noNewSpot, nonIntegralSpot.any(), constrainNonIntegralShifts, </span>
<span class="sd">                      nonIntegralShift.any(), )</span>
<span class="sd">                &quot;&quot;&quot;</span>
                
                <span class="k">if</span> <span class="n">mask</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">noNewSpot</span><span class="p">:</span>
                        <span class="n">fixedLocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">nonIntegralShift</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">spotNumber</span><span class="p">,</span><span class="n">timeNumber</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="mi">1</span><span class="p">))[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">noNewSpot</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">repetition</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="c1">#if not nonIntegralSpot.any(): # and nonIntegralSpotCosts &gt;= costShift:</span>
                        <span class="c1">#self.prst(&quot;No admissible location is affordable&quot;)</span>
                        <span class="c1">#break</span>
                <span class="c1">#elif fancyRounding and (</span>
                <span class="c1">#        (remainingBudgetValue &lt; 2*costShift+addCostSpot-0.0001 </span>
                <span class="c1">#       and (noNewSpot or not nonIntegralSpot.any())</span>
                <span class="c1">#       and nonIntegralShift.any())</span>
                <span class="c1">#       or constrainNonIntegralShifts):</span>
                <span class="c1">#    constrainNonIntegralShifts = True</span>
                <span class="c1"># if no variable that should be constrained to 0 is positive</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">operationResult</span><span class="p">))[</span><span class="n">operationResult</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    
                    <span class="n">argmax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operationResult</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">))</span>
                    <span class="n">maxLocation</span> <span class="o">=</span> <span class="n">argmax</span> <span class="o">//</span> <span class="n">shiftNumber</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Rounding up location&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIndexToStationID</span><span class="p">[</span>
                                                        <span class="n">relevantStationIndexToStationIndex</span><span class="p">[</span>
                                                           <span class="n">maxLocation</span><span class="p">]])</span>
                    <span class="k">if</span> <span class="n">spotusageOriginal</span><span class="p">[</span><span class="n">maxLocation</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.999</span><span class="p">:</span>
                        <span class="n">intervalCoverage</span> <span class="o">=</span> <span class="n">operatingTimeSums</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">maxLocation</span><span class="o">*</span><span class="n">timeNumber</span><span class="p">:(</span><span class="n">maxLocation</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">timeNumber</span><span class="p">]</span>
                        <span class="n">newIntervalCoverage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ma</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operatingTimeSumsOriginal</span><span class="p">[</span><span class="n">maxLocation</span><span class="o">*</span><span class="n">timeNumber</span><span class="p">:(</span><span class="n">maxLocation</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">timeNumber</span><span class="p">],</span>
                                                          <span class="n">mask</span><span class="o">=</span><span class="n">intervalCoverage</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">))</span>
                        <span class="k">if</span> <span class="n">noNewSpot</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">nonIntegralSpot</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>                                              
                            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                                <span class="n">firstNewIntervalCovered</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">newIntervalCoverage</span><span class="p">)</span>
                                <span class="n">shiftFirstNewIntervalCoverd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">subSubMatrixTime</span><span class="p">[:,</span><span class="n">firstNewIntervalCovered</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">newIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">shiftNumber</span><span class="o">*</span><span class="n">maxLocation</span> <span class="o">+</span> <span class="n">shiftFirstNewIntervalCoverd</span><span class="p">)</span>
                                <span class="k">if</span> <span class="ow">not</span> <span class="n">mask</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]:</span>
                                    <span class="k">break</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">newIntervalCoverage</span><span class="o">.</span><span class="n">mask</span><span class="p">[</span><span class="n">shiftFirstNewIntervalCoverd</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">newIndex</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">argmax</span><span class="p">)</span> <span class="c1"># because np.int64 is not supported</span>
                        <span class="n">operations</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="n">operationConstr</span><span class="p">[</span><span class="n">newIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Rounding up interval [</span><span class="si">{}</span><span class="s2">, </span><span class="si">{}</span><span class="s2">]&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">*</span><span class="n">shiftTimeIntervals</span><span class="p">[</span><span class="n">newIndex</span> <span class="o">%</span> <span class="n">shiftNumber</span><span class="p">]))</span>
                    
                    <span class="n">locationUsed</span><span class="p">[</span><span class="n">maxLocation</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">spotusageConstr</span><span class="p">[</span><span class="n">maxLocation</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">spotusage</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">locationUsed</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                    <span class="n">locationUsed_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">locationUsed</span><span class="p">,</span> <span class="p">(</span><span class="n">shiftNumber</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                    <span class="n">affordable</span> <span class="o">=</span> <span class="p">(</span><span class="n">costShift__</span><span class="o">+</span><span class="p">(</span><span class="o">~</span><span class="n">locationUsed_</span><span class="p">)</span><span class="o">*</span><span class="n">costSite</span> <span class="o">&lt;=</span> <span class="n">remainingBudget</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">((</span><span class="n">noNewSpot</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">nonIntegralSpot</span><span class="o">.</span><span class="n">any</span><span class="p">())</span> <span class="ow">and</span> <span class="ow">not</span>
                        <span class="n">affordable</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">spotNumber</span><span class="p">,</span> <span class="n">shiftNumber</span><span class="p">))[</span><span class="n">maxLocation</span><span class="p">]</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
                        <span class="n">fixedLocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">maxLocation</span><span class="p">)</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixedLocations</span><span class="p">)</span> <span class="o">==</span> <span class="n">locationUsed</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;All locations fixed.&quot;</span><span class="p">)</span>
                            <span class="k">break</span>
                    
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">affordable</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">operatingTimeSums</span><span class="o">.</span><span class="n">value</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                        <span class="c1">#if (nonIntegralSpot &amp; (~locationUsed)).any(): # and </span>
                        <span class="c1">#    #nonIntegralSpotCosts &gt;= costShift):</span>
                        <span class="n">noNewSpot</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="c1">#else:</span>
                        <span class="c1">#    self.prst(&quot;No admissible location is affordable after rounding&quot;)</span>
                        <span class="c1">#    break</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">remainingBudget</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;The budget has been used completely.&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                    
                    <span class="n">chosenLocations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">locationUsed</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">chosenOperations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span>
                                                <span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">spotNumber</span><span class="p">,</span> 
                                                           <span class="n">shiftNumber</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Chose the following spots so far:&quot;</span><span class="p">)</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
                    <span class="n">usedStationIDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIndexToStationID</span><span class="p">[</span>
                                            <span class="n">relevantStationIndexToStationIndex</span><span class="p">[</span>
                                                               <span class="n">chosenLocations</span><span class="p">]]</span>
                    <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">usedStationIDs</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iD</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chosenLocations</span><span class="p">[</span><span class="n">order</span><span class="p">],</span> <span class="n">usedStationIDs</span><span class="p">[</span><span class="n">order</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">iD</span><span class="p">,</span> <span class="o">*</span><span class="n">shiftTimeIntervals</span><span class="p">[</span><span class="n">chosenOperations</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                                  <span class="p">(</span><span class="s2">&quot;*&quot;</span> <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">fixedLocations</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Remaining budget:&quot;</span><span class="p">,</span> <span class="n">remainingBudget</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">baseCost</span><span class="p">)</span>
                    <span class="n">repetition</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">repetition</span><span class="p">:</span>
                        <span class="c1">#fixedLocations.append(np.nonzero((mask &amp; (0 &lt; operationResult))[operationResult&lt;1] // shiftNumber)[0][0])</span>
                        <span class="n">fixedLocations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">((</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;</span> <span class="n">operationResult</span><span class="p">))[</span><span class="n">operationResult</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">shiftNumber</span><span class="p">)</span>
                        <span class="n">repetition</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">repetition</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="c1">#operatingTimeSumsReshaped = np.array(operatingTimeSums.value).reshape((spotNumber, shiftNumber)) </span>
                
                
                <span class="k">if</span> <span class="n">noNewSpot</span> <span class="ow">and</span> <span class="n">relaxAffordable</span><span class="p">:</span>
                    <span class="n">operationConstr</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">noNewSpot</span><span class="p">:</span> 
                    <span class="n">affordable</span><span class="p">[:]</span> <span class="o">=</span> <span class="kc">True</span>
                
                <span class="k">if</span> <span class="n">fixedLocations</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">fixedLocations</span><span class="p">)</span> <span class="o">==</span> <span class="n">locationUsed</span><span class="o">.</span><span class="n">sum</span><span class="p">():</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;All locations fixed.&quot;</span><span class="p">)</span>
                        <span class="k">break</span>
                    
                    <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Fixate spot usage&quot;</span><span class="p">)</span>
                    <span class="n">fixedOperation</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">spotNumber</span><span class="p">,</span> <span class="n">shiftNumber</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                    <span class="n">fixedOperation</span><span class="p">[</span><span class="n">fixedLocations</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="n">fixed</span> <span class="o">=</span> <span class="n">fixedOperation</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
                    <span class="n">operationConstr</span><span class="p">[</span><span class="n">fixed</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">value</span><span class="p">)[</span><span class="n">fixed</span><span class="p">]</span>
                    <span class="c1">#equalityConstraints += [operatingTimeSums[i*timeNumber:(i+1)*timeNumber] </span>
                    <span class="c1">#                            == operatingTimeSums.value[i*timeNumber:(i+1)*timeNumber]</span>
                    <span class="c1">#                            for i in fixedLocations]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fixed</span> <span class="o">=</span> <span class="o">~</span><span class="n">affordable</span>
                
                <span class="n">covered</span> <span class="o">=</span> <span class="p">(</span><span class="n">matrixTimeConstraint</span><span class="o">.</span><span class="n">T</span><span class="nd">@operationConstr</span> <span class="o">+</span> <span class="n">matrixTimeConstraint</span><span class="nd">@operationConstr</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
                <span class="n">previous</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">equalityConstraints</span> <span class="o">=</span> <span class="p">[]</span>
                    
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">itercount</span><span class="p">(),</span> <span class="n">operationConstr</span><span class="p">,</span> <span class="n">covered</span><span class="p">,</span> 
                                      <span class="n">fixed</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">c</span> <span class="ow">or</span> <span class="n">a</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">previous</span><span class="p">:</span>
                            <span class="n">index</span> <span class="o">=</span> <span class="n">i</span>
                            <span class="n">constrArr</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">constrArr</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                        <span class="n">previous</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">previous</span><span class="p">:</span>
                            <span class="n">equalityConstraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operations</span><span class="p">[</span><span class="n">index</span><span class="p">:</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">constrArr</span><span class="p">))</span>
                        <span class="n">previous</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">if</span> <span class="n">previous</span><span class="p">:</span>
                    <span class="n">equalityConstraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">operations</span><span class="p">[</span><span class="n">index</span><span class="p">:]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">constrArr</span><span class="p">))</span>
                
                <span class="c1">#equalityConstraints = [operations[i] == v for i, v, c, a in</span>
                <span class="c1">#                       zip(itercount(), operations.value, </span>
                <span class="c1">#                           operatingTimeSums.value, affordable)</span>
                <span class="c1">#                       if c or not a]</span>
                
                <span class="c1"># just for debugging</span>
                <span class="c1">#equalityConstraints_ = [(self.roadNetwork.stationIndexToStationID[</span>
                <span class="c1">#                                        relevantStationIndexToStationIndex[</span>
                <span class="c1">#                                           i // shiftNumber]],</span>
                <span class="c1">#    i  % shiftNumber,</span>
                <span class="c1">#    operations.value[i], v) for i, v, c, a in</span>
                <span class="c1">#                       zip(itercount(), operations.value, </span>
                <span class="c1">#                           operatingTimeSums.value, affordable)</span>
                <span class="c1">#                       if c or not a]</span>
                <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                if constrainNonIntegralShifts:</span>
<span class="sd">                    self.prst(&quot;Rounding shift choice&quot;)</span>
<span class="sd">                    #TODO make this wrap around the day</span>
<span class="sd">                    newNonIntegralShiftSpot = np.nonzero(nonIntegralShift.reshape((spotNumber,timeNumber)).any(1))[0][0]</span>
<span class="sd">                    nonIntegralShiftSpots = np.unique(np.concatenate([newNonIntegralShiftSpot], nonIntegralShiftSpots)).astype(int)</span>
<span class="sd">                    for i in nonIntegralShiftSpots:</span>
<span class="sd">                        thisSpotOperation = operations.value[i*timeNumber:(i+1)*timeNumber]</span>
<span class="sd">                        coveredIntervals = subSubMatrixTime@thisSpotOperation</span>
<span class="sd">                        roundedIntervals = np.floor(operatingTimeSumsOriginal)[i*timeNumber:(i+1)*timeNumber]</span>
<span class="sd">                        newCoveredIntervals = (roundedIntervals.astype(bool) </span>
<span class="sd">                                               &amp; (~coveredIntervals.astype(bool)))</span>
<span class="sd">                        firstNewIntervalCovered = np.nonzero(newCoveredIntervals)[0][0]</span>
<span class="sd">                        #shiftFirstNewIntervalCoverd = np.nonzero(subSubMatrixTime[:,firstNewIntervalCovered])[0][0]</span>
<span class="sd">                        equalityConstraints.append(operatingTimeSums[i*timeNumber:i*timeNumber+firstNewIntervalCovered+1]</span>
<span class="sd">                                                   == newCoveredIntervals[:firstNewIntervalCovered+1])</span>
<span class="sd">                        </span>
<span class="sd">                    </span>
<span class="sd">                    equalityConstraints += [operatingTimeSums[i*timeNumber:(i+1)*timeNumber] </span>
<span class="sd">                                            == np.floor(operatingTimeSumsOriginal)[i*timeNumber:(i+1)*timeNumber]</span>
<span class="sd">                                            for i in nonIntegralShiftSpots]</span>
<span class="sd">                    spotusage.value = spotusageOriginal</span>
<span class="sd">                    noNewSpot = True</span>
<span class="sd">                &quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="n">noNewSpot</span><span class="p">:</span>
                    <span class="c1"># fixate spotusage</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Fixate spot choice&quot;</span><span class="p">)</span>
                    <span class="n">equalityConstraints</span> <span class="o">+=</span> <span class="p">[</span><span class="n">spotusage</span> <span class="o">==</span> <span class="n">spotusage</span><span class="o">.</span><span class="n">value</span><span class="p">]</span>
                    <span class="n">relaxAffordable</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">equalityConstraints</span> <span class="o">+=</span> <span class="p">[</span><span class="n">spotusage</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span>
                                            <span class="nb">enumerate</span><span class="p">(</span><span class="n">spotusage</span><span class="o">.</span><span class="n">value</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="o">&gt;</span> <span class="mf">0.999</span><span class="p">]</span>
                
                    
                <span class="c1">#y = matrixFlowConstraint*operations.value</span>
                <span class="c1">#equalityConstraints += [flows[i] == 1 for i, v in</span>
                <span class="c1">#                        enumerate(y) if v]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Optimization failed with message:&quot;</span><span class="p">,</span> <span class="n">optimizer</span><span class="o">.</span><span class="n">status</span><span class="p">)</span>
            <span class="k">return</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Optimization process terminated successfully&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;after </span><span class="si">{}</span><span class="s2"> iteration(s).&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">iterations</span><span class="p">))</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">matrixFlowConstraint</span><span class="o">*</span><span class="n">operations</span><span class="o">.</span><span class="n">value</span>
        <span class="n">flows</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">min</span><span class="p">(</span><span class="n">yy</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">yy</span> <span class="ow">in</span> <span class="n">y</span><span class="p">])</span>
        <span class="n">coveredFlowValue</span> <span class="o">=</span> <span class="n">coveredFlow</span><span class="o">.</span><span class="n">value</span>
        <span class="n">operationResult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">spotNumber</span><span class="p">,</span> 
                                                              <span class="n">shiftNumber</span><span class="p">))</span>
        <span class="n">operationResult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">operationResult</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">chosenLocations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">spotusage</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">integer</span><span class="p">:</span>
            <span class="n">intGap</span> <span class="o">=</span> <span class="n">coveredFlowValue</span><span class="o">/</span><span class="n">coveredFlowValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">intGap</span> <span class="o">=</span> <span class="n">coveredFlowValue</span><span class="o">/</span><span class="n">coveredFlowValues</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Covered flow:    </span><span class="si">{}</span><span class="s2"> (</span><span class="si">{:6.2%}</span><span class="s2"> of optimal value; </span><span class="si">{:6.2%}</span><span class="s2"> of total flow)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span> 
                              <span class="n">coveredFlowValue</span><span class="p">,</span> 
                              <span class="n">intGap</span><span class="p">,</span>
                              <span class="n">coveredFlowValue</span><span class="o">/</span><span class="n">totalFlow</span><span class="p">))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignoreRandomFlow</span><span class="p">:</span>
            <span class="n">coveredRandomFlowCorrect</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">operationResult</span><span class="o">*</span><span class="n">shiftTimeFactors</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                                                  <span class="o">*</span><span class="n">c4</span><span class="p">))</span><span class="o">*</span><span class="n">totalRandomFlow</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">((</span><span class="s2">&quot;Random flow: </span><span class="si">{:6.2f}</span><span class="s2"> (</span><span class="si">{:6.2%}</span><span class="s2"> of total covered flow; &quot;</span>
                               <span class="s2">&quot;actual random flow: </span><span class="si">{:6.2f}</span><span class="s2"> (</span><span class="si">{:6.2%}</span><span class="s2"> overestimate)&quot;</span>
                               <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">coveredRandomFlow</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">coveredRandomFlow</span><span class="o">.</span><span class="n">value</span><span class="o">/</span><span class="n">coveredFlow</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                                        <span class="n">coveredRandomFlowCorrect</span><span class="p">,</span>
                                        <span class="p">(</span><span class="n">coveredRandomFlow</span><span class="o">.</span><span class="n">value</span><span class="o">-</span><span class="n">coveredRandomFlowCorrect</span><span class="p">)</span><span class="o">/</span>
                                        <span class="n">coveredRandomFlowCorrect</span>
                                        <span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Remainig budget: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">remainingBudget</span><span class="o">.</span><span class="n">value</span> <span class="o">*</span> <span class="n">baseCost</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Chose the following spots:&quot;</span><span class="p">)</span> 
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        <span class="n">usedStationIDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIndexToStationID</span><span class="p">[</span>
                            <span class="n">relevantStationIndexToStationIndex</span><span class="p">[</span><span class="n">chosenLocations</span><span class="p">]]</span>
        <span class="n">order</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">usedStationIDs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">iD</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">chosenLocations</span><span class="p">[</span><span class="n">order</span><span class="p">],</span> <span class="n">usedStationIDs</span><span class="p">[</span><span class="n">order</span><span class="p">]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">iD</span><span class="p">,</span> <span class="o">*</span><span class="n">shiftTimeIntervals</span><span class="p">[</span><span class="n">operationResult</span><span class="p">[</span><span class="n">i</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="n">ignoreRandomFlow</span><span class="p">:</span>
            <span class="n">coveredFlowCorrect</span> <span class="o">=</span> <span class="n">coveredFlowValue</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">coveredFlowCorrect</span> <span class="o">=</span> <span class="n">coveredRandomFlowCorrect</span> <span class="o">+</span> <span class="n">coveredReducableFlow</span><span class="o">.</span><span class="n">value</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Corrected total flow: </span><span class="si">{:6.2f}</span><span class="s2"> (</span><span class="si">{:6.2%}</span><span class="s2"> error)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">coveredFlowCorrect</span><span class="p">,</span> <span class="p">(</span><span class="n">coveredFlowValue</span><span class="o">-</span><span class="n">coveredFlowCorrect</span><span class="p">)</span><span class="o">/</span><span class="n">coveredFlowCorrect</span><span class="p">))</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">coveredFlowCorrect</span>
        
        
        <span class="k">if</span> <span class="n">extended_info</span><span class="p">:</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;stationID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;flowCover&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;timeCover&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)]</span>
            
            <span class="n">info</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">usedStationIDs</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">info</span><span class="p">[</span><span class="s2">&quot;stationID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usedStationIDs</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">stationIndex</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">chosenLocations</span><span class="p">):</span>
                <span class="n">ops</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">operationResult</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
                <span class="n">ops</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;flowCover&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fullFlowList</span><span class="p">[(</span><span class="n">matrixFlowConstraint</span><span class="nd">@ops</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">flowNumber</span><span class="p">,</span> <span class="n">timeNumber</span><span class="p">))</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
                <span class="n">info</span><span class="p">[</span><span class="s2">&quot;timeCover&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">operationResult</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span>
                                              <span class="o">*</span><span class="n">shiftTimeFactors</span><span class="p">)</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">,</span> <span class="n">coveredFlowCorrect</span><span class="o">/</span><span class="n">totalFlow</span><span class="p">,</span> <span class="n">info</span>
        
        <span class="k">if</span> <span class="n">full_result</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">flows</span><span class="o">.</span><span class="n">value</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">operations</span><span class="o">.</span><span class="n">value</span><span class="p">),</span>
                              <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">spotusage</span><span class="o">.</span><span class="n">value</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">saveFile</span><span class="p">:</span>
            <span class="n">saveobject</span><span class="o">.</span><span class="n">save_object</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.create_caracteristic_plot"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.create_caracteristic_plot">[docs]</a>    <span class="k">def</span> <span class="nf">create_caracteristic_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">characteristic</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> 
                                  <span class="n">characteristicName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">valueNames</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">optim_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates a plot of the characteristics of the optimal inspection</span>
<span class="sd">        policy.</span>
<span class="sd">        </span>
<span class="sd">        The probability that an agent chooses a time while the inspection </span>
<span class="sd">        station is operated is plotted against the expected number of infested</span>
<span class="sd">        agents at the inspection stations for all used inspection stations.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        characteristic : callable/str</span>
<span class="sd">            Property or argument whose impact on the results shall be studeied.</span>
<span class="sd">            If of type `callable`, for each entry ``val`` of :py:obj:`values`,</span>
<span class="sd">            ``callable(self, val)`` will be executed. If of type `str`, it will</span>
<span class="sd">            be interpreted as a keyword argument of </span>
<span class="sd">            :py:obj:`optimize_inspection_station_operation`, which will be set</span>
<span class="sd">            to ``val``.</span>
<span class="sd">        values : arr</span>
<span class="sd">            Array of argument values.</span>
<span class="sd">        characteristicName : str</span>
<span class="sd">            Name of the property/argument that is studied. Used as axis label in</span>
<span class="sd">            the plot and to generate file names.</span>
<span class="sd">        valueNames : str</span>
<span class="sd">            Names of the values of the characteristic (used for the legend).</span>
<span class="sd">        **optim_kwargs : kwargs</span>
<span class="sd">            Keyword arguments passed to </span>
<span class="sd">            :py:obj:`optimize_inspection_station_operation`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">optim_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;characteristic&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">optim_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;full_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">optim_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;extended_info&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">characteristicName</span><span class="p">:</span>
            <span class="n">characteristicName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">characteristic</span><span class="p">)</span>
        
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.17</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.78</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1">#nticks=3, </span>
        
        <span class="n">markers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;o&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;v&quot;</span><span class="p">,</span> <span class="s2">&quot;s&quot;</span><span class="p">,</span> <span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="s2">&quot;D&quot;</span><span class="p">,</span> <span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;X&quot;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">valueNames</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">valueNames</span> <span class="o">=</span> <span class="n">values</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">characteristic</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">):</span>
            <span class="n">optim_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">characteristic</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">val</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">markers</span><span class="p">,</span> <span class="n">valueNames</span><span class="p">):</span>
            <span class="n">name</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">characteristic</span><span class="p">,</span> <span class="s2">&quot;__call__&quot;</span><span class="p">):</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="n">optim_kwargs</span>
                <span class="n">characteristic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
                <span class="n">fileNameAddition</span> <span class="o">=</span> <span class="n">characteristicName</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">name</span><span class="p">[:</span><span class="mi">5</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="n">characteristic</span><span class="p">:</span><span class="n">val</span><span class="p">,</span> <span class="o">**</span><span class="n">optim_kwargs</span><span class="p">}</span>
                <span class="n">fileNameAddition</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                
            <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_inspection_station_operation</span><span class="p">(</span>
                <span class="n">full_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extended_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="n">fileNameAddition</span><span class="o">=</span><span class="n">fileNameAddition</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="n">m</span> <span class="o">==</span> <span class="s2">&quot;.&quot;</span><span class="p">:</span>
                <span class="n">mfc</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfc</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">markerfacecolor</span><span class="o">=</span><span class="s2">&quot;None&quot;</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Covered flow&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;flowCover&quot;</span><span class="p">])</span>
            
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;timeCover&quot;</span><span class="p">],</span> <span class="n">info</span><span class="p">[</span><span class="s2">&quot;flowCover&quot;</span><span class="p">],</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                     <span class="n">marker</span><span class="o">=</span><span class="n">m</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                        <span class="n">label</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="o">**</span><span class="n">mfc</span><span class="p">)</span>
        
        
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Fraction of daily traffic covered&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Daily boater traffic&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s2">&quot;log&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        
        <span class="n">l</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="n">characteristicName</span><span class="p">,</span> <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="s1">&#39;upper left&#39;</span><span class="p">,</span> <span class="n">framealpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span> <span class="c1">#frameon=False loc=&#39;upper left&#39;, </span>
        <span class="c1">#l.get_frame().set_linewidth(0.0)</span>
        
        
        
        <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;Char_&quot;</span> <span class="o">+</span> <span class="n">characteristicName</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
            
            
<div class="viewcode-block" id="HybridVectorModel.create_budget_plots"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.create_budget_plots">[docs]</a>    <span class="k">def</span> <span class="nf">create_budget_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minBudget</span><span class="p">,</span> <span class="n">maxBudget</span><span class="p">,</span> <span class="n">nSteps</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                            <span class="o">**</span><span class="n">optim_kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates plots of the inspection success and price per inspected </span>
<span class="sd">        agent dependent on the invested budget.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        minBudget : float</span>
<span class="sd">            Minimal budget to be considered.</span>
<span class="sd">        maxBudget : float</span>
<span class="sd">            Maximal budget to be considered.</span>
<span class="sd">        nSteps : int</span>
<span class="sd">            Number of budget values to be considered.</span>
<span class="sd">        **optim_kwargs : kwargs</span>
<span class="sd">            Keyword arguments passed to </span>
<span class="sd">            :py:obj:`optimize_inspection_station_operation`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">budgets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">minBudget</span><span class="p">,</span> <span class="n">maxBudget</span><span class="p">,</span> <span class="n">nSteps</span><span class="p">)</span>
        <span class="n">fractions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">budgets</span><span class="p">)</span>
        <span class="n">boaters</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">budgets</span><span class="p">)</span>
        
        <span class="n">optim_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;costBound&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">optim_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;full_result&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">optim_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;extended_info&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">budget</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">budgets</span><span class="p">):</span>
            <span class="n">coveredFlow</span><span class="p">,</span> <span class="n">coveredFraction</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_inspection_station_operation</span><span class="p">(</span>
                <span class="n">costBound</span><span class="o">=</span><span class="n">budget</span><span class="p">,</span> <span class="n">full_result</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">extended_info</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                <span class="o">**</span><span class="n">optim_kwargs</span><span class="p">)</span>
            <span class="n">fractions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coveredFraction</span>
            <span class="n">boaters</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">coveredFlow</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Budgets&quot;</span><span class="p">,</span> <span class="n">budgets</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Covered Fractions&quot;</span><span class="p">,</span> <span class="n">fractions</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Boaters&quot;</span><span class="p">,</span> <span class="n">boaters</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Price&quot;</span><span class="p">,</span> <span class="n">budgets</span><span class="o">/</span><span class="n">boaters</span><span class="p">)</span>
        
        <span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.78</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Budget&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Fraction of boaters inspected&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">budgets</span><span class="p">,</span> <span class="n">fractions</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">budgets</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">budgets</span><span class="p">)</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span><span class="p">,</span> <span class="s2">&quot;:k&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1">#nticks=3, </span>
        <span class="c1">#plt.tight_layout()</span>
        
        <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;Budget&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">([</span><span class="n">minBudget</span><span class="p">,</span> <span class="n">maxBudget</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        
        <span class="n">rect</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.18</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.78</span><span class="p">]</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">)</span><span class="o">.</span><span class="n">add_axes</span><span class="p">(</span><span class="n">rect</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Costs per inspected high-risk boater&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Fraction of boaters inspected&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fractions</span><span class="p">,</span> <span class="n">budgets</span><span class="o">/</span><span class="n">boaters</span><span class="p">,</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">locator_params</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span> <span class="c1">#nticks=3, </span>
        
        <span class="c1">#plt.tight_layout()</span>
        
        <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;Price&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">([</span><span class="n">minBudget</span><span class="p">,</span> <span class="n">maxBudget</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        fig, ax1 = plt.subplots()</span>

<span class="sd">        ax1.set_xlabel(&#39;Budget&#39;)</span>
<span class="sd">        ax1.set_ylabel(&#39;Fraction of boaters inspected&#39;)</span>
<span class="sd">        ax1.plot(budgets, fractions)</span>
<span class="sd">        ax1.plot(budgets, np.ones_like(budgets)*self.complianceRate, &quot;:k&quot;)</span>
<span class="sd">        ax1.set_ylim((0, 1))</span>
<span class="sd">        ax1.locator_params(nticks=3, nbins=3)</span>
<span class="sd">        </span>
<span class="sd">        ax2 = ax1.twinx()  # instantiate a second axes that shares the same x-axis</span>
<span class="sd">        ax2.set_ylabel(&#39;Price per boater&#39;)</span>
<span class="sd">        ax2.plot(budgets, budgets/boaters, &quot;-&quot;, color=&quot;C1&quot;)</span>
<span class="sd">        ax2.locator_params(nticks=3, nbins=3)</span>
<span class="sd">        fig.tight_layout()</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
        
<div class="viewcode-block" id="HybridVectorModel.get_pair_distribution_property"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.get_pair_distribution_property">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">_get_k_q</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_pair_distribution_property</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dist_property</span><span class="o">=</span><span class="n">nbinom</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">arg</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                      <span class="n">pair</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shiftStart</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                      <span class="n">shiftEnd</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes a property of the distribution of the agent flow </span>
<span class="sd">        between origin-destination pairs. </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        dist_property : callable</span>
<span class="sd">            The distribution property of interest. Must be properties </span>
<span class="sd">            :py:obj:`scipy.stats.nbinom`. Can also be a list of </span>
<span class="sd">            properties.</span>
<span class="sd">        arg : float</span>
<span class="sd">            Additional argument for :py:obj:`dist_property`. For example which</span>
<span class="sd">            quantile is desired, if `dist_property==nbinom.ppf`. Can also be</span>
<span class="sd">            of type `float[]`.</span>
<span class="sd">        pair : tuple</span>
<span class="sd">            The origin-destination pair(s) of interest as ``(fromIndex, toIndex)``</span>
<span class="sd">            respectively. If ``None``, the property will be computed for all</span>
<span class="sd">            origin-destination pairs.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">k</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_k_q</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="n">shiftStart</span><span class="p">,</span> <span class="n">shiftEnd</span><span class="p">)</span>
        <span class="n">qm</span> <span class="o">=</span> <span class="mi">1</span><span class="o">-</span><span class="n">q</span>
        <span class="k">if</span> <span class="n">arg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dist_property</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">qm</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">dist_property</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dist_property</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">qm</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">dist_property</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">qm</span><span class="p">)</span> <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">m</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">qm</span><span class="p">)</span> 
                            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">dist_property</span><span class="p">,</span> <span class="n">arg</span><span class="p">)]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">[</span><span class="n">m</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">qm</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">dist_property</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">dist_property</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">qm</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.get_station_observation_prediction"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.get_station_observation_prediction">[docs]</a>    <span class="k">def</span> <span class="nf">get_station_observation_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns observed and predicted agent counts for the inspection</span>
<span class="sd">        locations for which data are available.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        predictions : struct[]</span>
<span class="sd">            If the predictions have been computed earlier, they can be provided</span>
<span class="sd">            as this argument. Otherwise the predictions will be computed anew.</span>
<span class="sd">            Must be the results of :py:meth:`get_station_mean_variance`.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">countData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span>
            
        <span class="k">if</span> <span class="n">predictions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rawPredictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_station_mean_variance</span><span class="p">(</span>
                    <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">],</span> <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">],</span> 
                    <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">rawPredictions</span> <span class="o">=</span> <span class="n">predictions</span>
        <span class="c1">#                            count, mean, variance</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
        
        <span class="k">for</span> <span class="n">stationID</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">mean</span><span class="p">,</span> <span class="n">variance</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">rawPredictions</span><span class="p">[</span><span class="s2">&quot;stationID&quot;</span><span class="p">],</span> 
                                                    <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;totalCount&quot;</span><span class="p">],</span>
                                                    <span class="n">rawPredictions</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> 
                                                    <span class="n">rawPredictions</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]):</span>
            <span class="n">item</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="n">stationID</span><span class="p">]</span>
            <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
            <span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">mean</span>
            <span class="n">item</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+=</span> <span class="n">variance</span>
        
        <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;stationID&quot;</span><span class="p">,</span> <span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;variance&quot;</span><span class="p">],</span> 
                 <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="n">IDTYPE</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">]}</span>
        
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">iD</span><span class="p">,</span> <span class="o">*</span><span class="n">vals</span><span class="p">)</span> <span class="k">for</span> <span class="n">iD</span><span class="p">,</span> <span class="n">vals</span> <span class="ow">in</span> <span class="n">predictions</span><span class="o">.</span><span class="n">items</span><span class="p">()],</span> 
                        <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.get_normalized_observation_prediction"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.get_normalized_observation_prediction">[docs]</a>    <span class="k">def</span> <span class="nf">get_normalized_observation_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minSampleSize</span><span class="o">=</span><span class="mi">20</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the mean observed and predicted agent counts at survey </span>
<span class="sd">        locations, thereby scaling the values so that they should come from</span>
<span class="sd">        a normal distribution.</span>
<span class="sd">        </span>
<span class="sd">        Only data obtained between a specific daytime interval will be </span>
<span class="sd">        considered to ensure individual observations are identically distributed</span>
<span class="sd">        and will yield a normal distribution when added together.</span>
<span class="sd">        </span>
<span class="sd">        </span>
<span class="sd">        minSampleSize : int</span>
<span class="sd">            The minimal number of survey shifts that must be available before</span>
<span class="sd">            a survey location can be considered. If this value is too low, the</span>
<span class="sd">            resulting values will not follow an approximate normal distribution.</span>
<span class="sd">            If the value is too large, no data will be available to compute the</span>
<span class="sd">            results.</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">countData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span>
        <span class="n">countData</span> <span class="o">=</span> <span class="n">countData</span><span class="p">[</span><span class="n">countData</span><span class="p">[</span><span class="s2">&quot;prunedCount&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># use only observations with a sufficiently large sample</span>
        <span class="n">stationIndices</span><span class="p">,</span> <span class="n">reverse_indices</span><span class="p">,</span> <span class="n">counts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">countData</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">],</span> 
                                                            <span class="n">return_inverse</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                                            <span class="n">return_counts</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">considered</span> <span class="o">=</span> <span class="n">counts</span> <span class="o">&gt;=</span> <span class="n">minSampleSize</span>
        <span class="n">stationIndices</span> <span class="o">=</span> <span class="n">stationIndices</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
        
        <span class="n">resultDType</span> <span class="o">=</span> <span class="p">[(</span><span class="s2">&quot;stationID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;observed&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;predicted&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;observedMean&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;observedMeanScaled&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span>
                       <span class="p">(</span><span class="s2">&quot;predictedMeanScaled&quot;</span><span class="p">,</span> <span class="nb">float</span><span class="p">)]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">stationIndices</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">resultDType</span><span class="p">)</span>
        
        <span class="n">counts</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">considered</span><span class="p">]</span>
        
        <span class="n">rawPredictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_station_mean_variance</span><span class="p">(</span>
                <span class="n">stationIndices</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pruneStartTime&quot;</span><span class="p">],</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pruneEndTime&quot;</span><span class="p">])</span>
        
        <span class="n">resultData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">stationIndices</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">resultDType</span><span class="p">)</span>
        <span class="n">resultData</span><span class="p">[</span><span class="s2">&quot;stationID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rawPredictions</span><span class="p">[</span><span class="s2">&quot;stationID&quot;</span><span class="p">]</span>
        
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">considered</span><span class="p">)[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">resultData</span><span class="p">[</span><span class="s2">&quot;observed&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">countData</span><span class="p">[</span><span class="s2">&quot;prunedCount&quot;</span><span class="p">][</span>
                                                    <span class="n">reverse_indices</span><span class="o">==</span><span class="n">station</span><span class="p">])</span>
            <span class="n">resultData</span><span class="p">[</span><span class="s2">&quot;observedMean&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">countData</span><span class="p">[</span><span class="s2">&quot;prunedCount&quot;</span><span class="p">][</span>
                                                    <span class="n">reverse_indices</span><span class="o">==</span><span class="n">station</span><span class="p">])</span>
        
        <span class="c1"># get the observed and predicted mean values</span>
        <span class="n">resultData</span><span class="p">[</span><span class="s2">&quot;predicted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rawPredictions</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
        
        <span class="c1"># get the predicted varience (note: By CLT, the variance decreases </span>
        <span class="c1">#                                   with the number of samples)</span>
        <span class="c1"># scale the mean values to have a variance of 1 so that they become </span>
        <span class="c1"># comparable (note: By CLT they are approximately normal distributed)</span>
        <span class="n">resultData</span><span class="p">[</span><span class="s2">&quot;observed&quot;</span><span class="p">]</span> <span class="o">-=</span> <span class="n">counts</span><span class="o">*</span><span class="n">rawPredictions</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
        <span class="n">resultData</span><span class="p">[</span><span class="s2">&quot;observed&quot;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">rawPredictions</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">counts</span><span class="p">)</span>
        <span class="n">resultData</span><span class="p">[</span><span class="s2">&quot;observed&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">rawPredictions</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
        <span class="n">stdFact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">counts</span> <span class="o">/</span> <span class="n">rawPredictions</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">])</span>
        <span class="n">resultData</span><span class="p">[</span><span class="s2">&quot;observedMeanScaled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">resultData</span><span class="p">[</span><span class="s2">&quot;observedMean&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">stdFact</span>
        <span class="n">resultData</span><span class="p">[</span><span class="s2">&quot;predictedMeanScaled&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rawPredictions</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">*</span> <span class="n">stdFact</span>
        
        <span class="k">return</span> <span class="n">resultData</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.get_pair_observation_prediction"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.get_pair_observation_prediction">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">get_station_observation_prediction</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_pair_observation_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returnes predicted and observed agent counts by origin-destination </span>
<span class="sd">        pair. </span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">predictions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">countData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_station_mean_variance</span><span class="p">(</span>
                    <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">],</span> <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">],</span> 
                    <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">],</span> <span class="n">getStationResults</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">getPairResults</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            
        <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;count&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;variance&quot;</span><span class="p">],</span> 
                 <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="nb">int</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">]}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pairCountData&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pairCountData&quot;</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">predictions</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">result</span></div>
    
    
<div class="viewcode-block" id="HybridVectorModel.check_count_distributions_NB"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.check_count_distributions_NB">[docs]</a>    <span class="k">def</span> <span class="nf">check_count_distributions_NB</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minDataSetSize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks whether the observed data may be normally distributed.</span>
<span class="sd">        </span>
<span class="sd">        Computes p-values for the test with null hypothesis </span>
<span class="sd">        `H0: Data are negative binomially distributed`. If the p-values are</span>
<span class="sd">        high, we cannot reject the hypothesis and may conclude that the negative</span>
<span class="sd">        binomial distribution is modelling the data appropriately.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        minDataSetSize : int</span>
<span class="sd">            It is necessary that parts of the considered data are identically</span>
<span class="sd">            distributed and that the samples are large enough. :py:obj:`minDataSetSize` </span>
<span class="sd">            sets the minimal size of such a data set.</span>
<span class="sd">        fileName : str</span>
<span class="sd">            Names of the files to which plots of the resulting p-values will be </span>
<span class="sd">            saved.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Checking whether the count data follow a negative &quot;</span>
                  <span class="o">+</span> <span class="s2">&quot;binomial distribution&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="n">allObservations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">allParams</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">allCountData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">][</span><span class="s2">&quot;prunedCount&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">totalCount</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">stationIndex</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">usedStationIndexToStationIndex</span><span class="p">:</span> 
            <span class="n">stationID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIndexToStationID</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Station:&quot;</span><span class="p">,</span> <span class="n">stationID</span><span class="p">)</span>
            
            <span class="n">countData</span> <span class="o">=</span> <span class="n">allCountData</span><span class="p">[</span><span class="n">allCountData</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">]</span> 
                                     <span class="o">==</span> <span class="n">stationIndex</span><span class="p">][</span><span class="s2">&quot;prunedCountData&quot;</span><span class="p">]</span>
            
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">countData</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">minDataSetSize</span><span class="p">:</span>
                <span class="k">continue</span>
            
            <span class="n">observations</span> <span class="o">=</span> <span class="n">FlexibleArrayDict</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">countData</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">100</span><span class="p">),</span> 
                 <span class="n">countData</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="n">FlexibleArrayDict</span><span class="p">(</span>
                <span class="p">(</span><span class="mi">3</span><span class="o">*</span><span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">countData</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="mi">100</span><span class="p">),</span> <span class="mi">2</span><span class="p">)</span>
                <span class="p">)</span>
            
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obsdict</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">countData</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">pair</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">obsdict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">pair</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parameters</span><span class="o">.</span><span class="n">indexDict</span><span class="p">:</span>
                        <span class="n">k</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_k_q</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> 
                                 <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pruneStartTime&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pruneEndTime&quot;</span><span class="p">],</span> 
                                 <span class="n">stationIndex</span><span class="p">)</span>
                        <span class="n">parameters</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">])</span>
                    <span class="n">observations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span>
            
            <span class="n">allObservations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">observations</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span>
            <span class="n">allParams</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parameters</span><span class="o">.</span><span class="n">get_array</span><span class="p">())</span>
            <span class="n">totalCount</span> <span class="o">+=</span> <span class="n">observations</span><span class="o">.</span><span class="n">size</span>
            
        <span class="n">pModelAgg</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Computing p-values (</span><span class="si">{}</span><span class="s2"> distributions)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">totalCount</span><span class="p">))</span>
        <span class="n">resolution</span> <span class="o">=</span> <span class="mi">50</span>
        <span class="n">testN</span> <span class="o">=</span> <span class="mi">20</span>
        <span class="n">counter</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">totalCount</span><span class="o">*</span><span class="n">testN</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">testN</span><span class="p">):</span>
            <span class="n">pValuesModel</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">modelData</span> <span class="o">=</span> <span class="p">[]</span>
            
            <span class="k">with</span> <span class="n">ProcessPoolExecutor</span><span class="p">()</span> <span class="k">as</span> <span class="n">pool</span><span class="p">:</span>
                <span class="n">modelPs</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">anderson_darling_NB</span><span class="p">,</span> <span class="n">iterchain</span><span class="p">(</span><span class="o">*</span><span class="n">allObservations</span><span class="p">),</span>
                                   <span class="n">iterchain</span><span class="p">(</span><span class="o">*</span><span class="n">allParams</span><span class="p">),</span> <span class="n">repeat</span><span class="p">(</span><span class="kc">False</span><span class="p">),</span> 
                                   <span class="n">repeat</span><span class="p">(</span><span class="mi">100</span><span class="p">))</span> 
                <span class="k">for</span> <span class="n">pModel</span><span class="p">,</span> <span class="n">cModel</span> <span class="ow">in</span> <span class="n">modelPs</span><span class="p">:</span>
                    <span class="n">modelData</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cModel</span><span class="p">)</span>
                    <span class="n">pValuesModel</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pModel</span><span class="p">)</span>
                    
                    <span class="n">percentage</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">percentage</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">percentage</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                
            <span class="n">modelData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">modelData</span><span class="p">)</span>
            <span class="n">ecmf</span> <span class="o">=</span> <span class="n">ECDF</span><span class="p">(</span><span class="n">modelData</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">modelData</span><span class="p">)</span>
            <span class="n">pModelAgg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">anderson_darling_test_discrete</span><span class="p">(</span><span class="n">pValuesModel</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ecmf</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="kc">True</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;p-value that data come from model&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pModelAgg</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Standard deviation:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pModelAgg</span><span class="p">),</span> <span class="s2">&quot;| Results&quot;</span><span class="p">,</span> <span class="n">pModelAgg</span><span class="p">)</span>
        <span class="c1">#sumv = np.array([np.sum(r) for r in iterchain(*allObservations)])</span>
        <span class="c1">#pValues = pValues[sumv&gt;2,:]</span>
        
        <span class="n">pmfhist</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">def</span> <span class="nf">reducedPmfhist</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
            <span class="n">freq</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">pmfhist</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">0</span>
            <span class="k">return</span> <span class="n">freq</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">bins</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">mask</span><span class="p">]</span>
        
        <span class="n">lenv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">iterchain</span><span class="p">(</span><span class="o">*</span><span class="n">allObservations</span><span class="p">)])</span> <span class="c1">#[sumv&gt;2]</span>
        
        <span class="n">maxv</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">iterchain</span><span class="p">(</span><span class="o">*</span><span class="n">allObservations</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Distribution of the maximal count values&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">reducedPmfhist</span><span class="p">(</span><span class="n">maxv</span><span class="p">))</span>
        <span class="n">sumv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">iterchain</span><span class="p">(</span><span class="o">*</span><span class="n">allObservations</span><span class="p">)])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Distribution of the total count values&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">reducedPmfhist</span><span class="p">(</span><span class="n">sumv</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Distribution of sample sizes&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">reducedPmfhist</span><span class="p">(</span><span class="n">lenv</span><span class="p">))</span>
        
        <span class="n">c</span> <span class="o">=</span> <span class="n">Counter</span><span class="p">(</span><span class="n">totalCount</span><span class="o">*</span><span class="n">testN</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">counter</span><span class="p">():</span>
            <span class="n">perc</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">next</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">perc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">perc</span><span class="p">,</span> <span class="n">percent</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Computing p-values to check the general distribution&quot;</span><span class="p">)</span>
        <span class="n">pNBs</span> <span class="o">=</span> <span class="p">[</span><span class="n">anderson_darling_P</span><span class="p">(</span><span class="n">iterchain</span><span class="p">(</span><span class="o">*</span><span class="n">allObservations</span><span class="p">),</span> <span class="kc">False</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">testN</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;p-value that data are NB distributed&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pNBs</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Standard deviation:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pNBs</span><span class="p">),</span> <span class="s2">&quot;| Results&quot;</span><span class="p">,</span> <span class="n">pNBs</span><span class="p">)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">reset</span><span class="p">()</span>
        <span class="n">pPoiss</span> <span class="o">=</span> <span class="p">[</span><span class="n">anderson_darling_P</span><span class="p">(</span><span class="n">iterchain</span><span class="p">(</span><span class="o">*</span><span class="n">allObservations</span><span class="p">),</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">testN</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;p-value that data are Poisson distributed&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">pPoiss</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Standard deviation:&quot;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">pPoiss</span><span class="p">),</span> <span class="s2">&quot;| Results&quot;</span><span class="p">,</span> <span class="n">pPoiss</span><span class="p">)</span>
        
        
        <span class="n">freqM</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">pValuesModel</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        <span class="n">xModelRes</span><span class="p">,</span> <span class="n">bins</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">modelData</span><span class="p">,</span> <span class="n">resolution</span><span class="p">,</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Plotting p-values&quot;</span><span class="p">)</span>
            <span class="c1">#plt.plot(np.insert(np.cumsum(xNBres), 0, 0), </span>
            <span class="c1">#         np.insert(np.cumsum(freq)/np.sum(freq), 0, 0))</span>
            <span class="c1">#plt.plot(np.insert(np.cumsum(xPoisres), 0, 0), </span>
            <span class="c1">#         np.insert(np.cumsum(freqP)/np.sum(freqP), 0, 0))</span>
            <span class="c1">#plt.plot(np.insert(np.cumsum(xModelRes)/np.sum(xModelRes), 0, 0), </span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">xModelRes</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xModelRes</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> 
                     <span class="n">np</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">freqM</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">freqM</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
            <span class="c1">#plt.plot(bins, np.insert(np.cumsum(freqP1)/np.sum(freqP1), 0, 0))</span>
            <span class="c1">#plt.plot(bins, np.insert(np.cumsum(freq10/np.sum(freq10)), 0, 0))</span>
            <span class="c1">#plt.plot(bins, np.insert(np.cumsum(freq20/np.sum(freq20)), 0, 0))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;k--&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span></div>
        
    
<div class="viewcode-block" id="HybridVectorModel.compare_travel_time_distributions"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.compare_travel_time_distributions">[docs]</a>    <span class="k">def</span> <span class="nf">compare_travel_time_distributions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">saveFileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compares agents&#39; travel time distributions at different survey</span>
<span class="sd">        locations.</span>
<span class="sd">        </span>
<span class="sd">        Conducts likelihood ratio tests evaluating whether multiple </span>
<span class="sd">        distributions are equal and plots the respective best-fitting time</span>
<span class="sd">        distributions at different locations.</span>
<span class="sd">        </span>
<span class="sd">        Compares not only travel time distributions at different locations but </span>
<span class="sd">        also travel time distributions of local and long-distance travellers.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        saveFileName : str</span>
<span class="sd">            File name for plots.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating traffic distribution comparison plots&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="c1"># create comparison plots</span>
        <span class="n">times</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">5000</span><span class="p">)</span>
        <span class="n">yLabel</span> <span class="o">=</span> <span class="s2">&quot;Traffic Density&quot;</span>
        <span class="n">xLabel</span> <span class="o">=</span> <span class="s2">&quot;Time&quot;</span>
        
        <span class="c1"># compare long distance versus short distance</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">longDistDistribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_travel_time_model</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">restDistribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_travel_time_model</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">H0Distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_travel_time_model</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> 
                             <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iterchain</span><span class="p">((</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;longDistTimeData&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()),</span> 
                                 <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;restTimeData&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">()))})</span> <span class="c1">#dict must be merged without overwriting keys!</span>
        
        
        <span class="n">LR</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">H0Distribution</span><span class="o">.</span><span class="n">negLL</span> <span class="o">-</span> <span class="n">longDistDistribution</span><span class="o">.</span><span class="n">negLL</span> <span class="o">-</span> 
                  <span class="n">restDistribution</span><span class="o">.</span><span class="n">negLL</span><span class="p">)</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">plh</span> <span class="o">=</span> <span class="s2">&quot;   &quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;H0: Long distance and rest have same distribution.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">plh</span><span class="p">,</span> <span class="s2">&quot;-2*ln(LR):&quot;</span><span class="p">,</span> <span class="n">LR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">plh</span><span class="p">,</span> <span class="s2">&quot;p-Value:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">longDistDistribution</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> 
                 <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Long-Distance Traffic&quot;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">restDistribution</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Other Traffic&quot;</span><span class="p">)</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">yLabel</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xLabel</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">saveFileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">saveFileName</span> <span class="o">+</span> <span class="s2">&quot;_LongVsRest&quot;</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)</span>
        
        <span class="n">longDistTimeData</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> 
                            <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;longDistTimeData&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">50</span><span class="p">}</span>
        <span class="n">restTimeData</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="p">:</span><span class="n">val</span> <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> 
                        <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;restTimeData&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">&gt;=</span><span class="mi">50</span><span class="p">}</span>
        
        <span class="c1"># compare traffic at the different sites</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">long</span><span class="p">,</span> <span class="n">nameExt</span> <span class="ow">in</span> <span class="p">((</span><span class="n">longDistTimeData</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;long&quot;</span><span class="p">),</span>
                                    <span class="p">(</span><span class="n">restTimeData</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;rest&quot;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
                <span class="k">continue</span>
            
            <span class="n">LR</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)))</span>
            <span class="n">nLL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
            
            <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">keyList</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">label</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keyList</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_travel_time_model</span><span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">long</span><span class="p">)</span>
                    <span class="n">nLL</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">negLL</span>
                    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">dist</span><span class="o">.</span><span class="n">negLL</span><span class="p">):</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">dist</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">times</span><span class="p">),</span> 
                             <span class="n">label</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIndexToStationID</span><span class="p">[</span>
                                                                        <span class="n">label</span><span class="p">]))</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keyList</span><span class="p">)):</span>
                    <span class="n">label2</span> <span class="o">=</span> <span class="n">keyList</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">dist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_travel_time_model</span><span class="p">([</span><span class="n">label</span><span class="p">,</span> 
                                                                   <span class="n">label2</span><span class="p">],</span> 
                                                                  <span class="n">long</span><span class="p">)</span>
                        <span class="n">LR</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">LR</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">negLL</span>
                    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                        <span class="k">pass</span>
            
            <span class="n">nLLH0</span> <span class="o">=</span> <span class="n">nLL</span> <span class="o">+</span> <span class="n">nLL</span><span class="p">[:,</span><span class="kc">None</span><span class="p">]</span>
            <span class="n">LR</span> <span class="o">-=</span> <span class="n">nLLH0</span>
            <span class="n">LR</span> <span class="o">*=</span> <span class="mi">2</span>
            
            <span class="c1"># nan matrix entries result here only from inf-inf. This, in turn,</span>
            <span class="c1"># happens only if all entries are similar, which implies that</span>
            <span class="c1"># the MLs are equal</span>
            <span class="c1">#LR[np.isnan(nLLH0)] = 0</span>
            
            <span class="c1"># we cannot draw inference over distributions with too few data</span>
            <span class="c1"># therefore, we set those with too few data to nan.</span>
            <span class="n">LR</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isinf</span><span class="p">(</span><span class="n">nLLH0</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="mi">2</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Considered stations:&quot;</span><span class="p">,</span> 
                      <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIndexToStationID</span><span class="p">[</span>
                           <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">keys</span><span class="p">())])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Respective numbers of data points:&quot;</span><span class="p">,</span> 
                      <span class="o">*</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">values</span><span class="p">()))</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;H0: Locations have pair-wise same distribution. (&quot;</span> 
                      <span class="o">+</span> <span class="n">nameExt</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">plh</span><span class="p">,</span> <span class="s2">&quot;-2*ln(LR):&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">plh</span><span class="p">,</span> <span class="s2">&quot;p-Value:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
            
            <span class="n">someInfNan</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nLL</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">someInfNan</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Some likelihood values are NaNs or Infs. &quot;</span><span class="o">+</span>
                              <span class="s2">&quot;The following reuslt may be biased.&quot;</span><span class="p">)</span>
                
            <span class="n">H0Distribution</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__create_travel_time_model</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> 
                                                                <span class="n">data</span><span class="p">)</span>
            <span class="n">LR</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">H0Distribution</span><span class="o">.</span><span class="n">negLL</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nLL</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nLL</span><span class="p">)]))</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">chi2</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">LR</span><span class="p">,</span> <span class="n">df</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">nLL</span><span class="p">))</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;H0: All locations have same distribution. (&quot;</span> 
                      <span class="o">+</span> <span class="n">nameExt</span> <span class="o">+</span> <span class="s2">&quot;)&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">plh</span><span class="p">,</span> <span class="s2">&quot;-2*ln(LR):&quot;</span><span class="p">,</span> <span class="n">LR</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">plh</span><span class="p">,</span> <span class="s2">&quot;p-Value:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            
            
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="n">yLabel</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="n">xLabel</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">saveFileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">fn</span> <span class="o">=</span> <span class="n">saveFileName</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">nameExt</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span> <span class="o">+</span> <span class="s2">&quot;.pdf&quot;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fn</span> <span class="o">+</span> <span class="s2">&quot;.png&quot;</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span></div>
    
    
    
<div class="viewcode-block" id="HybridVectorModel.get_PMF_observation_prediction"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.get_PMF_observation_prediction">[docs]</a>    <span class="k">def</span> <span class="nf">get_PMF_observation_prediction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stationID</span><span class="p">,</span> <span class="n">fromID</span><span class="p">,</span> <span class="n">toID</span><span class="p">,</span> <span class="n">xMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                                       <span class="n">getBestPMF</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                                       <span class="n">getPureObservations</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determines the observed and predicted probability mass function for </span>
<span class="sd">        agent counts between specific origin-destination pairs.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stationID : :py:data:`IDTYPE`</span>
<span class="sd">            ID of the survey location where the considered data have been </span>
<span class="sd">            collected. Can be an array.</span>
<span class="sd">        fromID : :py:data:`IDTYPE`</span>
<span class="sd">            ID of the origin of the considered agents. Can be an array.</span>
<span class="sd">        toID : :py:data:`IDTYPE`</span>
<span class="sd">            ID of the destination of the considered agents. Can be an array.</span>
<span class="sd">        xMax : int</span>
<span class="sd">            Count value up to which the probablity mass function is plotted</span>
<span class="sd">            at least. If not given, the probability mass function will be </span>
<span class="sd">            computed up to the maximal observed count value.</span>
<span class="sd">        getBestPMF : bool</span>
<span class="sd">            If ``True``, a negative binomial distribution will be fitted </span>
<span class="sd">            directly to the observed data. This can be helpful if it is of</span>
<span class="sd">            interest whether the observations come from a negative binomial </span>
<span class="sd">            distribution.</span>
<span class="sd">        getPureObservations : bool</span>
<span class="sd">            Whether the pure observed count data shall be returned in addition</span>
<span class="sd">            to the other results.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">stationIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIDToStationIndex</span><span class="p">[</span><span class="n">stationID</span><span class="p">]</span>
        <span class="n">fromIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sourceIDToSourceIndex</span><span class="p">[</span><span class="n">fromID</span><span class="p">]</span>
        <span class="n">toIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sinkIDToSinkIndex</span><span class="p">[</span><span class="n">toID</span><span class="p">]</span>
        
        <span class="n">countData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span>
        <span class="n">countData</span> <span class="o">=</span> <span class="n">countData</span><span class="p">[</span><span class="n">countData</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">stationIndex</span><span class="p">]</span>
        <span class="n">countData</span> <span class="o">=</span> <span class="n">countData</span><span class="p">[</span><span class="n">countData</span><span class="p">[</span><span class="s2">&quot;prunedCount&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">countData</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No observations have been made at the specified &quot;</span> <span class="o">+</span>
                             <span class="s2">&quot;inspection spot. I stop comparing the distributions.&quot;</span>
                             <span class="p">)</span>
            
        <span class="n">pair</span> <span class="o">=</span> <span class="p">(</span><span class="n">fromIndex</span><span class="p">,</span> <span class="n">toIndex</span><span class="p">)</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="p">[</span><span class="n">obsdict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pair</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> 
                        <span class="k">for</span> <span class="n">obsdict</span> <span class="ow">in</span> <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;prunedCountData&quot;</span><span class="p">]]</span>
        
        <span class="n">observations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">xMax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">xMax</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">xMax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">observations</span><span class="p">),</span> <span class="n">xMax</span><span class="p">)</span>
        
        <span class="n">observedPMF</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">xMax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">xMax</span><span class="o">+</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="n">observedPMF</span> <span class="o">=</span> <span class="n">observedPMF</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">observedPMF</span><span class="p">)</span>
        
        
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">xMax</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
                
        <span class="n">k</span><span class="p">,</span> <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_k_q</span><span class="p">((</span><span class="n">fromIndex</span><span class="p">,</span> <span class="n">toIndex</span><span class="p">),</span> 
                             <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pruneStartTime&quot;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;pruneEndTime&quot;</span><span class="p">],</span> 
                             <span class="n">stationIndex</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">):</span> <span class="n">k</span> <span class="o">=</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">predictedPMF</span> <span class="o">=</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">observedPMF</span><span class="p">,</span> <span class="n">predictedPMF</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">getBestPMF</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">negLogLikelihood</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
                <span class="n">kk</span><span class="p">,</span> <span class="n">qq</span> <span class="o">=</span> <span class="n">parameters</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">nbinom</span><span class="o">.</span><span class="n">logpmf</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">kk</span><span class="p">),</span>
                                             <span class="mi">1</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">qq</span><span class="o">*</span><span class="n">qq</span><span class="p">)))</span>
            
            <span class="n">x0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> 
            <span class="n">optResult</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">basinhopping</span><span class="p">(</span><span class="n">negLogLikelihood</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> 
                                        <span class="n">minimizer_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;method&quot;</span><span class="p">:</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span>
                                                  <span class="s2">&quot;options&quot;</span><span class="p">:{</span><span class="s2">&quot;maxiter&quot;</span><span class="p">:</span><span class="mi">300</span><span class="p">}})</span>
            
            <span class="n">bestK</span><span class="p">,</span> <span class="n">bestQ</span> <span class="o">=</span> <span class="n">optResult</span><span class="o">.</span><span class="n">x</span>
            <span class="n">bestK</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">bestK</span><span class="p">)</span>
            <span class="n">bestQ</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">bestQ</span><span class="o">*</span><span class="n">bestQ</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Optimal k and q for this pair and this station&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;compared to the predicted k and q:&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Optimal k:&quot;</span><span class="p">,</span> <span class="n">bestK</span><span class="p">,</span> <span class="s2">&quot;- Predicted k:&quot;</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Optimal q:&quot;</span><span class="p">,</span> <span class="n">bestQ</span><span class="p">,</span> <span class="s2">&quot;- Predicted q:&quot;</span><span class="p">,</span> <span class="n">q</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
            
            <span class="n">bestPMF</span> <span class="o">=</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">bestK</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">bestQ</span><span class="p">)</span>
            
            <span class="n">result</span> <span class="o">+=</span> <span class="p">(</span><span class="n">bestPMF</span><span class="p">,</span> <span class="p">)</span>
            
        <span class="k">if</span> <span class="n">getPureObservations</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">+=</span> <span class="p">(</span><span class="n">observations</span><span class="p">,)</span>
        
        <span class="k">return</span> <span class="n">result</span></div>
    
    
<div class="viewcode-block" id="HybridVectorModel.compare_distributions"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.compare_distributions">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">get_PMF_observation_prediction</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">compare_distributions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stationID</span><span class="p">,</span> <span class="n">fromID</span><span class="p">,</span> <span class="n">toID</span><span class="p">,</span> <span class="n">xMax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
                              <span class="n">saveFileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compares distributions of agent obervations via Anderson-Darling</span>
<span class="sd">        tests and comparative plots of the observed and</span>
<span class="sd">        predicted cumulitive mass functions.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        saveFileName : str</span>
<span class="sd">            File name for plots. If ``None`` no plots will be saved.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">X</span><span class="p">,</span> <span class="n">observedPMF</span><span class="p">,</span> <span class="n">predictedPMF</span><span class="p">,</span> <span class="n">bestPMF</span><span class="p">,</span> <span class="n">observations</span> <span class="o">=</span> \
                <span class="bp">self</span><span class="o">.</span><span class="n">get_PMF_observation_prediction</span><span class="p">(</span><span class="n">stationID</span><span class="p">,</span> <span class="n">fromID</span><span class="p">,</span> <span class="n">toID</span><span class="p">,</span> 
                                        <span class="n">xMax</span><span class="p">,</span> <span class="n">getPureObservations</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;One of the indices could not be resolved. &quot;</span> <span class="o">+</span>
                          <span class="s2">&quot;I stop comparing the distributions.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
            <span class="k">return</span>
    
        <span class="n">observedCMF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">observedPMF</span><span class="p">)</span>
        <span class="n">predictedCMF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">predictedPMF</span><span class="p">)</span>
        <span class="n">bestCMF</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">bestPMF</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Testing whether the distribution for the flow from&quot;</span><span class="p">,</span> 
                  <span class="n">fromID</span><span class="p">,</span> <span class="s2">&quot;to&quot;</span><span class="p">,</span> <span class="n">toID</span><span class="p">,</span> <span class="s2">&quot;as observed at&quot;</span><span class="p">,</span> <span class="n">stationID</span><span class="p">,</span> <span class="s2">&quot;matches&quot;</span><span class="p">,</span>
                  <span class="s2">&quot;the expectations.&quot;</span><span class="p">)</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="n">anderson_darling_test_discrete</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">predictedCMF</span><span class="p">,</span> 
                                           <span class="kc">True</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;p-value (for H0: the distributions are equal):&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        
        
        <span class="k">if</span> <span class="n">saveFileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">saveFileNamePMF</span> <span class="o">=</span> <span class="n">saveFileName</span> <span class="o">+</span> <span class="s2">&quot;PMF&quot;</span>
            <span class="n">saveFileNameCMF</span> <span class="o">=</span> <span class="n">saveFileName</span> <span class="o">+</span> <span class="s2">&quot;CMF&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">saveFileNamePMF</span> <span class="o">=</span> <span class="n">saveFileNameCMF</span> <span class="o">=</span> <span class="kc">None</span>
            
        <span class="n">create_distribution_plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">observedPMF</span><span class="p">,</span> <span class="n">predictedPMF</span><span class="p">,</span> <span class="n">bestPMF</span><span class="p">,</span> <span class="s2">&quot;PMF&quot;</span><span class="p">,</span> 
                                 <span class="n">fileName</span><span class="o">=</span><span class="n">saveFileNamePMF</span><span class="p">)</span>
        <span class="n">create_distribution_plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">observedCMF</span><span class="p">,</span> <span class="n">predictedCMF</span><span class="p">,</span> <span class="n">bestCMF</span><span class="p">,</span> <span class="s2">&quot;CMF&quot;</span><span class="p">,</span> 
                                 <span class="n">fileName</span><span class="o">=</span><span class="n">saveFileNameCMF</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">p</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.test_1_1_regression"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.test_1_1_regression">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">get_normalized_observation_prediction</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">test_1_1_regression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">minSampleSize</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">saveFileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">comparisonFileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Tests whether the model results are biased.</span>
<span class="sd">        </span>
<span class="sd">        Compares predicted and observed values and tests the null hypothesis</span>
<span class="sd">        that the model yields unbiased estimates. If we obtain a high p-value</span>
<span class="sd">        and are unable to reject this hypothesis, we may assume that the model</span>
<span class="sd">        dies a good job.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        saveFileName : str</span>
<span class="sd">            File name for a plot depicting the test and to save the results.</span>
<span class="sd">        comparisonFileName : str</span>
<span class="sd">            File name to load results from a different model or different </span>
<span class="sd">            data set for comparison.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Performing a 1:1 regression test.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">)</span>
        <span class="n">saveFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="n">saveFileName</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">comparisonFileName</span><span class="p">:</span>
            <span class="n">comparisonFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="n">comparisonFileName</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Computing normalized observation and prediction values.&quot;</span><span class="p">)</span>
        
        <span class="n">regressionData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_normalized_observation_prediction</span><span class="p">(</span>
                                                                <span class="n">minSampleSize</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">regressionData</span><span class="o">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Too few stations have the required sample size.&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;No regression analysis is possible.&quot;</span><span class="p">,</span>
                      <span class="s2">&quot;Try to reduce minSampleSize.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
            <span class="k">return</span>
        
        <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">regressionData</span><span class="p">[</span><span class="s2">&quot;predicted&quot;</span><span class="p">],</span> <span class="n">regressionData</span><span class="p">[</span><span class="s2">&quot;observed&quot;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Doing regression.&quot;</span><span class="p">)</span>
        <span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">p_value</span><span class="p">,</span> <span class="n">std_err</span> <span class="o">=</span> <span class="n">linregress</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">increase_print_level</span><span class="p">()</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Slope:                         &quot;</span><span class="p">,</span> <span class="n">slope</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Intercept:                     &quot;</span><span class="p">,</span> <span class="n">intercept</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Correlation coefficient:       &quot;</span><span class="p">,</span> <span class="n">r_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;R squared:                     &quot;</span><span class="p">,</span> <span class="n">R2</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;p-value for H0: no correlation:&quot;</span><span class="p">,</span> <span class="n">p_value</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Standard error:                &quot;</span><span class="p">,</span> <span class="n">std_err</span><span class="p">)</span>
                                        
        <span class="c1"># compute the F-statistic</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">regressionData</span><span class="o">.</span><span class="n">size</span>
        <span class="n">RMSE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Y</span> <span class="o">-</span> <span class="p">(</span><span class="n">intercept</span><span class="o">+</span><span class="n">slope</span><span class="o">*</span><span class="n">X</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">F</span> <span class="o">=</span> <span class="p">(</span><span class="n">n</span><span class="o">*</span><span class="n">intercept</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">intercept</span><span class="o">*</span><span class="p">(</span><span class="n">slope</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
             <span class="o">+</span> <span class="p">(</span><span class="n">slope</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">X</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">RMSE</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;f-value:                     &quot;</span><span class="p">,</span> <span class="n">F</span><span class="p">)</span>
        
        
        <span class="k">def</span> <span class="nf">fInt</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">fdist</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">F</span><span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="o">-</span><span class="n">F</span><span class="p">)</span>
        
        <span class="n">p</span> <span class="o">=</span> <span class="n">op</span><span class="o">.</span><span class="n">brenth</span><span class="p">(</span><span class="n">fInt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;p-value for H0: slope=1 and intercept=0:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">lbound</span><span class="p">,</span> <span class="n">ubound</span> <span class="o">=</span> <span class="n">fdist</span><span class="o">.</span><span class="n">interval</span><span class="p">(</span><span class="n">level</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="o">-</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Reject slope=1 and intercept=0 on a&quot;</span><span class="p">,</span> <span class="n">level</span><span class="p">,</span> 
                      <span class="s2">&quot;</span><span class="si">% s</span><span class="s2">ignificance level:&quot;</span><span class="p">,</span> <span class="ow">not</span> <span class="n">lbound</span> <span class="o">&lt;=</span> <span class="n">F</span> <span class="o">&lt;=</span> <span class="n">ubound</span><span class="p">)</span>
            
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating regression plot.&quot;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">saveFileName</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">saveFileName</span> <span class="o">+=</span> <span class="s2">&quot;Regression&quot;</span>
            
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.96</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
                                                  <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">intercept</span><span class="p">),</span>
                      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Observed vs. Predicted Regression Analysis&quot;</span><span class="p">,</span>
                      <span class="n">fileName</span><span class="o">=</span><span class="n">saveFileName</span><span class="p">,</span>
                      <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">comparisonFileName</span> 
                      <span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span><span class="n">regressionData</span><span class="p">[</span><span class="s2">&quot;predictedMeanScaled&quot;</span><span class="p">],</span> <span class="n">regressionData</span><span class="p">[</span><span class="s2">&quot;observedMeanScaled&quot;</span><span class="p">],</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">1.96</span><span class="p">,</span>
                      <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Observed vs. Predicted Regression Analysis&quot;</span><span class="p">,</span>
                      <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;_scaled&quot;</span><span class="p">),</span>
                      <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="s2">&quot;_scaled&quot;</span><span class="p">)</span>
                      <span class="p">)</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        modelData = self.flowModelData</span>
<span class="sd">        p = 1-self._convert_parameters(modelData[&quot;parameters&quot;], modelData[&quot;considered&quot;])[1]</span>
<span class="sd">        def errFuncUp(x):</span>
<span class="sd">            result = normaldist.ppf(0.975, x, np.sqrt(x/p))</span>
<span class="sd">            result[np.isnan(result)] = 0</span>
<span class="sd">            return result</span>
<span class="sd">        def errFuncLow(x):</span>
<span class="sd">            result = normaldist.ppf(0.025, x, np.sqrt(x/p))</span>
<span class="sd">            result[np.isnan(result)] = 0</span>
<span class="sd">            return result</span>
<span class="sd">        </span>
<span class="sd">        create_observed_predicted_mean_error_plot(X, regressionData[&quot;observedMean&quot;], None, None,</span>
<span class="sd">                                                  (errFuncLow, errFuncUp),</span>
<span class="sd">                      title=&quot;Observed vs. Predicted Regression Analysis&quot;,</span>
<span class="sd">                      fileName=saveFileName + &quot;Reg&quot;</span>
<span class="sd">                      )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">decrease_print_level</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.create_quality_plots"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.create_quality_plots">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">create_observed_predicted_mean_error_plot</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">create_quality_plots</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">worstLabelNo</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
                             <span class="n">saveFileName</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                             <span class="n">comparisonFileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Creates predicted vs. observed plots.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        worstLabelNo : int</span>
<span class="sd">            Number of data points that shall be labelled with their respective </span>
<span class="sd">            IDs. The data points will be labelled in order of the largest</span>
<span class="sd">            deviance between predictions and observations.</span>
<span class="sd">        </span>
<span class="sd">        ~+~</span>
<span class="sd">        </span>
<span class="sd">        .. todo:: Compute mean at stations only, incorporate timing later.</span>
<span class="sd">            This could speed up the procedure significatnly.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="c1">#!!!!!!!!!!!!!!! porting an old version of the program.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;originData&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">originData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lakeData</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">lakeData</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">destinationData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jurisdictionData</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">jurisdictionData</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rawDestinationData</span><span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawLakeData</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawLakeData</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rawOriginData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawJurisdictionData</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">rawJurisdictionData</span>
        
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">F_OK</span><span class="p">):</span> <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">)</span>
        <span class="n">saveFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="n">saveFileName</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">comparisonFileName</span><span class="p">:</span>
            <span class="n">comparisonFileName</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="n">comparisonFileName</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating quality plots.&quot;</span><span class="p">)</span>
        
        <span class="n">countData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span>
        <span class="n">rawStationData</span><span class="p">,</span> <span class="n">rawPairData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_station_mean_variance</span><span class="p">(</span>
                    <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">],</span> <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">],</span> 
                    <span class="n">countData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">],</span> <span class="n">getStationResults</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">getPairResults</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">stationData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_station_observation_prediction</span><span class="p">(</span><span class="n">rawStationData</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating plot of the quality by station.&quot;</span><span class="p">)</span>
        <span class="n">station_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">stationData</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">stationData</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">stationData</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">station_std</span><span class="p">,</span>
            <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">stationData</span><span class="p">[</span><span class="s2">&quot;stationID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="s2">&quot;Predicted and observed boater flows by station&quot;</span><span class="p">,</span>
            <span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Stations&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">stationData</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">stationData</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Stations_raw&quot;</span><span class="p">),</span>
            <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="s2">&quot;Stations_raw&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">stationData</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">/</span><span class="n">station_std</span><span class="p">,</span>
            <span class="n">stationData</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">/</span><span class="n">station_std</span><span class="p">,</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Stations_scaled&quot;</span><span class="p">),</span>
            <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="s2">&quot;Stations_scaled&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating plot of the quality by pair.&quot;</span><span class="p">)</span>
        <span class="n">pairData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pair_observation_prediction</span><span class="p">(</span><span class="n">rawPairData</span><span class="p">)</span>
        <span class="n">pair_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">pair_std</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Predicted and observed boater flows by source-sink pair&quot;</span><span class="p">,</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Pairs&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Pairs_raw&quot;</span><span class="p">),</span>
            <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="s2">&quot;Pairs_raw&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">/</span><span class="n">pair_std</span><span class="p">,</span>
            <span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">/</span><span class="n">pair_std</span><span class="p">,</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Pairs_scaled&quot;</span><span class="p">),</span>
            <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="s2">&quot;Pairs_scaled&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating plot of the quality by origin.&quot;</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">worstLabelNo</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destinationData</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destinationData</span><span class="p">[</span><span class="s2">&quot;destinationID&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean</span><span class="o">-</span><span class="n">count</span><span class="p">)</span>
            <span class="n">max10DiffInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="o">-</span><span class="n">worstLabelNo</span><span class="p">)[</span><span class="o">-</span><span class="n">worstLabelNo</span><span class="p">:]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">max10DiffInd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">destinationData</span><span class="p">[</span><span class="s2">&quot;destinationID&quot;</span><span class="p">][</span><span class="n">max10DiffInd</span><span class="p">]</span>
        <span class="n">destination_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">],</span> <span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">mean</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span>
            <span class="n">destination_std</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Predicted and observed boater flows by destination&quot;</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Destinations&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">mean</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Destinations_raw&quot;</span><span class="p">),</span>
            <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="s2">&quot;Destinations_raw&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">mean</span><span class="o">/</span><span class="n">destination_std</span><span class="p">,</span> <span class="n">count</span><span class="o">/</span><span class="n">destination_std</span><span class="p">,</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Destinations_scaled&quot;</span><span class="p">),</span>
            <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="s2">&quot;Destinations_scaled&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Creating plot of the quality by origin.&quot;</span><span class="p">)</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">worstLabelNo</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="o">.</span><span class="n">size</span><span class="p">:</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">[</span><span class="s2">&quot;originID&quot;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">mean</span><span class="o">-</span><span class="n">count</span><span class="p">)</span>
            <span class="n">max10DiffInd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argpartition</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="o">-</span><span class="n">worstLabelNo</span><span class="p">)[</span><span class="o">-</span><span class="n">worstLabelNo</span><span class="p">:]</span>
            <span class="n">labels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty_like</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span><span class="p">)</span>
            <span class="n">labels</span><span class="p">[</span><span class="n">max10DiffInd</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">[</span><span class="s2">&quot;originID&quot;</span><span class="p">][</span>
                                                                <span class="n">max10DiffInd</span><span class="p">]</span>
        <span class="n">jur_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">pairData</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">mean</span><span class="p">,</span>
            <span class="n">count</span><span class="p">,</span>
            <span class="n">jur_std</span><span class="p">,</span>
            <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Predicted and observed boater flows by origin&quot;</span><span class="p">,</span>
            <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Origins&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">mean</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Origins_raw&quot;</span><span class="p">),</span>
            <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="s2">&quot;Origins_raw&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="n">create_observed_predicted_mean_error_plot</span><span class="p">(</span>
            <span class="n">mean</span><span class="o">/</span><span class="n">jur_std</span><span class="p">,</span> <span class="n">count</span><span class="o">/</span><span class="n">jur_std</span><span class="p">,</span>
            <span class="n">saveFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">saveFileName</span><span class="p">,</span> <span class="s2">&quot;Origins_scaled&quot;</span><span class="p">),</span>
            <span class="n">comparisonFileName</span><span class="o">=</span><span class="n">_non_join</span><span class="p">(</span><span class="n">comparisonFileName</span><span class="p">,</span> <span class="s2">&quot;Origins_scaled&quot;</span><span class="p">)</span>
            <span class="p">)</span>
        
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        self.prst(&quot;Creating plot of the quality by pair (log scale).&quot;)</span>
<span class="sd">        create_observed_predicted_mean_error_plot(</span>
<span class="sd">            pairData[&quot;mean&quot;].ravel(),</span>
<span class="sd">            pairData[&quot;count&quot;].ravel(),</span>
<span class="sd">            np.sqrt(pairData[&quot;variance&quot;].ravel()),</span>
<span class="sd">            title=&quot;Predicted and observed boater flows by source-sink pair&quot;,</span>
<span class="sd">            saveFileName=_non_join(saveFileName, &quot;Pairs_logScale&quot;),</span>
<span class="sd">            logScale=True</span>
<span class="sd">            )</span>
<span class="sd">        create_observed_predicted_mean_error_plot(</span>
<span class="sd">            pairData[&quot;mean&quot;].ravel(), pairData[&quot;count&quot;].ravel(),</span>
<span class="sd">            saveFileName=_non_join(saveFileName, &quot;Pairs_logScale_raw&quot;),</span>
<span class="sd">            logScale=True,</span>
<span class="sd">            comparisonFileName=_non_join(comparisonFileName, &quot;Pairs_logScale_raw&quot;)</span>
<span class="sd">            )</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.save_model_predictions"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.save_model_predictions">[docs]</a>    <span class="k">def</span> <span class="nf">save_model_predictions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Computes and saves model predictions by origin, destination, </span>
<span class="sd">        origin-destination pair, and inspection location.</span>
<span class="sd">        </span>
<span class="sd">        Saves the estimated mean traffic and </span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileName : str</span>
<span class="sd">            Base of the file name to which the predictions shall be saved.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;The model must have an internal file name or&quot;</span>
                             <span class="o">+</span> <span class="s2">&quot;fileName must be explicitely given.&quot;</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Saving the model predictions to file&quot;</span><span class="p">,</span> <span class="n">fileName</span><span class="p">)</span>
        <span class="n">stationData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_station_mean_variance</span><span class="p">(</span><span class="n">fullCompliance</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">correctData</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">stationData</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;Stations.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">measures</span> <span class="o">=</span> <span class="p">[</span><span class="n">nbinom</span><span class="o">.</span><span class="n">mean</span><span class="p">,</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">var</span><span class="p">,</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">median</span><span class="p">,</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">,</span> 
                    <span class="n">nbinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">,</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">,</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">]</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">]</span>
        <span class="n">pairData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_pair_distribution_property</span><span class="p">(</span><span class="n">measures</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="n">dtype</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;names&quot;</span><span class="p">:[</span><span class="s2">&quot;fromID&quot;</span><span class="p">,</span> <span class="s2">&quot;toID&quot;</span><span class="p">,</span> <span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;variance&quot;</span><span class="p">,</span> <span class="s2">&quot;median&quot;</span><span class="p">,</span> 
                          <span class="s2">&quot;75_percentile&quot;</span><span class="p">,</span> <span class="s2">&quot;90_percentile&quot;</span><span class="p">,</span>
                          <span class="s2">&quot;95_percentile&quot;</span><span class="p">,</span> <span class="s2">&quot;97.5_percentile&quot;</span><span class="p">],</span> 
                 <span class="s1">&#39;formats&#39;</span><span class="p">:[</span><span class="n">IDTYPE</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> 
                            <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">]}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pairData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtype</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pairData</span><span class="p">,</span> <span class="n">dtype</span><span class="p">[</span><span class="s2">&quot;names&quot;</span><span class="p">][</span><span class="mi">2</span><span class="p">:]):</span>
            <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
            
        <span class="n">fromID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">][</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sourceIndexToVertexIndex</span><span class="p">]</span>
        <span class="n">toID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">vertices</span><span class="o">.</span><span class="n">array</span><span class="p">[</span><span class="s2">&quot;ID&quot;</span><span class="p">][</span>
                                      <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sinkIndexToVertexIndex</span><span class="p">]</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fromID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">fromID</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">toID</span><span class="p">))</span>
        <span class="n">result</span><span class="p">[</span><span class="s2">&quot;toID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">toID</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">fromID</span><span class="p">))</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;Pair.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">fromID</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">toID</span><span class="p">)))</span>
        <span class="n">originResult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fromID</span><span class="p">),</span> 
                                      <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;fromID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">),</span>
                                             <span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                             <span class="p">(</span><span class="s2">&quot;variance&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                             <span class="p">(</span><span class="s2">&quot;95_percentile&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                             <span class="p">])</span>
        <span class="n">destinationResult</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">toID</span><span class="p">),</span> 
                                      <span class="n">dtype</span><span class="o">=</span><span class="p">[(</span><span class="s2">&quot;toID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">),</span>
                                             <span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                             <span class="p">(</span><span class="s2">&quot;variance&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                             <span class="p">(</span><span class="s2">&quot;meanInfested&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                             <span class="p">(</span><span class="s2">&quot;varianceInfested&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                             <span class="p">(</span><span class="s2">&quot;95_percentile&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                             <span class="p">(</span><span class="s2">&quot;95_percentileInfested&quot;</span><span class="p">,</span> <span class="s1">&#39;double&#39;</span><span class="p">),</span>
                                             <span class="p">])</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.95</span>
        <span class="k">def</span> <span class="nf">get_ppf</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">var</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">mean</span> <span class="o">/</span> <span class="n">var</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">mean</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">var</span><span class="o">-</span><span class="n">mean</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">nbinom</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
        
        <span class="n">originResult</span><span class="p">[</span><span class="s2">&quot;fromID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;fromID&quot;</span><span class="p">][:,</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">originResult</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>        
        <span class="n">originResult</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>  
        <span class="n">originResult</span><span class="p">[</span><span class="s2">&quot;95_percentile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_ppf</span><span class="p">(</span>
            <span class="n">originResult</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> <span class="n">originResult</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">])</span>
        
        <span class="k">assert</span> <span class="p">(</span><span class="n">originResult</span><span class="p">[</span><span class="s2">&quot;fromID&quot;</span><span class="p">]</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">[</span><span class="s2">&quot;originID&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        
        <span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;toID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;toID&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>        
        <span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>        
        <span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;meanInfested&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">[</span><span class="s2">&quot;infested&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>        
        <span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;varianceInfested&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">originData</span><span class="p">[</span><span class="s2">&quot;infested&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>        
        <span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;95_percentile&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_ppf</span><span class="p">(</span><span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">],</span> 
                                              <span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;variance&quot;</span><span class="p">])</span>
        <span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;95_percentileInfested&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_ppf</span><span class="p">(</span>
            <span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;meanInfested&quot;</span><span class="p">],</span> <span class="n">destinationResult</span><span class="p">[</span><span class="s2">&quot;varianceInfested&quot;</span><span class="p">])</span>
        
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">originResult</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;Origin.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">destinationResult</span><span class="p">)</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;Destination.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></div>
        
    
<div class="viewcode-block" id="HybridVectorModel.simulate_count_data"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.simulate_count_data">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">_convert_parameters_static</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">simulate_count_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stationTimes</span><span class="p">,</span> <span class="n">day</span><span class="p">,</span> <span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">,</span>
                            <span class="n">limitToOneObservation</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate observation data that would be obtained one one day if the </span>
<span class="sd">        model were True.</span>
<span class="sd">        </span>
<span class="sd">        For each boater, start, end, and path are returned.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        stationTimes : dict</span>
<span class="sd">            Keys: indices of the survey locations; values: 2-tuples for start </span>
<span class="sd">            and end time of the survey shift at that location (in 24h format).</span>
<span class="sd">        day : int</span>
<span class="sd">            ID for that day.</span>
<span class="sd">        parameters : float[]</span>
<span class="sd">            Parameters for the traffic flow (gravity) model.</span>
<span class="sd">        limitToOneObservation : bool</span>
<span class="sd">            Whether an agent travelling on an inadmissible route can be observed </span>
<span class="sd">            at one location only (as assumed when we fit the route choice model) </span>
<span class="sd">            or at multiple locations.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">routeLengths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">lengthsOfPotentialRoutes</span><span class="o">.</span><span class="n">data</span>
        
        <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convert_parameters</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>
        
        <span class="n">pRandom</span><span class="p">,</span> <span class="n">routeExp</span><span class="p">,</span> <span class="n">pObserve</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">routeChoiceModel</span><span class="o">.</span><span class="n">parameters</span>
        <span class="n">kMatrix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_k_value</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span> 
        
        <span class="n">q</span> <span class="o">=</span> <span class="n">parameters</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        
        <span class="c1"># number of people going for each pair</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">negative_binomial</span><span class="p">(</span><span class="n">kMatrix</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">q</span><span class="p">)</span>
        
        <span class="n">routePowers</span> <span class="o">=</span> <span class="n">sparsepower</span><span class="p">(</span><span class="n">routeLengths</span><span class="p">,</span> <span class="n">routeExp</span><span class="p">)</span>
        <span class="n">normConstants</span> <span class="o">=</span> <span class="n">sparsesum</span><span class="p">(</span><span class="n">routePowers</span><span class="p">)</span>
        
        <span class="n">pairToPairIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">_pair_to_pair_index</span>
        
        <span class="n">multObservations</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">stations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stationTimes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">times</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">stationTimes</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
        <span class="n">shiftNo</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">stations</span><span class="p">)</span>
        <span class="n">inspectedRoutes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">inspectedPotentialRoutes</span>
        <span class="n">observationsDType</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;stationID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;day&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">,</span> <span class="s2">&quot;double&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">,</span> <span class="s2">&quot;double&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;double&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sourceID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;sinkID&quot;</span><span class="p">,</span> <span class="n">IDTYPE</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;relevant&quot;</span><span class="p">,</span> <span class="nb">bool</span><span class="p">),</span>
            <span class="p">]</span>
        <span class="n">observations</span> <span class="o">=</span> <span class="n">FlexibleArray</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">observationsDType</span><span class="p">)</span>
        
        <span class="n">stationIndexToStationID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIndexToStationID</span>
        <span class="n">sourceIndexToSourceID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sourceIndexToSourceID</span>
        <span class="n">sinkIndexToSinkID</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">sinkIndexToSinkID</span>
        
        <span class="c1"># boaters&#39; route choices</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n1</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">sink</span><span class="p">,</span> <span class="n">n_ij</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
                <span class="n">pair</span> <span class="o">=</span> <span class="n">pairToPairIndex</span><span class="p">((</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">))</span>
                <span class="n">rp</span> <span class="o">=</span> <span class="n">routePowers</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="o">/</span> <span class="n">normConstants</span><span class="p">[</span><span class="n">pair</span><span class="p">]</span>
                <span class="n">choices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">rp</span><span class="o">.</span><span class="n">size</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_ij</span><span class="p">):</span>
                    <span class="n">obsNum</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">goRandom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pRandom</span>
                    <span class="k">if</span> <span class="n">goRandom</span><span class="p">:</span>
                        <span class="n">observed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">shiftNo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pObserve</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">observed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shiftNo</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">bool</span><span class="p">)</span>
                        <span class="n">route</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">choices</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">rp</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">locInd</span><span class="p">,</span> <span class="n">station</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stations</span><span class="p">):</span>
                            <span class="n">observed</span><span class="p">[</span><span class="n">locInd</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                                <span class="n">station</span> <span class="ow">in</span> <span class="n">inspectedRoutes</span> <span class="ow">and</span>
                                <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">)</span> <span class="ow">in</span> <span class="n">inspectedRoutes</span><span class="p">[</span><span class="n">station</span><span class="p">]</span> <span class="ow">and</span>
                                <span class="n">route</span> <span class="ow">in</span> <span class="n">inspectedRoutes</span><span class="p">[</span><span class="n">station</span><span class="p">][</span>
                                    <span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">sink</span><span class="p">)])</span>
                    
                    <span class="n">tuples</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">locInd</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">observed</span><span class="p">)[</span><span class="mi">0</span><span class="p">]:</span>
                        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">travelTimeModel</span><span class="o">.</span><span class="n">sample</span><span class="p">()</span>
                        <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">locInd</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">start</span> <span class="o">&lt;=</span> <span class="n">time</span> <span class="o">&lt;=</span> <span class="n">end</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">complianceRate</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">properDataRate</span><span class="p">:</span>
                                <span class="n">sinkID</span> <span class="o">=</span> <span class="n">sinkIndexToSinkID</span><span class="p">[</span><span class="n">sink</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">sinkID</span> <span class="o">=</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span>
                            <span class="n">tuples</span><span class="o">.</span><span class="n">append</span><span class="p">((</span>
                                <span class="n">stationIndexToStationID</span><span class="p">[</span><span class="n">stations</span><span class="p">[</span><span class="n">locInd</span><span class="p">]],</span>
                                <span class="n">day</span><span class="p">,</span>
                                <span class="n">start</span><span class="p">,</span>
                                <span class="n">end</span><span class="p">,</span>
                                <span class="n">time</span><span class="p">,</span>
                                <span class="n">sourceIndexToSourceID</span><span class="p">[</span><span class="n">source</span><span class="p">],</span>
                                <span class="n">sinkID</span><span class="p">,</span>
                                <span class="kc">True</span>
                                <span class="p">))</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tuples</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">limitToOneObservation</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">goRandom</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tuples</span><span class="p">:</span>
                            <span class="n">observations</span><span class="o">.</span><span class="n">add_tuple</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
                            <span class="n">obsNum</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tuples</span><span class="p">):</span>
                            <span class="n">multObservations</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">tuples</span><span class="p">)]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">stations</span><span class="p">,</span> <span class="n">times</span><span class="p">):</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="n">t</span>
            <span class="n">observations</span><span class="o">.</span><span class="n">add_tuple</span><span class="p">((</span>
                <span class="n">stationIndexToStationID</span><span class="p">[</span><span class="n">s</span><span class="p">],</span>
                <span class="n">day</span><span class="p">,</span>
                <span class="n">start</span><span class="p">,</span>
                <span class="n">end</span><span class="p">,</span>
                <span class="mf">0.</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                <span class="kc">False</span>
                <span class="p">))</span>
        
        <span class="n">observations</span> <span class="o">=</span> <span class="n">observations</span><span class="o">.</span><span class="n">get_array</span><span class="p">()</span>
        <span class="n">observations</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">order</span><span class="o">=</span><span class="s2">&quot;stationID&quot;</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="n">observations</span><span class="p">,</span> <span class="n">multObservations</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.save_simulated_observations"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.save_simulated_observations">[docs]</a>    <span class="nd">@inherit_doc</span><span class="p">(</span><span class="n">simulate_count_data</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">save_simulated_observations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">considered</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">shiftNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">dayNumber</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">stationSets</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                    <span class="n">fileName</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Simulate observation data that would be obtained if the model were </span>
<span class="sd">        True.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        shiftNumber : int</span>
<span class="sd">            Number of observation shifts to be considered.</span>
<span class="sd">        dayNumber : int</span>
<span class="sd">            Number of days on which the shifts were conducted.</span>
<span class="sd">        stationSets : int[][]</span>
<span class="sd">            Sets/lists of survey location IDs at which inspections could be</span>
<span class="sd">            conducted simultaneously.</span>
<span class="sd">        fileName : str</span>
<span class="sd">            Name of the file to which the generated observations shall be saved.</span>
<span class="sd">        </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fileName</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="n">fileName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fileName</span>
            
        <span class="k">if</span> <span class="n">parameters</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parameters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span>
            <span class="n">considered</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">flowModelData</span><span class="p">[</span><span class="s2">&quot;considered&quot;</span><span class="p">]</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Simulating observations for static parameters&quot;</span><span class="p">,</span> 
                  <span class="n">parameters</span><span class="p">,</span> <span class="s2">&quot;with considered parameters&quot;</span><span class="p">,</span> <span class="n">considered</span><span class="p">)</span>    
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">travelTimeModel</span><span class="o">.</span><span class="n">location</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">travelTimeModel</span><span class="o">.</span><span class="n">kappa</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">shiftNumber</span><span class="p">:</span>
            <span class="n">shiftData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">shiftData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">shiftNumber</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">vonmises</span><span class="p">(</span>
                                            <span class="p">(</span><span class="o">-</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">shiftNumber</span><span class="p">)</span>
                                                 <span class="o">*</span><span class="p">(</span><span class="mi">12</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">maximum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span>
                                        <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">vonmises</span><span class="p">(</span>
                                            <span class="mi">3</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">shiftNumber</span><span class="p">)</span>
                                                 <span class="o">*</span><span class="p">(</span><span class="mi">12</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">23</span><span class="p">),</span> <span class="mi">4</span><span class="p">)</span>
            <span class="n">considered</span> <span class="o">=</span> <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">]</span>
            <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">][</span><span class="n">considered</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">][</span>
                                                                <span class="n">considered</span><span class="p">]</span><span class="o">+</span><span class="mi">3</span>
            
            <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">minimum</span><span class="p">(</span><span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">],</span> <span class="mf">23.5</span><span class="p">)</span>
            
            <span class="n">pNewDay</span> <span class="o">=</span> <span class="n">dayNumber</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">shiftData</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">stationSets</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                                                    <span class="bp">self</span><span class="o">.</span><span class="n">surveyData</span><span class="p">[</span><span class="s2">&quot;shiftData&quot;</span><span class="p">][</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">]),</span> 
                                                                 <span class="n">shiftNumber</span><span class="p">)</span>
                <span class="n">dayIndex</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">shiftData</span><span class="p">):</span>
                    <span class="n">row</span><span class="p">[</span><span class="s2">&quot;dayIndex&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dayIndex</span>
                    <span class="n">dayIndex</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">pNewDay</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dayIndex</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">shiftIndex</span> <span class="o">=</span> <span class="mi">0</span> 
                <span class="n">stationIDToStationIndex</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="n">stationIDToStationIndex</span>
                <span class="k">while</span> <span class="n">shiftIndex</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shiftData</span><span class="p">):</span>
                    <span class="n">chosenSet</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">stationSets</span><span class="p">)</span>
                    <span class="n">chosenStations</span> <span class="o">=</span> <span class="n">chosenSet</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">chosenSet</span><span class="p">))</span>
                                                              <span class="o">&lt;</span> <span class="mi">1</span><span class="o">/</span><span class="p">(</span><span class="n">pNewDay</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">chosenSet</span><span class="p">))]</span>
                    <span class="k">for</span> <span class="n">station</span> <span class="ow">in</span> <span class="n">chosenStations</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">shiftIndex</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">shiftData</span><span class="p">):</span>
                            <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">][</span><span class="n">shiftIndex</span><span class="p">]</span> <span class="o">=</span> \
                                <span class="n">stationIDToStationIndex</span><span class="p">[</span><span class="n">station</span><span class="p">]</span>
                            <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;dayIndex&quot;</span><span class="p">][</span><span class="n">shiftIndex</span><span class="p">]</span> <span class="o">=</span> <span class="n">dayIndex</span>
                            <span class="n">shiftIndex</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">dayIndex</span> <span class="o">+=</span> <span class="mi">1</span>
        
        <span class="c1">#shiftData[&quot;shiftStart&quot;]=11</span>
        <span class="c1">#shiftData[&quot;shiftEnd&quot;]=16</span>
        <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">]</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="n">shiftData</span><span class="o">.</span><span class="n">size</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-5</span>
        
        <span class="n">observations</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">countData</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="n">newDay</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;dayIndex&quot;</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;dayIndex&quot;</span><span class="p">])</span>
        <span class="n">newDay</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        
        <span class="n">dayStartIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">dayEndIndex</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">newDay</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">stationTimes</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">shiftIndex</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">dayStartIndex</span><span class="p">,</span> <span class="n">dayEndIndex</span><span class="p">):</span>
                <span class="n">stationIndex</span> <span class="o">=</span> <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;stationIndex&quot;</span><span class="p">][</span><span class="n">shiftIndex</span><span class="p">]</span>
                <span class="n">stationTimes</span><span class="p">[</span><span class="n">stationIndex</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftStart&quot;</span><span class="p">][</span><span class="n">shiftIndex</span><span class="p">],</span>
                                              <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;shiftEnd&quot;</span><span class="p">][</span><span class="n">shiftIndex</span><span class="p">])</span>
            <span class="n">obsData</span><span class="p">,</span> <span class="n">cData</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_count_data</span><span class="p">(</span>
                <span class="n">stationTimes</span><span class="p">,</span> <span class="n">shiftData</span><span class="p">[</span><span class="s2">&quot;dayIndex&quot;</span><span class="p">][</span><span class="n">dayStartIndex</span><span class="p">],</span> <span class="n">parameters</span><span class="p">,</span> 
                <span class="n">considered</span><span class="p">)</span>
            <span class="n">observations</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obsData</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">+=</span> <span class="n">obsData</span><span class="o">.</span><span class="n">size</span>
            <span class="k">for</span> <span class="n">obsNo</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">cData</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">countData</span><span class="p">[</span><span class="n">obsNo</span><span class="p">]</span> <span class="o">+=</span> <span class="n">count</span>
            <span class="n">dayStartIndex</span> <span class="o">=</span> <span class="n">dayEndIndex</span>
        
        <span class="n">totalObsNo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">distinctObsNo</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">obsNo</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">countData</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">totalObsNo</span> <span class="o">+=</span> <span class="n">obsNo</span><span class="o">*</span><span class="n">count</span>
            <span class="n">distinctObsNo</span> <span class="o">+=</span> <span class="n">count</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="s2">&quot;boaters have been observed&quot;</span><span class="p">,</span> <span class="n">obsNo</span><span class="p">,</span> <span class="s2">&quot;time(s).&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;In total, we have&quot;</span><span class="p">,</span> <span class="n">totalObsNo</span><span class="p">,</span> <span class="s2">&quot;observations of&quot;</span><span class="p">,</span>
                  <span class="n">distinctObsNo</span><span class="p">,</span> <span class="s2">&quot;distinct boaters in&quot;</span><span class="p">,</span> <span class="n">shiftData</span><span class="o">.</span><span class="n">size</span><span class="p">,</span>
                  <span class="s2">&quot;shifts.&quot;</span><span class="p">)</span>
        <span class="n">observationsArr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">observations</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
        
        <span class="n">sectionStart</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">subArr</span> <span class="ow">in</span> <span class="n">observations</span><span class="p">:</span>
            <span class="n">observationsArr</span><span class="p">[</span><span class="n">sectionStart</span><span class="p">:</span><span class="n">sectionStart</span><span class="o">+</span><span class="n">subArr</span><span class="o">.</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="n">subArr</span>
            <span class="n">sectionStart</span> <span class="o">+=</span> <span class="n">subArr</span><span class="o">.</span><span class="n">size</span>
        
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">observationsArr</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="s2">&quot;stationID&quot;</span><span class="p">,</span> <span class="s2">&quot;sourceID&quot;</span><span class="p">:</span>
            <span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sinkID&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;sinkID&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="mi">3</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">fileName</span> <span class="o">+</span> <span class="s2">&quot;_SimulatedObservations.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Done.&quot;</span><span class="p">)</span></div>
    
<div class="viewcode-block" id="HybridVectorModel.new"><a class="viewcode-back" href="../../hybrid_vector_model/hybrid_vector_model.hybrid_vector_model.html#hybrid_vector_model.hybrid_vector_model.HybridVectorModel.new">[docs]</a>    <span class="nd">@staticmethod_inherit_doc</span><span class="p">(</span><span class="n">read_origin_data</span><span class="p">,</span> <span class="n">read_destination_data</span><span class="p">,</span> <span class="n">read_survey_data</span><span class="p">,</span>
                              <span class="n">read_postal_code_area_data</span><span class="p">,</span> <span class="n">set_compliance_rate</span><span class="p">,</span> <span class="n">TransportNetwork</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">new</span><span class="p">(</span><span class="n">fileNameBackup</span><span class="p">,</span>
            <span class="n">trafficFactorModel_class</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fileNameEdges</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">fileNameVertices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fileNameOrigins</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fileNameDestinations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fileNamePostalCodeAreas</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">fileNameObservations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">complianceRate</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">preprocessingArgs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">edgeLengthRandomization</span><span class="o">=</span><span class="mf">0.001</span><span class="p">,</span>
            <span class="n">routeParameters</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">considerInfested</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">destinationToDestination</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">restart</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> 
            <span class="o">**</span><span class="n">restartArgs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Constructs a new :py:class:`HybridVectorModel`, thereby reusing saved previous results if possible.</span>
<span class="sd">        </span>
<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fileNameBackup : str</span>
<span class="sd">            Name of the file to load and save the model; without file extension</span>
<span class="sd">        trafficFactorModel_class : class</span>
<span class="sd">            Class representing the gravity model; must be inherited from </span>
<span class="sd">            :py:class:`BaseTrafficFactorModel`</span>
<span class="sd">        considerInfested : bool </span>
<span class="sd">            If given, only origins with the provided infestation state will be </span>
<span class="sd">            considered to fit the model; see :py:meth:`HybridVectorModel.set_origins_considered`</span>
<span class="sd">        restart : bool </span>
<span class="sd">            If ``True``, earlier results will be ignored and the model </span>
<span class="sd">            will be constructed from scratch. </span>
<span class="sd">        routeParameters : tuple</span>
<span class="sd">            Parameters defining which routes are deemed admissible. See</span>
<span class="sd">            :py:meth:`find_potential_routes`.</span>
<span class="sd">        ---------------------------------</span>
<span class="sd">        **restartArgs : keyword arguments</span>
<span class="sd">            The arguments below specify which parts of the model </span>
<span class="sd">            construction process shall be repeated even if earler results are </span>
<span class="sd">            available. If the arguments are set to ``True``, the respective</span>
<span class="sd">            model constrution process will take place (provided the necessary</span>
<span class="sd">            arguments, such as file names, are provided. </span>
<span class="sd">        readOriginData : bools</span>
<span class="sd">            Read csv with data on boater origins</span>
<span class="sd">        readDestinationData : bool</span>
<span class="sd">            Read csv with data on boater destinations</span>
<span class="sd">        readPostalCodeAreaData : bool</span>
<span class="sd">            Read csv with population data for postal code regions</span>
<span class="sd">        readRoadNetwork : bool </span>
<span class="sd">            Read csv with road network data</span>
<span class="sd">        findShortestDistances : boold</span>
<span class="sd">            Find the shortest distances between boater</span>
<span class="sd">            origins and destinations and between destinations and postal code </span>
<span class="sd">            area centres</span>
<span class="sd">        readSurveyData : bool</span>
<span class="sd">            Read csv file with boater survey data</span>
<span class="sd">        properDataRate : float</span>
<span class="sd">            Rate of complete data (inferred from the data if not given)</span>
<span class="sd">        fitTravelTimeModel : bool</span>
<span class="sd">            Fit the model for boaters&#39; travel timing</span>
<span class="sd">        travelTimeParameters : float[]</span>
<span class="sd">            If the traffic time model shall not be fitted but rather created </span>
<span class="sd">            with known parameters, this argument contains these parameters</span>
<span class="sd">        preprocessSurveyData: bool</span>
<span class="sd">            Prepare the boater observation data for the fit of the full </span>
<span class="sd">            traffic flow model</span>
<span class="sd">        findPotentialRoutes : bool</span>
<span class="sd">            Determine potential routes that boaters might take</span>
<span class="sd">        fitRouteChoiceModel : bool </span>
<span class="sd">            Fit the model assigning probabilities to the potential boater routes </span>
<span class="sd">        routeChoiceParameters : float[] </span>
<span class="sd">            If the route choice model shall not be fitted but rather created </span>
<span class="sd">            with known parameters, this argument contains these parameters</span>
<span class="sd">        continueRouteChoiceOptimization : bool </span>
<span class="sd">            If ``True``, the :py:obj:`routeChoiceParameters` will be interpreted </span>
<span class="sd">            as initial guess rather than the best-fit parameters for the route </span>
<span class="sd">            choice model</span>
<span class="sd">        preapareTrafficFactorModel : bool</span>
<span class="sd">            Prepare the traffic factor model</span>
<span class="sd">        fitFlowModel : bool</span>
<span class="sd">            Fit the gravity model for the vector flow between origins and </span>
<span class="sd">            destinations</span>
<span class="sd">        permutations : bool[][]</span>
<span class="sd">            Permutations of parameters to be considered. The number of </span>
<span class="sd">            columns must match the maximal number of parameters of the model </span>
<span class="sd">            (see :py:attr:`BaseTrafficFactorModel.SIZE` and </span>
<span class="sd">            :py:attr:`BaseTrafficFactorModel.PERMUTATIONS`)</span>
<span class="sd">        flowParameters : float[]</span>
<span class="sd">            If the flow model shall not be fitted but rather created with known </span>
<span class="sd">            parameters, this argument contains these parameters</span>
<span class="sd">        continueTrafficFactorOptimization : bool </span>
<span class="sd">            If ``True``, the :py:obj:`flowParameters` will be interpreted </span>
<span class="sd">            as initial guess rather than the best fitting parameters for the </span>
<span class="sd">            flow model</span>
<span class="sd">            </span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="k">if</span> <span class="n">restart</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">exists</span><span class="p">(</span><span class="n">fileNameBackup</span> <span class="o">+</span> <span class="s2">&quot;.vmm&quot;</span><span class="p">):</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">HybridVectorModel</span><span class="p">(</span><span class="n">fileNameBackup</span><span class="p">,</span> 
                                            <span class="n">trafficFactorModel_class</span><span class="p">,</span> 
                                            <span class="n">destinationToDestination</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Loading model from file&quot;</span><span class="p">,</span> <span class="n">fileNameBackup</span> <span class="o">+</span> <span class="s2">&quot;.vmm&quot;</span><span class="p">)</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">saveobject</span><span class="o">.</span><span class="n">load_object</span><span class="p">(</span><span class="n">fileNameBackup</span> <span class="o">+</span> <span class="s2">&quot;.vmm&quot;</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">fileName</span> <span class="o">=</span> <span class="n">fileNameBackup</span>
            <span class="k">if</span> <span class="s2">&quot;destinationToDestination&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">destinationToDestination</span> <span class="o">=</span> <span class="kc">False</span>
        
        <span class="n">attrDict</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="vm">__dict__</span>
        <span class="n">restartArgs</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span> <span class="n">restartArgs</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">destinationToDestination</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="s2">&quot;rawOriginData&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span> 
                 <span class="ow">or</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;readOriginData&quot;</span><span class="p">])</span>
                    <span class="ow">and</span> <span class="n">fileNameOrigins</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">model</span><span class="o">.</span><span class="n">read_origin_data</span><span class="p">(</span><span class="n">fileNameOrigins</span><span class="p">)</span>
                <span class="c1">#model.save()</span>
        
        <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="s2">&quot;rawDestinationData&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span> 
             <span class="ow">or</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;readDestinationData&quot;</span><span class="p">])</span>
                <span class="ow">and</span> <span class="n">fileNameDestinations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">read_destination_data</span><span class="p">(</span><span class="n">fileNameDestinations</span><span class="p">)</span>
            <span class="c1">#model.save()</span>
        
        <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="s2">&quot;postalCodeAreaData&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span> 
             <span class="ow">or</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;readPostalCodeAreaData&quot;</span><span class="p">])</span>
                <span class="ow">and</span> <span class="n">fileNamePostalCodeAreas</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">read_postal_code_area_data</span><span class="p">(</span><span class="n">fileNamePostalCodeAreas</span><span class="p">)</span>
            <span class="c1">#model.save()</span>
        
        <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="s2">&quot;roadNetwork&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span> 
             <span class="ow">or</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;readRoadNetwork&quot;</span><span class="p">])</span>
                <span class="ow">and</span> <span class="n">fileNameEdges</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="ow">and</span> <span class="n">fileNameVertices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">create_road_network</span><span class="p">(</span><span class="n">fileNameEdges</span><span class="p">,</span> <span class="n">fileNameVertices</span><span class="p">,</span> 
                                      <span class="n">preprocessingArgs</span><span class="p">,</span> 
                                      <span class="n">edgeLengthRandomization</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="s2">&quot;complianceRate&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span> 
            <span class="ow">or</span> <span class="p">(</span><span class="n">complianceRate</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> 
                <span class="ow">and</span> <span class="n">model</span><span class="o">.</span><span class="n">complianceRate</span> <span class="o">!=</span> <span class="n">complianceRate</span><span class="p">)):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">set_compliance_rate</span><span class="p">(</span><span class="n">complianceRate</span><span class="p">)</span>
            <span class="n">model</span><span class="o">.</span><span class="n">prst</span><span class="p">(</span><span class="s2">&quot;Compliance rate set to &quot;</span><span class="p">,</span> <span class="n">complianceRate</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">considerInfested</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model</span><span class="o">.</span><span class="n">set_origins_considered</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">considerInfested</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;roadNetwork&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span> <span class="ow">and</span>
            <span class="p">(</span><span class="ow">not</span> <span class="s2">&quot;shortestDistances&quot;</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="vm">__dict__</span>
             <span class="ow">or</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;findShortestDistances&quot;</span><span class="p">])):</span>
            <span class="n">model</span><span class="o">.</span><span class="n">find_shortest_distances</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">destinationToDestination</span><span class="p">:</span> <span class="c1">#!!!!!!!!!!!!!</span>
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="s2">&quot;surveyData&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span> 
                 <span class="ow">or</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;readSurveyData&quot;</span><span class="p">])</span>
                    <span class="ow">and</span> <span class="s2">&quot;roadNetwork&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span>
                    <span class="ow">and</span> <span class="n">fileNameObservations</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">properDataRate</span> <span class="o">=</span> <span class="n">restartArgs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properDataRate&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">read_survey_data</span><span class="p">(</span><span class="n">fileNameObservations</span><span class="p">,</span> 
                                            <span class="n">properDataRate</span><span class="o">=</span><span class="n">properDataRate</span><span class="p">)</span>
                <span class="c1">#model.save()</span>
                
            <span class="k">if</span> <span class="p">((</span><span class="ow">not</span> <span class="s2">&quot;travelTimeModel&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span> 
                 <span class="ow">or</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;fitTravelTimeModel&quot;</span><span class="p">])</span>
                    <span class="ow">and</span> <span class="s2">&quot;surveyData&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span><span class="p">):</span>
                <span class="n">travelTimeParameters</span> <span class="o">=</span> <span class="n">restartArgs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;travelTimeParameters&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">create_travel_time_model</span><span class="p">(</span><span class="n">travelTimeParameters</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">fileName</span><span class="p">)</span>
                <span class="c1">#model.save()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">restart</span><span class="p">:</span> <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;roadNetwork&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span> <span class="ow">and</span> <span class="n">routeParameters</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            
            <span class="k">if</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;preprocessSurveyData&quot;</span><span class="p">]:</span>
                <span class="n">model</span><span class="o">.</span><span class="n">__erase_processed_survey_data</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="n">model</span><span class="o">.</span><span class="n">roadNetwork</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inspectedPotentialRoutes&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> 
                    <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;findPotentialRoutes&quot;</span><span class="p">]):</span>
                <span class="n">model</span><span class="o">.</span><span class="n">find_potential_routes</span><span class="p">(</span><span class="o">*</span><span class="n">routeParameters</span><span class="p">)</span>
                <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            
            <span class="k">if</span> <span class="n">destinationToDestination</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">&quot;A model with destination to destination traffic&quot;</span>
                                          <span class="o">+</span> <span class="s2">&quot; has not yet been&quot;</span>
                                          <span class="o">+</span> <span class="s2">&quot; implemented completely.&quot;</span><span class="p">)</span>
            
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;travelTimeModel&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span><span class="p">):</span>
                <span class="n">save</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">create_route_choice_model</span><span class="p">(</span><span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;createRouteChoiceModel&quot;</span><span class="p">])</span>
                <span class="n">save</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">preprocess_survey_data</span><span class="p">()</span> <span class="ow">or</span> <span class="n">save</span>
                <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                    <span class="c1">#model.save()</span>
                    <span class="k">pass</span>
            
                
            <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;travelTimeModel&quot;</span> <span class="ow">in</span> <span class="n">attrDict</span><span class="p">):</span>
                
                <span class="n">save</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="n">routeChoiceParameters</span> <span class="o">=</span> <span class="n">restartArgs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;routeChoiceParameters&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">continueRouteChoiceOptimization</span> <span class="o">=</span> <span class="n">restartArgs</span><span class="p">[</span>
                                            <span class="s2">&quot;continueRouteChoiceOptimization&quot;</span><span class="p">]</span>
                
                
                <span class="n">refit</span> <span class="o">=</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;fitRouteChoiceModel&quot;</span><span class="p">]</span>
                <span class="n">save</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_route_choice_model</span><span class="p">(</span><span class="n">refit</span><span class="p">,</span> <span class="n">routeChoiceParameters</span><span class="p">,</span>
                                                    <span class="n">continueRouteChoiceOptimization</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                    <span class="c1">#model.save()</span>
                    <span class="k">pass</span>
                    
                <span class="n">flowParameters</span> <span class="o">=</span> <span class="n">restartArgs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;flowParameters&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="n">continueTrafficFactorOptimization</span> <span class="o">=</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;continueTrafficFactorOptimization&quot;</span><span class="p">]</span>
                
                <span class="c1">#if model.fit_flow_model(parameters, refit=refit, flowParameters=flowParameters):</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;trafficFactorModel&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">model</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">or</span> 
                        <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;preapareTrafficFactorModel&quot;</span><span class="p">]):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">prepare_traffic_factor_model</span><span class="p">()</span>
                    
                <span class="n">refit</span> <span class="o">=</span> <span class="n">restartArgs</span><span class="p">[</span><span class="s2">&quot;fitFlowModel&quot;</span><span class="p">]</span>
                <span class="n">permutations</span> <span class="o">=</span> <span class="n">restartArgs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;permutations&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">model</span><span class="o">.</span><span class="n">fit_flow_model</span><span class="p">(</span><span class="n">permutations</span><span class="p">,</span> <span class="n">refit</span><span class="p">,</span> <span class="n">flowParameters</span><span class="p">,</span> 
                                        <span class="n">continueTrafficFactorOptimization</span><span class="p">):</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">test_1_1_regression</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span>
                                              <span class="n">model</span><span class="o">.</span><span class="n">fileName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">routeParameters</span><span class="p">))</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">create_quality_plots</span><span class="p">(</span><span class="n">saveFileName</span><span class="o">=</span>
                                               <span class="n">model</span><span class="o">.</span><span class="n">fileName</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">routeParameters</span><span class="p">))</span>
                    <span class="n">save</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">save</span><span class="p">:</span>
                    <span class="n">model</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
            <span class="c1">#model.create_quality_plots(parameters, </span>
            <span class="c1">#                               model.fileName + str(parameters))</span>
        <span class="k">return</span> <span class="n">model</span>    </div></div>
            


<span class="c1">#print(HybridVectorModel._get_k_value.__doc__)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">HybridVectorModel</span><span class="o">.</span><span class="n">maximize_log_likelihood_static</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
<span class="c1">#print(HybridVectorModel._get_nLL_funs.__doc__)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h3><a href="../../index.html">Packages</a></h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../hybrid_vector_model.html">hybrid_vector_model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ci_rvm.html">ci_rvm</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../lopaths.html">lopaths</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vemomoto_core.html">vemomoto_core</a></li>
</ul>

<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">VeMoMoTo</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2020, Samuel M. Fischer.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.3.0.
    </div>
  </body>
</html>